# å®¢æœæœºå™¨äººé¡¹ç›®æ¶æ„è¯´æ˜ï¼ˆè¡¨å•ç‰ˆæœ¬ï¼‰

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

**é¡¹ç›®ç±»å‹**ï¼šå¤šæ§½ä½ä¿¡æ¯é‡‡é›†å¯¹è¯ç³»ç»Ÿï¼ˆForm-Based Dialog Systemï¼‰  
**æ ¸å¿ƒåŠŸèƒ½**ï¼šé€šè¿‡è‡ªç„¶è¯­è¨€ç†è§£ï¼Œé€æ­¥æ”¶é›†ç”¨æˆ·éœ€æ±‚ä¿¡æ¯ï¼ˆå“ç±»ã€å“ç‰Œã€ç³»åˆ—ã€é…ç½®ç­‰ï¼‰  
**æŠ€æœ¯ç‰¹ç‚¹**ï¼šé…ç½®é©±åŠ¨ + å¤šå±‚ä¿¡æ¯æŠ½å– + LLMå¢å¼º

---

## ğŸ—ï¸ ç³»ç»Ÿå±‚æ¬¡æ¶æ„ï¼ˆè‡ªä¸Šè€Œä¸‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              1. ç”¨æˆ·äº¤äº’å±‚ (main.py)                      â”‚
â”‚  - ä¸šåŠ¡çº¿é€‰æ‹©                                             â”‚
â”‚  - æ¬¢è¿æç¤ºæ˜¾ç¤º                                           â”‚
â”‚  - ç”¨æˆ·è¾“å…¥å¤„ç†                                           â”‚
â”‚  - ç³»ç»Ÿå“åº”è¾“å‡º                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        2. æ ¸å¿ƒå¯¹è¯ç®¡ç†å±‚ (core/)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ FormBasedDialogSystem (form_based_system.py)      â”‚  â”‚
â”‚  â”‚  - æ§½ä½çŠ¶æ€ç®¡ç† (SlotStatus: EMPTY/FILLED/...)   â”‚  â”‚
â”‚  â”‚  - è®¢å•çŠ¶æ€æµè½¬ (OrderStatus: COLLECTING/...)    â”‚  â”‚
â”‚  â”‚  - å†²çªæ£€æµ‹ä¸è§£å†³                                 â”‚  â”‚
â”‚  â”‚  - ä¾èµ–é“¾ç®¡ç†                                     â”‚  â”‚
â”‚  â”‚  - é‡é€‰åŠŸèƒ½                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         3. ä¿¡æ¯æŠ½å–å±‚ï¼ˆä¸‰å±‚ç€‘å¸ƒå¼ï¼‰                       â”‚
â”‚                                                           â”‚
â”‚  Layer 1: ç›´æ¥å…³é”®è¯åŒ¹é… (Direct Keyword)                 â”‚
â”‚    â””â”€ _direct_keyword_extraction()                       â”‚
â”‚       ä»é…ç½®çš„åˆ«ååˆ—è¡¨ä¸­ç²¾ç¡®åŒ¹é…                          â”‚
â”‚       ä¼˜å…ˆçº§æœ€é«˜ï¼Œé€Ÿåº¦æœ€å¿«                                â”‚
â”‚                                                           â”‚
â”‚  Layer 2: è¯­ä¹‰æ˜ å°„ (Semantic Mapping)                    â”‚
â”‚    â””â”€ _semantic_slot_extraction()                        â”‚
â”‚       ä½¿ç”¨ OptionBuilder è¿›è¡Œæœ¬åœ°è¯­ä¹‰æ„é€                  â”‚
â”‚       æ”¯æŒä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„é€‰é¡¹è¿‡æ»¤                            â”‚
â”‚                                                           â”‚
â”‚  Layer 3: LLM å…¨å±€æŠ½å– (LLM Extraction)                  â”‚
â”‚    â””â”€ _llm_slot_extraction()                             â”‚
â”‚       è°ƒç”¨æ˜Ÿç«å¤§æ¨¡å‹è¿›è¡Œæ™ºèƒ½åˆ†æ                          â”‚
â”‚       å¤„ç†å¤æ‚è¯­å¢ƒå’Œæ¨¡ç³Šè¡¨è¾¾                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          4. çŸ¥è¯†ä¸é…ç½®å±‚ (knowledge/)                     â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ business_config_loader.py (ç»Ÿä¸€é…ç½®åŠ è½½å™¨)       â”‚    â”‚
â”‚  â”‚  - åŠ è½½ business_configs/*.json                 â”‚    â”‚
â”‚  â”‚  - æä¾›æ§½ä½è§„æ ¼ (SlotSpec)                      â”‚    â”‚
â”‚  â”‚  - æä¾›æšä¸¾é€‰é¡¹ (enums)                         â”‚    â”‚
â”‚  â”‚  - æä¾›è¿‡æ»¤è§„åˆ™ (filters)                       â”‚    â”‚
â”‚  â”‚  - æä¾›å‘½ä»¤å…³é”®è¯ (command_keywords)            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ product_knowledge.py (ä¸šåŠ¡çŸ¥è¯†åº“)                â”‚    â”‚
â”‚  â”‚  - æä¾›ä¸šåŠ¡è¯æœ¯æ¨¡æ¿ (templates)                 â”‚    â”‚
â”‚  â”‚  - æä¾›æ¬¢è¿è¯­ã€æç¤ºè¯­ç­‰æ–‡æ¡ˆ                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                           â”‚
â”‚  ä¸šåŠ¡é…ç½®æ–‡ä»¶:                                            â”‚
â”‚    - apple_store.json (è‹¹æœä¸“å–åº—)                        â”‚
â”‚    - dining.json (é¤é¥®é¢„è®¢)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            5. å¤–éƒ¨æœåŠ¡å±‚                                  â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ llm/spark_client.py (LLMå®¢æˆ·ç«¯)                  â”‚    â”‚
â”‚  â”‚  - æ˜Ÿç«å¤§æ¨¡å‹ API å°è£…                           â”‚    â”‚
â”‚  â”‚  - JSON æ ¼å¼ä¿¡æ¯æŠ½å–                             â”‚    â”‚
â”‚  â”‚  - æ„å›¾è¯†åˆ«ï¼ˆå·²åºŸå¼ƒï¼Œç°ç”¨æ§½ä½æŠ½å–ï¼‰             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ semantics/option_mapping.py (è¯­ä¹‰æ˜ å°„å™¨)         â”‚    â”‚
â”‚  â”‚  - OptionBuilder: æœ¬åœ°é€‰é¡¹æ„é€                    â”‚    â”‚
â”‚  â”‚  - SemanticMapper: è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å®Œæ•´è¿è½¬æµç¨‹ï¼ˆä»¥é¤é¥®é¢„è®¢ä¸ºä¾‹ï¼‰

### **é˜¶æ®µ 1ï¼šç³»ç»Ÿå¯åŠ¨**
```
main.py (ç”¨æˆ·äº¤äº’å±‚)
  â”œâ”€ åŠ è½½ä¸šåŠ¡é…ç½®åˆ—è¡¨
  â”œâ”€ ç”¨æˆ·é€‰æ‹©ä¸šåŠ¡çº¿ â†’ "dining" (é¤é¥®é¢„è®¢)
  â”œâ”€ åˆå§‹åŒ– FormBasedDialogSystem(business_line="dining")
  â”‚   â”œâ”€ ä» business_config_loader åŠ è½½æ§½ä½è§„æ ¼
  â”‚   â”œâ”€ åˆ›å»ºç©ºè¡¨å• (6ä¸ªæ§½ä½: category/brand/series/party_size/date/contact)
  â”‚   â””â”€ åŠ è½½ä¸šåŠ¡æ¨¡æ¿å’Œè¿‡æ»¤è§„åˆ™
  â”œâ”€ åˆå§‹åŒ– SparkLLMClient (LLMå®¢æˆ·ç«¯)
  â””â”€ æ˜¾ç¤ºæ¬¢è¿è¯­å’Œåˆå§‹æç¤º
```

### **é˜¶æ®µ 2ï¼šç”¨æˆ·è¾“å…¥å¤„ç†**
```
ç”¨æˆ·è¾“å…¥: "æ˜å¤©æ™šä¸Š4ä¸ªäººå»æµ·åº•æ"
    â†“
FormBasedDialogSystem.process_input()
    â†“
â”œâ”€ æ­¥éª¤1: æ£€æŸ¥ç‰¹æ®ŠçŠ¶æ€
â”‚   â”œâ”€ æ˜¯å¦åœ¨å†²çªè§£å†³ä¸­? â†’ å¦
â”‚   â”œâ”€ æ˜¯å¦åœ¨é‡é€‰ä¸­? â†’ å¦
â”‚   â””â”€ æ˜¯å¦ä¸ºçº¯æ•°å­—è¾“å…¥? â†’ å¦
â”‚
â”œâ”€ æ­¥éª¤2: å¤šæ§½ä½ä¿¡æ¯æŠ½å–
â”‚   â”‚
â”‚   â”œâ”€ Layer 1: ç›´æ¥å…³é”®è¯åŒ¹é…
â”‚   â”‚   â”œâ”€ "æµ·åº•æ" â†’ brand = "æµ·åº•æ" (ç½®ä¿¡åº¦ 1.0)
â”‚   â”‚   â”œâ”€ "æ™šä¸Š" â†’ series = "æ™šé¤æ—¶æ®µ" (ç½®ä¿¡åº¦ 1.0)
â”‚   â”‚   â”œâ”€ "4ä¸ªäºº" â†’ party_size = "4äºº" (ç½®ä¿¡åº¦ 1.0)
â”‚   â”‚   â””â”€ "æ˜å¤©" â†’ date = "æ˜å¤©" (ç½®ä¿¡åº¦ 1.0)
â”‚   â”‚
â”‚   â”œâ”€ Layer 2: è¯­ä¹‰æ˜ å°„ (è·³è¿‡ï¼Œå·²æœ‰ç›´æ¥åŒ¹é…)
â”‚   â”‚
â”‚   â””â”€ Layer 3: LLM å…¨å±€æŠ½å–
â”‚       â”œâ”€ è°ƒç”¨ SparkLLMClient.extract_slots()
â”‚       â”œâ”€ è¿”å› JSON: {"contact": {"value": "", ...}}
â”‚       â””â”€ æ— æ–°å¢ä¿¡æ¯ï¼ˆcontactä¸ºç©ºï¼‰
â”‚
â”œâ”€ æ­¥éª¤3: æ›´æ–°æ§½ä½çŠ¶æ€
â”‚   â”œâ”€ brand: EMPTY â†’ FILLED ("æµ·åº•æ")
â”‚   â”œâ”€ series: EMPTY â†’ FILLED ("æ™šé¤æ—¶æ®µ")
â”‚   â”œâ”€ party_size: EMPTY â†’ FILLED ("4äºº")
â”‚   â””â”€ date: EMPTY â†’ FILLED ("æ˜å¤©")
â”‚
â”œâ”€ æ­¥éª¤4: æ£€æµ‹å†²çª
â”‚   â””â”€ æ— å†²çª
â”‚
â”œâ”€ æ­¥éª¤5: æ£€æŸ¥è¡¨å•å®Œæ•´æ€§
â”‚   â”œâ”€ å·²å¡«å……: category, brand, series, party_size, date
â”‚   â””â”€ ç¼ºå¤±: contact (è”ç³»æ–¹å¼)
â”‚
â””â”€ æ­¥éª¤6: ç”Ÿæˆå“åº”
    â”œâ”€ æ˜¾ç¤ºå·²è®°å½•ä¿¡æ¯
    â”œâ”€ è¯¢é—®ä¸‹ä¸€ä¸ªç¼ºå¤±æ§½ä½: contact
    â””â”€ è¾“å‡ºæç¤º: "è¯·æä¾›æ‚¨çš„è”ç³»æ–¹å¼..."
```

### **é˜¶æ®µ 3ï¼šå¤„ç†çº¯æ•°å­—è¾“å…¥ï¼ˆè”ç³»æ–¹å¼ï¼‰**
```
ç”¨æˆ·è¾“å…¥: "13812345678"
    â†“
FormBasedDialogSystem.process_input()
    â†“
â”œâ”€ æ£€æµ‹åˆ°çº¯æ•°å­—è¾“å…¥ï¼Œè¿›å…¥æ•°å­—å¤„ç†é€»è¾‘
â”‚
â”œâ”€ åœºæ™¯åˆ¤æ–­:
â”‚   â”œâ”€ åœºæ™¯1: å†²çªè§£å†³? â†’ å¦
â”‚   â”œâ”€ åœºæ™¯2: é‡é€‰æ§½ä½? â†’ å¦
â”‚   â”œâ”€ åœºæ™¯3: ç¡®è®¤èœå•? â†’ å¦
â”‚   â””â”€ åœºæ™¯4: å½“å‰æ§½ä½å¡«å……
â”‚       â”œâ”€ ç›®æ ‡æ§½ä½: contact (last_prompted_slot)
â”‚       â”œâ”€ æ£€æŸ¥ enums_key: æ— ï¼ˆè‡ªç”±æ–‡æœ¬æ§½ä½ï¼‰
â”‚       â””â”€ ç›´æ¥æ¥å—è¾“å…¥ â†’ contact = "13812345678"
â”‚
â”œâ”€ æ›´æ–°æ§½ä½: contact: EMPTY â†’ FILLED
â”‚
â”œâ”€ æ£€æŸ¥è¡¨å•å®Œæ•´æ€§: âœ… æ‰€æœ‰å¿…å¡«æ§½ä½å·²å¡«å……
â”‚
â””â”€ ç”Ÿæˆå“åº”:
    â”œâ”€ æ˜¾ç¤ºè®¢å•æ‘˜è¦
    â”œâ”€ çŠ¶æ€åˆ‡æ¢: COLLECTING â†’ READY_CONFIRM
    â””â”€ æ˜¾ç¤ºç¡®è®¤é€‰é¡¹ (1.ç¡®è®¤ / 2.é‡é€‰ / 3.é‡æ–°å¼€å§‹)
```

### **é˜¶æ®µ 4ï¼šå†²çªå¤„ç†ï¼ˆç¤ºä¾‹ï¼‰**
```
å‡è®¾ç”¨æˆ·è¾“å…¥: "è¿˜æ˜¯åƒæµ·åº•æçš„åˆé¤å§"ï¼ˆåœ¨å·²é€‰å¤–å©†å®¶æ™šé¤åï¼‰
    â†“
ä¿¡æ¯æŠ½å–ç»“æœ:
  - brand: "æµ·åº•æ" (æ–°å€¼) vs "å¤–å©†å®¶" (æ—§å€¼) â†’ å†²çªï¼
  - series: "åˆé¤æ—¶æ®µ" (æ–°å€¼)
    â†“
å†²çªæ£€æµ‹è§¦å‘:
  â”œâ”€ æ£€æµ‹åˆ° brand å†²çª
  â”œâ”€ ç«‹å³ä¸­æ–­åç»­æ§½ä½æ›´æ–°ï¼ˆseries ä¸ä¼šè¢«æ›´æ–°ï¼‰
  â”œâ”€ è®¾ç½® awaiting_conflict_slot = "brand"
  â””â”€ æ˜¾ç¤ºå†²çªæç¤º: "1.ä¿ç•™å¤–å©†å®¶ / 2.ç”¨æµ·åº•æ / 3.é‡æ–°è¯´"
    â†“
ç”¨æˆ·é€‰æ‹©: "2" (ä½¿ç”¨æ–°å€¼)
    â†“
å†²çªè§£å†³:
  â”œâ”€ æ¸…ç©º brand åŠå…¶ä¾èµ–é“¾ (series, party_size, date, contact)
  â”œâ”€ å¡«å……æ–°å€¼: brand = "æµ·åº•æ"
  â”œâ”€ æ¸…é™¤å†²çªçŠ¶æ€
  â””â”€ æç¤ºç”¨æˆ·é‡æ–°å¡«å……: "è¯·é€‰æ‹©ç”¨é¤æ—¶æ®µ..."
```

### **é˜¶æ®µ 5ï¼šé‡é€‰åŠŸèƒ½**
```
ç”¨æˆ·åœ¨ç¡®è®¤é˜¶æ®µè¾“å…¥: "é‡é€‰"
    â†“
FormBasedDialogSystem.process_input()
    â†“
â”œâ”€ è¯†åˆ«ä¸ºé‡é€‰å‘½ä»¤ (ä» command_keywords é…ç½®åŠ è½½)
â”‚
â”œâ”€ ç”Ÿæˆé‡é€‰é€‰é¡¹åˆ—è¡¨:
â”‚   â”œâ”€ åˆ—å‡ºæ‰€æœ‰å·²å¡«å……æ§½ä½ (1.é¢„è®¢ç±»å‹ / 2.é¤å… / 3.æ—¶æ®µ ...)
â”‚   â””â”€ è®¾ç½® reselect_slot = "waiting"
â”‚
â””â”€ ç­‰å¾…ç”¨æˆ·é€‰æ‹©
    â†“
ç”¨æˆ·è¾“å…¥: "2" (é€‰æ‹©ä¿®æ”¹é¤å…)
    â†“
â”œâ”€ æ£€æµ‹åˆ° reselect_slot == "waiting"
â”œâ”€ ç¡®å®šç›®æ ‡æ§½ä½: brand (ç¬¬2ä¸ªæ§½ä½)
â”œâ”€ æ¸…ç©º brand åŠå…¶ä¾èµ–é“¾ (series, party_size, date, contact)
â”œâ”€ è®¾ç½® order_status = RESELECTING
â”œâ”€ è®¾ç½® last_prompted_slot = "brand"
â””â”€ æ˜¾ç¤ºé¤å…é€‰æ‹©æç¤º
    â†“
ç”¨æˆ·è¾“å…¥: "1" (é€‰æ‹©æµ·åº•æ)
    â†“
â”œâ”€ æ›´æ–° brand = "æµ·åº•æ"
â”œâ”€ çŠ¶æ€åˆ‡æ¢: RESELECTING â†’ READY_CONFIRM
â””â”€ è¿”å›ç¡®è®¤ç•Œé¢
```

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. **é…ç½®é©±åŠ¨æ¶æ„**
- **æ‰€æœ‰ä¸šåŠ¡é€»è¾‘é€šè¿‡ JSON é…ç½®æ–‡ä»¶å®šä¹‰**
- æ–°å¢ä¸šåŠ¡åœºæ™¯åªéœ€æ·»åŠ é…ç½®æ–‡ä»¶ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
- é…ç½®å†…å®¹ï¼šæ§½ä½å®šä¹‰ã€æšä¸¾é€‰é¡¹ã€è¿‡æ»¤è§„åˆ™ã€è¯æœ¯æ¨¡æ¿ã€å‘½ä»¤å…³é”®è¯

### 2. **ä¸‰å±‚ä¿¡æ¯æŠ½å–ç€‘å¸ƒ**
```
ç›´æ¥åŒ¹é… (é€Ÿåº¦æœ€å¿«ï¼Œå‡†ç¡®åº¦é«˜)
    â†“ æœªåŒ¹é…
è¯­ä¹‰æ˜ å°„ (æœ¬åœ°è®¡ç®—ï¼Œä¸­ç­‰é€Ÿåº¦)
    â†“ æœªåŒ¹é…
LLM æŠ½å– (æœ€æ™ºèƒ½ï¼Œä½†é€Ÿåº¦æ…¢)
```
**ä¼˜åŠ¿**ï¼šå‡å°‘ LLM è°ƒç”¨ï¼Œé™ä½æˆæœ¬ï¼Œæé«˜å“åº”é€Ÿåº¦

### 3. **çŠ¶æ€æœºç®¡ç†**
- **æ§½ä½çŠ¶æ€**: EMPTY â†’ PARTIAL â†’ FILLED / CONFLICTED
- **è®¢å•çŠ¶æ€**: COLLECTING â†’ READY_CONFIRM â†’ CONFIRMED
- **å†²çªçŠ¶æ€**: æ£€æµ‹å†²çª â†’ ç­‰å¾…ç”¨æˆ·å†³ç­– â†’ æ¸…ç©ºä¾èµ–é“¾ â†’ é‡æ–°å¡«å……

### 4. **æœ€å°é—­åŒ…æ¸…ç©ºç­–ç•¥**
- ä¿®æ”¹æŸä¸ªæ§½ä½æ—¶ï¼Œè‡ªåŠ¨æ¸…ç©ºå…¶æ‰€æœ‰ä¸‹æ¸¸ä¾èµ–æ§½ä½
- ä¾‹å¦‚ï¼šä¿®æ”¹ brand (é¤å…) â†’ æ¸…ç©º series, party_size, date, contact
- **é¿å…å¤æ‚çš„å¤šå€¼åŒæ­¥é—®é¢˜**ï¼Œä¿è¯ä¾èµ–é“¾ä¸€è‡´æ€§

### 5. **ä¼˜å…ˆçº§å†²çªå¤„ç†**
```
æ¥æºä¼˜å…ˆçº§: ç›´æ¥åŒ¹é… > æ•°å­—é€‰æ‹© > è¯­ä¹‰æ˜ å°„ > LLM
å†²çªè§¦å‘: é«˜ä¼˜å…ˆçº§æ–°å€¼ vs ç°æœ‰å€¼ â†’ æç¤ºç”¨æˆ·ç¡®è®¤
å†²çªè§£å†³: ç«‹å³ä¸­æ–­åç»­æ§½ä½æ›´æ–° â†’ ç”¨æˆ·å†³ç­– â†’ æ¸…ç©ºä¾èµ–é“¾
```

---

## ğŸ“Š æ•°æ®æµå›¾

```
                    ç”¨æˆ·è¾“å…¥
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   process_input()        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚              â”‚
Layer 1         Layer 2       Layer 3
ç›´æ¥åŒ¹é…       è¯­ä¹‰æ˜ å°„       LLMæŠ½å–
    â”‚              â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
            extracted_info
                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æ§½ä½æ›´æ–°å¾ªç¯            â”‚
        â”‚   â”œâ”€ æ£€æµ‹å†²çª?           â”‚
        â”‚   â”‚   â””â”€ Yes â†’ break     â”‚
        â”‚   â””â”€ æ›´æ–°æ§½ä½çŠ¶æ€        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
            â”‚             â”‚
        æœ‰å†²çª        æ— å†²çª
            â”‚             â”‚
       æ˜¾ç¤ºå†²çª      æ£€æŸ¥å®Œæ•´æ€§
       ç­‰å¾…å†³ç­–          â”‚
            â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
            â”‚      â”‚             â”‚
            â”‚   å®Œæ•´          ä¸å®Œæ•´
            â”‚      â”‚             â”‚
            â”‚   æ˜¾ç¤ºæ‘˜è¦     è¯¢é—®ä¸‹ä¸€é¡¹
            â”‚   ç­‰å¾…ç¡®è®¤         â”‚
            â”‚                    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                  ç”Ÿæˆå“åº”
                     â†“
                  è¿”å›ç”¨æˆ·
```

---

## ğŸ”‘ å…³é”®ç±»ä¸æ–¹æ³•

### **FormBasedDialogSystem æ ¸å¿ƒæ–¹æ³•**

```python
# === ä¸»æµç¨‹ ===
process_input(user_input, llm_client, semantic_mapper)
    â†’ å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œè¿”å›å“åº”

# === ä¿¡æ¯æŠ½å– ===
_extract_multiple_slots(user_input, llm_client, semantic_mapper)
    â†’ ä¸‰å±‚æŠ½å–ï¼Œè¿”å› Dict[slot_name, SlotValue]

_direct_keyword_extraction(user_input)
    â†’ Layer 1: ç›´æ¥å…³é”®è¯åŒ¹é…

_semantic_slot_extraction(user_input, slot_name, semantic_mapper)
    â†’ Layer 2: è¯­ä¹‰æ˜ å°„

_llm_slot_extraction(user_input, missing_slots, llm_client)
    â†’ Layer 3: LLM å…¨å±€æŠ½å–

# === çŠ¶æ€ç®¡ç† ===
_update_slot(slot_name, new_value)
    â†’ æ›´æ–°æ§½ä½ï¼Œæ£€æµ‹å†²çª

_resolve_conflict(slot_name, decision)
    â†’ è§£å†³å†²çªï¼Œæ¸…ç©ºä¾èµ–é“¾

_clear_slot_and_dependencies(slot_name)
    â†’ æ¸…ç©ºæ§½ä½åŠå…¶ä¸‹æ¸¸ä¾èµ–

# === å“åº”ç”Ÿæˆ ===
_generate_response(extraction_result)
    â†’ æ ¹æ®å½“å‰çŠ¶æ€ç”Ÿæˆç³»ç»Ÿå“åº”

_generate_slot_prompt(slot_name)
    â†’ ç”Ÿæˆç‰¹å®šæ§½ä½çš„è¯¢é—®æç¤º
```

---

## ğŸ“ ç›®å½•ç»“æ„æ˜ å°„

```
src/
â”œâ”€â”€ main.py                        # 1ï¸âƒ£ ç”¨æˆ·äº¤äº’å±‚å…¥å£
â”‚
â”œâ”€â”€ core/                          # 2ï¸âƒ£ æ ¸å¿ƒå¯¹è¯ç®¡ç†
â”‚   â”œâ”€â”€ form_based_system.py      # è¡¨å•å¯¹è¯ç³»ç»Ÿæ ¸å¿ƒï¼ˆ1220è¡Œï¼‰
â”‚   â”œâ”€â”€ interfaces.py              # æ¥å£å®šä¹‰ (ILLMClient, SlotSpecç­‰)
â”‚   â”œâ”€â”€ slot_validators.py         # æ§½ä½éªŒè¯å™¨
â”‚   â””â”€â”€ context.py                 # ä¸Šä¸‹æ–‡ç®¡ç†
â”‚
â”œâ”€â”€ knowledge/                     # 4ï¸âƒ£ çŸ¥è¯†ä¸é…ç½®å±‚
â”‚   â”œâ”€â”€ business_config_loader.py  # ç»Ÿä¸€é…ç½®åŠ è½½å™¨
â”‚   â”œâ”€â”€ product_knowledge.py       # ä¸šåŠ¡çŸ¥è¯†åº“ï¼ˆè¯æœ¯æ¨¡æ¿ï¼‰
â”‚   â””â”€â”€ business_configs/          # ä¸šåŠ¡é…ç½®æ–‡ä»¶
â”‚       â”œâ”€â”€ apple_store.json       # è‹¹æœä¸“å–åº—é…ç½®ï¼ˆ276è¡Œï¼‰
â”‚       â””â”€â”€ dining.json            # é¤é¥®é¢„è®¢é…ç½®ï¼ˆ211è¡Œï¼‰
â”‚
â”œâ”€â”€ llm/                           # 5ï¸âƒ£ å¤–éƒ¨æœåŠ¡å±‚
â”‚   â””â”€â”€ spark_client.py            # æ˜Ÿç« LLM å®¢æˆ·ç«¯
â”‚
â”œâ”€â”€ semantics/                     # 5ï¸âƒ£ è¯­ä¹‰å¤„ç†
â”‚   â””â”€â”€ option_mapping.py          # è¯­ä¹‰æ˜ å°„å™¨ã€é€‰é¡¹æ„é€ å™¨
â”‚
â””â”€â”€ config/                        # é…ç½®ç®¡ç†
    â””â”€â”€ settings.py                # å…¨å±€é…ç½®ï¼ˆAPIå¯†é’¥ç­‰ï¼‰
```

---

## ğŸ¨ ä¸šåŠ¡é…ç½®ç¤ºä¾‹

### **é¤é¥®é¢„è®¢é…ç½® (dining.json)**

```json
{
  "business_info": {
    "name": "dining",
    "display_name": "é¤é¥®é¢„è®¢",
    "description": "é¤å…é¢„è®¢æœåŠ¡"
  },
  
  "slot_specs": [
    {
      "name": "brand",
      "required": true,
      "description": "é¤å…é€‰æ‹©",
      "dependencies": ["category"],  // ä¾èµ– category
      "enums_key": "dining_brand",
      "allow_llm": false
    }
  ],
  
  "enums": {
    "dining_brand": [
      {
        "label": "æµ·åº•æ",
        "aliases": ["æµ·åº•æ", "ç«é”…", "hdl", "æµ·åº•æç«é”…"]
      }
    ]
  },
  
  "filters": {
    "series_by_brand": {
      "æµ·åº•æ": ["åˆé¤æ—¶æ®µ", "æ™šé¤æ—¶æ®µ", "ç‰¹è‰²å¥—é¤"]
    }
  },
  
  "command_keywords": {
    "confirm": ["ç¡®è®¤", "ç¡®è®¤é¢„è®¢", "æäº¤"],
    "reselect": ["é‡é€‰", "ä¿®æ”¹"],
    "restart": ["é‡æ–°å¼€å§‹", "å†æ¥ä¸€ä¸ª"]
  },
  
  "templates": {
    "form_welcome": [
      "ğŸ˜‹ æ‚¨å¥½ï¼æˆ‘æ˜¯é¤é¥®é¢„è®¢åŠ©æ‰‹å°ç¾...",
    ],
    "form_brand_prompt": [
      "æˆ‘ä»¬åˆä½œçš„ä¼˜è´¨é¤å…æœ‰ï¼š",
      "1. æµ·åº•æ Â· æ­£å®—ç«é”…ï¼ŒæœåŠ¡è´´å¿ƒ"
    ]
  }
}
```

---

## ğŸš€ ä¼˜åŠ¿æ€»ç»“

1. **é«˜æ‰©å±•æ€§**ï¼šæ–°å¢ä¸šåŠ¡åªéœ€æ·»åŠ  JSON é…ç½®
2. **é«˜æ€§èƒ½**ï¼šä¸‰å±‚æŠ½å–å‡å°‘ LLM è°ƒç”¨ï¼Œå“åº”æ›´å¿«
3. **é«˜å¯é æ€§**ï¼šå†²çªæ£€æµ‹ã€ä¾èµ–ç®¡ç†ä¿è¯æ•°æ®ä¸€è‡´æ€§
4. **é«˜ç”¨æˆ·ä½“éªŒ**ï¼šè‡ªç„¶è¯­è¨€è¾“å…¥ã€æ™ºèƒ½æç¤ºã€è‡ªç”±é‡é€‰
5. **æ˜“ç»´æŠ¤**ï¼šä»£ç é€»è¾‘æ¸…æ™°ï¼Œé…ç½®ä¸ä»£ç åˆ†ç¦»

---

## ğŸ“Œ æŠ€æœ¯äº®ç‚¹

âœ… **é…ç½®é©±åŠ¨æ¶æ„** - ä¸šåŠ¡é€»è¾‘é›¶ä»£ç æ‰©å±•  
âœ… **ä¸‰å±‚ä¿¡æ¯æŠ½å–** - æ€§èƒ½ä¸å‡†ç¡®åº¦å¹³è¡¡  
âœ… **æœ€å°é—­åŒ…æ¸…ç©º** - ä¼˜é›…çš„ä¾èµ–ç®¡ç†  
âœ… **çŠ¶æ€æœºç®¡ç†** - æ¸…æ™°çš„æµç¨‹æ§åˆ¶  
âœ… **å†²çªä¼˜å…ˆå¤„ç†** - é¿å…å¤šå€¼åŒæ­¥é—®é¢˜  
âœ… **è‡ªç”±æ–‡æœ¬æ”¯æŒ** - è”ç³»æ–¹å¼ç­‰æ— æšä¸¾æ§½ä½  
âœ… **åŠ¨æ€è¿‡æ»¤** - åŸºäºå·²é€‰é¡¹è¿‡æ»¤åç»­é€‰é¡¹  
âœ… **é‡é€‰åŠŸèƒ½** - æ”¯æŒä»»æ„æ§½ä½ä¿®æ”¹

---

*æœ€åæ›´æ–°: 2025-11-19*
