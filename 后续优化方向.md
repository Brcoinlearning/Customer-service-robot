# 项目后续优化与拓展建议（自动机化改造版）

本文在现有混合架构的基础上，给出“将 DSL 编译/解释为有守卫与评分的自动机”的系统化路线，统一状态推进的来源，降低解释器分叉逻辑，并强化可测性与可观测性。

**一、总体目标**
- 单一真相来源：由 DSL 推导状态与转移；解释器负责执行而非散落式 if/else。
- 稳定可控：数字优先、本地语义其次、LLM 兜底；低置信度不推进。
- 可观测可回放：每次决策输出 trace（候选、置信度、守卫检查、最终裁决）。
- 易扩展：新增规则=新增转移，无需修改解释器核心。

**二、从 DSL 构建规则图（RuleGraph）**
- 状态抽取：
   - 起点默认 `welcome`；凡 `CONTEXT_STAGE_IS "<stage>"` 与 `SET_STAGE "<stage>"` 中出现的均视作节点。
- 转移抽取：
   - 每条 RULE 生成一条边（from = WHEN 中的阶段条件；to = 首个 SET_STAGE；若无则保持原阶段）。
   - 条件拆分：上下文/阶段类条件→布尔守卫；文本类条件（USER_MENTION/ANY）→交由评分器。
   - 动作挂载：RESPOND/RESPOND_KB/SET_VAR/ADD_TO_CHAIN 等绑定在边上执行。

**三、输入规范化与评分裁决管线**
- Normalizing（规范化中间态）：
   - 清洗：标点、大小写、数字单位（如 TB/GB）标准化；别名与同义词展开。
   - 分桶：`numeric_choice` / `semantic_keyword` / `free_text` / `direct_shortcut` / `ambiguous`。
- Scoring（裁决）：
   1) 确定性数字：若为数字且在有效范围内 → 选择对应边，score=1.0。
   2) 本地语义：使用现有 OptionBuilder + SemanticMapper（子串/权重）对同源候选边打分；score∈[0,1]。
   3) LLM 回退：仅当前两级无高分候选时调用一次，产出候选边与置信度。
   - 裁决规则：同一源状态内选最高分且 ≥ 阈值（如 0.25/0.35）；并列用优先级或“更特异”规则打破平局。
   - 失败处理：无候选 ≥ 阈值 → 保持原状态，触发该状态的 fallback 文案。

**四、守卫与安全规则（Guards）**
- 结构化守卫：
   - high_confidence：语义评分≥阈值或命中白名单（mac/iphone）。
   - series_allows_1tb：系列不支持的选项（如标准 iPhone 16 的 1TB）直接否决候选。
   - size_allows_max：MacBook Pro 16寸不允许“第三个芯片”边，防误跳。
- 统一检测：守卫失败不推进，但给出原因提示（可选）。

**五、槽位（Slots）与终态就绪**
- 定义每条业务线的必备槽位：
   - 电脑：品牌/系列/尺寸/芯片/存储/颜色。
   - 订餐：人数/包间/日期/时间/联系方式。
- 终态前检查：缺少即重定向到第一个缺失槽位对应的状态（或让 DSL fallback 引导）。

**六、快捷直达白名单（最小集）**
- 仅保留极高置信度（无歧义）词：`mac`、`iphone`，在评分器中给予 score=1.0。
- 其他“快捷”一律通过语义评分与守卫裁决，不再在解释器硬编码。

**七、静态分析与优先级**
- check_dsl.py（最小静态分析）：
   - 检测不可达规则、重复/冲突关键词、未使用意图、无出口或自环异常等。
- 优先级策略：
   - 为 RULE/边提供可选 `priority` 字段；当分数接近或并列时优先高优先级边。

**八、可观测性（Trace & Metrics）**
- Trace JSON：`{ state_before, normalized_input, candidates: [{rule,score,guards}], chosen, state_after, latency, source_layer }`。
- 指标：匹配耗时/LLM 调用率/低置信度率/回退率/阶段停留时长等。

**九、测试与回归**
- 转移覆盖：每个状态至少 1 条正向样例 + 1 条守卫失败样例。
- 语义映射回归：芯片/存储/颜色/手机型号存储颜色全覆盖（含中文多字词子串）。
- 录制/回放：LLM 层使用 snapshot 固定，CI 离线跑通。

**十、迁移与落地步骤（建议）**
1) 规则图构建器：从当前 DSL 解析状态/转移/守卫/动作生成 IR（不改脚本）。
2) 决策裁决器：数字→本地语义→LLM 的评分流水线接入 IR，同源候选内裁决。
3) 槽位管理器：定义必备 slots + 重定向策略。
4) 移除解释器分散短路：将“mac/iphone”改为评分器白名单，其他全部走事件裁决。
5) Trace 与指标：输出到调试/日志，便于回放与定位。
6) check_dsl.py：跑一次静态检查，清理不可达/冲突项。
7) 覆盖测试集：新增 `tests/state_transitions/`，确保主流程与边界守卫稳定。

**十一、与现状的结合**
- 复用：现有 `OptionBuilder`、`SemanticMapper`、数值有效范围校验逻辑 → 作为评分器前两层。
- 差异：解释器不再硬编码阶段推进；保留极少白名单 → 通过“候选边 score=1.0”注入。
- 已解决的 1TB 误判用例：上升为通用 `series_allows_*` 守卫，覆盖所有类似约束。

**十二、可选的回退策略（若现状不稳定）**
- 若近期变更导致回归较多，可短期回退到上一稳定版本（Tag/Commit），然后按上述步骤逐步引入：
   1) 引入规则图 + 数字/本地语义裁决；
   2) 维护 slots 并对照现有 DSL 行为；
   3) 最后再接入 LLM 回退与 Trace。

---

## 7. 重要部分（沿用并细化）

后续应该一边测试程序的稳定性、上下文感知能力、纠错能力，然后尝试从“是否能根据某个规则而开发出完备的脚本？”的方向来优化源代码逻辑。

本次补充：
- “完备脚本”对应“完备自动机”：脚本→状态/转移/守卫/动作→评分裁决→可观测与回放。
- 通过最小静态分析确保脚本无不可达/冲突，提升规则质量；通过槽位收敛保证终态信息完备。
- 回归与指标闭环，使迭代在安全边界内持续推进。
