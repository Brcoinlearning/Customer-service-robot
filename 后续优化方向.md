# 项目后续优化与拓展建议

> 本文档用于记录在当前实现基础上，可以继续优化或扩展的方向，便于后续按优先级逐步完善。
>
> 约定：
> - **优先级**：P0（建议优先解决）> P1 > P2
> - **复杂度**：L（大）/ M（中）/ S（小）

---

## 1. DSL 与解析器（`DSLParser`）

### 1.1 统一 DSL 文法与代码实现（✅ 已完成）
- **现状**：
  - `DSL设计.md` 中的 BNF 与当前 `ecommerce.dsl` 实际语法不完全一致。
  - 解析器目前支持：`INTENT_IS`、`USER_MENTION`、`USER_MENTION_ANY`、`CONTEXT_EQ`、`CONTEXT_NOT_SET`、`CONTEXT_STAGE_IS` 等。
- **问题**：文档与实际实现不完全对齐，不利于后续维护和答辩说明。
- **建议**（P1 / M）：
  1. 在文档中补充当前实际支持的语法（以代码为准）。
  2. 或者在解析器中补齐文档中已有而未实现的语法，二者选其一保持一致。

### 1.2 条件系统扩展（含 `CONTEXT_HAS` / 复合条件）
- **现状**：
  - `tests/test_memory_features.py` 中的示例 DSL 使用了 `CONTEXT_HAS`，但解析器尚未实现该关键字。
  - 当前条件组合通过多次 `AND` 写在一行，解释器简单按“所有条件同时满足”处理，没有显示的 OR/NOT。
- **问题**：
  - 测试示例与真实语法不一致，容易造成困惑或潜在解析错误。
- **建议**：
  - **P0 / S**：
    - 选择其一：
      - 在 `_parse_when_condition` / `_match_rule` 中实现 `CONTEXT_HAS` 语义（如“变量存在且非 None”）；
      - 或者修改测试中的 DSL 示例，改用已经实现的 `CONTEXT_EQ` / `CONTEXT_NOT_SET` 表达同样逻辑。
  - **P2 / L（可选增强）**：
    - 设计简单的条件 AST，支持 `AND` / `OR` / `NOT` 组合，而不仅仅是“全部 AND”。

  - ✅【已完成（P0）】已在 DSLParser / DSLInterpreter 中实现 `CONTEXT_HAS` 条件语义，并更新测试用例使示例 DSL 与真实语法保持一致。

### 1.3 错误提示与调试友好性
- **现状**：
  - 解析错误会抛 `SyntaxError(Line X: ...)`，信息有限。
- **建议**（P2 / S-M）：
  - 在错误消息中加入更具体的原因（例如“INTENT 格式缺少冒号”“字符串未闭合”等）。
  - 在 `main.py` 中捕获 `SyntaxError`，输出更友好的提示，指明是 DSL 文件的哪一行写错。

---

## 2. 解释器与对话控制（`DSLInterpreter`）

### 2.1 规则优先级与冲突控制
- **现状**：
  - 规则按 `ecommerce.dsl` 中的顺序依次匹配，命中第一个就 `break`。
  - 全局重置、兜底规则依赖“写在前面”来保证优先级，顺序敏感。
- **建议**（P1 / M）：
  - 为规则引入可选优先级字段（例如通过注释或新语法声明 `priority`）。
  - 在解释器初始化时按优先级排序规则，再执行匹配逻辑，减少对书写顺序的依赖。

### 2.2 上下文兜底逻辑迁移到 DSL（✅ 已完成）
- **现状**：
  - `_get_context_aware_fallback` 中硬编码了阶段到提示语的映射（如 `category_select`、`subtype_select` 等）。
- **问题**：
  - 业务文案分散在 Python 与 DSL 中，不利于统一调整。
- **建议**（P2 / M）：
  - 用 DSL 定义“fallback 规则”，如 `RULE fallback_stage_category_select`，由解释器在无匹配时触发特定阶段对应的规则。
  - 这样提示语全部收敛在 DSL 中，便于统一修改和扩展。

### 2.3 动作执行的可扩展性（✅ 已完成）
- **现状**：
  - `_execute_actions` 使用较长的 `if-elif` 链处理不同 `type`（`respond`、`set_stage`、`add_to_chain` 等）。
- **建议**（P2 / S）：
  - 引入 `action_handlers` 映射：`{"respond": handler, "set_stage": handler, ...}`。
  - 每种动作用一个小函数实现，便于后续增加新动作（如调用知识库、外部服务、日志记录等）。

---

## 3. LLM 客户端与配置安全（`SparkLLMClient` & `Config`）

### 3.1 API Key 管理与安全
- **现状**：
  - `Config.LLM_API_KEY` 中包含真实样例 Key 的默认值。
- **问题**：
  - 不符合“API 密钥不应硬编码到仓库”的安全要求。
- **建议**（P0 / S）：
  - 移除默认真实 Key，只从环境变量 `SPARK_API_KEY` 读取；若未设置则在启动时给出清晰错误。
  - 文档中说明如何在本地设置环境变量来运行项目。

### 3.2 LLM 调用的健壮性与 Mock 模式
- **现状**：
  - 正常情况下直接调用 HTTP 接口，异常时退回到关键词匹配 `_fallback_intent_detection`。
  - 单元测试时如果真实调用 API，会受网络与配额影响。
- **建议**：
  - **P1 / M**：
    - 在 `_call_api` 中加入超时与重试机制，并在日志中输出简要的错误原因（不泄露敏感信息）。
  - **P1 / M**（较推荐）：
    - 引入“Mock 模式”开关（通过配置或环境变量控制），在该模式下：
      - `detect_intent` 不真正发 HTTP 请求，而是走简化规则（如关键词匹配或固定映射）；
      - 这样可以在单元测试中稳定测试 `DSLInterpreter` 的行为，而不依赖外部服务。

---

## 4. 上下文记忆与产品知识库集成

### 4.1 上下文参与 LLM 提示词
- **现状**：
  - `EnhancedConversationContext` 记录了丰富信息（`current_stage`、`product_chain`、用户偏好、对话历史等），但 `SparkLLMClient` 调用时只使用了当前一句 `user_input`。
- **建议**（P2 / M）：
  - 在构造 prompt 时适度加入：
    - 当前阶段（stage）；
    - 当前已选类别/品牌/系列；
    - 最近几条对话摘要。
  - 让 LLM 更清楚“现在处于哪个步骤”，提高意图识别准确率。

### 4.2 用 DSL 动作驱动产品知识库（`ProductKnowledge`）
- **现状**：
  - `ProductKnowledge` 中已经维护了品类/品牌/系列/场景，但 DSL 文案（推荐列表等）多为硬编码字符串。
- **建议**（P1 / L）：
  - 设计新的 DSL 动作，例如：
    - `SUGGEST_BRANDS "电脑"`
    - `SUGGEST_SERIES "电脑" "苹果"`
  - 在解释器中为这些动作调用 `ProductKnowledge` 动态生成响应，让 DSL 更偏“结构化逻辑”，减少复制粘贴文案的不一致风险。

### 4.3 真·购物车模型
- **现状**：
  - 购物车阶段的展示基于 `product_chain` 单条链路，本质上只能表达“当前这一个配置”，不是真正意义上的“多个商品”。
- **建议**（P2 / M-L）：
  - 在上下文中新增 `cart_items` 列表，每次加入购物车时将当前 `product_chain` 的快照追加进去。
  - `view_cart_rule` / `clear_cart_rule` / `checkout_rule` 改为操作 `cart_items`，支持多商品加入、查看、清空等更真实的电商场景。

---

## 5. 测试与工程化

### 5.1 覆盖真实 DSL 与解释器行为
- **现状**：
  - `test_parser.py` 只覆盖了非常简单的 DSL 片段。
  - `test_memory_features.py` 更偏示例/打印，并部分使用与解析器不完全匹配的语法。
- **建议**：
  - **P1 / M**：
    - ✅【已部分完成】当前已通过 `tests/test_memory_features.py` 中多条用例直接解析 `src/scripts/ecommerce.dsl` 并验证 `DSLInterpreter` 的行为，后续可继续补充更多场景测试。

    - 新增测试用例：直接解析 `src/scripts/ecommerce.dsl`，确保无语法错误且规则数量符合预期。
    - 新增若干针对 `DSLInterpreter` 的行为测试：构造少量规则 + 上下文，断言返回的 `responses` 与预期相符。

### 5.2 导入路径与项目结构
- **现状**：
  - 部分脚本（如 `tests/test_parser.py`、`src/main.py`）通过修改 `sys.path` 的方式导入模块。
- **建议**（P2 / M）：
  - 使用更规范的方式运行测试与主程序，例如：
    - 通过 `PYTHONPATH=src` 或在 `pytest` 配置中声明源目录；
    - 或将 `src` 组织为安装包，在开发环境中以可编辑模式安装。
  - 这样可以减少不同环境下导入问题，也更贴近真实项目工程实践。

---

## 6. 建议的落地顺序（可选参考）

1. **P0**：
   - 修正 `CONTEXT_HAS` 与实际解析能力不一致的问题（实现或调整测试二选一）。
   - 移除真实 API Key 默认值，改为强制从环境变量读取。
2. **P1**：
   - 增加 LLM Mock 模式，完善针对 `ecommerce.dsl` 的解析与解释器行为测试。
   - 梳理并统一 DSL 文法与实际实现，更新文档说明。
3. **P2**：
   - 扩展条件系统（OR/NOT）、规则优先级、上下文参与 LLM 提示词。
   - 引入基于 `ProductKnowledge` 的动态推荐动作，以及多商品购物车模型。

> 后续可以在每条建议下面补充：
> - 具体实现方案
> - 已完成/进行中的标记
> - 关联的 commit 或测试用例

