### 1. 测试执行入口 (Test Runners)

这些脚本是您运行测试的“操作台”，负责调度和启动测试。

* **`tests/run_all_tests.py`**
  * **作用** ： **主测试入口脚本** 。用于一键运行所有或指定的测试套件。
  * **实现思路** ：
  * 使用 **`argparse` 解析命令行参数（如** **`--verbose`,** **`--suite`）。
  * 初始化** **`TestDriver` 实例。
  * 导入并注册所有** **`tests/test_suites/` 下的测试套件（核心、业务场景、异常处理等）。
  * 调用** **`driver.run_all_tests()` 执行测试并返回退出码（CI/CD 友好）。
* **`tests/run_coverage.py`**
  * **作用** ： **覆盖率测试入口** 。在运行测试的同时统计代码覆盖率。
  * **实现思路** ：
  * 封装了 `coverage` 库。
  * 设置覆盖率统计范围（`source=['src']`），排除测试代码本身。
  * 执行测试后，生成多种格式的报告（HTML, XML, JSON）。
  * 支持设置覆盖率阈值（如 80%），如果低于阈值则报错，用于质量门禁。
* **`tests/validate_test_code.py`**
  * **作用** ： **测试代码自检工具** 。用于验证测试代码本身的语法和配置文件的格式。
  * **实现思路** ：
  * 检查 Python 测试文件的语法错误（SyntaxError）。
  * 验证 JSON 配置文件（如** **`test_cases.json`）的格式合法性。
  * 检查测试脚本的 CLI 接口是否正常响应** **`--help`。

### 2. 专项测试脚本 (Specialized Tests)

针对特定非功能需求的测试脚本。

* **`tests/test_performance.py`**
  * **作用** ： **性能与压力测试** 。
  * **实现思路** ：
  * **DSL解析性能** ：生成不同规模的 DSL 文本，测量解析耗时。
  * **意图识别性能** ：测量意图识别模块的响应时间。
  * **并发测试** ：使用** **`ThreadPoolExecutor` 模拟多用户并发访问，计算吞吐量 (TPS) 和响应延迟。
* **`tests/test_security.py`**
  * **作用** ： **安全与漏洞扫描** 。
  * **实现思路** ：
  * **注入攻击** ：构造 SQL 注入、XSS 脚本等恶意字符串，测试系统是否能正确处理或拦截。
  * **敏感信息泄露** ：检查系统输出或日志中是否包含手机号、身份证等敏感信息的明文。
  * **配置安全** ：扫描配置文件，检查是否有硬编码的密钥或密码。
* **`tests/test_ci_integration.py`**
  * **作用** ： **CI/CD 集成测试** 。
  * **实现思路** ：
  * 模拟不同环境（Test/Staging/Prod）的配置。
  * 根据环境加载不同的测试策略（如超时时间、重试次数）。
  * 生成标准的 JUnit XML 报告，以便 Jenkins/GitHub Actions 等工具解析。

### 3. 核心功能单元测试 (Unit/Functional Tests)

针对具体功能模块的细粒度测试。

* **`tests/test_form_system.py`**
  * **作用** ：测试**表单系统核心逻辑** (`FormBasedDialogSystem`)。
  * **实现思路** ：模拟用户输入，验证槽位填充、多槽位同时抽取、冲突解决流程、订单确认状态流转等核心状态机的行为。
* **`tests/test_enum_matching.py`**
  * **作用** ：测试 **枚举匹配逻辑** 。
  * **实现思路** ：验证纯数字选择、唯一文本匹配、模糊匹配等机制是否能正确映射到对应的枚举值。
* **`tests/test_size_enum.py`**
  * **作用** ：针对**尺寸槽位**的专项测试。
  * **实现思路** ：测试尺寸（如 "14寸", "16英寸"）的数字选择和文本匹配准确性。
* **`tests/test_command_semantics.py`**
  * **作用** ：测试 **通用命令** 。
  * **实现思路** ：验证 "restart"（重新开始）、"reselect"（重选）、"confirm"（确认）等命令在不同对话状态下的行为。
* **`tests/test_dining_intent.py`** &** ****`test_intent_recommendation_config.py`**
  * **作用** ：测试 **意图推荐功能** 。
  * **实现思路** ：验证输入模糊需求（如“吃火锅”、“视频剪辑”）时，系统能否根据配置推荐正确的槽位值（如“海底捞”、“M3 Pro”）。
* **`tests/test_spark_api.py`**
  * **作用** ： **真实 API 连接测试** 。
  * **实现思路** ：直接调用讯飞星火 API 接口，验证网络连接和鉴权是否正常（这是唯一会真的发网络请求的测试）。
* **`tests/test_stubs_verification.py`**
  * **作用** ：验证**测试桩 (Stubs)** 本身的功能。
  * **实现思路** ：确保 Mock 对象（如** **`MockLLMClient`）能按预期工作，正确模拟正常和异常场景，保证测试工具本身的可靠性。

### 4. 测试基础设施 (Drivers & Utils)

构建测试框架的底层代码。

* **`tests/drivers/test_driver.py`**
  * **作用** ： **测试驱动核心类** 。
  * **实现思路** ：
  * 定义** **`TestDriver` 类，负责注册和管理** **`TestSuite`。
  * 实现测试执行循环，捕获断言异常。
  * 统计测试结果（通过/失败/错误）。
  * 生成 HTML/JSON 测试报告。
* **`tests/test_utils.py`**
  * **作用** ： **通用测试工具库** 。
  * **实现思路** ：提供配置管理 (`ConfigManager`)、测试自动发现 (`TestDiscovery`)、性能监控 (`PerformanceMonitor`) 和报告格式化工具。
* **`tests/test_config.py`**
  * **作用** ：测试配置的管理器。
  * **实现思路** ：负责加载** **`tests/test_data/` 下的配置文件和测试用例数据，提供给各个测试脚本使用。

### 5. 测试桩 (Stubs / Mocks)

位于** **`tests/stubs/` 目录，用于模拟外部依赖，隔离测试环境。

* **`tests/stubs/mock_llm_client.py`**
  * **作用** ： **模拟 LLM 客户端** 。
  * **实现思路** ：不调用真实 API，而是通过关键词匹配（如输入包含 "电脑" 返回** **`category=computer`）来模拟 LLM 的槽位抽取和意图识别，确保测试快速且零成本。
* **`tests/stubs/mock_config_loaders.py`**
  * **作用** ： **模拟配置加载器** 。
  * **实现思路** ：模拟配置文件的读取过程，支持注入故障（如模拟 "文件不存在"、"JSON 格式错误"），用于测试系统的异常处理能力。
* **`tests/stubs/mock_semantic_mapper.py`**
  * **作用** ： **模拟语义映射器** 。
  * **实现思路** ：模拟语义匹配过程，支持设置固定的匹配结果或置信度，用于测试语义理解模块的边界情况。

### 6. 集成测试套件 (Test Suites)

位于** **`tests/test_suites/` 目录，将分散的测试用例组织成逻辑组。

* **`test_core_system.py`** : 核心系统功能的集成测试。
* **`test_business_scenarios.py`** : 完整的端到端业务流程测试（如完整的购物流程）。
* **`test_exception_handling.py`** : 专门测试各种异常情况（断网、配置错误、非法输入）。
* **`test_intent_recommendation.py`** : 意图推荐功能的集成测试。
* **`test_llm_integration.py`** : LLM 集成逻辑的测试（使用 Mock）。
* **`test_config_loader.py`** : 配置加载逻辑的测试。

### 7. 测试数据 (Test Data)

位于** **`tests/test_data/` 目录，存放测试所需的静态数据。

* **`test_cases.json` /** **`extended_test_cases.json`** : 定义了具体的测试输入和预期输出。
* **`ci_config.json`** : CI 环境的配置文件。
* **`test_config.ini`** : 测试运行时的配置文件（如超时时间、覆盖率阈值）。

### 8.测试命令

#### 1.1 基础功能测试（最常用）

运行所有单元测试和集成测试，验证系统核心逻辑：

**Bash**

```
python tests/run_all_tests.py
```

**可选参数：**

* `--verbose`：显示详细的测试执行日志。
* `--output=reports/`：指定测试报告的输出目录。
* `--suite=core_system`：仅运行指定的测试套件（如** **`core_system`,** **`business_scenarios`）。

#### 1.2 代码覆盖率测试

检查测试用例对源代码的覆盖程度，生成详细报告：

**Bash**

```
python tests/run_coverage.py
```

* **输出** ：执行后会在** **`coverage_reports/html/` 目录下生成** **`index.html`，可用浏览器打开查看每一行代码的覆盖情况。

#### 1.3 性能压力测试

模拟多用户并发访问，评估系统响应速度和吞吐量：

**Bash**

```
# 模拟 10 个并发用户，每人发送 20 个请求
python tests/test_performance.py --iterations 100 --concurrent-users 10
```

##### 1.4 安全性测试

检测系统是否存在注入攻击漏洞或敏感信息泄露风险：

**Bash**

```
python tests/test_security.py --include-injection-tests
```

---

#### 2. 测试内容详解

本项目测试体系分为以下几个核心维度，旨在确保系统的功能正确性、健壮性和安全性：

| **测试维度**     | **测试内容描述**                                                                           |
| ---------------------- | ------------------------------------------------------------------------------------------------ |
| **核心功能测试** | 验证表单系统 (`FormBasedDialogSystem`) 的状态流转、槽位填充、依赖管理及冲突检测机制。          |
| **业务场景测试** | 模拟真实用户的完整对话路径（End-to-End），覆盖“苹果专卖店购物”和“餐饮预订”两个完整业务闭环。 |
| **意图推荐测试** | 验证系统能否基于用户模糊输入（如“我要剪辑视频”）智能推荐相关配置（如“M3 Pro 芯片”）。        |
| **异常处理测试** | 验证系统在配置文件丢失、网络异常、超长输入、乱码输入等极端情况下的容错能力和降级策略。           |
| **LLM 集成测试** | 验证系统与大模型接口的交互逻辑，使用 Mock 对象模拟 LLM 返回，确保测试稳定且不消耗 API 额度。     |
| **配置加载测试** | 验证 YAML 流程定义文件 (`.flow.yaml`) 和 JSON 业务配置文件 (`.json`) 的解析与校验逻辑。      |
