# 客服系统输入验证测试文档

## 测试目标
验证客服系统在各个选择阶段的输入验证功能，确保：
1. 非法输入不触发状态转移
2. 提供准确的错误提示和用户引导
3. 保持对话流程的稳定性

## 验证系统覆盖范围

### 电商脚本阶段验证

#### 电脑产品流程
| 阶段 | 有效范围 | 测试无效输入 | 预期行为 |
|------|----------|-------------|----------|
| `series_select` | 1-5 | 6, 0, -1 | 显示"请输入 1 到 5" + 重新显示系列选择 |
| `config_select` | 1-2 | 3, 0 | 显示"请输入 1 或 2" + 重新显示配置选择 |
| `storage_select` | 1-3 | 4, 0 | 显示"请输入 1 到 3" + 重新显示存储选择 |
| `color_select` | 1-4 | 5, 0 | 显示"请输入 1 到 4" + 重新显示颜色选择 |
| `chip_select` | 1-3 | 4, 0 | 显示"请输入 1 到 3" + 重新显示芯片选择 |
| `subtype_select` | 1-2 | 3, 0 | 显示"请输入 1 或 2" + 重新显示子类型选择 |
| `size_select` | 1-2 | 3, 0 | 显示"请输入 1 或 2" + 重新显示尺寸选择 |
| `brand_select` | 1-5 | 6, 0 | 显示"请输入 1 到 5" + 重新显示品牌选择 |

#### 手机产品流程
| 阶段 | 有效范围 | 测试无效输入 | 预期行为 |
|------|----------|-------------|----------|
| `phone_model_select` | 1-3 | 4, 0 | 显示"请输入 1 到 3" + 重新显示型号选择 |
| `phone_storage_select` | 1-4 | 5, 0 | 显示"请输入 1 到 4" + 重新显示存储选择 |
| `phone_color_select` | 1-4 | 5, 0 | 显示"请输入 1 到 4" + 重新显示颜色选择 |

### 餐饮脚本阶段验证

#### 数字选择阶段
| 阶段 | 有效范围 | 测试无效输入 | 预期行为 |
|------|----------|-------------|----------|
| `brand_select` | 1-5 | 6, 0 | 显示"请输入 1 到 5" + 重新显示品牌选择 |
| `series_select` | 1-3 | 4, 0 | 显示"请输入 1 到 3" + 重新显示系列选择 |
| `date_collect` | 1-3 | 4, 0 | 显示"请输入 1 到 3" + 重新显示日期选择 |
| `final_confirm` | 1-2 | 3, 0 | 显示"请输入 1 或 2" + 重新显示确认选择 |

#### 自由文本输入阶段（无需验证）
- `details_collect`: 人数、包间偏好等自由输入
- `budget_collect`: 预算范围自由输入
- `contact_collect`: 联系方式自由输入

## 测试用例

### 测试用例 1：电脑配置选择流程
```
步骤：
1. 用户: "你好"
2. 用户: "Mac"  
3. 用户: "air"
4. 用户: "3" (无效输入)
   预期：❌ 无效的选项，请输入 1 或 2 + 重新显示配置
5. 用户: "1" (有效输入)
   预期：进入存储选择阶段
6. 用户: "4" (无效输入)
   预期：❌ 无效的选项，请输入 1 到 3 + 重新显示存储
7. 用户: "2" (有效输入)
   预期：进入颜色选择阶段
```

### 测试用例 2：产品切换流程
```
步骤：
1. 在任意电脑配置阶段
2. 用户: "还是买手机吧"
   预期：重置上下文 + 进入手机选择流程
3. 用户: "6" (无效输入)
   预期：❌ 无效的选项，请输入 1 到 5 + 显示手机系列
```

### 测试用例 3：手机选择流程
```
步骤：
1. 进入手机型号选择
2. 用户: "4" (无效输入)
   预期：❌ 无效的选项，请输入 1 到 3 + 重新显示型号
3. 用户: "1" (有效输入)
   预期：进入存储选择
4. 用户: "5" (无效输入) 
   预期：❌ 无效的选项，请输入 1 到 4 + 重新显示存储
```

## 验证系统技术实现

### 核心验证逻辑
```python
# 验证阶段列表（仅数字选择阶段）
numeric_choice_stages = [
    # 电商产品选择阶段
    "config_select", "storage_select", "color_select", "chip_select", 
    "series_select", "phone_model_select", "phone_storage_select", 
    "phone_color_select", "size_select", "subtype_select", "brand_select",
    # 餐饮数字选择阶段  
    "date_collect", "final_confirm"
]

# 验证流程
1. 检查当前阶段是否需要数字验证
2. 验证输入是否为数字且在有效范围内
3. 有效输入：继续DSL规则处理
4. 无效输入：返回错误提示 + 重新显示选项，不改变状态
```

### 有效范围配置
```python
def _get_valid_range_for_stage(stage):
    ranges = {
        "config_select": [1, 2],
        "storage_select": [1, 2, 3], 
        "color_select": [1, 2, 3, 4],
        "chip_select": [1, 2, 3],
        "series_select": [1, 2, 3, 4, 5],
        "phone_model_select": [1, 2, 3],
        "phone_storage_select": [1, 2, 3, 4],
        "phone_color_select": [1, 2, 3, 4],
        # ... 其他阶段
    }
    return ranges.get(stage, [1, 2])  # 默认范围
```

## 错误提示模板

### 通用错误提示格式
```
❌ 无效的选项，请输入 {有效范围}
💡 提示：直接输入数字即可选择
{重新显示当前阶段选项}
```

### 范围格式化规则
- 2个选项：`1 或 2`
- 3+个选项：`1 到 N`
- 1个选项：`1`

## 测试检查清单

### 基本功能测试
- [ ] 每个阶段的边界值测试（最小值-1，最大值+1）
- [ ] 零和负数输入测试
- [ ] 非数字输入测试（让DSL规则处理）
- [ ] 空输入测试

### 状态管理测试  
- [ ] 无效输入后状态不变
- [ ] 有效输入后状态正常转移
- [ ] 产品切换后状态正确重置

### 用户体验测试
- [ ] 错误提示清晰准确
- [ ] 选项重新显示完整
- [ ] 引导信息有帮助

### 脚本兼容性测试
- [ ] 电商脚本所有阶段覆盖
- [ ] 餐饮脚本数字选择阶段覆盖
- [ ] 自由文本输入不受影响

## 回归测试

### 定期验证项目
1. **核心流程完整性**：从开始到完成的完整产品选择流程
2. **错误恢复能力**：连续多次无效输入后的系统稳定性
3. **跨脚本功能**：两个DSL脚本的验证一致性
4. **边界条件**：极端输入值的处理

### 性能考虑
- 验证逻辑应该快速执行，不影响响应时间
- 错误提示生成不应该导致异常或崩溃
- 状态重新显示应该使用缓存避免重复计算

## 未来扩展

### 可扩展性设计
- 新增阶段只需在配置中添加有效范围
- 错误提示模板可统一管理和国际化
- 验证逻辑与具体业务逻辑解耦

### 可能的增强功能
- 智能输入建议（如输入7时提示"您是想输入1-5中的某个数字吗？"）
- 上下文相关的错误提示（根据产品类型定制提示内容）
- 输入历史记录（记录用户常见错误输入模式）