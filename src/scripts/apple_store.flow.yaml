# apple_store.flow.yaml
# è‹¹æœå•†åº—æ™ºèƒ½è¡¨å•æµç¨‹å®šä¹‰
# è¿™æ˜¯ä¸€ä¸ªåŸºäºYAMLçš„å£°æ˜å¼DSLè„šæœ¬ï¼Œå®šä¹‰äº†è´­ç‰©æµç¨‹çš„æ‰€æœ‰é…ç½®
# ä½œè€…: èƒ¡è€å¸ˆå›¢é˜Ÿ
# æ—¥æœŸ: 2024-11-19

flow:
  name: apple_shopping
  version: "1.0"
  description: "è‹¹æœäº§å“æ™ºèƒ½è´­ç‰©æµç¨‹"
  business_line: apple_store
  
  # ==================== æµç¨‹é…ç½® ====================
  
  # æ§½ä½å¡«å……é¡ºåº
  process_order:
    - category
    - brand
    - series
    - size
    - chip
    - storage
    - color

  # ==================== æ§½ä½å®šä¹‰ ====================
  
  slots:
    category:
      label: "äº§å“å¤§ç±»"
      description: "é€‰æ‹©äº§å“ç±»å‹"
      required: true
      allow_llm: false
      type: enum
      enums_key: category  # ä»JSONåŠ è½½æšä¸¾å€¼
      dependencies: []
      prompt_template: form_category_prompt  # å¼•ç”¨JSONæ¨¡æ¿
      help: "æˆ‘ä»¬æœ‰Macç”µè„‘ã€iPhoneæ‰‹æœºå’ŒiPadå¹³æ¿ä¸‰å¤§ç±»äº§å“"
      
    brand:
      label: "å“ç‰Œé€‰æ‹©"
      description: "å“ç‰Œé€‰æ‹©"
      required: true
      allow_llm: false
      type: enum
      enums_key: brand
      dependencies: [category]
      prompt_template: form_brand_prompt
      auto_fill: true  # å•é€‰é¡¹è‡ªåŠ¨å¡«å……
      
    series:
      label: "äº§å“ç³»åˆ—"
      description: "é€‰æ‹©å…·ä½“äº§å“ç³»åˆ—"
      required: true
      allow_llm: true
      type: enum
      enums_key: series
      semantic_stage: series_selection  # è¯­ä¹‰é˜¶æ®µæ ‡è®°
      dependencies: [category,brand]
      prompt_template: form_series_prompt  # åŸºç¡€æ¨¡æ¿
      # æ”¯æŒæ¡ä»¶æ¨¡æ¿è¦†ç›–
      conditional_prompts:
        - condition: "category == 'ç”µè„‘'"
          template: form_series_prompt_computer
        - condition: "category == 'æ‰‹æœº'"
          template: form_series_prompt_phone
      help: "æ ¹æ®æ‚¨é€‰æ‹©çš„ç±»åˆ«ï¼Œä¸ºæ‚¨æ¨èåˆé€‚çš„ç³»åˆ—"
      
    size:
      label: "å°ºå¯¸è§„æ ¼"
      description: "é€‰æ‹©å±å¹•å°ºå¯¸æˆ–è®¾å¤‡å°ºå¯¸"
      required: true
      allow_llm: true
      type: enum
      enums_key: size
      dependencies: [series]
      prompt_template: form_size_prompt
      help: "ä¸åŒå°ºå¯¸é€‚åˆä¸åŒä½¿ç”¨åœºæ™¯"
        
    chip:
      label: "å¤„ç†å™¨èŠ¯ç‰‡"
      description: "é€‰æ‹©å¤„ç†å™¨å‹å·"
      required: true
      allow_llm: true
      type: enum
      enums_key: chip
      semantic_stage: chip_selection
      dependencies: [category, series, size]
      prompt_template: form_chip_prompt
      validation:
        must_be_valid_enum: true
        min_confidence: 0.35
        
    storage:
      label: "å­˜å‚¨å®¹é‡"
      description: "é€‰æ‹©å­˜å‚¨ç©ºé—´å¤§å°"
      required: true
      allow_llm: true
      type: enum
      enums_key: storage
      dependencies: [category, chip]
      prompt_template: form_storage_prompt
      validation:
        must_be_valid_enum: true
        min_confidence: 0.35
    
    color:
      label: "é¢œè‰²"
      description: "é€‰æ‹©è®¾å¤‡é¢œè‰²"
      required: true
      allow_llm: true
      type: enum
      enums_key: color
      dependencies: []
      prompt_template: form_color_prompt
      validation:
        must_be_valid_enum: true
        min_confidence: 0.35

  # ==================== äº‹ä»¶å¤„ç† ====================
      help: "é€‰ä¸€ä¸ªæ‚¨å–œæ¬¢çš„é¢œè‰²"
      validation:
        must_be_valid_enum: true
        min_confidence: 0.35

  # ==================== äº‹ä»¶å¤„ç† ====================
  
  events:
    # æµç¨‹å¼€å§‹æ—¶
    on_start:
      - action: reset_form
        description: "é‡ç½®è¡¨å•çŠ¶æ€"
      - action: auto_fill_single_options
        description: "è‡ªåŠ¨å¡«å……å•é€‰é¡¹æ§½ä½"
      - action: show_template
        template: form_welcome
        description: "æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯"
    
    # æ‰€æœ‰å¿…å¡«æ§½ä½å¡«å……å®Œæˆæ—¶
    on_all_filled:
      - action: show_summary
        description: "æ˜¾ç¤ºè®¢å•æ‘˜è¦"
      - action: show_template
        template: form_confirmation_options
        description: "æ˜¾ç¤ºç¡®è®¤é€‰é¡¹"
    
    # ç”¨æˆ·ç¡®è®¤è®¢å•æ—¶
    on_confirm:
      - action: validate_form
        description: "éªŒè¯è¡¨å•æ•°æ®"
      - action: submit_order
        description: "æäº¤è®¢å•"
      - action: show_template
        template: form_order_confirmed
        description: "æ˜¾ç¤ºç¡®è®¤æˆåŠŸ"
      - action: show_template
        template: form_order_thanks
        description: "æ„Ÿè°¢è´­ä¹°"
      - action: ask_continue
        description: "è¯¢é—®æ˜¯å¦ç»§ç»­è´­ç‰©"
    
    # é‡æ–°å¼€å§‹æ—¶
    on_restart:
      - action: reset_form
        description: "é‡ç½®è¡¨å•"
      - action: show_template
        template: form_welcome
        description: "æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯"

  # ==================== ç”¨æˆ·å‘½ä»¤æ˜ å°„ ====================
  
  commands:
    # é‡é€‰å‘½ä»¤
    reselect:
      keywords: ["é‡é€‰", "ä¿®æ”¹", "change", "é‡æ–°é€‰æ‹©"]
      description: "é‡æ–°é€‰æ‹©æŸä¸ªæ§½ä½çš„å€¼"
      action: enter_reselect_mode
      available_when: any_slot_filled
      
    # é‡æ–°å¼€å§‹å‘½ä»¤
    restart:
      keywords: ["é‡æ–°å¼€å§‹", "é‡ç½®", "reset", "å†æ¥ä¸€æ¬¡"]
      description: "æ¸…ç©ºæ‰€æœ‰é€‰æ‹©ï¼Œé‡æ–°å¼€å§‹"
      action: restart_flow
      available_when: always
      
    # ç¡®è®¤è®¢å•å‘½ä»¤
    confirm:
      keywords: ["ç¡®è®¤", "ä¸‹å•", "ok", "yes", "å¥½çš„", "1"]
      description: "ç¡®è®¤å½“å‰è®¢å•"
      condition: all_slots_filled
      action: confirm_order
      
    # æŸ¥çœ‹è®¢å•å‘½ä»¤
    show_order:
      keywords: ["çœ‹çœ‹", "æŸ¥çœ‹", "show", "è®¢å•"]
      description: "æŸ¥çœ‹å½“å‰è®¢å•æ‘˜è¦"
      condition: any_slot_filled
      action: show_summary
      
    # å–æ¶ˆå‘½ä»¤
    cancel:
      keywords: ["å–æ¶ˆ", "ä¸è¦", "cancel", "ç®—äº†"]
      description: "å–æ¶ˆå½“å‰æ“ä½œ"
      action: cancel_current_action
      
    # å¸®åŠ©å‘½ä»¤
    help:
      keywords: ["å¸®åŠ©", "help", "?", "æ€ä¹ˆç”¨"]
      description: "æ˜¾ç¤ºä½¿ç”¨å¸®åŠ©"
      action: show_help
      response: |
        ğŸ“– ä½¿ç”¨å¸®åŠ©ï¼š
        
        â€¢ æŒ‰ç…§æç¤ºé€‰æ‹©äº§å“é…ç½®
        â€¢ å¯ä»¥ç›´æ¥è¯´åç§°ï¼Œä¹Ÿå¯ä»¥è¾“å…¥æ•°å­—
        â€¢ éšæ—¶è¯´"é‡é€‰"å¯ä»¥ä¿®æ”¹ä¹‹å‰çš„é€‰æ‹©
        â€¢ è¯´"é‡æ–°å¼€å§‹"å¯ä»¥æ¸…ç©ºé‡æ¥
        â€¢ è¯´"æŸ¥çœ‹"å¯ä»¥çœ‹å½“å‰è®¢å•
        â€¢ è¯´"å¸®åŠ©"æŸ¥çœ‹æœ¬è¯´æ˜
        
        æœ‰ä»»ä½•é—®é¢˜éšæ—¶å‘Šè¯‰æˆ‘ï¼

  # ==================== éªŒè¯è§„åˆ™ï¼ˆå¯é€‰ï¼‰====================
  
  validations:
    # ç¤ºä¾‹ï¼šèŠ¯ç‰‡å’Œå­˜å‚¨å®¹é‡çš„å…¼å®¹æ€§æ£€æŸ¥
    - name: chip_storage_compatibility
      description: "æ£€æŸ¥èŠ¯ç‰‡å’Œå­˜å‚¨å®¹é‡çš„å…¼å®¹æ€§"
      enabled: false  # å½“å‰ç¦ç”¨ï¼Œå¯æ ¹æ®éœ€è¦å¯ç”¨
      when:
        slots_filled: [chip, storage]
      rules:
        - condition: "chip == 'A17 Pro' and storage == '2TB'"
          valid: false
          message: "A17 ProèŠ¯ç‰‡ä¸æ”¯æŒ2TBå­˜å‚¨å®¹é‡"

  # ==================== å“åº”æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰====================
  
  templates:
    # è¿™äº›æ¨¡æ¿ä¼šè¦†ç›–business_configä¸­çš„é»˜è®¤æ¨¡æ¿
    custom_welcome:
      enabled: false
      content:
        - "ğŸŒŸ æ¬¢è¿æ¥åˆ°è‹¹æœä¸“å–åº—"
        - "æˆ‘æ˜¯AIåŠ©æ‰‹å°Aï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡"
        - "è®©æˆ‘ä»¬ä¸€èµ·æŒ‘é€‰å¿ƒä»ªçš„è‹¹æœäº§å“å§ï½"
