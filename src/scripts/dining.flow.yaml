# dining.flow.yaml
# é¤é¥®é¢„è®¢æµç¨‹å®šä¹‰
# åŸºäºYAMLçš„å£°æ˜å¼DSLè„šæœ¬
# ä½œè€…: èƒ¡è€å¸ˆå›¢é˜Ÿ
# æ—¥æœŸ: 2024-11-19

flow:
  name: dining_reservation
  version: "1.0"
  description: "é¤å…é¢„è®¢æ™ºèƒ½è¡¨å•æµç¨‹"
  business_line: dining
  
  # ==================== æµç¨‹é…ç½® ====================
  
  process_order:
    - category
    - brand
    - series
    - party_size
    - date
    - contact
    
  # ==================== æ§½ä½å®šä¹‰ ====================
  
  slots:
    category:
      label: "é¢„è®¢ç±»å‹"
      description: "é¢„è®¢ç±»å‹"
      required: true
      allow_llm: false
      type: enum
      enums_key: dining_category
      dependencies: []
      prompt_template: form_category_prompt
      auto_fill: true
      
    brand:
      label: "é¤å…é€‰æ‹©"
      description: "é€‰æ‹©é¤å…"
      required: true
      allow_llm: false
      type: enum
      enums_key: dining_brand
      dependencies: [category]
      prompt_template: form_brand_prompt
      
    series:
      label: "ç”¨é¤æ—¶æ®µ"
      description: "é€‰æ‹©ç”¨é¤æ—¶æ®µ"
      required: true
      allow_llm: false
      type: enum
      enums_key: dining_series
      dependencies: [brand]
      prompt_template: form_series_prompt
      
    party_size:
      label: "ç”¨é¤äººæ•°"
      description: "ç”¨é¤äººæ•°"
      required: true
      allow_llm: false
      type: enum
      enums_key: party_size
      dependencies: [series]
      prompt_template: form_party_size_prompt
      
    date:
      label: "é¢„è®¢æ—¥æœŸ"
      description: "é¢„è®¢æ—¥æœŸ"
      required: true
      allow_llm: true
      type: enum
      enums_key: date
      dependencies: [party_size]
      prompt_template: form_date_prompt
      validation:
        must_be_valid_enum: true
        min_confidence: 0.35
        
    contact:
      label: "è”ç³»æ–¹å¼"
      description: "è”ç³»æ–¹å¼"
      required: true
      allow_llm: true
      type: text
      dependencies: [date]
      prompt_template: form_contact_prompt
  
  # ==================== äº‹ä»¶å¤„ç† ====================
  
  events:
    on_start:
      - action: reset_form
      - action: show_template
        template: form_welcome
    
    on_all_filled:
      - action: show_summary
      - action: ask_confirm
      
    on_confirm:
      - action: validate_form
      - action: submit_order  # ç»Ÿä¸€ä½¿ç”¨submit_order
      - action: show_template
        template: form_order_confirmed
      - action: show_template
        template: form_order_thanks
      - action: ask_continue
    
    on_restart:
      - action: reset_form
      - action: show_welcome

  # ==================== ç”¨æˆ·å‘½ä»¤ ====================
  
  commands:
    restart:
      keywords: ["é‡æ–°é¢„è®¢", "é‡æ¥", "reset"]
      action: restart_flow
      
    confirm:
      keywords: ["ç¡®è®¤", "å¥½çš„", "æ˜¯çš„", "æ²¡é—®é¢˜"]
      condition: all_slots_filled
      action: confirm_order  # ç»Ÿä¸€ä½¿ç”¨confirm_order
      
    modify:
      keywords: ["ä¿®æ”¹", "æ”¹ä¸€ä¸‹", "é‡é€‰"]
      action: enter_reselect_mode
      
    cancel:
      keywords: ["å–æ¶ˆé¢„è®¢", "ä¸é¢„è®¢äº†"]
      action: cancel_reservation
      
    help:
      keywords: ["å¸®åŠ©", "help"]
      action: show_help
      response: |
        ğŸ“– é¢„è®¢å¸®åŠ©ï¼š
        
        â€¢ æŒ‰ç…§æç¤ºæä¾›é¢„è®¢ä¿¡æ¯
        â€¢ å¯ä»¥è¯´"ä¿®æ”¹"é‡æ–°é€‰æ‹©æŸé¡¹
        â€¢ è¯´"é‡æ–°é¢„è®¢"å¯ä»¥æ¸…ç©ºé‡æ¥
        â€¢ è¯´"å¸®åŠ©"æŸ¥çœ‹æœ¬è¯´æ˜

  # ==================== éªŒè¯è§„åˆ™ ====================
  
  validations:
    - name: weekend_people_limit
      description: "å‘¨æœ«ç”¨é¤äººæ•°é™åˆ¶"
      enabled: true
      when:
        slots_filled: [date, people]
      rules:
        - condition: "is_weekend(date) and people > 10"
          valid: false
          message: "å‘¨æœ«æœ€å¤šæ¥å¾…10äººç”¨é¤ï¼Œå¦‚éœ€æ›´å¤šäººæ•°è¯·æå‰è‡´ç”µ"
    
    - name: time_availability
      description: "æ£€æŸ¥æ—¶é—´æ®µå¯ç”¨æ€§"
      enabled: false  # éœ€è¦æ¥å…¥çœŸå®é¢„è®¢ç³»ç»Ÿ
      when:
        slots_filled: [date, time]
      action: check_availability

  # ==================== æ¨¡æ¿ ====================
  
  templates:
    form_welcome:
      - "ğŸ½ï¸ æ¬¢è¿ä½¿ç”¨é¤å…é¢„è®¢ç³»ç»Ÿ"
      - "æˆ‘ä¼šå¸®æ‚¨å¿«é€Ÿå®Œæˆé¢„è®¢"
      - "è®©æˆ‘ä»¬å¼€å§‹å§ï½"
