# 🏗️ 当前程序架构分析

### 核心架构模式

**混合架构**：结合了**分层架构** + **模块化架构** + **插件化架构**

## 🔧 建议的子系统划分

### 1. **入口层 (Entry Layer)**

```
src/
├── main.py                 # DSL驱动入口（新架构）
└── config/
    └── settings.py         # 全局配置管理
```

**职责**：

- 程序启动和初始化
- 业务线选择
- 组件装配和依赖注入

### 2. **DSL引擎层 (DSL Engine Layer)**

```
src/dsl/
├── yaml_flow_loader.py     # YAML流程加载器
├── flow_interpreter.py     # 流程解释器
└── __init__.py
```

**职责**：

- 解析和验证YAML流程定义
- 执行流程状态机
- 管理流程事件和命令

### 3. **对话核心层 (Dialog Core Layer)**

```
src/core/
├── form_based_system.py    # 表单对话系统（核心引擎）
├── interfaces.py           # 接口定义
├── slot_specs.py           # 槽位规格定义
└── slot_validators.py      # 业务验证规则
```

**职责**：

- 多槽位信息采集状态管理
- 槽位填充和冲突解决
- 对话流程控制

### 4. **语义理解层 (Semantic Understanding Layer)**

```
src/semantics/
└── option_mapping.py       # 语义映射和选项构建
```

**职责**：

- 本地语义匹配和关键词映射
- 上下文感知的选项推荐
- 智能意图理解

### 5. **AI服务层 (AI Service Layer)**

```
src/llm/
└── spark_client.py         # LLM客户端
```

**职责**：

- 意图识别和槽位抽取
- AI驱动的自然语言理解
- 多槽位并行识别

### 6. **知识库层 (Knowledge Base Layer)**

```
src/knowledge/
├── business_config_loader.py   # 业务配置加载器
└── business_configs/           # 业务配置文件
    ├── apple_store.json
    └── dining.json
```

**职责**：

- 业务配置和模板管理
- 枚举值和别名注册
- 动态过滤规则管理

### 7. **流程定义层 (Flow Definition Layer)**

```
src/scripts/
├── apple_store.flow.yaml   # 苹果商店流程定义
└── dining.flow.yaml        # 餐饮预订流程定义
```

**职责**：

- 声明式业务流程定义
- 槽位依赖和验证规则
- 用户命令和事件处理

## 🔄 子系统协作关系

### 数据流协作图

```
用户输入
    ↓
入口层 → 选择业务线
    ↓
DSL引擎层 → 加载流程定义 → 知识库层
    ↓
对话核心层 → 处理用户输入
    ↓
    ├─ 语义理解层 → 本地匹配
    ├─ AI服务层 → 智能识别
    └─ 知识库层 → 获取配置
    ↓
对话核心层 → 生成响应
    ↓
用户输出
```

### 关键协作接口

#### 1. **DSL引擎 ↔ 对话核心**

```python
# DSL向表单系统注入配置
interpreter._register_slots_to_form()
form_system.process_input()
```

#### 2. **对话核心 ↔ AI服务**

```python
# 多层级槽位抽取
form_system._extract_multiple_slots()
llm_client.extract_slots()
llm_client.detect_intent()
```

#### 3. **对话核心 ↔ 语义理解**

```python
# 本地语义映射
semantic_mapper.map()
OptionBuilder.build()
```

#### 4. **各层 ↔ 知识库**

```python
# 统一配置访问
business_config_loader.get_slot_specs()
business_config_loader.get_template()
business_config_loader.get_enums()
```

## 🎯 架构优势

### 1. **清晰的关注点分离**

- **DSL层**：关注"做什么"（声明式流程）
- **核心层**：关注"怎么做"（算法实现）
- **配置层**：关注"配置什么"（业务数据）

### 2. **优秀的扩展性**

- 新增业务线只需添加JSON配置和YAML流程
- 插件化的AI服务可替换不同LLM提供商
- 模块化的语义理解可扩展匹配策略

### 3. **灵活的部署选项**

- 可独立使用本地语义匹配（无LLM依赖）
- 可混合使用AI增强和规则引擎
- 支持渐进式智能化升级
