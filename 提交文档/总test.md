# 1 å‰è¨€

é¢˜ç›®ç®€è¦ä»‹ç»

å¯¹é¢˜ç›®èƒŒæ™¯ã€æ„ä¹‰çš„ç†è§£

## é¢˜ç›®ç®€è¦ä»‹ç»

æœ¬é¡¹ç›®æ—¨åœ¨è®¾è®¡å¹¶å®ç°ä¸€ä¸ªä¸“é—¨ç”¨äºæ™ºèƒ½å®¢æœæœºå™¨äººçš„é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆDSLï¼‰åŠå…¶è§£é‡Šå™¨ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿèƒ½å¤Ÿé€šè¿‡è‡ªç„¶è¯­è¨€ä¸ç”¨æˆ·è¿›è¡Œå¤šè½®å¯¹è¯ï¼Œæ™ºèƒ½ç†è§£ç”¨æˆ·æ„å›¾ï¼Œå¹¶æŒ‰ç…§é¢„å®šä¹‰çš„ä¸šåŠ¡æµç¨‹æ”¶é›†ç»“æ„åŒ–ä¿¡æ¯ã€‚ä¸åŒäºä¼ ç»Ÿçš„ç¡¬ç¼–ç å¯¹è¯ç³»ç»Ÿï¼Œæœ¬é¡¹ç›®é‡‡ç”¨å£°æ˜å¼çš„DSLè„šæœ¬é©±åŠ¨ä¸šåŠ¡æµç¨‹ï¼Œå®ç°äº†ä¸šåŠ¡é€»è¾‘ä¸æ ¸å¿ƒæŠ€æœ¯çš„å®Œå…¨åˆ†ç¦»ã€‚

## é¢˜ç›®èƒŒæ™¯ä¸æˆ‘å¯¹é¢˜ç›®æ„ä¹‰çš„ç†è§£

åœ¨å½“ä»Šæ•°å­—åŒ–è½¬å‹çš„æµªæ½®ä¸­ï¼Œæ™ºèƒ½å®¢æœæœºå™¨äººå·²æˆä¸ºä¼ä¸šä¸ç”¨æˆ·äº¤äº’çš„é‡è¦æ¸ é“ã€‚ç„¶è€Œï¼Œä¼ ç»Ÿçš„å®¢æœæœºå™¨äººç³»ç»Ÿé¢ä¸´ç€ä¸¥å³»çš„æŒ‘æˆ˜ï¼š

**å®é™…ä¸šåŠ¡ç—›ç‚¹**ï¼š
	åœ¨é¡¹ç›®åˆæœŸï¼Œæˆ‘ä»¬å°è¯•é‡‡ç”¨ç¡¬ç¼–ç æ–¹å¼å®ç°å¯¹è¯æµç¨‹ï¼Œå¾ˆå¿«å‘ç°äº†ä¼ ç»Ÿæ–¹æ³•çš„å±€é™æ€§ã€‚ä»¥è‹¹æœä¸“å–åº—å¯¼è´­åœºæ™¯ä¸ºä¾‹ï¼Œé‡‡ç”¨æœ‰é™çŠ¶æ€æœºè®¾è®¡éœ€è¦ç»´æŠ¤70-80ä¸ªçŠ¶æ€èŠ‚ç‚¹ï¼Œä»£ç è‡ƒè‚¿ä¸”éš¾ä»¥ç»´æŠ¤ã€‚æ¯å½“æ–°å¢ä¸šåŠ¡åœºæ™¯æˆ–è°ƒæ•´æµç¨‹æ—¶ï¼Œéƒ½éœ€è¦æ·±å…¥ä¿®æ”¹æ ¸å¿ƒä»£ç ï¼Œå¯¼è‡´ç³»ç»Ÿè„†å¼±ã€æµ‹è¯•æˆæœ¬é«˜æ˜‚ï¼Œä¸”å¼€å‘å‘¨æœŸæ¼«é•¿ã€‚

    æ›´ä¸¥é‡çš„æ˜¯ï¼Œè¿™ç§è®¾è®¡æ— æ³•é€‚åº”ç°å®å¯¹è¯çš„çµæ´»æ€§ã€‚åœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œç”¨æˆ·å¾€å¾€ä¸ä¼šæŒ‰ç…§é¢„è®¾é¡ºåºæä¾›ä¿¡æ¯ï¼Œå¯èƒ½ä¸€æ¬¡æ€§è¯´å‡º"æˆ‘æƒ³ä¹°ä¸€éƒ¨iPhone 15 Pro 256GBçš„é»‘è‰²æ‰‹æœº"ï¼Œä¼ ç»Ÿçš„çŠ¶æ€æœºéš¾ä»¥å¤„ç†è¿™ç§å¤šä¿¡æ¯å¹¶è¡Œè¾“å…¥çš„åœºæ™¯ã€‚

**ä¸šåŠ¡æœ¬è´¨æ´å¯Ÿ**ï¼š
	é€šè¿‡æ·±å…¥åˆ†æå¤šä¸ªä¸šåŠ¡åœºæ™¯ï¼ˆè‹¹æœä¸“å–åº—ã€é¤å…é¢„è®¢ã€å”®åå’¨è¯¢ç­‰ï¼‰ï¼Œæˆ‘ä»¬å‘ç°è¿™äº›çœ‹ä¼¼ä¸åŒçš„åœºæ™¯èƒŒåéƒ½æœ‰ä¸€ä¸ªå…±åŒçš„æœ¬è´¨ï¼š**ç»“æ„åŒ–ä¿¡æ¯æ”¶é›†**ã€‚æ— è®ºæ˜¯è´­ä¹°ç”µå­äº§å“è¿˜æ˜¯é¢„è®¢é¤å…ï¼Œæ ¸å¿ƒéƒ½æ˜¯é€šè¿‡å¯¹è¯æ”¶é›†ä¸€ç»„ç›¸å…³çš„ä¿¡æ¯å­—æ®µï¼ˆæ§½ä½ï¼‰ï¼Œè€Œè¿™äº›å­—æ®µä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ä½†å¹¶éä¸¥æ ¼çš„çº¿æ€§é¡ºåºã€‚

    åŸºäºè¿™ä¸€æ´å¯Ÿï¼Œæˆ‘ä»¬æå‡ºäº†**å¤šæ§½ä½ä¿¡æ¯é‡‡é›†å¯¹è¯ç³»ç»Ÿï¼ˆForm-Based Dialog Systemï¼‰**çš„åˆ›æ–°æ¶æ„ã€‚è¿™ä¸€è®¾è®¡çªç ´äº†ä¼ ç»ŸçŠ¶æ€æœºçš„é™åˆ¶ï¼Œå°†å¯¹è¯æµç¨‹é‡æ–°å®šä¹‰ä¸ºåŠ¨æ€çš„è¡¨å•å¡«å……è¿‡ç¨‹ã€‚

**é¡¹ç›®å®é™…ä¼˜åŠ¿**ï¼š

1. **çœŸæ­£çš„ä¸šåŠ¡çº§æ·±åº¦**ï¼šç³»ç»Ÿå…·å¤‡å®Œæ•´çš„å¯¹è¯è®°å¿†èƒ½åŠ›ï¼Œä¸ä»…èƒ½ç†è§£å½“å‰ç”¨æˆ·è¾“å…¥ï¼Œè¿˜èƒ½åŸºäºæ•´ä¸ªå¯¹è¯å†å²åšå‡ºæ™ºèƒ½å†³ç­–ã€‚å½“ç”¨æˆ·è¯´"æ¢ä¸ªé¢œè‰²"æ—¶ï¼Œç³»ç»ŸçŸ¥é“æŒ‡çš„æ˜¯å½“å‰æ­£åœ¨é…ç½®çš„äº§å“é¢œè‰²ï¼Œè€Œä¸æ˜¯å…¶ä»–æ— å…³ä¿¡æ¯ã€‚
2. **æ™ºèƒ½è€Œé"äººå·¥æ™ºéšœ"**ï¼šé€šè¿‡ä¸‰å±‚ä¿¡æ¯æŠ½å–ç­–ç•¥ï¼ˆç›´æ¥åŒ¹é…â†’è¯­ä¹‰æ˜ å°„â†’LLMç†è§£ï¼‰ï¼Œç³»ç»Ÿèƒ½å¤Ÿå¤„ç†å¤æ‚çš„ç”¨æˆ·è¡¨è¾¾ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·è¯´"æˆ‘è¦åŠå…¬ç”¨çš„ç¬”è®°æœ¬ï¼Œæ€§èƒ½å¥½ç‚¹çš„"ï¼Œç³»ç»Ÿèƒ½ç†è§£è¿™å¯¹åº”"å“ç±»=ç”µè„‘ï¼Œç³»åˆ—=MacBook Pro"ã€‚
3. **å¼ºå¤§çš„é€‚åº”æ€§**ï¼šåŒä¸€å¥—æ ¸å¿ƒç³»ç»Ÿé€šè¿‡ä¸åŒçš„DSLè„šæœ¬å³å¯æ”¯æŒå®Œå…¨ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚ä»ç”µå­äº§å“å¯¼è´­åˆ°é¤å…é¢„è®¢ï¼Œåªéœ€ç¼–å†™ç›¸åº”çš„ä¸šåŠ¡é…ç½®å’Œæµç¨‹è„šæœ¬ï¼Œæ— éœ€ä¿®æ”¹ä»»ä½•æ ¸å¿ƒä»£ç ã€‚
4. **ä¼˜é›…çš„å†²çªå¤„ç†**ï¼šå½“ç”¨æˆ·ä¸­é€”ä¿®æ”¹é€‰æ‹©æ—¶ï¼ˆå¦‚ä»"iPhone 14"æ”¹ä¸º"iPhone 15"ï¼‰ï¼Œç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¹¶è§£å†³ä¾èµ–å†²çªï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚
5. **æ¸è¿›å¼ä½“éªŒ**ï¼šç³»ç»Ÿæ”¯æŒç”¨æˆ·ä»¥ä»»æ„é¡ºåºæä¾›ä¿¡æ¯ï¼Œå¯ä»¥ä¸€æ¬¡æ€§è¯´å‡ºæ‰€æœ‰éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥åˆ†å¤šæ¬¡é€æ­¥å®Œå–„ï¼ŒçœŸæ­£æ¨¡æ‹Ÿäººç±»å¯¹è¯çš„è‡ªç„¶æµç•…ã€‚

**å®é™…åº”ç”¨ä»·å€¼**ï¼š
	æœ¬é¡¹ç›®è§£å†³çš„ä¸ä»…ä»…æ˜¯å­¦æœ¯é—®é¢˜ï¼Œè€Œæ˜¯çœŸå®çš„äº§ä¸šéœ€æ±‚ã€‚åœ¨å½“å‰ä¼ä¸šæ•°å­—åŒ–è½¬å‹çš„èƒŒæ™¯ä¸‹ï¼Œå¿«é€Ÿéƒ¨ç½²ã€æ˜“äºç»´æŠ¤ã€æ™ºèƒ½çµæ´»çš„å®¢æœç³»ç»Ÿå…·æœ‰å·¨å¤§çš„å¸‚åœºä»·å€¼ã€‚æˆ‘ä»¬çš„ç³»ç»Ÿè®©ä¸šåŠ¡äººå‘˜èƒ½å¤Ÿé€šè¿‡ç¼–å†™DSLè„šæœ¬ç›´æ¥å®šä¹‰å¯¹è¯æµç¨‹ï¼Œå¤§å¤§é™ä½äº†æŠ€æœ¯é—¨æ§›ï¼ŒåŠ é€Ÿäº†ä¸šåŠ¡è¿­ä»£é€Ÿåº¦ã€‚

    é€šè¿‡ä¸‰æ¬¡è¿­ä»£æ¼”è¿›ï¼Œæˆ‘ä»¬ä»æœ€åˆè„†å¼±çš„ç¡¬ç¼–ç ç³»ç»Ÿï¼Œå‘å±•åˆ°ç°åœ¨å¥å£®ã€çµæ´»ã€æ™ºèƒ½çš„å¤šæ§½ä½ä¿¡æ¯é‡‡é›†ç³»ç»Ÿï¼Œè¿™ä¸€å†ç¨‹å……åˆ†ä½“ç°äº†è½¯ä»¶å·¥ç¨‹ä¸­æŠ½è±¡å’Œæ¶æ„è®¾è®¡çš„é‡è¦æ€§ã€‚æœ¬é¡¹ç›®ä¸ä»…æ˜¯DSLæŠ€æœ¯å’ŒAIæŠ€æœ¯çš„ç»“åˆï¼Œæ›´æ˜¯å¯¹ç°ä»£è½¯ä»¶ç³»ç»Ÿè®¾è®¡ç†å¿µçš„ä¸€æ¬¡æˆåŠŸå®è·µã€‚

# 2 éœ€æ±‚åˆ†æ

æ ¹æ®è‡ªå·±çš„ç†è§£ç»™å‡ºå®Œæ•´é¡¹ç›®éœ€æ±‚åˆ†æã€‚å¦‚æœéœ€æ±‚æ²¡æœ‰å®ç°ï¼Œéœ€è¦æ³¨æ˜ï¼š

- æœ¬æ¬¡å¤§ä½œä¸šä¸è¦æ±‚ï¼Œæˆ–è€…
- æœªå®ç°ï¼ˆç†ç”±ï¼‰

## 2.1 åŠŸèƒ½éœ€æ±‚

### 2.1.1 DSLæ ¸å¿ƒè¯­è¨€è®¾è®¡

é¡¹ç›®éœ€è¦è®¾è®¡ä¸€å¥—ä¸“é—¨ç”¨äºæè¿°å®¢æœæœºå™¨äººå“åº”é€»è¾‘çš„è„šæœ¬è¯­è¨€ã€‚è¯¥è¯­è¨€åº”å½“èƒ½å¤Ÿæ¸…æ™°å®šä¹‰ä¸šåŠ¡åœºæ™¯ä¸­çš„å¯¹è¯æµç¨‹ã€çŠ¶æ€è½¬æ¢å’Œç”¨æˆ·æ„å›¾æ˜ å°„ã€‚è€ƒè™‘åˆ°å®é™…åº”ç”¨åœºæ™¯çš„å¤šæ ·æ€§ï¼ŒDSLéœ€è¦å…·å¤‡è¶³å¤Ÿçš„è¡¨è¾¾èƒ½åŠ›æ¥è¦†ç›–ä¸åŒä¸šåŠ¡é¢†åŸŸçš„ç‰¹å®šéœ€æ±‚ï¼ŒåŒæ—¶ä¿æŒè¯­æ³•ç®€æ´æ€§ä»¥é™ä½é…ç½®äººå‘˜çš„ä¸Šæ‰‹é—¨æ§›ã€‚åœ¨å®ç°å±‚é¢ï¼Œéœ€è¦å¹³è¡¡å£°æ˜å¼æè¿°çš„ç›´è§‚æ€§ä¸æµç¨‹æ§åˆ¶çš„çµæ´»æ€§ã€‚

### 2.1.2 è§£é‡Šå™¨æ‰§è¡Œå¼•æ“

è§£é‡Šå™¨ä½œä¸ºç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£è§£æå’Œæ‰§è¡ŒDSLè„šæœ¬ã€‚å…¶è®¾è®¡é‡ç‚¹åœ¨äºå¦‚ä½•å‡†ç¡®ç†è§£è„šæœ¬è¯­ä¹‰ï¼Œå¹¶é©±åŠ¨æ•´ä¸ªå¯¹è¯æµç¨‹çš„æ¨è¿›ã€‚è§£é‡Šå™¨éœ€è¦ç»´æŠ¤å¯¹è¯çŠ¶æ€æœºï¼Œå¤„ç†ç”¨æˆ·è¾“å…¥ä¸è„šæœ¬é€»è¾‘çš„åŒ¹é…ï¼Œå¹¶ç¡®ä¿åœ¨å¤šè½®å¯¹è¯ä¸­ä¸Šä¸‹æ–‡ä¿¡æ¯çš„ä¸€è‡´æ€§å’Œè¿è´¯æ€§ã€‚æ‰§è¡Œå¼•æ“çš„æ€§èƒ½ç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒï¼Œå› æ­¤éœ€è¦ä¼˜åŒ–çŠ¶æ€ç®¡ç†å’Œæµç¨‹è·³è½¬çš„æ•ˆç‡ã€‚

### 2.1.3 AIæ„å›¾è¯†åˆ«é›†æˆ

ç³»ç»Ÿéœ€è¦é›†æˆå¤§è¯­è¨€æ¨¡å‹APIæ¥å®ç°è‡ªç„¶è¯­è¨€ç†è§£ã€‚è¿™éƒ¨åˆ†åŠŸèƒ½çš„å…³é”®åœ¨äºå¦‚ä½•å°†LLMçš„å¼ºå¤§è¯­ä¹‰ç†è§£èƒ½åŠ›ä¸ä¼ ç»Ÿè§„åˆ™å¼•æ“ç›¸ç»“åˆã€‚è®¾è®¡æ—¶éœ€è¦è€ƒè™‘APIè°ƒç”¨çš„æ€§èƒ½å¼€é”€ã€é”™è¯¯å¤„ç†æœºåˆ¶ä»¥åŠæ„å›¾è¯†åˆ«ç»“æœä¸DSLè„šæœ¬çš„å¯¹æ¥æ–¹å¼ã€‚åŒæ—¶ï¼Œç³»ç»Ÿåº”å½“å…·å¤‡ä¸€å®šçš„å®¹é”™èƒ½åŠ›ï¼Œåœ¨LLMæœåŠ¡ä¸å¯ç”¨æ—¶èƒ½å¤Ÿé™çº§åˆ°åŸºäºè§„åˆ™çš„åŸºç¡€ç†è§£æ¨¡å¼ã€‚

### 2.1.4 ä¸šåŠ¡åœºæ™¯é€‚é…æ€§

é¡¹ç›®è¦æ±‚æä¾›å¤šä¸ªä¸åŒä¸šåŠ¡åœºæ™¯çš„è„šæœ¬èŒƒä¾‹ï¼Œè¿™æ„å‘³ç€DSLéœ€è¦å…·å¤‡è‰¯å¥½çš„é€šç”¨æ€§å’Œå¯æ‰©å±•æ€§ã€‚åœ¨è®¾è®¡æ—¶éœ€è¦æŠ½è±¡å‡ºä¸åŒä¸šåŠ¡åœºæ™¯ä¸­çš„å…±æ€§éœ€æ±‚ï¼Œå½¢æˆæ ‡å‡†åŒ–çš„æè¿°æ¨¡å¼ï¼ŒåŒæ—¶ä¿ç•™è¶³å¤Ÿçš„å®šåˆ¶åŒ–ç©ºé—´æ¥æ»¡è¶³ç‰¹å®šåœºæ™¯çš„ç‰¹æ®Šè¦æ±‚ã€‚èŒƒä¾‹è„šæœ¬åº”å½“èƒ½å¤Ÿæ¸…æ™°å±•ç¤ºDSLçš„è¡¨è¾¾èƒ½åŠ›å’Œè§£é‡Šå™¨çš„æ‰§è¡Œæ•ˆæœã€‚

### 2.1.5 ç”¨æˆ·äº¤äº’æ¥å£

è™½ç„¶é¡¹ç›®å…è®¸ç®€åŒ–ä¸ºå‘½ä»¤è¡Œç•Œé¢ï¼Œä½†äº¤äº’è®¾è®¡ä»éœ€è€ƒè™‘ç”¨æˆ·ä½“éªŒã€‚ç³»ç»Ÿåº”å½“æä¾›æ¸…æ™°çš„æç¤ºä¿¡æ¯ã€çŠ¶æ€åé¦ˆå’Œé”™è¯¯æŒ‡å¼•ï¼Œä½¿å¾—ç”¨æˆ·èƒ½å¤Ÿç›´è§‚ç†è§£å½“å‰å¯¹è¯è¿›åº¦å’Œä¸‹ä¸€æ­¥æ“ä½œã€‚å¯¹äºå¤æ‚çš„å¤šè½®å¯¹è¯åœºæ™¯ï¼Œè¿˜éœ€è¦è€ƒè™‘å¦‚ä½•è®©ç”¨æˆ·éšæ—¶äº†è§£å·²æä¾›çš„ä¿¡æ¯å’Œå¾…å®Œæˆçš„ä»»åŠ¡ã€‚

> æœ¬æ¬¡å¤§ä½œä¸šä¸è¦æ±‚å®ç°å›¾å½¢åŒ–ç•Œé¢ï¼Œé‡ç‚¹åœ¨äºæ ¸å¿ƒçš„DSLè§£é‡Šå™¨å’ŒAIé›†æˆåŠŸèƒ½ã€‚

## 2.2 éåŠŸèƒ½éœ€æ±‚

### 2.2.1 ç³»ç»Ÿæ€§èƒ½è€ƒé‡

è§£é‡Šå™¨çš„å“åº”é€Ÿåº¦ç›´æ¥å½±å“å¯¹è¯çš„æµç•…åº¦ã€‚æœ¬åœ°è§„åˆ™åŒ¹é…å’ŒçŠ¶æ€è½¬æ¢åº”å½“åœ¨æ¯«ç§’çº§å®Œæˆï¼Œè€ŒLLM APIè°ƒç”¨ä½œä¸ºä¸»è¦æ€§èƒ½ç“¶é¢ˆï¼Œéœ€è¦é€šè¿‡åˆç†çš„è¶…æ—¶è®¾ç½®å’Œå¼‚æ­¥å¤„ç†æ¥å¹³è¡¡å“åº”é€Ÿåº¦ä¸è¯†åˆ«å‡†ç¡®ç‡ã€‚åœ¨èµ„æºä½¿ç”¨æ–¹é¢ï¼Œç³»ç»Ÿåº”å½“ä¼˜åŒ–å†…å­˜ç®¡ç†ï¼Œç¡®ä¿åœ¨é•¿æ—¶é—´è¿è¡Œå’Œå¤šä¼šè¯å¹¶å‘æ—¶ä¿æŒç¨³å®šã€‚

### 2.2.2 å¯é æ€§ä¸å®¹é”™æ€§

ç³»ç»Ÿéœ€è¦å…·å¤‡è¾ƒå¼ºçš„é²æ£’æ€§ï¼Œèƒ½å¤Ÿå¤„ç†å„ç§å¼‚å¸¸æƒ…å†µï¼ŒåŒ…æ‹¬ç”¨æˆ·çš„ä¸è§„èŒƒè¾“å…¥ã€ç½‘ç»œé€šä¿¡æ•…éšœã€å¤–éƒ¨æœåŠ¡ä¸å¯ç”¨ç­‰ã€‚è®¾è®¡æ—¶åº”å½“è€ƒè™‘å®Œæ•´çš„å¼‚å¸¸å¤„ç†é“¾æ¡ï¼Œä»è¾“å…¥éªŒè¯åˆ°é”™è¯¯æ¢å¤ï¼Œç¡®ä¿å•ç‚¹æ•…éšœä¸ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒã€‚çŠ¶æ€æŒä¹…åŒ–æœºåˆ¶ä¹Ÿæ˜¯ä¿éšœå¯é æ€§çš„é‡è¦ç¯èŠ‚ã€‚

### 2.2.3 å¯ç»´æŠ¤æ€§ä¸æ‰©å±•æ€§

æ¨¡å—åŒ–è®¾è®¡æ˜¯ä¿éšœç³»ç»Ÿé•¿æœŸå¯ç»´æŠ¤çš„å…³é”®ã€‚å„ç»„ä»¶åº”å½“èŒè´£æ¸…æ™°ã€æ¥å£æ˜ç¡®ï¼Œä¾¿äºå•ç‹¬æµ‹è¯•å’Œå‡çº§ã€‚DSLçš„è§£é‡Šå™¨æ ¸å¿ƒåº”å½“ä¸å…·ä½“çš„ä¸šåŠ¡é€»è¾‘è§£è€¦ï¼Œä½¿å¾—æ–°å¢ä¸šåŠ¡åœºæ™¯åªéœ€ç¼–å†™å¯¹åº”çš„è„šæœ¬è€Œä¸éœ€è¦ä¿®æ”¹è§£é‡Šå™¨ä»£ç ã€‚è¿™ç§è®¾è®¡ä¹Ÿä¸ºåç»­é›†æˆæ›´å¤šAIèƒ½åŠ›æˆ–æ‰©å±•äº¤äº’æ–¹å¼é¢„ç•™äº†ç©ºé—´ã€‚

### 2.2.4 å¼€å‘ä¸éƒ¨ç½²çº¦æŸ

é¡¹ç›®å¯¹å¼€å‘ç¯å¢ƒä¿æŒå¼€æ”¾æ€åº¦ï¼Œä½†è¦æ±‚ä½¿ç”¨Gitè¿›è¡Œç‰ˆæœ¬ç®¡ç†ã€‚è¿™æ„å‘³ç€åœ¨æŠ€æœ¯é€‰å‹æ—¶éœ€è¦è€ƒè™‘åˆ°å›¢é˜Ÿåä½œå’Œä»£ç ç®¡ç†çš„ä¾¿åˆ©æ€§ã€‚è™½ç„¶ä¸é™åˆ¶ç¼–ç¨‹è¯­è¨€ï¼Œä½†é€‰æ‹©ç”Ÿæ€ä¸°å¯Œã€å·¥å…·é“¾æˆç†Ÿçš„è¯­ç§å°†æœ‰åŠ©äºæé«˜å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡ã€‚éƒ¨ç½²æ–¹é¢åº”å½“å°½é‡ç®€åŒ–ç¯å¢ƒä¾èµ–ï¼Œé™ä½è¿è¡Œé—¨æ§›ã€‚

### 2.2.5 æµ‹è¯•éªŒè¯è¦æ±‚

é¡¹ç›®å¯¹æµ‹è¯•æœ‰æ˜ç¡®è¦æ±‚ï¼Œéœ€è¦è®¾è®¡æµ‹è¯•æ¡©ã€æµ‹è¯•é©±åŠ¨å’Œè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ã€‚è¿™è¦æ±‚åœ¨ç³»ç»Ÿè®¾è®¡é˜¶æ®µå°±è€ƒè™‘å¯æµ‹è¯•æ€§ï¼Œæä¾›è¶³å¤Ÿçš„æ¥å£å’Œæ‰©å±•ç‚¹æ¥æ”¯æŒå„ç§æµ‹è¯•åœºæ™¯ã€‚æµ‹è¯•è¦†ç›–èŒƒå›´åº”å½“åŒ…æ‹¬DSLè„šæœ¬è§£æã€æ„å›¾è¯†åˆ«å‡†ç¡®ç‡ã€å¯¹è¯æµç¨‹æ­£ç¡®æ€§ç­‰å…³é”®åŠŸèƒ½ç‚¹ã€‚

# 3 æ€»ä½“è®¾è®¡

å­ç³»ç»Ÿåˆ’åˆ†ï¼Œå„å­ç³»ç»Ÿä¹‹é—´çš„å…³ç³»ï¼ˆè¯´æ˜+å›¾ç¤ºï¼‰

    åŸºäºé¡¹ç›®éœ€æ±‚å¹¶é€šè¿‡ä¸‰æ¬¡è¿­ä»£æ¼”è¿›ï¼Œç³»ç»Ÿä»æœ€åˆçš„ç¡¬ç¼–ç å¯¹è¯æœºå™¨äººå‘å±•ä¸ºå½“å‰ä¸“é—¨é’ˆå¯¹ä¿¡æ¯æ”¶é›†çš„æ™ºèƒ½å®¢æœæœºå™¨äººç³»ç»Ÿâ€”â€”æˆ‘å°†å®ƒç§°ä¸ºï¼šå¤šæ§½ä½ä¿¡æ¯é‡‡é›†å¯¹è¯ç³»ç»Ÿï¼ˆForm-Based Dialog Systemï¼‰ã€‚æœ¬é¡¹ç›®æ ¸å¿ƒç›®æ ‡æ˜¯é€šè¿‡è‡ªç„¶è¯­è¨€ç†è§£é€æ­¥æ”¶é›†ç”¨æˆ·éœ€æ±‚ä¿¡æ¯ï¼Œå°†å¤æ‚çš„è‡ªç„¶è¯­è¨€å¯¹è¯æŠ½è±¡ä¸ºç»“æ„åŒ–çš„ä¿¡æ¯é‡‡é›†æµç¨‹ã€‚æœ¬ç³»ç»Ÿé‡‡ç”¨é…ç½®é©±åŠ¨çš„è®¾è®¡ç†å¿µï¼Œé€šè¿‡YAML DSLå®ç°ä¸šåŠ¡é€»è¾‘ä¸æ ¸å¿ƒä»£ç çš„åˆ†ç¦»ï¼Œæ”¯æŒå®šä¹‰ä¸åŒä¸šåŠ¡åœºæ™¯çš„å¯¹è¯æµç¨‹ï¼Œå…·æœ‰å¾ˆå¼ºçš„å¯æ‹“å±•æ€§ã€‚

## 3.1 å­ç³»ç»Ÿåˆ’åˆ†

åŸºäºå½“å‰ç¨‹åºæ¶æ„åˆ†æï¼Œç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„ä¸æ¨¡å—åŒ–æ¶æ„ç›¸ç»“åˆçš„è®¾è®¡æ¨¡å¼ï¼Œå°†æ•´ä¸ªæ™ºèƒ½è¡¨å•å®¢æœç³»ç»Ÿåˆ’åˆ†ä¸ºä»¥ä¸‹7ä¸ªå­ç³»ç»Ÿï¼š

### 3.1.1 å…¥å£å±‚ (Entry Layer)

**ä½ç½®**: `src/main.py`, `src/config/settings.py`

- **èŒè´£**: ç¨‹åºå¯åŠ¨å…¥å£å’Œå…¨å±€é…ç½®ç®¡ç†
- **æ ¸å¿ƒåŠŸèƒ½**:
  - ä¸šåŠ¡æµç¨‹é€‰æ‹©å’Œåˆå§‹åŒ–
  - ç»„ä»¶è£…é…å’Œä¾èµ–æ³¨å…¥
  - å…¨å±€é…ç½®å‚æ•°ç®¡ç†
- **è®¾è®¡æ€è·¯**: é‡‡ç”¨å•ä¸€å…¥å£æ¨¡å¼ï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¸šåŠ¡æµç¨‹çš„å¯åŠ¨å’Œé…ç½®ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚

### 3.1.2 DSLå¼•æ“å±‚ (DSL Engine Layer)

**ä½ç½®**: `src/dsl/` ç›®å½•

- **èŒè´£**: YAMLæµç¨‹å®šä¹‰çš„è§£æå’Œæ‰§è¡Œ
- **æ ¸å¿ƒç»„ä»¶**:
  - `yaml_flow_loader.py`: æµç¨‹å®šä¹‰åŠ è½½å’ŒéªŒè¯
  - `flow_interpreter.py`: æµç¨‹çŠ¶æ€æœºè§£é‡Šæ‰§è¡Œ
- **è®¾è®¡æ€è·¯**: é€šè¿‡å£°æ˜å¼DSLå°†ä¸šåŠ¡æµç¨‹ä¸ä»£ç é€»è¾‘åˆ†ç¦»ï¼Œå®ç°ä¸šåŠ¡è§„åˆ™çš„å¯é…ç½®åŒ–ï¼Œé™ä½å¼€å‘å’Œç»´æŠ¤æˆæœ¬ã€‚

### 3.1.3 å¯¹è¯æ ¸å¿ƒå±‚ (Dialog Core Layer)

**ä½ç½®**: `src/core/` ç›®å½•

- **èŒè´£**: å¤šæ§½ä½ä¿¡æ¯é‡‡é›†å’Œå¯¹è¯æµç¨‹æ§åˆ¶
- **æ ¸å¿ƒç»„ä»¶**:
  - `form_based_system.py`: è¡¨å•å¯¹è¯ç³»ç»Ÿæ ¸å¿ƒå¼•æ“
  - `interfaces.py`: ç³»ç»Ÿæ¥å£å®šä¹‰
  - `slot_validators.py`: ä¸šåŠ¡çº¦æŸæ ¡éªŒ
- **è®¾è®¡æ€è·¯**:é‡‡ç”¨çŠ¶æ€æœºæ¨¡å¼ç®¡ç†å¯¹è¯æµç¨‹ï¼Œæ”¯æŒå¤æ‚çš„æ§½ä½ä¾èµ–å…³ç³»å’Œå†²çªè§£å†³æœºåˆ¶ã€‚

### 3.1.4 è¯­ä¹‰ç†è§£å±‚ (Semantic Understanding Layer)

**ä½ç½®**: `src/semantics/option_mapping.py`

- **èŒè´£**: æœ¬åœ°è¯­ä¹‰åŒ¹é…å’Œæ™ºèƒ½é€‰é¡¹æ¨è
- **æ ¸å¿ƒåŠŸèƒ½**:
  - å…³é”®è¯æ˜ å°„å’ŒåŒä¹‰è¯è¯†åˆ«
  - ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„é€‰é¡¹æ„å»º
  - åŸºäºä½¿ç”¨åœºæ™¯çš„æ™ºèƒ½æ¨è
- **è®¾è®¡æ€è·¯**:åœ¨LLMæœåŠ¡ä¸å¯ç”¨æˆ–å“åº”å»¶è¿Ÿæ—¶æä¾›å…œåº•æ–¹æ¡ˆï¼Œç¡®ä¿ç³»ç»Ÿçš„é²æ£’æ€§å’Œå“åº”é€Ÿåº¦ã€‚

### 3.1.5 AIæœåŠ¡å±‚ (AI Service Layer)

**ä½ç½®**: `src/llm/spark_client.py`

- **èŒè´£**: å¤§è¯­è¨€æ¨¡å‹æœåŠ¡é›†æˆ
- **æ ¸å¿ƒåŠŸèƒ½**:
  - æ„å›¾è¯†åˆ«å’Œæ§½ä½æŠ½å–
  - è‡ªç„¶è¯­è¨€ç†è§£
  - å¤šæ§½ä½å¹¶è¡Œè¯†åˆ«
- **è®¾è®¡æ€è·¯**:é‡‡ç”¨é€‚é…å™¨æ¨¡å¼å°è£…ä¸åŒLLMæä¾›å•†çš„APIï¼Œæ”¯æŒçµæ´»æ›¿æ¢å’Œæ‰©å±•ã€‚

### 3.1.6 çŸ¥è¯†åº“å±‚ (Knowledge Base Layer)

**ä½ç½®**: `src/knowledge/` ç›®å½•

- **èŒè´£**: ä¸šåŠ¡é…ç½®å’Œæ¨¡æ¿ç®¡ç†
- **æ ¸å¿ƒç»„ä»¶**:
  - `business_config_loader.py`: ç»Ÿä¸€é…ç½®åŠ è½½å™¨
  - ä¸šåŠ¡é…ç½®æ–‡ä»¶: `apple_store.json`, `dining.json`
- **è®¾è®¡æ€è·¯**:é›†ä¸­åŒ–ç®¡ç†æ‰€æœ‰ä¸šåŠ¡ç›¸å…³çš„é…ç½®æ•°æ®ï¼Œæ”¯æŒåŠ¨æ€åŠ è½½å’Œçƒ­æ›´æ–°ã€‚

### 3.1.7 æµç¨‹å®šä¹‰å±‚ (Flow Definition Layer)

**ä½ç½®**: `src/scripts/` ç›®å½•

- **èŒè´£**: å£°æ˜å¼ä¸šåŠ¡æµç¨‹å®šä¹‰
- **æ ¸å¿ƒæ–‡ä»¶**:
  - `apple_store.flow.yaml`: è‹¹æœå•†åº—è´­ç‰©æµç¨‹
  - `dining.flow.yaml`: é¤é¥®é¢„è®¢æµç¨‹
- **è®¾è®¡æ€è·¯**:ä½¿ç”¨YAMLä½œä¸ºDSLè½½ä½“ï¼Œæä¾›ç›´è§‚çš„ä¸šåŠ¡æµç¨‹æè¿°ï¼Œæ”¯æŒéæŠ€æœ¯äººå‘˜å‚ä¸æµç¨‹è®¾è®¡ã€‚

## 3.2 å­ç³»ç»Ÿå…³ç³»

### 3.2.1 æ•°æ®æµåä½œå…³ç³»

```
ç”¨æˆ·è¾“å…¥
    â†“
å…¥å£å±‚ â†’ é€‰æ‹©ä¸šåŠ¡çº¿
    â†“
DSLå¼•æ“å±‚ â†’ åŠ è½½æµç¨‹å®šä¹‰ â†’ çŸ¥è¯†åº“å±‚
    â†“
å¯¹è¯æ ¸å¿ƒå±‚ â†’ å¤„ç†ç”¨æˆ·è¾“å…¥
    â†“
    â”œâ”€ è¯­ä¹‰ç†è§£å±‚ â†’ æœ¬åœ°è¯­ä¹‰åŒ¹é…
    â”œâ”€ AIæœåŠ¡å±‚ â†’ æ™ºèƒ½è¯†åˆ« (å¯é€‰)
    â””â”€ çŸ¥è¯†åº“å±‚ â†’ è·å–é…ç½®å’Œæ¨¡æ¿
    â†“
å¯¹è¯æ ¸å¿ƒå±‚ â†’ ç”Ÿæˆå“åº”
    â†“
ç”¨æˆ·è¾“å‡º
```

### 3.2.2 å…³é”®åä½œæ¥å£

1. **DSLå¼•æ“ â†” å¯¹è¯æ ¸å¿ƒ**

   - æ¥å£æ–¹å¼: é…ç½®æ³¨å…¥å’Œäº‹ä»¶è§¦å‘
   - æ•°æ®æµ: DSLé…ç½® â†’ è¡¨å•ç³»ç»ŸçŠ¶æ€ç®¡ç†
   - è®¾è®¡ä¼˜åŠ¿: å®ç°ä¸šåŠ¡æµç¨‹ä¸æ‰§è¡Œé€»è¾‘çš„æ¾è€¦åˆ
2. **å¯¹è¯æ ¸å¿ƒ â†” AIæœåŠ¡/è¯­ä¹‰ç†è§£**

   - æ¥å£æ–¹å¼: å¤šå±‚çº§æ§½ä½æŠ½å–ç­–ç•¥
   - åä½œæ¨¡å¼: ç²¾ç¡®åŒ¹é… â†’ è¯­ä¹‰æ¨è â†’ LLMå…œåº•
   - è®¾è®¡ä¼˜åŠ¿: æä¾›æ¸è¿›å¼æ™ºèƒ½è¯†åˆ«ï¼Œå¹³è¡¡å‡†ç¡®æ€§å’Œæ€§èƒ½
3. **å„å±‚ â†” çŸ¥è¯†åº“**

   - æ¥å£æ–¹å¼: ç»Ÿä¸€é…ç½®è®¿é—®æ¥å£
   - æ•°æ®æµ: ä¸šåŠ¡é…ç½® â†’ è¿è¡Œæ—¶æ•°æ®
   - è®¾è®¡ä¼˜åŠ¿: é›†ä¸­åŒ–é…ç½®ç®¡ç†ï¼Œæ”¯æŒå¤šä¸šåŠ¡çº¿å¹¶è¡Œ

### 3.2.3 å­ç³»ç»Ÿå…³ç³»å›¾ç¤º

```
+----------------+     +------------------+     +-------------------+
|                |     |                  |     |                   |
|   å…¥å£å±‚       |---->|   DSLå¼•æ“å±‚      |---->|   å¯¹è¯æ ¸å¿ƒå±‚      |
|                |     |                  |     |                   |
+----------------+     +------------------+     +---------+---------+
                                                          |
         +------------------+------------------+          |
         |                  |                  |          |
+--------v-------+ +--------v-------+ +--------v---------+
|                | |                | |                  |
|  è¯­ä¹‰ç†è§£å±‚    | |   AIæœåŠ¡å±‚     | |   çŸ¥è¯†åº“å±‚       |
|                | |                | |                  |
+----------------+ +----------------+ +------------------+
         |                  |                  |
         +------------------+------------------+
                            |
                   +--------v---------+
                   |                  |
                   |  æµç¨‹å®šä¹‰å±‚      |
                   |                  |
                   +------------------+
```

## 3.3 æ¶æ„ä¼˜åŠ¿åˆ†æ

### 3.3.1 æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»

- **DSLå±‚**ä¸“æ³¨äº"åšä»€ä¹ˆ"ï¼ˆå£°æ˜å¼ä¸šåŠ¡æµç¨‹å®šä¹‰ï¼‰
- **æ ¸å¿ƒå±‚**ä¸“æ³¨äº"æ€ä¹ˆåš"ï¼ˆç®—æ³•å®ç°å’ŒçŠ¶æ€ç®¡ç†ï¼‰
- **é…ç½®å±‚**ä¸“æ³¨äº"é…ç½®ä»€ä¹ˆ"ï¼ˆä¸šåŠ¡æ•°æ®å’Œæ¨¡æ¿ï¼‰
- **ä¼˜åŠ¿**: å„å±‚èŒè´£æ˜ç¡®ï¼Œä¾¿äºå›¢é˜Ÿåä½œå’Œç‹¬ç«‹å¼€å‘

### 3.3.2 ä¼˜ç§€çš„æ‰©å±•æ€§

- **ä¸šåŠ¡æ‰©å±•**: æ–°å¢ä¸šåŠ¡çº¿åªéœ€æ·»åŠ JSONé…ç½®å’ŒYAMLæµç¨‹å®šä¹‰
- **æŠ€æœ¯æ‰©å±•**: æ’ä»¶åŒ–çš„AIæœåŠ¡æ”¯æŒä¸åŒLLMæä¾›å•†æ›¿æ¢
- **åŠŸèƒ½æ‰©å±•**: æ¨¡å—åŒ–çš„è¯­ä¹‰ç†è§£å±‚æ”¯æŒå¤šç§åŒ¹é…ç­–ç•¥æ‰©å±•
- **ä¼˜åŠ¿**: æ”¯æŒä¸šåŠ¡å’ŒæŠ€æœ¯çš„å¹¶è¡Œæ¼”è¿›ï¼Œé™ä½ç³»ç»Ÿæ¼”åŒ–æˆæœ¬

### 3.3.3 çµæ´»çš„éƒ¨ç½²é€‰é¡¹

- **ç‹¬ç«‹éƒ¨ç½²**: å¯ä»…ä½¿ç”¨æœ¬åœ°è¯­ä¹‰åŒ¹é…ï¼Œæ— LLMä¾èµ–
- **æ··åˆéƒ¨ç½²**: æ”¯æŒAIå¢å¼ºå’Œè§„åˆ™å¼•æ“çš„æ··åˆä½¿ç”¨
- **æ¸è¿›å‡çº§**: æ”¯æŒä»è§„åˆ™å¼•æ“å‘AIé©±åŠ¨çš„å¹³æ»‘è¿‡æ¸¡
- **ä¼˜åŠ¿**: é€‚åº”ä¸åŒè§„æ¨¡å’Œåº”ç”¨åœºæ™¯çš„æŠ€æœ¯éœ€æ±‚

### 3.3.4 é«˜å¯ç»´æŠ¤æ€§

- **é…ç½®é©±åŠ¨**: ä¸šåŠ¡è§„åˆ™å¤–éƒ¨åŒ–ï¼Œå‡å°‘ä»£ç ä¿®æ”¹
- **ç»Ÿä¸€æ¥å£**: æ ‡å‡†åŒ–å­ç³»ç»Ÿé—´äº¤äº’åè®®
- **æ¨¡å—åŒ–è®¾è®¡**: å„ç»„ä»¶ç‹¬ç«‹æµ‹è¯•å’Œéƒ¨ç½²
- **ä¼˜åŠ¿**: é™ä½ç³»ç»Ÿç»´æŠ¤æˆæœ¬ï¼Œæé«˜å¼€å‘æ•ˆç‡

è¿™ç§æ¶æ„è®¾è®¡ä½“ç°äº†è½¯ä»¶å·¥ç¨‹çš„æœ€ä½³å®è·µï¼Œé€šè¿‡åˆ†å±‚å’Œæ¨¡å—åŒ–å®ç°äº†ç³»ç»Ÿçš„é«˜å†…èšã€ä½è€¦åˆï¼Œä¸ºç³»ç»Ÿçš„é•¿æœŸæ¼”è¿›å¥ å®šäº†åšå®åŸºç¡€ã€‚

# 4 è¯¦ç»†è®¾è®¡

åˆ†å­ç³»ç»Ÿç»™å‡ºè¯¦ç»†è®¾è®¡ï¼Œæ¯ä¸ªå­ç³»ç»Ÿç”¨åˆ°çš„ç±»ï¼Œç±»ä¹‹é—´çš„çš„å…³ç³»ï¼ˆè¯´æ˜+å›¾ç¤ºï¼‰

## 4.1 å…¥å£å±‚è¯¦ç»†è®¾è®¡

### 4.1.1 å­ç³»ç»Ÿæ¦‚è¿°

å…¥å£å±‚å­ç³»ç»Ÿæ˜¯ç³»ç»Ÿçš„å¯åŠ¨å…¥å£å’Œå…¨å±€åè°ƒä¸­å¿ƒï¼Œè´Ÿè´£ç¨‹åºåˆå§‹åŒ–ã€ä¸šåŠ¡æµç¨‹é€‰æ‹©ã€ç»„ä»¶è£…é…å’Œå…¨å±€é…ç½®ç®¡ç†ã€‚è¯¥å­ç³»ç»Ÿé‡‡ç”¨å•ä¸€å…¥å£æ¨¡å¼ï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¸šåŠ¡æµç¨‹çš„å¯åŠ¨å’Œé…ç½®ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚

### 4.1.2 æ ¸å¿ƒæ¨¡å—è®¾è®¡

#### main.py - ç³»ç»Ÿä¸»å…¥å£

**å®šä¹‰æ¥æº**ï¼šmain.py

```python
def main():
    """ç³»ç»Ÿä¸»å…¥å£å‡½æ•°"""
     1. åŸºç¡€é…ç½®éªŒè¯
    if not Config.validate_config():
        print("é…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒå˜é‡å’Œç›®å½•ç»“æ„")
        return
  
     2. ä¸šåŠ¡æµç¨‹é€‰æ‹©
    business_line, yaml_file = choose_flow()
  
    try:
         3. DSLè„šæœ¬åŠ è½½å’ŒéªŒè¯
        print(f"ğŸ“„ æ­£åœ¨åŠ è½½æµç¨‹å®šä¹‰: {yaml_file}")
        flow_config = YAMLFlowLoader.load(yaml_file)
        flow_info = YAMLFlowLoader.get_flow_info(flow_config)
  
         4. ä»DSLæ„å»ºæ§½ä½è§„æ ¼
        slot_specs = []
        for slot_name in flow_config['process_order']:
            slot_cfg = flow_config['slots'].get(slot_name, {})
            if slot_cfg:
                slot_spec = SlotSpec(
                    name=slot_name,
                    required=slot_cfg.get('required', True),
                    description=slot_cfg.get('description', slot_cfg.get('label', '')),
                    dependencies=slot_cfg.get('dependencies', []),
                    enums_key=slot_cfg.get('enums_key'),
                    semantic_stage=slot_cfg.get('semantic_stage'),
                    allow_llm=slot_cfg.get('allow_llm', False)
                )
                slot_specs.append(slot_spec)
  
         5. åŠ¨æ€æ³¨å…¥æ§½ä½è§„æ ¼åˆ°ä¸šåŠ¡é…ç½®
        business_config_loader.inject_slot_specs(business_line, slot_specs)
  
         6. åˆ›å»ºæ ¸å¿ƒç³»ç»Ÿç»„ä»¶
        form = FormBasedDialogSystem(business_line)
        interpreter = FlowInterpreter(flow_config, form)
  
         7. åˆ›å»ºæœåŠ¡ç»„ä»¶
        semantic_mapper = SemanticMapper()
        llm_client = build_llm_client()   å¯èƒ½è¿”å›Noneï¼ˆé™çº§æ¨¡å¼ï¼‰
  
         8. è§¦å‘åˆå§‹äº‹ä»¶
        if interpreter.last_response:
            display_response(interpreter.last_response)
  
         9. å¯åŠ¨ä¸»å¯¹è¯å¾ªç¯
        run_dialog_loop(interpreter, llm_client, semantic_mapper)
  
    except Exception as e:
        print(f"ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: {e}")
        return

def choose_flow() -> Tuple[str, str]:
    """
    é€‰æ‹©ä¸šåŠ¡æµç¨‹å’Œå¯¹åº”çš„DSLè„šæœ¬
  
    Returns:
        ä¸šåŠ¡çº¿æ ‡è¯†å’Œå¯¹åº”çš„YAMLæ–‡ä»¶è·¯å¾„
    """
    scripts_dir = Config.get_dsl_scripts_dir()
    available_flows = []
  
     æ‰«æå¯ç”¨çš„DSLè„šæœ¬
    for filename in os.listdir(scripts_dir):
        if filename.endswith('.flow.yaml'):
            business_name = filename[:-10]   å»æ‰.flow.yamlåç¼€
            available_flows.append((business_name, os.path.join(scripts_dir, filename)))
  
    if not available_flows:
        raise Exception("æœªæ‰¾åˆ°ä»»ä½•DSLæµç¨‹å®šä¹‰æ–‡ä»¶")
  
     æ˜¾ç¤ºé€‰æ‹©èœå•
    print("\n" + "="*50)
    print("   å¤šæ§½ä½ä¿¡æ¯é‡‡é›†å¯¹è¯ç³»ç»Ÿ")
    print("="*50)
    print("è¯·é€‰æ‹©ä¸šåŠ¡æµç¨‹ï¼š")
  
    for idx, (name, path) in enumerate(available_flows, 1):
         åŠ è½½æµç¨‹ä¿¡æ¯æ˜¾ç¤ºæè¿°
        try:
            flow_config = YAMLFlowLoader.load(path)
            flow_info = YAMLFlowLoader.get_flow_info(flow_config)
            description = flow_info.get('description', '')
            print(f"{idx}. {name} - {description}")
        except:
            print(f"{idx}. {name}")
  
    print(f"{len(available_flows) + 1}. é€€å‡ºç³»ç»Ÿ")
  
     ç”¨æˆ·é€‰æ‹©
    while True:
        choice = input("\nè¯·è¾“å…¥æ•°å­—é€‰æ‹©: ").strip()
        if choice == str(len(available_flows) + 1):
            print("æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼")
            sys.exit(0)
        elif choice.isdigit() and 1 <= int(choice) <= len(available_flows):
            business_name, yaml_file = available_flows[int(choice) - 1]
            return business_name, yaml_file
        else:
            print("æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥")

def build_llm_client() -> Optional[SparkLLMClient]:
    """
    æ„å»ºLLMå®¢æˆ·ç«¯å®ä¾‹
  
    Returns:
        LLMå®¢æˆ·ç«¯å®ä¾‹ï¼Œå¦‚æœé…ç½®ä¸å¯ç”¨åˆ™è¿”å›None
    """
    llm_config = Config.get_llm_config()
    api_key = llm_config.get('api_key')
  
    if not api_key:
        print("âš ï¸  æœªé…ç½®LLM APIå¯†é’¥ï¼Œå°†ç¦ç”¨AIç†è§£åŠŸèƒ½")
        print("   ç³»ç»Ÿå°†ä»…ä½¿ç”¨æœ¬åœ°è¯­ä¹‰åŒ¹é…")
        return None
  
    try:
        client = SparkLLMClient(
            api_key=api_key,
            api_url=llm_config.get('api_url'),
            model=llm_config.get('model')
        )
        print("âœ… LLMå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")
        return client
    except Exception as e:
        print(f"âš ï¸  LLMå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: {e}")
        print("   ç³»ç»Ÿå°†é™çº§åˆ°æœ¬åœ°è¯­ä¹‰åŒ¹é…æ¨¡å¼")
        return None

def run_dialog_loop(interpreter: FlowInterpreter, llm_client: Optional[SparkLLMClient], 
                   semantic_mapper: SemanticMapper):
    """
    è¿è¡Œä¸»å¯¹è¯å¾ªç¯
  
    Args:
        interpreter: æµç¨‹è§£é‡Šå™¨å®ä¾‹
        llm_client: LLMå®¢æˆ·ç«¯å®ä¾‹ï¼ˆå¯èƒ½ä¸ºNoneï¼‰
        semantic_mapper: è¯­ä¹‰æ˜ å°„å™¨å®ä¾‹
    """
    print("\n" + "="*50)
    print("å¯¹è¯å¼€å§‹ï¼è¾“å…¥'é€€å‡º'æˆ–'quit'ç»“æŸå¯¹è¯")
    print("="*50)
  
     æ˜¾ç¤ºåˆå§‹æç¤º
    initial_prompt = interpreter.form_system.get_initial_prompt()
    if initial_prompt:
        display_response(initial_prompt)
  
    while True:
        try:
             è·å–ç”¨æˆ·è¾“å…¥
            user_input = input("\nğŸ‘¤ æ‚¨: ").strip()
  
             é€€å‡ºæ¡ä»¶æ£€æŸ¥
            if user_input.lower() in ['é€€å‡º', 'quit', 'exit', 'q']:
                print("\næ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼ğŸ‘‹")
                break
  
            if not user_input:
                print("è¯·è¾“å…¥æœ‰æ•ˆå†…å®¹")
                continue
  
             å¤„ç†ç”¨æˆ·è¾“å…¥
            result = interpreter.process_input(
                user_input=user_input,
                llm_client=llm_client,
                semantic_mapper=semantic_mapper
            )
  
             æ˜¾ç¤ºç³»ç»Ÿå“åº”
            if result.get('response'):
                display_response(result['response'])
  
             æ£€æŸ¥æ˜¯å¦åº”è¯¥é€€å‡º
            if result.get('should_exit'):
                print("\nå¯¹è¯ç»“æŸï¼Œæ„Ÿè°¢ä½¿ç”¨ï¼ğŸ‘‹")
                break
  
        except KeyboardInterrupt:
            print("\n\næ£€æµ‹åˆ°ä¸­æ–­ä¿¡å·ï¼Œé€€å‡ºç³»ç»Ÿ")
            break
        except Exception as e:
            print(f"\nâŒ ç³»ç»Ÿé”™è¯¯: {e}")
            print("è¯·é‡æ–°è¾“å…¥æˆ–è¾“å…¥'é€€å‡º'ç»“æŸå¯¹è¯")

def display_response(response: str):
    """
    æ ¼å¼åŒ–æ˜¾ç¤ºç³»ç»Ÿå“åº”
  
    Args:
        response: ç³»ç»Ÿå“åº”æ–‡æœ¬
    """
    print(f"\nğŸ¤– ç³»ç»Ÿ: {response}")

def initialize_global_components():
    """
    åˆå§‹åŒ–å…¨å±€ç»„ä»¶
    """
    global business_config_loader
    business_config_loader = BusinessConfigLoader()
    print("âœ… å…¨å±€ç»„ä»¶åˆå§‹åŒ–å®Œæˆ")

if __name__ == "__main__":
     åˆå§‹åŒ–å…¨å±€ç»„ä»¶
    initialize_global_components()
  
     å¯åŠ¨ä¸»ç¨‹åº
    main()
```

#### Configç±» - å…¨å±€é…ç½®ç®¡ç†

**å®šä¹‰æ¥æº**ï¼šconfig/settings.py

```python
class Config:
    """å…¨å±€ç³»ç»Ÿé…ç½®ç®¡ç†"""
  
     é…ç½®ç¼“å­˜
    _config_cache: Optional[Dict[str, Any]] = None
  
    @staticmethod
    def validate_config() -> bool:
        """
        éªŒè¯å…¨å±€é…ç½®çš„å®Œæ•´æ€§
  
        Returns:
            é…ç½®éªŒè¯ç»“æœ
        """
        try:
             1. ç¯å¢ƒå˜é‡æ£€æŸ¥
            required_env_vars = ['SPARK_API_KEY']
            for env_var in required_env_vars:
                if not os.getenv(env_var):
                    print(f"âš ï¸  ç¼ºå°‘ç¯å¢ƒå˜é‡: {env_var}")
                    print("   ç³»ç»Ÿå°†ç¦ç”¨LLMåŠŸèƒ½ï¼Œä»…ä½¿ç”¨æœ¬åœ°è¯­ä¹‰åŒ¹é…")
  
             2. ç›®å½•ç»“æ„æ£€æŸ¥
            required_dirs = [
                Config.get_business_config_dir(),
                Config.get_dsl_scripts_dir()
            ]
  
            for directory in required_dirs:
                if not os.path.exists(directory):
                    print(f"âŒ ç›®å½•ä¸å­˜åœ¨: {directory}")
                    return False
  
             3. ä¸šåŠ¡é…ç½®æ£€æŸ¥
            config_loader = BusinessConfigLoader()
            try:
                config_loader._load_all_configs()
                if len(config_loader._configs) == 0:
                    print("âŒ æœªæ‰¾åˆ°ä»»ä½•ä¸šåŠ¡é…ç½®")
                    return False
                else:
                    print(f"âœ… åŠ è½½äº† {len(config_loader._configs)} ä¸ªä¸šåŠ¡é…ç½®")
            except Exception as e:
                print(f"âŒ ä¸šåŠ¡é…ç½®åŠ è½½å¤±è´¥: {e}")
                return False
  
             4. DSLè„šæœ¬æ£€æŸ¥
            scripts_dir = Config.get_dsl_scripts_dir()
            dsl_files = [f for f in os.listdir(scripts_dir) if f.endswith('.flow.yaml')]
            if not dsl_files:
                print("âŒ æœªæ‰¾åˆ°ä»»ä½•DSLæµç¨‹å®šä¹‰æ–‡ä»¶")
                return False
            else:
                print(f"âœ… æ‰¾åˆ° {len(dsl_files)} ä¸ªDSLæµç¨‹å®šä¹‰")
  
            print("âœ… é…ç½®éªŒè¯é€šè¿‡")
            return True
  
        except Exception as e:
            print(f"âŒ é…ç½®éªŒè¯å¤±è´¥: {e}")
            return False
  
    @staticmethod
    def get_llm_config() -> Dict[str, Any]:
        """
        è·å–LLMæœåŠ¡é…ç½®
  
        Returns:
            LLMé…ç½®å­—å…¸ï¼ŒåŒ…å«APIå¯†é’¥ã€ç«¯ç‚¹ç­‰
        """
        return {
            'api_key': os.getenv('SPARK_API_KEY', ''),
            'api_url': os.getenv('SPARK_API_URL', 'https://spark-api.xf-yun.com/v1/chat'),
            'model': os.getenv('SPARK_MODEL', 'lite'),
            'timeout': int(os.getenv('LLM_TIMEOUT', '30')),
            'max_tokens': int(os.getenv('LLM_MAX_TOKENS', '1000'))
        }
  
    @staticmethod
    def get_business_config_dir() -> str:
        """
        è·å–ä¸šåŠ¡é…ç½®ç›®å½•è·¯å¾„
  
        Returns:
            é…ç½®ç›®å½•ç»å¯¹è·¯å¾„
        """
        env_dir = os.getenv('BUSINESS_CONFIG_DIR')
        if env_dir:
            return env_dir
  
         é»˜è®¤è·¯å¾„ï¼šé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„knowledgeç›®å½•
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        return os.path.join(base_dir, 'knowledge')
  
    @staticmethod
    def get_dsl_scripts_dir() -> str:
        """
        è·å–DSLè„šæœ¬ç›®å½•è·¯å¾„
  
        Returns:
            DSLè„šæœ¬ç›®å½•ç»å¯¹è·¯å¾„
        """
        env_dir = os.getenv('DSL_SCRIPTS_DIR')
        if env_dir:
            return env_dir
  
         é»˜è®¤è·¯å¾„ï¼šé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„scriptsç›®å½•
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        return os.path.join(base_dir, 'scripts')
  
    @staticmethod
    def get_log_config() -> Dict[str, Any]:
        """
        è·å–æ—¥å¿—é…ç½®
  
        Returns:
            æ—¥å¿—é…ç½®å­—å…¸
        """
        return {
            'level': os.getenv('LOG_LEVEL', 'INFO'),
            'format': '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            'file': os.getenv('LOG_FILE', 'logs/dialog_system.log')
        }
  
    @staticmethod
    def get_feature_flags() -> Dict[str, bool]:
        """
        è·å–åŠŸèƒ½å¼€å…³é…ç½®
  
        Returns:
            åŠŸèƒ½å¼€å…³å­—å…¸
        """
        return {
            'enable_llm': os.getenv('ENABLE_LLM', 'true').lower() == 'true',
            'enable_semantic_mapping': os.getenv('ENABLE_SEMANTIC_MAPPING', 'true').lower() == 'true',
            'enable_validation': os.getenv('ENABLE_VALIDATION', 'true').lower() == 'true',
            'debug_mode': os.getenv('DEBUG_MODE', 'false').lower() == 'true'
        }
  
    @staticmethod
    def get_performance_config() -> Dict[str, Any]:
        """
        è·å–æ€§èƒ½ç›¸å…³é…ç½®
  
        Returns:
            æ€§èƒ½é…ç½®å­—å…¸
        """
        return {
            'max_concurrent_requests': int(os.getenv('MAX_CONCURRENT_REQUESTS', '5')),
            'request_timeout': int(os.getenv('REQUEST_TIMEOUT', '30')),
            'cache_ttl': int(os.getenv('CACHE_TTL', '300'))   5åˆ†é’Ÿ
        }
```

### 4.1.3 å…³é”®æ•°æ®ç»“æ„

#### ç³»ç»Ÿé…ç½®ç»“æ„

```python
@dataclass
class SystemConfig:
    """ç³»ç»Ÿé…ç½®æ•°æ®ç»“æ„"""
    business_config_dir: str
    dsl_scripts_dir: str
    llm_api_key: Optional[str]
    llm_api_url: str
    llm_model: str
    log_level: str
    log_format: str
    enable_llm: bool
    enable_semantic_mapping: bool
    enable_validation: bool
    debug_mode: bool
```

#### å¯¹è¯ç³»ç»ŸçŠ¶æ€

```python
@dataclass
class DialogState:
    """å¯¹è¯çŠ¶æ€è®°å½•"""
    current_business: str
    start_time: datetime
    turn_count: int
    last_input: str
    last_response: str
    llm_enabled: bool
    semantic_mapping_enabled: bool
```

#### åˆå§‹åŒ–ç»“æœç»“æ„

```python
@dataclass
class InitializationResult:
    """ç³»ç»Ÿåˆå§‹åŒ–ç»“æœ"""
    success: bool
    business_line: str
    flow_config: Dict[str, Any]
    form_system: FormBasedDialogSystem
    interpreter: FlowInterpreter
    llm_client: Optional[SparkLLMClient]
    semantic_mapper: SemanticMapper
    error_message: Optional[str] = None
```

### 4.1.4 æ ¸å¿ƒç®—æ³•å®ç°

#### ç³»ç»Ÿåˆå§‹åŒ–ç®—æ³•

**å®ç°æ¥æº**ï¼šmain.py

```python
def initialize_system(business_line: str, yaml_file: str) -> InitializationResult:
    """
    ç³»ç»Ÿåˆå§‹åŒ–ç®—æ³•
  
    Args:
        business_line: ä¸šåŠ¡çº¿æ ‡è¯†
        yaml_file: YAMLæµç¨‹å®šä¹‰æ–‡ä»¶è·¯å¾„
  
    Returns:
        åˆå§‹åŒ–ç»“æœå¯¹è±¡
    """
    try:
         1. åŠ è½½DSLæµç¨‹é…ç½®
        print(f"ğŸ“„ æ­£åœ¨åŠ è½½æµç¨‹å®šä¹‰: {yaml_file}")
        flow_config = YAMLFlowLoader.load(yaml_file)
        flow_info = YAMLFlowLoader.get_flow_info(flow_config)
        print(f"âœ… æµç¨‹åŠ è½½æˆåŠŸ: {flow_info.get('name')} - {flow_info.get('description')}")
  
         2. ä»DSLæ„å»ºæ§½ä½è§„æ ¼
        slot_specs = []
        for slot_name in flow_config['process_order']:
            slot_cfg = flow_config['slots'].get(slot_name, {})
            if slot_cfg:
                slot_spec = SlotSpec(
                    name=slot_name,
                    required=slot_cfg.get('required', True),
                    description=slot_cfg.get('description', slot_cfg.get('label', '')),
                    dependencies=slot_cfg.get('dependencies', []),
                    enums_key=slot_cfg.get('enums_key'),
                    semantic_stage=slot_cfg.get('semantic_stage'),
                    allow_llm=slot_cfg.get('allow_llm', False)
                )
                slot_specs.append(slot_spec)
  
        print(f"âœ… ä»DSLç”Ÿæˆäº† {len(slot_specs)} ä¸ªæ§½ä½è§„æ ¼")
  
         3. åŠ¨æ€æ³¨å…¥æ§½ä½è§„æ ¼åˆ°ä¸šåŠ¡é…ç½®
        business_config_loader.inject_slot_specs(business_line, slot_specs)
        print(f"âœ… æ§½ä½è§„æ ¼å·²æ³¨å…¥ä¸šåŠ¡é…ç½®: {business_line}")
  
         4. åˆ›å»ºæ ¸å¿ƒç³»ç»Ÿç»„ä»¶
        form_system = FormBasedDialogSystem(business_line)
        interpreter = FlowInterpreter(flow_config, form_system)
        print("âœ… æ ¸å¿ƒç³»ç»Ÿç»„ä»¶åˆ›å»ºå®Œæˆ")
  
         5. åˆ›å»ºæœåŠ¡ç»„ä»¶
        semantic_mapper = SemanticMapper()
        llm_client = build_llm_client()
  
        feature_flags = Config.get_feature_flags()
        if llm_client and feature_flags['enable_llm']:
            print("âœ… LLMæœåŠ¡å·²å¯ç”¨")
        else:
            print("âš ï¸  LLMæœåŠ¡å·²ç¦ç”¨ï¼Œä½¿ç”¨æœ¬åœ°è¯­ä¹‰åŒ¹é…")
  
        if feature_flags['enable_semantic_mapping']:
            print("âœ… è¯­ä¹‰æ˜ å°„æœåŠ¡å·²å¯ç”¨")
        else:
            print("âš ï¸  è¯­ä¹‰æ˜ å°„æœåŠ¡å·²ç¦ç”¨")
  
        return InitializationResult(
            success=True,
            business_line=business_line,
            flow_config=flow_config,
            form_system=form_system,
            interpreter=interpreter,
            llm_client=llm_client,
            semantic_mapper=semantic_mapper
        )
  
    except FileNotFoundError as e:
        error_msg = f"æ–‡ä»¶æœªæ‰¾åˆ°: {e}"
        print(f"âŒ {error_msg}")
        return InitializationResult(success=False, error_message=error_msg)
    except yaml.YAMLError as e:
        error_msg = f"YAMLæ ¼å¼é”™è¯¯: {e}"
        print(f"âŒ {error_msg}")
        return InitializationResult(success=False, error_message=error_msg)
    except ValueError as e:
        error_msg = f"é…ç½®éªŒè¯å¤±è´¥: {e}"
        print(f"âŒ {error_msg}")
        return InitializationResult(success=False, error_message=error_msg)
    except Exception as e:
        error_msg = f"ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: {e}"
        print(f"âŒ {error_msg}")
        return InitializationResult(success=False, error_message=error_msg)
```

#### ä¸šåŠ¡æµç¨‹é€‰æ‹©ç®—æ³•

**å®ç°æ¥æº**ï¼šmain.py

```python
def choose_flow() -> Tuple[str, str]:
    """
    ä¸šåŠ¡æµç¨‹é€‰æ‹©ç®—æ³•
  
    Returns:
        ä¸šåŠ¡çº¿æ ‡è¯†å’Œå¯¹åº”çš„YAMLæ–‡ä»¶è·¯å¾„
    """
    scripts_dir = Config.get_dsl_scripts_dir()
    available_flows = []
  
     æ‰«æå¯ç”¨çš„DSLè„šæœ¬
    for filename in os.listdir(scripts_dir):
        if filename.endswith('.flow.yaml'):
            business_name = filename[:-10]   å»æ‰.flow.yamlåç¼€
            file_path = os.path.join(scripts_dir, filename)
  
             éªŒè¯æ–‡ä»¶å¯è¯»æ€§
            try:
                flow_config = YAMLFlowLoader.load(file_path)
                flow_info = YAMLFlowLoader.get_flow_info(flow_config)
                available_flows.append((business_name, file_path, flow_info))
            except Exception as e:
                print(f"âš ï¸  è·³è¿‡æ— æ•ˆçš„DSLæ–‡ä»¶ {filename}: {e}")
                continue
  
    if not available_flows:
        raise Exception("æœªæ‰¾åˆ°ä»»ä½•å¯ç”¨çš„DSLæµç¨‹å®šä¹‰æ–‡ä»¶")
  
     æ˜¾ç¤ºé€‰æ‹©èœå•
    print("\n" + "="*60)
    print("          å¤šæ§½ä½ä¿¡æ¯é‡‡é›†å¯¹è¯ç³»ç»Ÿ")
    print("="*60)
    print("å¯ç”¨çš„ä¸šåŠ¡æµç¨‹ï¼š")
  
    for idx, (name, path, info) in enumerate(available_flows, 1):
        name_display = info.get('name', name)
        description = info.get('description', '')
        version = info.get('version', '1.0')
        print(f"{idx}. {name_display} (v{version})")
        print(f"   {description}")
        if idx < len(available_flows):
            print()
  
    print(f"\n{len(available_flows) + 1}. é€€å‡ºç³»ç»Ÿ")
    print("="*60)
  
     ç”¨æˆ·é€‰æ‹©å¤„ç†
    while True:
        try:
            choice = input("\nè¯·è¾“å…¥æ•°å­—é€‰æ‹©: ").strip()
  
            if choice == str(len(available_flows) + 1):
                print("æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼")
                sys.exit(0)
  
            if choice.isdigit() and 1 <= int(choice) <= len(available_flows):
                business_name, file_path, flow_info = available_flows[int(choice) - 1]
                selected_name = flow_info.get('name', business_name)
                print(f"âœ… å·²é€‰æ‹©: {selected_name}")
                return business_name, file_path
            else:
                print("âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥")
  
        except KeyboardInterrupt:
            print("\n\næ£€æµ‹åˆ°ä¸­æ–­ä¿¡å·ï¼Œé€€å‡ºç³»ç»Ÿ")
            sys.exit(0)
        except EOFError:
            print("\n\nè¾“å…¥ç»“æŸï¼Œé€€å‡ºç³»ç»Ÿ")
            sys.exit(0)
```

#### é”™è¯¯å¤„ç†ç®—æ³•

**å®ç°æ¥æº**ï¼šmain.py

```python
def handle_initialization_error(error_result: InitializationResult):
    """
    åˆå§‹åŒ–é”™è¯¯å¤„ç†ç®—æ³•
  
    Args:
        error_result: åˆå§‹åŒ–é”™è¯¯ç»“æœ
    """
    print(f"\nâŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: {error_result.error_message}")
    print("\nå¯èƒ½çš„åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼š")
  
    if "æ–‡ä»¶æœªæ‰¾åˆ°" in error_result.error_message:
        print("â€¢ æ£€æŸ¥DSLè„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨")
        print("â€¢ ç¡®è®¤æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®")
        print("â€¢ éªŒè¯æ–‡ä»¶è¯»å–æƒé™")
  
    elif "YAMLæ ¼å¼é”™è¯¯" in error_result.error_message:
        print("â€¢ æ£€æŸ¥YAMLæ–‡ä»¶è¯­æ³•")
        print("â€¢ éªŒè¯ç¼©è¿›å’Œæ ¼å¼")
        print("â€¢ æ£€æŸ¥å¿…éœ€çš„é…ç½®å­—æ®µ")
  
    elif "é…ç½®éªŒè¯å¤±è´¥" in error_result.error_message:
        print("â€¢ æ£€æŸ¥ä¸šåŠ¡é…ç½®å®Œæ•´æ€§")
        print("â€¢ éªŒè¯æ§½ä½ä¾èµ–å…³ç³»")
        print("â€¢ ç¡®è®¤æšä¸¾é”®åå­˜åœ¨")
  
    elif "ä¸šåŠ¡é…ç½®åŠ è½½å¤±è´¥" in error_result.error_message:
        print("â€¢ æ£€æŸ¥ä¸šåŠ¡é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨")
        print("â€¢ éªŒè¯JSONæ–‡ä»¶æ ¼å¼")
        print("â€¢ ç¡®è®¤é…ç½®ç›®å½•æƒé™")
  
    else:
        print("â€¢ æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯")
        print("â€¢ æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—")
        print("â€¢ è”ç³»ç³»ç»Ÿç®¡ç†å‘˜")
  
    print(f"\næŠ€æœ¯æ”¯æŒä¿¡æ¯: {error_result.error_message}")

def graceful_shutdown(interpreter: Optional[FlowInterpreter] = None):
    """
    ä¼˜é›…å…³é—­ç®—æ³•
  
    Args:
        interpreter: æµç¨‹è§£é‡Šå™¨å®ä¾‹
    """
    print("\næ­£åœ¨å…³é—­ç³»ç»Ÿ...")
  
    try:
         ä¿å­˜ä¼šè¯çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
        if interpreter and hasattr(interpreter, 'form_system'):
            print("ğŸ’¾ ä¿å­˜å¯¹è¯çŠ¶æ€...")
             è¿™é‡Œå¯ä»¥æ·»åŠ çŠ¶æ€ä¿å­˜é€»è¾‘
  
         å…³é—­LLMè¿æ¥
        print("ğŸ”Œ å…³é—­æœåŠ¡è¿æ¥...")
  
         æ¸…ç†èµ„æº
        print("ğŸ§¹ æ¸…ç†ç³»ç»Ÿèµ„æº...")
  
    except Exception as e:
        print(f"âš ï¸  å…³é—­è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
  
    finally:
        print("âœ… ç³»ç»Ÿå…³é—­å®Œæˆ")
        sys.exit(0)
```

### 4.1.5 ç±»åä½œå…³ç³»

#### ç±»å…³ç³»å›¾ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      main       â”‚    â”‚      Config      â”‚
â”‚                 â”‚    â”‚                  â”‚
â”‚ - main()        â”‚    â”‚ - validate_config()â”‚
â”‚ - choose_flow() â”‚    â”‚ - get_xxx()      â”‚
â”‚ - run_dialog()  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
         â”‚                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚                 â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                       â”‚ BusinessConfig  â”‚ â”‚ YAMLFlowLoaderâ”‚
                       â”‚ Loader          â”‚ â”‚             â”‚
                       â”‚ - inject_specs()â”‚ â”‚ - load()    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ æ ¸å¿ƒç³»ç»Ÿç»„ä»¶     â”‚
                       â”‚                 â”‚
                       â”‚ - FormBased     â”‚
                       â”‚   DialogSystem  â”‚
                       â”‚ - FlowInterpreterâ”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚              â”‚              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ SparkLLMClient â”‚ â”‚Semantic  â”‚ â”‚ å…¶ä»–æœåŠ¡ç»„ä»¶ â”‚
         â”‚               â”‚ â”‚Mapper    â”‚ â”‚             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åä½œæµç¨‹è¯´æ˜

1. **ç³»ç»Ÿå¯åŠ¨æµç¨‹**ï¼š

   - `main()` å‡½æ•°ä½œä¸ºç¨‹åºå…¥å£ç‚¹
   - `Config.validate_config()` éªŒè¯ç³»ç»Ÿé…ç½®å®Œæ•´æ€§
   - `choose_flow()` æä¾›ä¸šåŠ¡æµç¨‹é€‰æ‹©ç•Œé¢
   - `initialize_system()` åˆå§‹åŒ–æ‰€æœ‰ç³»ç»Ÿç»„ä»¶
2. **ç»„ä»¶è£…é…æµç¨‹**ï¼š

   - åŠ è½½DSLè„šæœ¬å¹¶é€šè¿‡ `YAMLFlowLoader` è§£æ
   - ä»DSLé…ç½®ç”Ÿæˆæ§½ä½è§„æ ¼
   - é€šè¿‡ `BusinessConfigLoader.inject_slot_specs()` åŠ¨æ€æ³¨å…¥é…ç½®
   - åˆ›å»ºæ ¸å¿ƒç³»ç»Ÿç»„ä»¶ï¼š`FormBasedDialogSystem` å’Œ `FlowInterpreter`
   - åˆ›å»ºæœåŠ¡ç»„ä»¶ï¼š`SparkLLMClient` å’Œ `SemanticMapper`
3. **å¯¹è¯å¾ªç¯ç®¡ç†**ï¼š

   - `run_dialog_loop()` ç®¡ç†ä¸»å¯¹è¯å¾ªç¯
   - æ¥æ”¶ç”¨æˆ·è¾“å…¥å¹¶å§”æ‰˜ç»™ `FlowInterpreter` å¤„ç†
   - åè°ƒLLMå®¢æˆ·ç«¯å’Œè¯­ä¹‰æ˜ å°„å™¨çš„ä½¿ç”¨
   - å¤„ç†ç”¨æˆ·ä¸­æ–­å’Œå¼‚å¸¸æƒ…å†µ
4. **é”™è¯¯å¤„ç†åä½œ**ï¼š

   - é…ç½®éªŒè¯å¤±è´¥æ—¶æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - ç»„ä»¶åˆå§‹åŒ–å¤±è´¥æ—¶ä¼˜é›…é™çº§
   - ç”¨æˆ·è¾“å…¥å¼‚å¸¸æ—¶æä¾›å‹å¥½çš„é”™è¯¯æç¤º
   - ç³»ç»Ÿå…³é—­æ—¶æ¸…ç†èµ„æºå¹¶ä¿å­˜çŠ¶æ€
5. **é…ç½®ç®¡ç†åä½œ**ï¼š

   - `Config` ç±»é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®å‚æ•°
   - æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤é…ç½®
   - æä¾›ç±»å‹å®‰å…¨çš„é…ç½®è®¿é—®æ¥å£
   - éªŒè¯é…ç½®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§

#### æ•°æ®æµå‘

```
å‘½ä»¤è¡Œå¯åŠ¨
    â†“
main() â†’ é…ç½®éªŒè¯ â†’ ä¸šåŠ¡æµç¨‹é€‰æ‹©
    â†“
ç»„ä»¶åˆå§‹åŒ–
    â”œâ”€â”€â†’ DSLåŠ è½½ â†’ æ§½ä½è§„æ ¼ç”Ÿæˆ â†’ é…ç½®æ³¨å…¥
    â”œâ”€â”€â†’ è¡¨å•ç³»ç»Ÿåˆ›å»º
    â”œâ”€â”€â†’ è§£é‡Šå™¨åˆ›å»º
    â”œâ”€â”€â†’ LLMå®¢æˆ·ç«¯åˆ›å»º
    â””â”€â”€â†’ è¯­ä¹‰æ˜ å°„å™¨åˆ›å»º
    â†“
ä¸»å¯¹è¯å¾ªç¯
    â”œâ”€â”€â†’ ç”¨æˆ·è¾“å…¥ â†’ è§£é‡Šå™¨å¤„ç† â†’ ç³»ç»Ÿå“åº”
    â”œâ”€â”€â†’ LLMæœåŠ¡è°ƒç”¨ï¼ˆå¯é€‰ï¼‰
    â”œâ”€â”€â†’ è¯­ä¹‰æ˜ å°„è°ƒç”¨
    â””â”€â”€â†’ çŠ¶æ€ç®¡ç†å’ŒæŒä¹…åŒ–
    â†“
ä¼˜é›…å…³é—­
    â”œâ”€â”€â†’ çŠ¶æ€ä¿å­˜
    â”œâ”€â”€â†’ èµ„æºæ¸…ç†
    â””â”€â”€â†’ è¿æ¥å…³é—­
```

è¿™ç§è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿçš„æ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§ï¼Œå…¥å£å±‚è´Ÿè´£åè°ƒå„ä¸ªå­ç³»ç»Ÿï¼Œè€Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ç”±ä¸“é—¨çš„å­ç³»ç»Ÿå¤„ç†ã€‚é€šè¿‡é…ç½®é©±åŠ¨çš„æ–¹å¼ï¼Œç³»ç»Ÿå¯ä»¥çµæ´»é€‚åº”ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼ŒåŒæ—¶æä¾›äº†å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·äº¤äº’ä½“éªŒã€‚

## 4.2 DSLå¼•æ“å±‚è¯¦ç»†è®¾è®¡

### 4.2.1 å­ç³»ç»Ÿæ¦‚è¿°

DSLå¼•æ“å±‚è´Ÿè´£ä¸šåŠ¡åœºæ™¯çš„YAMLæµç¨‹å®šä¹‰è§£æã€éªŒè¯å’Œæ‰§è¡Œï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„ä¸šåŠ¡æµç¨‹é©±åŠ¨æ ¸å¿ƒã€‚è¯¥å­ç³»ç»Ÿå°†ä¸šåŠ¡é€»è¾‘ä»ä»£ç ä¸­å®Œå…¨æŠ½ç¦»ï¼Œé€šè¿‡å£°æ˜å¼çš„DSLè„šæœ¬å®šä¹‰å®Œæ•´çš„å¯¹è¯æµç¨‹ï¼Œå®ç°"é…ç½®å³é€»è¾‘"çš„è®¾è®¡ç†å¿µã€‚

### 4.2.2 æ ¸å¿ƒç±»è®¾è®¡

#### YAMLFlowLoaderç±»

**å®šä¹‰æ¥æº**ï¼šyaml_flow_loader.py

```python
class YAMLFlowLoader:
    """YAMLæµç¨‹é…ç½®åŠ è½½å™¨"""
  
    @staticmethod
    def load(yaml_file: str) -> Dict[str, Any]:
        """
        åŠ è½½å’ŒéªŒè¯YAMLæµç¨‹å®šä¹‰æ–‡ä»¶
  
        Args:
            yaml_file: YAMLæ–‡ä»¶è·¯å¾„ï¼Œæ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„
  
        Returns:
            æµç¨‹é…ç½®å­—å…¸ï¼ŒåŒ…å«nameã€process_orderã€slotsç­‰å­—æ®µ
  
        Raises:
            FileNotFoundError: æ–‡ä»¶ä¸å­˜åœ¨æ—¶æŠ›å‡º
            yaml.YAMLError: YAMLæ ¼å¼é”™è¯¯æ—¶æŠ›å‡º  
            ValueError: é…ç½®éªŒè¯å¤±è´¥æ—¶æŠ›å‡º
        """
  
    @staticmethod
    def validate(flow_config: Dict[str, Any]) -> bool:
        """
        éªŒè¯æµç¨‹é…ç½®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
  
        Args:
            flow_config: æµç¨‹é…ç½®å­—å…¸
  
        Returns:
            Trueè¡¨ç¤ºéªŒè¯é€šè¿‡ï¼ŒFalseè¡¨ç¤ºéªŒè¯å¤±è´¥
  
        Raises:
            ValueError: é…ç½®ç¼ºå°‘å¿…éœ€å­—æ®µæˆ–å­˜åœ¨é€»è¾‘é”™è¯¯æ—¶æŠ›å‡º
        """
  
    @staticmethod
    def get_flow_info(flow_config: Dict[str, Any]) -> Dict[str, str]:
        """
        æå–æµç¨‹çš„åŸºæœ¬ä¿¡æ¯
  
        Args:
            flow_config: æµç¨‹é…ç½®å­—å…¸
  
        Returns:
            åŒ…å«æµç¨‹åç§°ã€ç‰ˆæœ¬ã€æè¿°ç­‰ä¿¡æ¯å­—å…¸
        """
```

**èŒè´£è¯´æ˜**ï¼š

- DSLé…ç½®æ–‡ä»¶çš„åŠ è½½å’Œè¯­æ³•è§£æ
- æ‰§è¡Œé…ç½®å®Œæ•´æ€§éªŒè¯ï¼Œç¡®ä¿å¿…éœ€å­—æ®µå­˜åœ¨
- æä¾›æµç¨‹å…ƒä¿¡æ¯çš„æŸ¥è¯¢æ¥å£
- æ”¯æŒé…ç½®ç‰ˆæœ¬ç®¡ç†å’Œçƒ­é‡è½½

#### FlowInterpreterç±»

**å®šä¹‰æ¥æº**ï¼šflow_interpreter.py

```python
class FlowInterpreter:
    """æµç¨‹è§£é‡Šå™¨"""
  
    def __init__(self, flow_config: Dict[str, Any], form_system: FormBasedDialogSystem):
        """
        åˆå§‹åŒ–æµç¨‹è§£é‡Šå™¨
  
        Args:
            flow_config: é€šè¿‡YAMLFlowLoaderåŠ è½½çš„æµç¨‹é…ç½®
            form_system: è¡¨å•ç³»ç»Ÿå®ä¾‹ï¼Œç”¨äºå®é™…ä¸šåŠ¡å¤„ç†
        """
  
    def process_input(self, user_input: str, llm_client=None, semantic_mapper=None) -> Dict[str, Any]:
        """
        å¤„ç†ç”¨æˆ·è¾“å…¥å¹¶æ‰§è¡ŒDSLé€»è¾‘
  
        Args:
            user_input: ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹
            llm_client: å¯é€‰çš„LLMå®¢æˆ·ç«¯ï¼Œç”¨äºAIå¢å¼ºç†è§£
            semantic_mapper: å¯é€‰çš„è¯­ä¹‰æ˜ å°„å™¨ï¼Œç”¨äºæœ¬åœ°è¯­ä¹‰åŒ¹é…
  
        Returns:
            å¤„ç†ç»“æœå­—å…¸ï¼ŒåŒ…å«:
            - response: ç³»ç»Ÿå“åº”æ–‡æœ¬
            - action: æ‰§è¡Œçš„åŠ¨ä½œæ ‡è¯†ï¼ˆå¯é€‰ï¼‰
            - should_exit: æ˜¯å¦åº”è¯¥é€€å‡ºå¯¹è¯ï¼ˆå¯é€‰ï¼‰
        """
  
    def _handle_events(self, event_name: str) -> List[str]:
        """
        å¤„ç†æŒ‡å®šäº‹ä»¶çš„åŠ¨ä½œåºåˆ—
  
        Args:
            event_name: äº‹ä»¶åç§°ï¼Œå¦‚'on_start'ã€'on_all_filled'
  
        Returns:
            äº‹ä»¶å¤„ç†ç”Ÿæˆçš„å“åº”æ–‡æœ¬åˆ—è¡¨
        """
  
    def _execute_command(self, command_name: str) -> Dict[str, Any]:
        """
        æ‰§è¡Œç”¨æˆ·å‘½ä»¤
  
        Args:
            command_name: å‘½ä»¤åç§°ï¼Œå¦‚'restart'ã€'confirm'
  
        Returns:
            å‘½ä»¤æ‰§è¡Œç»“æœå­—å…¸
        """
  
    def _identify_command(self, user_input: str) -> Optional[str]:
        """
        è¯†åˆ«ç”¨æˆ·è¾“å…¥ä¸­çš„å‘½ä»¤
  
        Args:
            user_input: ç”¨æˆ·è¾“å…¥æ–‡æœ¬
  
        Returns:
            è¯†åˆ«åˆ°çš„å‘½ä»¤åç§°ï¼Œå¦‚æ— å‘½ä»¤è¿”å›None
        """
```

**èŒè´£è¯´æ˜**ï¼š

- è§£é‡ŠDSLè„šæœ¬ä¸­çš„æµç¨‹å®šä¹‰å’Œæ§åˆ¶é€»è¾‘
- ç®¡ç†ç”¨æˆ·å‘½ä»¤çš„è¯†åˆ«å’Œæ˜ å°„æ‰§è¡Œ
- è§¦å‘é¢„å®šä¹‰çš„äº‹ä»¶å¤„ç†é“¾
- ç»´æŠ¤æµç¨‹æ‰§è¡ŒçŠ¶æ€å’Œä¸Šä¸‹æ–‡

### 4.2.3 å…³é”®æ•°æ®ç»“æ„

#### DSLæµç¨‹é…ç½®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šYAML DSLæ–‡ä»¶ï¼ˆå¦‚apple_store.flow.yamlï¼‰

```yaml
flow:
  name: string                     æµç¨‹åç§°
  version: string                  ç‰ˆæœ¬å·
  description: string              æµç¨‹æè¿°
  business_line: string            ä¸šåŠ¡çº¿æ ‡è¯†
  
  process_order:                   æ§½ä½å¤„ç†é¡ºåº
    - category
    - brand
    - series
  
  slots:                           æ§½ä½å®šä¹‰å­—å…¸
    category:
      label: "äº§å“å¤§ç±»"
      description: "é€‰æ‹©äº§å“ç±»å‹" 
      required: true
      type: enum
      enums_key: category
      dependencies: []
  
  events:                          äº‹ä»¶å¤„ç†å™¨
    on_start:
      - action: reset_form
      - action: show_template
        template: form_welcome
  
  commands:                        ç”¨æˆ·å‘½ä»¤æ˜ å°„
    restart:
      keywords: ["é‡æ–°å¼€å§‹", "reset"]
      action: restart_flow
```

#### æ§½ä½é…ç½®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šYAML DSLæ–‡ä»¶ä¸­çš„slotséƒ¨åˆ†

```yaml
slots:
  category:
    label: "äº§å“å¤§ç±»"
    description: "é€‰æ‹©äº§å“ç±»å‹"
    required: true
    allow_llm: false
    type: enum
    enums_key: category
    dependencies: []
    prompt_template: form_category_prompt
  
  chip:
    label: "å¤„ç†å™¨èŠ¯ç‰‡" 
    description: "é€‰æ‹©å¤„ç†å™¨å‹å·"
    required: true
    allow_llm: true
    type: enum
    enums_key: chip
    dependencies: [category, series, size]
    semantic_stage: chip_selection
    validation:
      must_be_valid_enum: true
      min_confidence: 0.35
```

#### äº‹ä»¶å¤„ç†é…ç½®ç»“æ„

```yaml
events:
  on_start:                        æµç¨‹å¼€å§‹äº‹ä»¶
    - action: <action_name>        åŠ¨ä½œåç§°
      template: <template_key>     å¯é€‰ï¼šæ¨¡æ¿é”®å
  
  on_all_filled:                   æ‰€æœ‰æ§½ä½å¡«å……å®Œæˆäº‹ä»¶  
    - action: show_summary
    - action: ask_confirm
  
  on_confirm:                      ç”¨æˆ·ç¡®è®¤äº‹ä»¶
    - action: validate_form
    - action: submit_order
    - action: show_template
      template: form_order_confirmed
```

#### å‘½ä»¤æ˜ å°„é…ç½®ç»“æ„

```yaml
commands:
  restart:                         å‘½ä»¤åç§°
    keywords:                      è§¦å‘å…³é”®è¯åˆ—è¡¨
      - "é‡æ–°å¼€å§‹"
      - "reset"
    action: restart_flow           æ‰§è¡ŒåŠ¨ä½œ
    available_when: always         å¯ç”¨æ¡ä»¶
  
  confirm:
    keywords: ["ç¡®è®¤", "å¥½çš„", "ok"]
    action: confirm_order
    condition: all_slots_filled    æ‰§è¡Œæ¡ä»¶
  
  help:
    keywords: ["å¸®åŠ©", "help"]  
    action: show_help
    response: |                    ç›´æ¥å“åº”å†…å®¹
      ä½¿ç”¨å¸®åŠ©ï¼š
      â€¢ æŒ‰ç…§æç¤ºé€‰æ‹©é…ç½®
      â€¢ è¯´"é‡é€‰"ä¿®æ”¹ä¹‹å‰é€‰æ‹©
```

### 4.2.4 æ ¸å¿ƒç®—æ³•å®ç°

#### DSLé…ç½®éªŒè¯ç®—æ³•

**å®ç°æ¥æº**ï¼šyaml_flow_loader.py

```python
def validate(flow_config: Dict[str, Any]) -> bool:
    """DSLé…ç½®éªŒè¯ç®—æ³•"""
     1. å¿…éœ€å­—æ®µæ£€æŸ¥
    required_fields = ['flow', 'name', 'process_order', 'slots']
    for field in required_fields:
        if field not in flow_config:
            raise ValueError(f"ç¼ºå°‘å¿…éœ€å­—æ®µ: {field}")
  
     2. æ§½ä½ä¾èµ–å…³ç³»éªŒè¯
    slots = flow_config['slots']
    process_order = flow_config['process_order']
  
    for slot_name, slot_config in slots.items():
        dependencies = slot_config.get('dependencies', [])
        for dep in dependencies:
            if dep not in slots:
                raise ValueError(f"æ§½ä½ {slot_name} ä¾èµ–ä¸å­˜åœ¨çš„æ§½ä½: {dep}")
             æ£€æŸ¥ä¾èµ–é¡ºåº
            if dep in process_order and process_order.index(dep) > process_order.index(slot_name):
                raise ValueError(f"æ§½ä½ {slot_name} åœ¨ä¾èµ– {dep} ä¹‹å‰å¤„ç†")
  
     3. ä¸šåŠ¡çº¿é…ç½®å­˜åœ¨æ€§éªŒè¯
    business_line = flow_config.get('business_line')
    if not business_line:
        raise ValueError("æµç¨‹é…ç½®ç¼ºå°‘business_lineå­—æ®µ")
  
     4. æšä¸¾é”®å¼•ç”¨éªŒè¯
    for slot_name, slot_config in slots.items():
        if slot_config.get('type') == 'enum':
            enums_key = slot_config.get('enums_key')
            if not enums_key:
                raise ValueError(f"æšä¸¾ç±»å‹æ§½ä½ {slot_name} ç¼ºå°‘enums_keyé…ç½®")
  
    return True
```

**è®¾è®¡æ€è·¯**ï¼šé€šè¿‡ä¸¥æ ¼çš„é…ç½®éªŒè¯ï¼Œç¡®ä¿DSLè„šæœ¬çš„é€»è¾‘æ­£ç¡®æ€§ï¼Œé˜²æ­¢é”™è¯¯çš„é…ç½®å½±å“ç³»ç»Ÿè¿è¡Œã€‚

#### äº‹ä»¶å¤„ç†é“¾æ‰§è¡Œç®—æ³•

**å®ç°æ¥æº**ï¼šflow_interpreter.py

```python
def _handle_events(self, event_name: str) -> List[str]:
    """äº‹ä»¶å¤„ç†é“¾æ‰§è¡Œç®—æ³•"""
    responses = []
    events_config = self.flow_config.get('events', {})
    event_actions = events_config.get(event_name, [])
  
    for action_config in event_actions:
        action_type = action_config['action']
  
        if action_type == 'show_template':
            template_key = action_config['template']
            template_lines = business_config_loader.get_template(
                self.flow_config['business_line'], template_key)
            if template_lines:
                responses.append("\n".join(template_lines))
  
        elif action_type == 'reset_form':
            self.form_system._reset_form()
  
        elif action_type == 'show_summary':
            summary = self.form_system._generate_order_summary()
            responses.append(summary)
  
        elif action_type == 'ask_confirm':
            confirm_prompt = self.form_system._generate_confirmation_options()
            responses.append(confirm_prompt)
  
        elif action_type == 'validate_form':
            context_view = {n: s.value.value for n, s in self.form_system.current_form.items() if s.value}
            errors = run_validators(context_view)
            if errors:
                self.form_system.validation_errors = errors
  
        elif action_type == 'submit_order':
            self.form_system.order_status = OrderStatus.CONFIRMED
            success_template = business_config_loader.get_template(
                self.flow_config['business_line'], "form_order_confirmed")
            if success_template:
                responses.append("\n".join(success_template))
  
    return responses
```

**è®¾è®¡æ€è·¯**ï¼šæ”¯æŒåœ¨å…³é”®ä¸šåŠ¡æµç¨‹èŠ‚ç‚¹æ‰§è¡Œé¢„å®šä¹‰åŠ¨ä½œé“¾ï¼Œå®ç°å¤æ‚çš„ä¸šåŠ¡æµç¨‹æ§åˆ¶ã€‚

#### ç”¨æˆ·å‘½ä»¤è¯†åˆ«ç®—æ³•

**å®ç°æ¥æº**ï¼šflow_interpreter.py

```python
def _identify_command(self, user_input: str) -> Optional[str]:
    """ç”¨æˆ·å‘½ä»¤è¯†åˆ«ç®—æ³•"""
    user_input_lower = user_input.lower().strip()
    commands_config = self.flow_config.get('commands', {})
  
    for command_name, command_config in commands_config.items():
        keywords = command_config.get('keywords', [])
        for keyword in keywords:
             æ”¯æŒç²¾ç¡®åŒ¹é…å’ŒåŒ…å«åŒ¹é…
            if user_input_lower == keyword.lower() or keyword.lower() in user_input_lower:
                 æ£€æŸ¥æ‰§è¡Œæ¡ä»¶
                condition = command_config.get('condition')
                if condition == 'all_slots_filled':
                    if not self.form_system._check_form_completeness():
                        continue
                elif condition == 'has_conflicts':
                    if not self.form_system.pending_conflicts:
                        continue
  
                return command_name
  
    return None
```

**è®¾è®¡æ€è·¯**ï¼šå°†ç”¨æˆ·è‡ªç„¶è¯­è¨€è¾“å…¥æ˜ å°„åˆ°ç³»ç»Ÿé¢„å®šä¹‰å‘½ä»¤ï¼Œæ”¯æŒæ¡ä»¶æ‰§è¡Œå’Œä¸Šä¸‹æ–‡æ„ŸçŸ¥ã€‚

#### å‘½ä»¤æ‰§è¡Œç®—æ³•

**å®ç°æ¥æº**ï¼šflow_interpreter.py

```python
def _execute_command(self, command_name: str) -> Dict[str, Any]:
    """å‘½ä»¤æ‰§è¡Œç®—æ³•"""
    commands_config = self.flow_config.get('commands', {})
    command_config = commands_config.get(command_name, {})
  
    result = {
        "response": "",
        "action": command_name,
        "should_exit": False
    }
  
    action = command_config.get('action')
    direct_response = command_config.get('response')
  
    if direct_response:
         ç›´æ¥å“åº”å‘½ä»¤
        result["response"] = direct_response
  
    elif action == 'restart_flow':
        self.form_system._reset_form()
        initial_prompt = self.form_system.get_initial_prompt()
        result["response"] = "å¥½çš„ï¼Œè®©æˆ‘ä»¬é‡æ–°å¼€å§‹ï¼\n\n" + initial_prompt
  
    elif action == 'confirm_order':
        if self.form_system._check_form_completeness():
             è§¦å‘ç¡®è®¤äº‹ä»¶
            confirm_responses = self._handle_events('on_confirm')
            result["response"] = "\n\n".join(confirm_responses)
        else:
            result["response"] = "è¯·å…ˆå®Œæˆæ‰€æœ‰å¿…è¦ä¿¡æ¯çš„é€‰æ‹©"
  
    elif action == 'show_help':
        help_template = business_config_loader.get_template(
            self.flow_config['business_line'], "form_help")
        if help_template:
            result["response"] = "\n".join(help_template)
        else:
            result["response"] = command_config.get('response', '')
  
    elif action == 'exit_flow':
        result["response"] = "æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼"
        result["should_exit"] = True
  
    return result
```

**è®¾è®¡æ€è·¯**ï¼šæ‰§è¡Œç”¨æˆ·å‘½ä»¤å¯¹åº”çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ”¯æŒç›´æ¥å“åº”å’Œå¤æ‚åŠ¨ä½œæ‰§è¡Œã€‚

### 4.2.5 ç±»åä½œå…³ç³»

#### ç±»å…³ç³»å›¾ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YAMLFlowLoader â”‚    â”‚ FlowInterpreter  â”‚
â”‚                 â”‚    â”‚                  â”‚
â”‚ - load()        â”‚â—„---â”‚ - process_input()â”‚
â”‚ - validate()    â”‚    â”‚ - _handle_events()â”‚
â”‚ - get_flow_info()â”‚   â”‚ - _execute_command()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ FormBasedDialog  â”‚
                        â”‚ System           â”‚
                        â”‚                  â”‚
                        â”‚ - process_input()â”‚
                        â”‚ - get_context()  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚               â”‚               â”‚
                 â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ BusinessConfig  â”‚ â”‚   SparkLLMClient â”‚ â”‚ SemanticMapper  â”‚
        â”‚ Loader          â”‚ â”‚                 â”‚ â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åä½œæµç¨‹è¯´æ˜

1. **é…ç½®åŠ è½½é˜¶æ®µ**ï¼š

   - `YAMLFlowLoader.load()` åŠ è½½YAMLæµç¨‹å®šä¹‰æ–‡ä»¶
   - `YAMLFlowLoader.validate()` éªŒè¯é…ç½®å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
   - ä»DSLé…ç½®ä¸­æå–æ§½ä½è§„æ ¼ä¿¡æ¯
   - `BusinessConfigLoader.inject_slot_specs()` åŠ¨æ€æ³¨å…¥æ§½ä½è§„æ ¼åˆ°ä¸šåŠ¡é…ç½®
2. **ç”¨æˆ·è¾“å…¥å¤„ç†é˜¶æ®µ**ï¼š

   - `FlowInterpreter.process_input()` æ¥æ”¶ç”¨æˆ·è¾“å…¥
   - `FlowInterpreter._identify_command()` è¯†åˆ«ç”¨æˆ·å‘½ä»¤
   - å¦‚æœ‰å‘½ä»¤åˆ™ `FlowInterpreter._execute_command()` æ‰§è¡Œå‘½ä»¤é€»è¾‘
   - å¦‚æ— å‘½ä»¤åˆ™å§”æ‰˜ç»™ `FormBasedDialogSystem.process_input()` å¤„ç†ä¸šåŠ¡é€»è¾‘
   - è°ƒç”¨ `SparkLLMClient` æˆ– `SemanticMapper` è¿›è¡Œè¯­ä¹‰ç†è§£
3. **äº‹ä»¶è§¦å‘é˜¶æ®µ**ï¼š

   - åœ¨å…³é”®ä¸šåŠ¡æµç¨‹èŠ‚ç‚¹è°ƒç”¨ `FlowInterpreter._handle_events()`
   - æ‰§è¡Œé¢„å®šä¹‰çš„äº‹ä»¶åŠ¨ä½œé“¾
   - ç”Ÿæˆç³»ç»Ÿå“åº”è¿”å›ç»™ç”¨æˆ·
4. **çŠ¶æ€ç®¡ç†é˜¶æ®µ**ï¼š

   - `FlowInterpreter` ç»´æŠ¤æµç¨‹æ‰§è¡ŒçŠ¶æ€
   - `FormBasedDialogSystem` ç®¡ç†è¡¨å•æ§½ä½çŠ¶æ€
   - ä¸¤è€…ååŒç¡®ä¿ä¸šåŠ¡æµç¨‹çš„æ­£ç¡®æ¨è¿›

#### æ•°æ®æµå‘

```
DSLé…ç½®æ–‡ä»¶ (.yaml)
        â†“
YAMLFlowLoader (åŠ è½½éªŒè¯)
        â†“
æµç¨‹é…ç½®å­—å…¸
        â†“
FlowInterpreter (è§£é‡Šæ‰§è¡Œ)
        â”‚
        â”œâ”€â”€â”€â†’ å‘½ä»¤è¯†åˆ« â†’ å‘½ä»¤æ‰§è¡Œ
        â”‚
        â”œâ”€â”€â”€â†’ äº‹ä»¶è§¦å‘ â†’ åŠ¨ä½œæ‰§è¡Œ
        â”‚
        â””â”€â”€â”€â†’ ä¸šåŠ¡å§”æ‰˜ â†’ FormBasedDialogSystem
```

## 4.3 æ ¸å¿ƒå¯¹è¯å¼•æ“å­ç³»ç»Ÿè¯¦ç»†è®¾è®¡

### 4.3.1 å­ç³»ç»Ÿæ¦‚è¿°

æ ¸å¿ƒå¯¹è¯å¼•æ“å­ç³»ç»Ÿæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ™ºèƒ½ä¸­æ¢ï¼Œè´Ÿè´£ç®¡ç†å¤šè½®å¯¹è¯çŠ¶æ€ã€æ‰§è¡Œä¿¡æ¯æŠ½å–ç­–ç•¥ã€å¤„ç†æ•°æ®å†²çªå’Œç»´æŠ¤ä¸šåŠ¡è§„åˆ™ä¸€è‡´æ€§ã€‚è¯¥å­ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„å¤šæ§½ä½ä¿¡æ¯é‡‡é›†æµç¨‹ï¼Œé€šè¿‡çŠ¶æ€æœºæ¨¡å¼ç®¡ç†å¯¹è¯æµç¨‹ï¼Œæ”¯æŒå¤æ‚çš„æ§½ä½ä¾èµ–å…³ç³»å’Œå†²çªè§£å†³æœºåˆ¶ã€‚

### 4.3.2 æ ¸å¿ƒç±»è®¾è®¡

#### FormBasedDialogSystemç±»

**å®šä¹‰æ¥æº**ï¼šform_based_system.py

```python
class FormBasedDialogSystem:
    """è¡¨å•é©±åŠ¨çš„å¯¹è¯ç³»ç»Ÿ"""
  
    def __init__(self, business_line: str):
        """
        åˆå§‹åŒ–è¡¨å•å¯¹è¯ç³»ç»Ÿ
  
        Args:
            business_line: ä¸šåŠ¡çº¿æ ‡è¯†ï¼Œç”¨äºåŠ è½½å¯¹åº”çš„ä¸šåŠ¡é…ç½®
        """
  
    def process_input(self, user_input: str, llm_client, semantic_mapper) -> Dict[str, Any]:
        """
        å¤„ç†ç”¨æˆ·è¾“å…¥çš„æ ¸å¿ƒæ–¹æ³•
  
        Args:
            user_input: ç”¨æˆ·è¾“å…¥çš„è‡ªç„¶è¯­è¨€æ–‡æœ¬
            llm_client: LLMå®¢æˆ·ç«¯å®ä¾‹ï¼Œç”¨äºAIç†è§£
            semantic_mapper: è¯­ä¹‰æ˜ å°„å™¨å®ä¾‹ï¼Œç”¨äºæœ¬åœ°åŒ¹é…
  
        Returns:
            å®Œæ•´çš„å¤„ç†ç»“æœï¼ŒåŒ…å«:
            - slots_updated: æœ¬æ¬¡æ›´æ–°äº†çš„æ§½ä½åˆ—è¡¨
            - slots_filled: æœ¬æ¬¡å¡«å……å®Œæˆçš„æ§½ä½åˆ—è¡¨  
            - conflicts: æ£€æµ‹åˆ°çš„å†²çªåˆ—è¡¨
            - response: ç”Ÿæˆçš„ç³»ç»Ÿå“åº”æ–‡æœ¬
            - form_complete: è¡¨å•æ˜¯å¦å·²å®Œæ•´å¡«å……
            - should_exit: æ˜¯å¦åº”è¯¥é€€å‡ºå¯¹è¯
        """
  
    def get_initial_prompt(self) -> str:
        """
        è·å–åˆå§‹æç¤ºä¿¡æ¯
  
        Returns:
            å¼•å¯¼ç”¨æˆ·å¼€å§‹è¡¨å•å¡«å†™çš„åˆå§‹æç¤ºæ–‡æœ¬
            å¦‚æœå·²ç»æ˜¾ç¤ºè¿‡æˆ–æ— éœ€æç¤ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        """
  
    def get_context(self) -> Dict[str, Any]:
        """
        è·å–å½“å‰è¡¨å•çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
  
        Returns:
            ä¸Šä¸‹æ–‡å­—å…¸ï¼ŒåŒ…å«å½“å‰å·²å¡«å……çš„æ‰€æœ‰æ§½ä½å€¼
            ç”¨äºè¯­ä¹‰æ˜ å°„å’ŒLLMç†è§£çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥
        """
  
    def _extract_multiple_slots(self, user_input: str, llm_client, semantic_mapper) -> Dict[str, SlotValue]:
        """ä»ç”¨æˆ·è¾“å…¥ä¸­æŠ½å–å¤šä¸ªæ§½ä½ä¿¡æ¯çš„ä¸‰å±‚ç­–ç•¥"""
  
    def _direct_keyword_extraction(self, user_input: str) -> Dict[str, SlotValue]:
        """ç›´æ¥å…³é”®è¯åŒ¹é…ç®—æ³•"""
  
    def _semantic_slot_extraction(self, user_input: str, slot_name: str, semantic_mapper) -> Optional[SlotValue]:
        """åŸºäºè¯­ä¹‰é˜¶æ®µçš„æ™ºèƒ½æ˜ å°„"""
  
    def _llm_slot_extraction(self, user_input: str, target_slots: List[str], llm_client) -> Dict[str, SlotValue]:
        """LLMå…¨å±€æŠ½å–ç®—æ³•"""
  
    def _update_slot(self, slot_name: str, new_value: SlotValue) -> Dict[str, bool]:
        """æ§½ä½çŠ¶æ€æ›´æ–°å®ç°"""
  
    def _should_trigger_conflict(self, existing_value: SlotValue, new_value: SlotValue) -> bool:
        """å†²çªè§¦å‘æ¡ä»¶åˆ¤æ–­ç®—æ³•"""
  
    def _resolve_conflict(self, slot_name: str, decision: str):
        """å†²çªè§£å†³å¤„ç†ç®—æ³•"""
  
    def _generate_response(self, extraction_result: Dict[str, Any]) -> str:
        """æ™ºèƒ½å“åº”ç”Ÿæˆå®ç°"""
  
    def _generate_slot_prompt(self, slot_name: str) -> str:
        """åŠ¨æ€æ§½ä½æç¤ºç”Ÿæˆ"""
  
    def _check_form_completeness(self) -> bool:
        """è¡¨å•å®Œæ•´æ€§æ£€æŸ¥"""
  
    def _get_next_missing_slot(self) -> Optional[str]:
        """è·å–ä¸‹ä¸€ä¸ªéœ€è¦å¡«å……çš„æ§½ä½"""
  
    def _reset_form(self):
        """è¡¨å•èµ„æºé‡ç½®å®ç°"""
  
    def _handle_digital_input(self, input_text: str) -> Optional[Dict[str, Any]]:
        """æ•°å­—è¾“å…¥å¤„ç†å®ç°"""
  
    def _handle_commands(self, user_input: str) -> Optional[Dict[str, Any]]:
        """é€šç”¨å‘½ä»¤å¤„ç†"""
  
    def _handle_unique_match(self, user_input: str) -> Optional[Dict[str, Any]]:
        """å”¯ä¸€åŒ¹é…å°è¯•å¤„ç†"""
  
    def _get_filtered_options(self, enum_key: str) -> List[Dict[str, Any]]:
        """åŠ¨æ€æšä¸¾è¿‡æ»¤ç®—æ³•"""
  
    def _clear_slot_and_dependencies(self, slot_name: str):
        """æ¸…ç©ºæ§½ä½åŠå…¶ä¾èµ–é“¾"""
  
    def _generate_order_summary(self) -> str:
        """ç”Ÿæˆè®¢å•æ‘˜è¦"""
  
    def _generate_confirmation_options(self) -> str:
        """ç”Ÿæˆç¡®è®¤é€‰é¡¹"""
```

**èŒè´£è¯´æ˜**ï¼š

- ç®¡ç†è¡¨å•æ§½ä½çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
- æ‰§è¡Œä¸‰å±‚ä¿¡æ¯æŠ½å–ç­–ç•¥ç†è§£ç”¨æˆ·è¾“å…¥
- å®ç°æ™ºèƒ½çš„å†²çªæ£€æµ‹å’Œè§£å†³æœºåˆ¶
- ç»´æŠ¤è®¢å•çŠ¶æ€æœºå’Œä¸šåŠ¡æµç¨‹æ§åˆ¶
- ç”Ÿæˆæ™ºèƒ½å“åº”å’Œç”¨æˆ·å¼•å¯¼æç¤º

### 4.3.3 å…³é”®æ•°æ®ç»“æ„

#### è¡¨å•æ§½ä½è¿è¡Œæ—¶çŠ¶æ€

**å®šä¹‰æ¥æº**ï¼šform_based_system.py

```python
@dataclass
class FormSlot:
    """è¡¨å•æ§½ä½è¿è¡Œæ—¶çŠ¶æ€"""
    definition: SlotDefinition
    status: SlotStatus = SlotStatus.EMPTY
    value: Optional[SlotValue] = None
    candidates: List[SlotValue] = field(default_factory=list)
```

**è¯´æ˜**ï¼šç®¡ç†å•ä¸ªæ§½ä½çš„å®Œæ•´è¿è¡Œæ—¶çŠ¶æ€ã€‚`status`è·Ÿè¸ªå¡«å……è¿›åº¦ï¼Œ`candidates`å­˜å‚¨å†²çªæ£€æµ‹çš„å€™é€‰å€¼ï¼Œæ”¯æŒå¤šè½®äº¤äº’å’Œå†²çªè§£å†³ã€‚

#### æ§½ä½å€¼æ•°æ®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šform_based_system.py

```python
@dataclass  
class SlotValue:
    """æ§½ä½å€¼åŠå…¶å…ƒæ•°æ®"""
    value: Any
    confidence: float
    source: str   "numeric", "semantic", "llm", "direct", "single_match"
    reason: str = ""
```

**è¯´æ˜**ï¼šå°è£…ç”¨æˆ·æä¾›çš„å€¼åŠå…¶å…ƒæ•°æ®ã€‚`confidence`æ”¯æŒç½®ä¿¡åº¦å†³ç­–ï¼Œ`source`è®°å½•è¯†åˆ«æ¥æºç”¨äºå†²çªä¼˜å…ˆçº§åˆ¤æ–­ï¼Œ`reason`æä¾›å†³ç­–é€æ˜åº¦ã€‚

#### çŠ¶æ€æšä¸¾å®šä¹‰

**å®šä¹‰æ¥æº**ï¼šform_based_system.py

```python
class SlotStatus(Enum):
    EMPTY = "empty"            æœªå¡«å……ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥
    PARTIAL = "partial"        éƒ¨åˆ†ä¿¡æ¯ï¼Œéœ€è¦è¿›ä¸€æ­¥ç¡®è®¤
    FILLED = "filled"          å·²å®Œæ•´å¡«å……ï¼Œä¿¡æ¯å°±ç»ª
    CONFLICTED = "conflicted"  ä¿¡æ¯å†²çªï¼Œéœ€è¦ç”¨æˆ·å†³ç­–

class OrderStatus(Enum):
    COLLECTING = "collecting"            ä¿¡æ¯æ”¶é›†ä¸­
    READY_CONFIRM = "ready_confirm"      å‡†å¤‡ç¡®è®¤è®¢å•
    CONFIRMED = "confirmed"              å·²ç¡®è®¤è®¢å•
    RESELECTING = "reselecting"          é‡æ–°é€‰æ‹©æŸé¡¹
    AWAITING_CONTINUE = "awaiting_continue"   ç­‰å¾…ç»§ç»­è´­ç‰©å†³ç­–
```

**è¯´æ˜**ï¼šå®šä¹‰æ§½ä½å¡«å……çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å’Œæ•´ä¸ªè®¢å•æµç¨‹çš„çŠ¶æ€æœºã€‚æ”¯æŒæ¸è¿›å¼ä¿¡æ¯æ”¶é›†å’Œå†²çªå¤„ç†ï¼Œç¡®ä¿æ•°æ®è´¨é‡ã€‚

#### è¿è¡Œæ—¶çŠ¶æ€ç®¡ç†

**å®šä¹‰æ¥æº**ï¼šform_based_system.py

```python
class FormBasedDialogSystem:
    def __init__(self, business_line: str):
        self.business_line = business_line
        self.current_form: Dict[str, FormSlot] = {}
        self.order_status = OrderStatus.COLLECTING
        self.pending_conflicts: List[Dict] = []
        self.awaiting_conflict_slot: Optional[str] = None
        self.validation_errors: List[str] = []
        self.order_confirmed = False
        self.order_summary: Dict[str, Any] = {}
        self.reselect_slot: Optional[str] = None
        self.last_prompted_slot: Optional[str] = None
        self.form_template: Dict[str, SlotDefinition] = {}
        self.business_filters: Dict[str, Any] = {}
```

### 4.3.4 æ ¸å¿ƒç®—æ³•å®ç°

#### ä¸‰å±‚ä¿¡æ¯æŠ½å–ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _extract_multiple_slots(self, user_input: str, llm_client, semantic_mapper) -> Dict[str, SlotValue]:
    """ä»ç”¨æˆ·è¾“å…¥ä¸­æŠ½å–å¤šä¸ªæ§½ä½ä¿¡æ¯çš„ä¸‰å±‚ç­–ç•¥"""
    extracted = {}
  
     Layer 1: ç›´æ¥å…³é”®è¯åŒ¹é…ï¼ˆé«˜ç½®ä¿¡åº¦ï¼‰
    direct_matches = self._direct_keyword_extraction(user_input)
    extracted.update(direct_matches)
  
     Layer 2: æ™ºèƒ½æ¨èå±‚ï¼ˆåŸºäºæ„å›¾å’Œè¯­ä¹‰ï¼‰
    missing_slots = [name for name, slot in self.current_form.items() 
                    if slot.status == SlotStatus.EMPTY and name not in extracted]
  
    for slot_name in missing_slots:
         ä¼˜å…ˆä½¿ç”¨è¯­ä¹‰é˜¶æ®µåŠ¨æ€è¿‡æ»¤
        semantic_result = self._semantic_slot_extraction(user_input, slot_name, semantic_mapper)
        if semantic_result:
            extracted[slot_name] = semantic_result
            continue
  
         æ„å›¾æ¨èä½œä¸ºè¯­ä¹‰æ˜ å°„çš„è¡¥å……
        intent_result = self._intent_based_recommendation(user_input, slot_name)
        if intent_result:
            extracted[slot_name] = intent_result
  
     Layer 3: LLMå…¨å±€æŠ½å–ï¼ˆå…œåº•ç­–ç•¥ï¼‰
    all_missing_slots = [name for name, slot in self.current_form.items() 
                        if slot.status == SlotStatus.EMPTY]
    llm_result = self._llm_slot_extraction(user_input, all_missing_slots, llm_client)
    for slot_name, slot_value in llm_result.items():
        if slot_name not in extracted:   ä¼˜å…ˆçº§æ§åˆ¶
            extracted[slot_name] = slot_value
  
    return extracted
```

**è®¾è®¡æ€è·¯**ï¼šè®¾è®¡äº†ä¸‰å±‚æ¸è¿›å¼ä¿¡æ¯æŠ½å–ç­–ç•¥ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯åœ¨ä¿è¯ç†è§£å‡†ç¡®æ€§çš„åŒæ—¶æœ€å¤§åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚é€šè¿‡å°†ç†è§£ä»»åŠ¡æŒ‰å¤æ‚åº¦åˆ†é…åˆ°ä¸åŒå±‚çº§ï¼Œå®ç°äº†ä»ç²¾ç¡®åˆ°æ¨¡ç³Šçš„æ¸è¿›å¼ç†è§£ï¼Œæ—¢å‡å°‘äº†LLMè°ƒç”¨æˆæœ¬ï¼Œåˆæå‡äº†ç”¨æˆ·ä½“éªŒã€‚

#### ç›´æ¥å…³é”®è¯åŒ¹é…ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _direct_keyword_extraction(self, user_input: str) -> Dict[str, SlotValue]:
    """ç›´æ¥å…³é”®è¯åŒ¹é…ç®—æ³•"""
    extracted = {}
    text_lower = user_input.lower().strip()
    candidates = {}   æ”¶é›†æ¯ä¸ªæ§½ä½çš„åŒ¹é…å€™é€‰
  
     ä»…æ‰«æç¼ºå¤±æ§½ä½ï¼Œä¼˜åŒ–æ€§èƒ½
    for slot_name, slot_def in self.form_template.items():
        if self.current_form[slot_name].status != SlotStatus.EMPTY:
            continue   è·³è¿‡å·²å¡«å……æ§½ä½
  
        enum_key = slot_def.enums_key
        enum_list = business_config_loader.get_enums(self.business_line).get(enum_key, [])
  
        for enum_item in enum_list:
            label = enum_item.get("label", "")
            aliases = enum_item.get("aliases", [])
  
             å¤šç­–ç•¥åŒ¹é…
            matched = False
            matched_keyword = None
            best_match_length = 0
  
            for alias in aliases:
                alias_lower = alias.lower()
                 ç­–ç•¥1: å®Œå…¨ç›¸ç­‰åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                if text_lower == alias_lower:
                    matched = True
                    matched_keyword = alias
                    break
                 ç­–ç•¥2: è¾¹ç•Œå­ä¸²åŒ¹é…ï¼ˆé¿å…è¯¯åŒ¹é…ï¼‰
                elif len(alias_lower) > best_match_length:
                    pattern = r'(^|[^a-z0-9])' + re.escape(alias_lower) + r'($|[^a-z0-9])'
                    if re.search(pattern, text_lower):
                        matched = True
                        matched_keyword = alias
                        best_match_length = len(alias_lower)
  
            if matched:
                 ç½®ä¿¡åº¦è®¡ç®—å’Œå€™é€‰æ”¶é›†
                confidence = 0.95   ç›´æ¥åŒ¹é…é«˜ç½®ä¿¡åº¦
                if slot_name not in candidates:
                    candidates[slot_name] = []
                candidates[slot_name].append((label, confidence, f"å…³é”®è¯'{matched_keyword}'åŒ¹é…", best_match_length))
  
     æ¶ˆæ­§å¤„ç†ï¼šæ¯ä¸ªæ§½ä½é€‰æ‹©æœ€ä½³åŒ¹é…
    for slot_name, matches in candidates.items():
        if matches:
            best_match = max(matches, key=lambda x: (x[3], x[1]))   é•¿åº¦ä¼˜å…ˆï¼Œå…¶æ¬¡ç½®ä¿¡åº¦
            label, confidence, reason, _ = best_match
            extracted[slot_name] = SlotValue(label, confidence, "direct", reason)
  
    return extracted
```

**è®¾è®¡æ€è·¯**ï¼šè®¾è®¡äº†åŸºäºé…ç½®åˆ«åçš„ç²¾ç¡®åŒ¹é…æœºåˆ¶ï¼Œä¸“é—¨å¤„ç†ç”¨æˆ·è¾“å…¥ä¸­çš„æ˜ç¡®æšä¸¾å€¼ã€‚é€šè¿‡è¾¹ç•ŒåŒ¹é…ç­–ç•¥å’Œé€‰æ‹©æ€§æ‰«æä¼˜åŒ–ï¼Œåœ¨ä¿è¯å‡†ç¡®æ€§çš„åŒæ—¶æ˜¾è‘—æå‡æ€§èƒ½ã€‚

#### è¯­ä¹‰æ˜ å°„æŠ½å–ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _semantic_slot_extraction(self, user_input: str, slot_name: str, semantic_mapper) -> Optional[SlotValue]:
    """åŸºäºè¯­ä¹‰é˜¶æ®µçš„æ™ºèƒ½æ˜ å°„"""
    slot_def = self.form_template.get(slot_name)
    if not slot_def or not slot_def.semantic_stage:
        return None
  
     æ„å»ºä¸Šä¸‹æ–‡å¹¶è·å–è¯­ä¹‰é€‰é¡¹
    context = self.get_context()
    options = OptionBuilder.build(slot_def.semantic_stage, context)
    if not options:
        return None
  
     æ‰§è¡Œè¯­ä¹‰åŒ¹é…
    match_result = semantic_mapper.map(user_input, options)
    if match_result.chosen_index is None:
        return None
  
     è½¬æ¢ä¸ºæ§½ä½å€¼
    chosen_opt = options[match_result.chosen_index - 1]
    return SlotValue(
        value=chosen_opt.label,
        confidence=match_result.confidence,
        source="semantic",
        reason=match_result.reason
    )
```

**è®¾è®¡æ€è·¯**ï¼šè®¾è®¡äº†åŸºäºè¯­ä¹‰é˜¶æ®µçš„åŠ¨æ€é€‰é¡¹æ„å»ºæœºåˆ¶ï¼Œè§£å†³å›ºå®šæšä¸¾åˆ—è¡¨æ— æ³•é€‚åº”å¤æ‚ä¸šåŠ¡åœºæ™¯çš„é—®é¢˜ã€‚é€šè¿‡è¯­ä¹‰é˜¶æ®µæ ‡è¯†å’Œä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼Œå®ç°äº†çœŸæ­£æ™ºèƒ½çš„é€‰é¡¹æ¨èã€‚

#### å†²çªæ£€æµ‹ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _should_trigger_conflict(self, existing_value: SlotValue, new_value: SlotValue) -> bool:
    """å†²çªè§¦å‘æ¡ä»¶åˆ¤æ–­ç®—æ³•"""
     ç›¸åŒå€¼ä¸å†²çª
    if existing_value.value == new_value.value:
        return False
  
     å†²çªè§¦å‘ç­–ç•¥ï¼š
     1. é«˜ç½®ä¿¡åº¦çš„æ–°å€¼ä¸ç°æœ‰å€¼ä¸åŒ
    if new_value.confidence >= 0.6:
        return True
  
     2. ä¸åŒæ¥æºçš„å€¼ä¼˜å…ˆçº§æ¯”è¾ƒ
    source_priorities = {
        "direct": 3,       ç›´æ¥å…³é”®è¯åŒ¹é…
        "numeric": 2,      æ•°å­—é€‰æ‹©
        "semantic": 2,     è¯­ä¹‰æ˜ å°„  
        "single_match": 2, å”¯ä¸€åŒ¹é…
        "llm": 1,          å•ä¸ªLLMè¯†åˆ«
        "multi_llm": 1,    å¤šæ§½ä½LLMè¯†åˆ«
        "intent_recommend": 1   æ„å›¾æ¨è
    }
  
    existing_priority = source_priorities.get(existing_value.source, 0)
    new_priority = source_priorities.get(new_value.source, 0)
  
     å¦‚æœæ–°å€¼ä¼˜å…ˆçº§è¶³å¤Ÿé«˜ï¼Œä¸”ç½®ä¿¡åº¦ä¸æ˜¯å¤ªä½ï¼Œè§¦å‘å†²çª
    if new_priority >= existing_priority and new_value.confidence >= 0.4:
        return True
  
     3. ç‰¹æ®Šæƒ…å†µï¼šAIè¯†åˆ«ä¸ç›´æ¥è¯†åˆ«å†²çªæ—¶ï¼Œæ€»æ˜¯æç¤ºç”¨æˆ·ç¡®è®¤
    if ((existing_value.source == "direct" and new_value.source in ["llm", "multi_llm"]) or
        (existing_value.source in ["llm", "multi_llm"] and new_value.source == "direct")):
        return True
  
    return False
```

**è®¾è®¡æ€è·¯**ï¼šè®¾è®¡äº†å¤šç»´åº¦å†²çªæ£€æµ‹ç­–ç•¥ï¼Œè§£å†³ç”¨æˆ·ä¸­é€”ä¿®æ”¹é€‰æ‹©å¯¼è‡´çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚é€šè¿‡ç»¼åˆè€ƒè™‘ç½®ä¿¡åº¦ã€æ¥æºä¼˜å…ˆçº§å’Œç‰¹æ®Šåœºæ™¯ï¼Œå®ç°äº†ç²¾ç¡®çš„å†²çªè¯†åˆ«ã€‚

#### å†²çªè§£å†³ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _resolve_conflict(self, slot_name: str, decision: str):
    """å†²çªè§£å†³å¤„ç†ç®—æ³•"""
    slot = self.current_form.get(slot_name)
    if not slot:
        return
  
    old_value = slot.value.value if slot.value else "(æ— )"
  
    if decision == "1":
         ä¿ç•™åŸå€¼ï¼Œä¸¢å¼ƒå€™é€‰
        slot.status = SlotStatus.FILLED
        slot.candidates = []
  
    elif decision == "2":
         ä½¿ç”¨æ–°å€¼ï¼šæ¸…ç©ºè¯¥æ§½ä½åŠå…¶ä¾èµ–é“¾ï¼Œç„¶åå¡«å……æ–°å€¼
        if slot.candidates:
            new_val = slot.candidates[-1]
  
             å…ˆæ¸…ç©ºä¾èµ–é“¾ï¼ˆé¿å…æ—§å€¼æ®‹ç•™ï¼‰
            self._clear_slot_and_dependencies(slot_name)
  
             å¡«å……æ–°å€¼
            slot.value = new_val
            slot.status = SlotStatus.FILLED if new_val.confidence >= 0.7 else SlotStatus.PARTIAL
            slot.candidates = []
  
    elif decision == "3":
         æ¸…ç©ºè¯¥æ§½ä½åŠå…¶ä¾èµ–é“¾ï¼Œç­‰å¾…é‡æ–°è¾“å…¥
        self._clear_slot_and_dependencies(slot_name)
  
     æ¸…ç†å†²çªçŠ¶æ€
    self.awaiting_conflict_slot = None
    self.pending_conflicts = [c for c in self.pending_conflicts if c.get("slot") != slot_name]
```

**è®¾è®¡æ€è·¯**ï¼šè®¾è®¡äº†åŸºäºä¾èµ–é“¾çš„å†²çªè§£å†³æ–¹æ¡ˆï¼Œå½»åº•è§£å†³å¤æ‚çš„å¤šå€¼åŒæ­¥é—®é¢˜ã€‚é€šè¿‡"æœ€å°é—­åŒ…æ¸…ç©º"ç­–ç•¥ï¼Œå½“ç”¨æˆ·é€‰æ‹©ä¿®æ”¹æŸä¸ªå€¼æ—¶ï¼Œè‡ªåŠ¨æ¸…ç©ºå…¶æ‰€æœ‰ä¸‹æ¸¸ä¾èµ–æ§½ä½ï¼Œé¿å…æ®‹ç•™æ—§å€¼å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚

#### åŠ¨æ€æšä¸¾è¿‡æ»¤ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _get_filtered_options(self, enum_key: str) -> List[Dict[str, Any]]:
    """åŠ¨æ€æšä¸¾è¿‡æ»¤ç®—æ³•"""
    raw_options = get_slot_options(enum_key, self.business_line)
    if not raw_options:
        return []
  
     ä»…è‹¹æœä¸“å–åº—æ‰§è¡ŒåŠ¨æ€è¿‡æ»¤
    if self.business_line != "apple_store":
        return raw_options
  
     è·å–å½“å‰ä¸Šä¸‹æ–‡ç”¨äºè¿‡æ»¤
    category = self.current_form.get("category")
    category_val = category.value.value if category and category.value else None
  
    series = self.current_form.get("series") 
    series_val = series.value.value if series and series.value else None
  
     åº”ç”¨å±‚çº§è¿‡æ»¤è§„åˆ™
    if enum_key == "series" and category_val:
        allowed_series = self.business_filters.get("series_by_category", {}).get(category_val)
        if allowed_series:
            return [opt for opt in raw_options if opt.get("label") in allowed_series]
  
    elif enum_key == "size":
         ä¼˜å…ˆæŒ‰seriesè¿‡æ»¤ï¼Œå…¶æ¬¡æŒ‰category
        if series_val:
            allowed_sizes = self.business_filters.get("size_by_series", {}).get(series_val)
            if allowed_sizes:
                return [opt for opt in raw_options if opt.get("label") in allowed_sizes]
  
        if category_val:
            allowed_sizes = self.business_filters.get("size_by_category", {}).get(category_val)
            if allowed_sizes:
                return [opt for opt in raw_options if opt.get("label") in allowed_sizes]
  
    elif enum_key == "chip" and category_val:
        allowed_chips = self.business_filters.get("chip_by_category", {}).get(category_val)
        if allowed_chips:
            return [opt for opt in raw_options if opt.get("label") in allowed_chips]
  
    elif enum_key == "storage" and category_val:
        allowed_storage = self.business_filters.get("storage_by_category", {}).get(category_val)
        if allowed_storage:
            filtered = [opt for opt in raw_options if opt.get("label") in allowed_storage]
             å­˜å‚¨ç‰¹æ®Šå¤„ç†ï¼šç”µè„‘ä¸æ˜¾ç¤º128/256GB
            if category_val == "ç”µè„‘":
                filtered = [opt for opt in filtered if opt.get("label") in {"512GB", "1TB", "2TB"}]
            return filtered
  
     é»˜è®¤è¿”å›åŸå§‹é€‰é¡¹
    return raw_options
```

**è®¾è®¡æ€è·¯**ï¼šè®¾è®¡äº†å±‚çº§è¿‡æ»¤ç­–ç•¥ç”¨äºç›¸å¯¹å¤æ‚çš„ä¿¡æ¯æ”¶å–åœºæ™¯ï¼Œå®ç°åŸºäºä¸Šä¸‹æ–‡çš„æ™ºèƒ½é€‰é¡¹æ¨èã€‚é€šè¿‡åˆ†æå®é™…ä¸šåŠ¡è§„åˆ™ï¼Œå»ºç«‹äº†å¤šçº§è¿‡æ»¤æ˜ å°„ï¼Œç¡®ä¿ç”¨æˆ·åœ¨æ¯ä¸ªæ­¥éª¤éƒ½åªèƒ½çœ‹åˆ°å½“å‰ä¸Šä¸‹æ–‡ä¸­æœ‰æ•ˆçš„é€‰é¡¹ã€‚

#### æ™ºèƒ½å“åº”ç”Ÿæˆç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _generate_response(self, extraction_result: Dict[str, Any]) -> str:
    """æ™ºèƒ½å“åº”ç”Ÿæˆå®ç°"""
    response_parts = []
  
     1. ç¡®è®¤æ”¶åˆ°çš„ä¿¡æ¯ï¼ˆå¸¦æ¥æºæ ‡è¯†ï¼‰
    if extraction_result["slots_updated"]:
        filled_info = []
        for slot_name in extraction_result["slots_updated"]:
            slot = self.current_form[slot_name]
            source_prefix = self._get_source_prefix(slot.value.source)
            filled_info.append(f"{source_prefix}{slot.definition.description}: {slot.value.value}")
  
        if filled_info:
            recorded_template = business_config_loader.get_template(self.business_line, "form_info_recorded")
            recorded_msg = "\n".join(recorded_template) if recorded_template else "âœ… å¥½çš„ï¼Œæˆ‘è®°ä¸‹å•¦ï¼š"
            response_parts.append(recorded_msg + "\n" + "\n".join(f"   {info}" for info in filled_info))
  
     2. å†²çªå¤„ç†æç¤º
    if extraction_result["conflicts"]:
        for conflict in extraction_result["conflicts"]:
            conflict_msg = self._generate_conflict_message(conflict)
            response_parts.append(conflict_msg)
            return "\n\n".join(response_parts)   å†²çªæ—¶ç«‹å³è¿”å›
  
     3. è¯¢é—®ç¼ºå¤±ä¿¡æ¯
    missing_required = [name for name, slot in self.current_form.items()
                       if slot.definition.required and slot.status == SlotStatus.EMPTY]
  
    if missing_required and not extraction_result["form_complete"]:
        next_slot_name = self._get_next_available_slot(missing_required)
        if next_slot_name:
            prompt = self._generate_slot_prompt(next_slot_name)
            response_parts.append(prompt)
            self.last_prompted_slot = next_slot_name
  
     4. è¡¨å•å®Œæˆå¤„ç†
    elif extraction_result["form_complete"]:
         è¿è¡ŒéªŒè¯å™¨
        from core.slot_validators import run_validators
        context_view = {n: s.value.value for n, s in self.current_form.items() if s.value}
        errors = run_validators(context_view)
  
        if errors:
            self.validation_errors = errors
            error_title_template = business_config_loader.get_template(self.business_line, "form_validation_error_title")
            error_footer_template = business_config_loader.get_template(self.business_line, "form_validation_error_footer")
            error_title = "\n".join(error_title_template) if error_title_template else "ğŸ˜® æŸäº›ç»„åˆæš‚æ—¶ä¸å¤ªåˆé€‚ï¼š"
            error_footer = "\n".join(error_footer_template) if error_footer_template else "å¯ä»¥è°ƒæ•´ç›¸å…³é¡¹åå†è¯•ä¸€ä¸‹ï½"
            response_parts.append(error_title)
            response_parts.extend(f"- {msg}" for msg in errors)
            response_parts.append(error_footer)
        else:
             è®¾ç½®è®¢å•çŠ¶æ€ä¸ºå‡†å¤‡ç¡®è®¤
            self.order_status = OrderStatus.READY_CONFIRM
            order_summary = self._generate_order_summary()
            response_parts.append(order_summary)
            response_parts.append(self._generate_confirmation_options())
  
    return "\n\n".join(response_parts)
```

**è®¾è®¡æ€è·¯**ï¼šè®¾è®¡äº†çŠ¶æ€é©±åŠ¨çš„å“åº”ç”Ÿæˆæœºåˆ¶ï¼Œæ ¹æ®ç³»ç»Ÿå½“å‰çŠ¶æ€å’Œç”¨æˆ·æ“ä½œç”Ÿæˆæœ€åˆé€‚çš„æç¤ºä¿¡æ¯ã€‚é€šè¿‡æ¨¡æ¿åŒ–å“åº”å’ŒåŠ¨æ€å†…å®¹æ„å»ºï¼Œå®ç°äº†è‡ªç„¶æµç•…çš„å¯¹è¯ä½“éªŒã€‚

### 4.3.5 ç±»åä½œå…³ç³»

#### ç±»å…³ç³»å›¾ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FormBasedDialog  â”‚    â”‚   FlowInterpreterâ”‚
â”‚ System           â”‚â—„---â”‚                  â”‚
â”‚                  â”‚    â”‚ - process_input()â”‚
â”‚ - process_input()â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ - get_context()  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
          â”‚                    â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ çŠ¶æ€ç®¡ç†   â”‚    â”‚  è¯­ä¹‰ç†è§£æœåŠ¡    â”‚    â”‚   é…ç½®ç®¡ç†       â”‚
    â”‚           â”‚    â”‚                 â”‚    â”‚                 â”‚
    â”‚ - æ§½ä½çŠ¶æ€ â”‚    â”‚ - SparkLLMClientâ”‚    â”‚ - BusinessConfigâ”‚
    â”‚ - è®¢å•çŠ¶æ€ â”‚    â”‚ - SemanticMapperâ”‚    â”‚   Loader        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     ä¸šåŠ¡è§„åˆ™å¼•æ“     â”‚
                    â”‚                     â”‚
                    â”‚ - æ§½ä½éªŒè¯å™¨        â”‚
                    â”‚ - åŠ¨æ€é€‰é¡¹è¿‡æ»¤      â”‚
                    â”‚ - å†²çªè§£å†³ç­–ç•¥      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åä½œæµç¨‹è¯´æ˜

1. **è¾“å…¥å¤„ç†åä½œ**ï¼š

   - `FlowInterpreter.process_input()` æ¥æ”¶ç”¨æˆ·è¾“å…¥å¹¶å§”æ‰˜ç»™ `FormBasedDialogSystem.process_input()`
   - è¡¨å•ç³»ç»Ÿæ‰§è¡Œä¸‰å±‚ä¿¡æ¯æŠ½å–ç­–ç•¥ï¼Œè°ƒç”¨ `SparkLLMClient` å’Œ `SemanticMapper`
   - é€šè¿‡ `BusinessConfigLoader` è·å–ä¸šåŠ¡é…ç½®å’Œæ¨¡æ¿
2. **çŠ¶æ€ç®¡ç†åä½œ**ï¼š

   - `FormBasedDialogSystem` ç®¡ç†æ‰€æœ‰æ§½ä½çš„è¿è¡Œæ—¶çŠ¶æ€ (`FormSlot`)
   - ç»´æŠ¤è®¢å•çŠ¶æ€æœº (`OrderStatus`) å’Œæ§½ä½çŠ¶æ€ (`SlotStatus`)
   - çŠ¶æ€å˜åŒ–è§¦å‘ç›¸åº”çš„äº‹ä»¶å¤„ç†å’Œå“åº”ç”Ÿæˆ
3. **è¯­ä¹‰ç†è§£åä½œ**ï¼š

   - ç›´æ¥å…³é”®è¯åŒ¹é…ï¼šä½¿ç”¨æœ¬åœ°é…ç½®è¿›è¡Œå¿«é€ŸåŒ¹é…
   - è¯­ä¹‰æ˜ å°„ï¼šè°ƒç”¨ `SemanticMapper.map()` è¿›è¡Œæœ¬åœ°è¯­ä¹‰ç†è§£
   - LLMæŠ½å–ï¼šè°ƒç”¨ `SparkLLMClient.extract_slots()` è¿›è¡Œå¤æ‚è¯­ä¹‰ç†è§£
   - åŠ¨æ€é€‰é¡¹ï¼šè°ƒç”¨ `OptionBuilder.build()` åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆå€™é€‰é€‰é¡¹
4. **å†²çªå¤„ç†åä½œ**ï¼š

   - å†²çªæ£€æµ‹ï¼šæ¯”è¾ƒæ–°æ—§å€¼çš„æ¥æºä¼˜å…ˆçº§å’Œç½®ä¿¡åº¦
   - å†²çªè§£å†³ï¼šæä¾›ä¸‰ç§è§£å†³ç­–ç•¥å¹¶æ¸…ç†ä¾èµ–é“¾
   - çŠ¶æ€æ¢å¤ï¼šå†²çªè§£å†³åæ¢å¤æ­£å¸¸çš„å¯¹è¯æµç¨‹
5. **å“åº”ç”Ÿæˆåä½œ**ï¼š

   - åŸºäºå½“å‰çŠ¶æ€å’ŒæŠ½å–ç»“æœç”Ÿæˆå“åº”
   - ä½¿ç”¨ä¸šåŠ¡æ¨¡æ¿å’ŒåŠ¨æ€å†…å®¹æ„å»ºç”¨æˆ·æç¤º
   - æ”¯æŒå†²çªæç¤ºã€ç¼ºå¤±ä¿¡æ¯è¯¢é—®ã€è®¢å•ç¡®è®¤ç­‰å¤šç§å“åº”ç±»å‹

#### æ•°æ®æµå‘

```
ç”¨æˆ·è¾“å…¥
    â†“
FormBasedDialogSystem.process_input()
    â†“
ä¸‰å±‚ä¿¡æ¯æŠ½å–ç­–ç•¥
    â”œâ”€â”€ Layer 1: ç›´æ¥å…³é”®è¯åŒ¹é… â†’ æœ¬åœ°é…ç½®
    â”œâ”€â”€ Layer 2: è¯­ä¹‰æ˜ å°„æ¨è â†’ SemanticMapper + OptionBuilder  
    â””â”€â”€ Layer 3: LLMå…¨å±€æŠ½å– â†’ SparkLLMClient
    â†“
æ§½ä½çŠ¶æ€æ›´æ–°å’Œå†²çªæ£€æµ‹
    â†“
æ™ºèƒ½å“åº”ç”Ÿæˆ
    â”œâ”€â”€ ç¡®è®¤æ”¶åˆ°ä¿¡æ¯
    â”œâ”€â”€ å†²çªå¤„ç†æç¤º
    â”œâ”€â”€ ç¼ºå¤±ä¿¡æ¯è¯¢é—®
    â””â”€â”€ è®¢å•ç¡®è®¤é€‰é¡¹
    â†“
ç”¨æˆ·è¾“å‡º
```

è¿™ç§è®¾è®¡å®ç°äº†å®Œæ•´çš„å¯¹è¯çŠ¶æ€ç®¡ç†å’Œä¸šåŠ¡æµç¨‹æ§åˆ¶ï¼Œé€šè¿‡å¤šå±‚çº§çš„ä¿¡æ¯æŠ½å–ç­–ç•¥å’Œæ™ºèƒ½çš„å†²çªè§£å†³æœºåˆ¶ï¼Œç¡®ä¿äº†ç³»ç»Ÿåœ¨å¤æ‚å¯¹è¯åœºæ™¯ä¸‹çš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚

## 4.4 AIæœåŠ¡é›†æˆå­ç³»ç»Ÿè¯¦ç»†è®¾è®¡

### 4.4.1 å­ç³»ç»Ÿæ¦‚è¿°

AIæœåŠ¡é›†æˆå­ç³»ç»Ÿè´Ÿè´£å°è£…å¤–éƒ¨AIæœåŠ¡çš„èƒ½åŠ›ï¼Œæä¾›ç»Ÿä¸€çš„è‡ªç„¶è¯­è¨€ç†è§£æ¥å£ï¼ŒåŒæ—¶å®ç°æœåŠ¡é™çº§å’Œå®¹é”™æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯é æ€§ã€‚è¯¥å­ç³»ç»Ÿé›†æˆäº†æ˜Ÿç«å¤§æ¨¡å‹APIå’Œæœ¬åœ°è¯­ä¹‰ç†è§£èƒ½åŠ›ï¼Œé€šè¿‡å¤šå±‚æ¬¡çš„è¯­ä¹‰åŒ¹é…ç­–ç•¥å¹³è¡¡å‡†ç¡®æ€§å’Œæ€§èƒ½ã€‚

### 4.4.2 æ ¸å¿ƒç±»è®¾è®¡

#### SparkLLMClientç±»

**å®šä¹‰æ¥æº**ï¼šspark_client.py

```python
class SparkLLMClient(ILLMClient):
    """æ˜Ÿç«å¤§æ¨¡å‹å®¢æˆ·ç«¯"""
  
    def __init__(self, api_key: str, api_url: str = None, model: str = None):
        """
        åˆå§‹åŒ–LLMå®¢æˆ·ç«¯
  
        Args:
            api_key: APIè®¤è¯å¯†é’¥ï¼Œæ”¯æŒBearer Tokenæ ¼å¼
            api_url: APIç«¯ç‚¹URLï¼Œå¯é€‰ï¼Œæœ‰é»˜è®¤å€¼
            model: ä½¿ç”¨çš„æ¨¡å‹åç§°ï¼Œå¯é€‰ï¼Œæœ‰é»˜è®¤å€¼
        """
  
    def extract_slots(self, user_input: str, business_line: str, 
                     target_slots: List[str], current_values: Optional[Dict[str, Any]] = None) -> Dict[str, Dict[str, Any]]:
        """
        ä»ç”¨æˆ·è¾“å…¥ä¸­æŠ½å–å¤šä¸ªæ§½ä½ä¿¡æ¯
  
        Args:
            user_input: ç”¨æˆ·è¾“å…¥çš„è‡ªç„¶è¯­è¨€æ–‡æœ¬
            business_line: ä¸šåŠ¡çº¿æ ‡è¯†ï¼Œç”¨äºæ„é€ é¢†åŸŸç‰¹å®šçš„æç¤º
            target_slots: ç›®æ ‡æŠ½å–çš„æ§½ä½åç§°åˆ—è¡¨
            current_values: å½“å‰å·²å¡«å……çš„æ§½ä½å€¼ï¼Œç”¨äºä¸Šä¸‹æ–‡ç†è§£
  
        Returns:
            æ§½ä½æŠ½å–ç»“æœå­—å…¸ï¼Œç»“æ„ä¸º:
            {
                "slot_name": {
                    "value": "æŠ½å–çš„å€¼",
                    "confidence": 0.8,
                    "reason": "æŠ½å–ç†ç”±"
                }
            }
        """
  
    def _call_api(self, messages: List[Dict]) -> str:
        """APIè°ƒç”¨å®ç°"""
  
    def _build_extraction_prompt(self, user_input: str, target_slots: List[str], 
                               current_values: Dict[str, Any]) -> List[Dict[str, str]]:
        """LLMæç¤ºè¯æ„é€ ç®—æ³•"""
  
    def _clean_llm_response(self, text: str) -> str:
        """æ¸…ç†LLMå“åº”æ–‡æœ¬"""
  
    def _parse_llm_json(self, text: str) -> Optional[Dict[str, Any]]:
        """è§£æLLMè¿”å›çš„JSON"""
  
    def _validate_and_filter_results(self, result_obj: Dict[str, Any], business_line: str) -> Dict[str, Dict[str, Any]]:
        """éªŒè¯å’Œè¿‡æ»¤æŠ½å–ç»“æœ"""
```

**èŒè´£è¯´æ˜**ï¼š

- å°è£…æ˜Ÿç«å¤§æ¨¡å‹APIçš„è°ƒç”¨ç»†èŠ‚
- å®ç°å¤šæ§½ä½å¹¶è¡ŒæŠ½å–çš„æç¤ºè¯æ„é€ 
- æä¾›é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥
- ç®¡ç†APIè®¤è¯å’Œè¯·æ±‚é™æµ

#### SemanticMapperç±»

**å®šä¹‰æ¥æº**ï¼šoption_mapping.py

```python
class SemanticMapper:
    """è¯­ä¹‰æ˜ å°„å™¨"""
  
    @staticmethod
    def map(user_text: str, options: List[Option]) -> SemanticMatchResult:
        """
        å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè¯­ä¹‰æ˜ å°„åŒ¹é…
  
        Args:
            user_text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬ï¼Œè¿›è¡Œå°å†™åŒ–å’Œæ¸…ç†å¤„ç†
            options: å€™é€‰é€‰é¡¹åˆ—è¡¨ï¼ŒåŒ…å«æ ‡ç­¾ã€åŒä¹‰è¯å’Œå…³é”®è¯
  
        Returns:
            è¯­ä¹‰åŒ¹é…ç»“æœï¼ŒåŒ…å«é€‰æ‹©çš„ç´¢å¼•ã€ç½®ä¿¡åº¦ã€åŸå› å’Œç­–ç•¥
            å¦‚æœæ²¡æœ‰è¶³å¤Ÿç½®ä¿¡åº¦çš„åŒ¹é…ï¼Œchosen_indexä¸ºNone
        """
  
    @staticmethod
    def _calculate_similarity(text1: str, text2: str) -> float:
        """è®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦"""
  
    @staticmethod
    def _exact_match(text_clean: str, option: Option) -> Optional[SemanticMatchResult]:
        """ç²¾ç¡®åŒ¹é…ç­–ç•¥"""
  
    @staticmethod
    def _synonym_match(text_clean: str, option: Option) -> Optional[SemanticMatchResult]:
        """åŒä¹‰è¯åŒ¹é…ç­–ç•¥"""
  
    @staticmethod
    def _keyword_match(text_clean: str, option: Option) -> Tuple[bool, float]:
        """å…³é”®è¯åŒ¹é…ç­–ç•¥"""
  
    @staticmethod
    def _boundary_match(text_clean: str, option: Option) -> Optional[SemanticMatchResult]:
        """è¾¹ç•ŒåŒ¹é…ç­–ç•¥"""
```

**èŒè´£è¯´æ˜**ï¼š

- å®ç°åŸºäºè§„åˆ™çš„æœ¬åœ°è¯­ä¹‰ç†è§£
- æä¾›å…³é”®è¯å’ŒåŒä¹‰è¯çš„åŒ¹é…è®¡ç®—
- æ”¯æŒè¾¹ç•ŒåŒ¹é…é¿å…è¯¯åŒ¹é…é—®é¢˜
- æä¾›å¯è§£é‡Šçš„åŒ¹é…ç»“æœ

#### OptionBuilderç±»

**å®šä¹‰æ¥æº**ï¼šoption_mapping.py

```python
class OptionBuilder:
    """é€‰é¡¹æ„å»ºå™¨"""
  
    @staticmethod
    def build(stage: str, context: Dict) -> List[Option]:
        """
        æ ¹æ®è¯­ä¹‰é˜¶æ®µå’Œä¸Šä¸‹æ–‡æ„å»ºå€™é€‰é€‰é¡¹
  
        Args:
            stage: è¯­ä¹‰é˜¶æ®µæ ‡è¯†ï¼Œå¦‚'chip_select'ã€'storage_select'
            context: ä¸Šä¸‹æ–‡å­—å…¸ï¼ŒåŒ…å«å½“å‰å·²é€‰çš„æ§½ä½å€¼
  
        Returns:
            å€™é€‰é€‰é¡¹åˆ—è¡¨ï¼ŒåŒ…å«ç´¢å¼•ã€ä»£ç ã€æ ‡ç­¾å’Œè¯­ä¹‰ä¿¡æ¯
            å¦‚æœæ²¡æœ‰åŒ¹é…çš„é˜¶æ®µï¼Œè¿”å›ç©ºåˆ—è¡¨
        """
  
    @staticmethod
    def _filter_by_context(options: List[Option], context: Dict) -> List[Option]:
        """åŸºäºä¸Šä¸‹æ–‡è¿‡æ»¤é€‰é¡¹"""
  
    @staticmethod
    def _load_stage_config(stage: str) -> Optional[Dict[str, Any]]:
        """åŠ è½½è¯­ä¹‰é˜¶æ®µé…ç½®"""
  
    @staticmethod
    def _build_option_from_config(option_config: Dict[str, Any], idx: int) -> Option:
        """ä»é…ç½®æ„å»ºé€‰é¡¹å¯¹è±¡"""
  
    @staticmethod
    def _apply_business_rules(options: List[Option], context: Dict) -> List[Option]:
        """åº”ç”¨ä¸šåŠ¡è§„åˆ™è¿‡æ»¤"""
```

**èŒè´£è¯´æ˜**ï¼š

- åŠ¨æ€æ„å»ºåŸºäºä¸Šä¸‹æ–‡çš„å€™é€‰é€‰é¡¹
- å®ç°ä¸šåŠ¡è§„åˆ™çš„åŠ¨æ€åº”ç”¨
- æ”¯æŒè¯­ä¹‰é˜¶æ®µçš„ä¸ªæ€§åŒ–é€‰é¡¹ç”Ÿæˆ
- æä¾›é€‰é¡¹çš„è¯­ä¹‰æè¿°å’Œå…³é”®è¯

### 4.4.3 å…³é”®æ•°æ®ç»“æ„

#### è¯­ä¹‰åŒ¹é…ç»“æœ

**å®šä¹‰æ¥æº**ï¼šoption_mapping.py

```python
@dataclass
class SemanticMatchResult:
    """è¯­ä¹‰åŒ¹é…ç»“æœ"""
    chosen_index: Optional[int]    é€‰æ‹©çš„é€‰é¡¹ç´¢å¼•
    confidence: float              åŒ¹é…ç½®ä¿¡åº¦ [0.0, 1.0]
    reason: str                    åŒ¹é…åŸå› æè¿°
    strategy: str                  åŒ¹é…ç­–ç•¥æ ‡è¯†
```

**è¯´æ˜**ï¼šå°è£…è¯­ä¹‰åŒ¹é…çš„ç»“æœå’Œå…ƒæ•°æ®ã€‚`confidence`æ”¯æŒé˜ˆå€¼è¿‡æ»¤ï¼Œ`reason`æä¾›å¯è§£é‡Šçš„åŒ¹é…è¿‡ç¨‹ï¼Œå¢å¼ºç³»ç»Ÿé€æ˜åº¦ã€‚

#### é€‰é¡¹æ•°æ®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šoption_mapping.py

```python
@dataclass
class Option:
    """è¯­ä¹‰é€‰é¡¹ç»“æ„"""
    idx: int                1-basedç´¢å¼•
    code: str               è§„èŒƒçŸ­ä»£ç 
    label: str              æ˜¾ç¤ºæ ‡ç­¾
    synonyms: List[str] = field(default_factory=list)     åŒä¹‰è¯
    keywords: List[str] = field(default_factory=list)     å…³é”®è¯
```

**è¯´æ˜**ï¼šç”¨äºè¯­ä¹‰æ˜ å°„çš„é€‰é¡¹ç»“æ„ã€‚`synonyms`æ”¯æŒçµæ´»çš„ç”¨æˆ·è¡¨è¾¾ï¼Œ`keywords`ç”¨äºç²¾ç¡®çš„è¯­ä¹‰åŒ¹é…ï¼Œå®ç°æœ¬åœ°åŒ–çš„æ™ºèƒ½ç†è§£ã€‚

#### LLMè¯·æ±‚æ•°æ®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šspark_client.py

```python
@dataclass
class LLMRequest:
    """LLM APIè¯·æ±‚ç»“æ„"""
    model: str = "lite"
    messages: List[Dict[str, str]] = field(default_factory=list)
    temperature: float = 0.1
    max_tokens: int = 1000
    stream: bool = False

@dataclass  
class LLMResponse:
    """LLM APIå“åº”ç»“æ„"""
    content: str
    status_code: int
    error_message: Optional[str] = None
```

**è¯´æ˜**ï¼šå°è£…LLM APIçš„è¯·æ±‚å’Œå“åº”æ•°æ®ï¼Œæä¾›ç±»å‹å®‰å…¨çš„æ¥å£å®šä¹‰ã€‚

### 4.4.4 æ ¸å¿ƒç®—æ³•å®ç°

#### LLMæç¤ºè¯æ„é€ ç®—æ³•

**å®ç°æ¥æº**ï¼šspark_client.py

```python
def _build_extraction_prompt(self, user_input: str, target_slots: List[str], 
                           current_values: Dict[str, Any]) -> List[Dict[str, str]]:
    """LLMæç¤ºè¯æ„é€ ç®—æ³•"""
    system_prompt = f"""ä½ æ˜¯ä¸€ä¸ª{self.business_line}é¢†åŸŸçš„æ™ºèƒ½åŠ©æ‰‹ã€‚
è¯·ä»ç”¨æˆ·è¾“å…¥ä¸­æå–ä»¥ä¸‹ä¿¡æ¯ï¼š{', '.join(target_slots)}
  
å½“å‰å·²å¡«å†™ä¿¡æ¯ï¼š{json.dumps(current_values, ensure_ascii=False)}
  
è¦æ±‚ï¼š
1. åªæå–ç”¨æˆ·æ˜ç¡®æä¾›çš„ä¿¡æ¯
2. ä¸è¦æ¨æµ‹æˆ–æ·»åŠ é¢å¤–ä¿¡æ¯
3. å¦‚æœä¿¡æ¯ä¸å­˜åœ¨ï¼Œå¯¹åº”å­—æ®µç•™ç©º
4. è¿”å›JSONæ ¼å¼ï¼ŒåŒ…å«valueã€confidenceã€reasonå­—æ®µ
5. confidenceä¸º0-1çš„æµ®ç‚¹æ•°ï¼Œè¡¨ç¤ºç¡®ä¿¡ç¨‹åº¦
6. reasonç®€è¦è¯´æ˜æå–ä¾æ®

ç¤ºä¾‹æ ¼å¼ï¼š
{{
  "slot_name1": {{
    "value": "æå–çš„å€¼",
    "confidence": 0.8,
    "reason": "ç”¨æˆ·æ˜ç¡®æåˆ°äº†..."
  }},
  "slot_name2": {{
    "value": "",
    "confidence": 0.0,
    "reason": "ç”¨æˆ·æœªæä¾›æ­¤ä¿¡æ¯"
  }}
}}"""
  
    return [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_input}
    ]
```

**è®¾è®¡æ€è·¯**ï¼šè®¾è®¡äº†é¢†åŸŸç‰¹å®šçš„æç¤ºè¯æ„é€ ç­–ç•¥ï¼Œé€šè¿‡ç³»ç»Ÿæç¤ºæ˜ç¡®æŠ½å–è§„åˆ™å’Œæ ¼å¼è¦æ±‚ï¼Œç»“åˆå½“å‰ä¸Šä¸‹æ–‡ä¿¡æ¯æé«˜æŠ½å–å‡†ç¡®æ€§ã€‚

#### æœ¬åœ°è¯­ä¹‰åŒ¹é…ç®—æ³•

**å®ç°æ¥æº**ï¼šoption_mapping.py

```python
def map(user_text: str, options: List[Option]) -> SemanticMatchResult:
    """æœ¬åœ°è¯­ä¹‰åŒ¹é…ç®—æ³•"""
    text_clean = user_text.lower().strip()
    best_match = None
    best_confidence = 0.0
    best_strategy = ""
    best_reason = ""
  
    for option in options:
         ç­–ç•¥1: å®Œå…¨åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        exact_result = SemanticMapper._exact_match(text_clean, option)
        if exact_result:
            return exact_result
  
         ç­–ç•¥2: åŒä¹‰è¯åŒ¹é…
        synonym_result = SemanticMapper._synonym_match(text_clean, option)
        if synonym_result:
            return synonym_result
  
         ç­–ç•¥3: è¾¹ç•ŒåŒ¹é…
        boundary_result = SemanticMapper._boundary_match(text_clean, option)
        if boundary_result:
            return boundary_result
  
         ç­–ç•¥4: å…³é”®è¯åŒ¹é…ï¼ˆæ”¶é›†æœ€ä½³åŒ¹é…ï¼‰
        keyword_match, keyword_confidence = SemanticMapper._keyword_match(text_clean, option)
        if keyword_match and keyword_confidence > best_confidence:
            best_confidence = keyword_confidence
            best_match = option
            best_strategy = "keyword_match"
            best_reason = f"å…³é”®è¯åŒ¹é…: {option.label}"
  
    if best_match:
        return SemanticMatchResult(
            chosen_index=best_match.idx,
            confidence=best_confidence,
            reason=best_reason,
            strategy=best_strategy
        )
  
    return SemanticMatchResult(None, 0.0, "æ— åŒ¹é…", "no_match")
```

**è®¾è®¡æ€è·¯**ï¼šå®ç°äº†å¤šçº§è¯­ä¹‰åŒ¹é…ç­–ç•¥ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œä¸åŒç²’åº¦çš„åŒ¹é…ç®—æ³•ï¼Œç¡®ä¿åœ¨ä¿è¯å‡†ç¡®æ€§çš„åŒæ—¶æä¾›å¿«é€Ÿå“åº”ã€‚

#### ç²¾ç¡®åŒ¹é…ç­–ç•¥

**å®ç°æ¥æº**ï¼šoption_mapping.py

```python
def _exact_match(text_clean: str, option: Option) -> Optional[SemanticMatchResult]:
    """ç²¾ç¡®åŒ¹é…ç­–ç•¥"""
     å®Œå…¨ç›¸ç­‰åŒ¹é…
    if text_clean == option.label.lower():
        return SemanticMatchResult(
            chosen_index=option.idx,
            confidence=1.0,
            reason=f"å®Œå…¨åŒ¹é…: {option.label}",
            strategy="exact_match"
        )
  
     åŒä¹‰è¯å®Œå…¨åŒ¹é…
    for synonym in option.synonyms:
        if text_clean == synonym.lower():
            return SemanticMatchResult(
                chosen_index=option.idx,
                confidence=0.95,
                reason=f"åŒä¹‰è¯å®Œå…¨åŒ¹é…: {synonym} -> {option.label}",
                strategy="exact_synonym_match"
            )
  
    return None
```

**è®¾è®¡æ€è·¯**ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥ä¸é€‰é¡¹æ ‡ç­¾æˆ–åŒä¹‰è¯å®Œå…¨ä¸€è‡´çš„æƒ…å†µï¼Œæä¾›æœ€é«˜ç½®ä¿¡åº¦çš„åŒ¹é…ç»“æœã€‚

#### è¾¹ç•ŒåŒ¹é…ç­–ç•¥

**å®ç°æ¥æº**ï¼šoption_mapping.py

```python
def _boundary_match(text_clean: str, option: Option) -> Optional[SemanticMatchResult]:
    """è¾¹ç•ŒåŒ¹é…ç­–ç•¥"""
     é€‰é¡¹æ ‡ç­¾è¾¹ç•ŒåŒ¹é…
    label_lower = option.label.lower()
    pattern = r'(^|[^a-z0-9])' + re.escape(label_lower) + r'($|[^a-z0-9])'
    if re.search(pattern, text_clean):
        return SemanticMatchResult(
            chosen_index=option.idx,
            confidence=0.9,
            reason=f"è¾¹ç•ŒåŒ¹é…: {option.label}",
            strategy="boundary_match"
        )
  
     åŒä¹‰è¯è¾¹ç•ŒåŒ¹é…
    for synonym in option.synonyms:
        synonym_lower = synonym.lower()
        pattern = r'(^|[^a-z0-9])' + re.escape(synonym_lower) + r'($|[^a-z0-9])'
        if re.search(pattern, text_clean):
            return SemanticMatchResult(
                chosen_index=option.idx,
                confidence=0.85,
                reason=f"åŒä¹‰è¯è¾¹ç•ŒåŒ¹é…: {synonym} -> {option.label}",
                strategy="boundary_synonym_match"
            )
  
    return None
```

**è®¾è®¡æ€è·¯**ï¼šé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ç¡®ä¿å…³é”®è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…è¯¯åŒ¹é…é—®é¢˜ï¼Œå¦‚"pro"ä¸ä¼šåŒ¹é…åˆ°"professional"ã€‚

#### å…³é”®è¯åŒ¹é…ç­–ç•¥

**å®ç°æ¥æº**ï¼šoption_mapping.py

```python
def _keyword_match(text_clean: str, option: Option) -> Tuple[bool, float]:
    """å…³é”®è¯åŒ¹é…ç­–ç•¥"""
    keyword_match = False
    max_keyword_confidence = 0.0
  
    for keyword in option.keywords:
        keyword_lower = keyword.lower()
        if keyword_lower in text_clean:
            keyword_match = True
             ç½®ä¿¡åº¦è®¡ç®—ï¼šåŸºç¡€ç½®ä¿¡åº¦ + å…³é”®è¯é•¿åº¦æƒé‡
            base_confidence = 0.7
            length_bonus = min(0.2, len(keyword_lower) * 0.05)
            confidence = base_confidence + length_bonus
            max_keyword_confidence = max(max_keyword_confidence, confidence)
  
    return keyword_match, max_keyword_confidence
```

**è®¾è®¡æ€è·¯**ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥åŒ…å«é€‰é¡¹å…³é”®è¯çš„æƒ…å†µï¼Œé€šè¿‡å…³é”®è¯é•¿åº¦åŠ¨æ€è°ƒæ•´ç½®ä¿¡åº¦ï¼Œé•¿å…³é”®è¯å…·æœ‰æ›´é«˜æƒé‡ã€‚

#### åŠ¨æ€é€‰é¡¹æ„å»ºç®—æ³•

**å®ç°æ¥æº**ï¼šoption_mapping.py

```python
def build(stage: str, context: Dict) -> List[Option]:
    """åŠ¨æ€é€‰é¡¹æ„å»ºç®—æ³•"""
     åŠ è½½è¯­ä¹‰é˜¶æ®µé…ç½®
    stage_config = OptionBuilder._load_stage_config(stage)
    if not stage_config:
        return []
  
     è·å–åŸºç¡€é€‰é¡¹
    base_options = stage_config.get('options', [])
    if not base_options:
        return []
  
     æ„å»ºé€‰é¡¹å¯¹è±¡
    options = []
    for idx, option_config in enumerate(base_options, 1):
        option = OptionBuilder._build_option_from_config(option_config, idx)
        options.append(option)
  
     åº”ç”¨ä¸Šä¸‹æ–‡è¿‡æ»¤
    filtered_options = OptionBuilder._filter_by_context(options, context)
  
     åº”ç”¨ä¸šåŠ¡è§„åˆ™
    final_options = OptionBuilder._apply_business_rules(filtered_options, context)
  
    return final_options
```

**è®¾è®¡æ€è·¯**ï¼šåŸºäºè¯­ä¹‰é˜¶æ®µæ ‡è¯†å’Œå½“å‰å¯¹è¯ä¸Šä¸‹æ–‡åŠ¨æ€æ„å»ºå€™é€‰é€‰é¡¹ï¼Œæ”¯æŒå¤æ‚çš„ä¸šåŠ¡è§„åˆ™è¿‡æ»¤å’Œä¸ªæ€§åŒ–æ¨èã€‚

#### LLMå“åº”è§£æç®—æ³•

**å®ç°æ¥æº**ï¼šspark_client.py

```python
def _parse_llm_json(self, text: str) -> Optional[Dict[str, Any]]:
    """LLMå“åº”è§£æç®—æ³•"""
    try:
         å°è¯•ç›´æ¥è§£æJSON
        return json.loads(text)
    except json.JSONDecodeError:
         å°è¯•æå–JSONå—
        json_match = re.search(r'\{.*\}', text, re.DOTALL)
        if json_match:
            try:
                return json.loads(json_match.group())
            except json.JSONDecodeError:
                pass
  
         å°è¯•æ¸…ç†å¸¸è§æ ¼å¼é—®é¢˜
        cleaned_text = text.strip()
        if cleaned_text.startswith('```json'):
            cleaned_text = cleaned_text[7:]
        if cleaned_text.endswith('```'):
            cleaned_text = cleaned_text[:-3]
        cleaned_text = cleaned_text.strip()
  
        try:
            return json.loads(cleaned_text)
        except json.JSONDecodeError:
            print(f"LLMå“åº”JSONè§£æå¤±è´¥: {cleaned_text}")
            return None
```

**è®¾è®¡æ€è·¯**ï¼šå®ç°å¥å£®çš„JSONè§£æç­–ç•¥ï¼Œå¤„ç†LLMè¿”å›çš„ä¸è§„èŒƒJSONæ ¼å¼ï¼Œé€šè¿‡å¤šå±‚æ¢å¤ç­–ç•¥æé«˜è§£ææˆåŠŸç‡ã€‚

#### å¼‚å¸¸å¤„ç†ç®—æ³•

**å®ç°æ¥æº**ï¼šspark_client.py

```python
def extract_slots(self, user_input: str, business_line: str, target_slots: List[str], 
                 current_values: Optional[Dict[str, Any]] = None) -> Dict[str, Dict[str, Any]]:
    """LLMæŠ½å–çš„å¼‚å¸¸å®‰å…¨å®ç°"""
    if not user_input or not target_slots:
        return {}
  
    try:
         æ„å»ºæç¤ºè¯å’Œè°ƒç”¨LLM
        messages = self._build_extraction_prompt(user_input, target_slots, current_values or {})
        raw_result = self._call_api(messages)
        text = raw_result.strip()
  
         å“åº”æ ¼å¼æ¸…ç†
        cleaned_text = self._clean_llm_response(text)
        if not cleaned_text:
            return {}
  
         JSONè§£æ
        result_obj = self._parse_llm_json(cleaned_text)
        if not result_obj:
            return {}
  
         ç»“æœéªŒè¯å’Œè¿‡æ»¤
        return self._validate_and_filter_results(result_obj, business_line)
  
    except requests.exceptions.Timeout:
        print("ğŸ¤– LLM APIè¯·æ±‚è¶…æ—¶")
        return {}
    except requests.exceptions.ConnectionError:
        print("ğŸ¤– LLM APIè¿æ¥é”™è¯¯")
        return {}
    except Exception as e:
        print(f"ğŸ¤– LLMæŠ½å–å¼‚å¸¸: {e}")
        return {}   é™é»˜é™çº§ï¼Œè¿”å›ç©ºç»“æœ
```

**è®¾è®¡æ€è·¯**ï¼šè®¾è®¡äº†é˜²å¾¡æ€§çš„LLMæœåŠ¡é›†æˆç­–ç•¥ï¼Œç¡®ä¿åœ¨å¤–éƒ¨æœåŠ¡å¼‚å¸¸æ—¶ç³»ç»Ÿä»èƒ½é™çº§è¿è¡Œã€‚é€šè¿‡å¤šå±‚å¼‚å¸¸æ•è·å’Œé™é»˜é™çº§ï¼Œå®ç°äº†é«˜å¯ç”¨çš„å¯¹è¯æœåŠ¡ã€‚

### 4.4.5 ç±»åä½œå…³ç³»

#### ç±»å…³ç³»å›¾ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SparkLLMClient  â”‚    â”‚  SemanticMapper  â”‚    â”‚   OptionBuilder  â”‚
â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚
â”‚ - extract_slots()â”‚    â”‚ - map()          â”‚    â”‚ - build()        â”‚
â”‚ - _call_api()    â”‚    â”‚ - _exact_match() â”‚    â”‚ - _filter_by_    â”‚
â”‚ - _build_prompt()â”‚    â”‚ - _keyword_match()â”‚   â”‚   context()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚                       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ FormBasedDialog â”‚
                         â”‚ System          â”‚
                         â”‚                 â”‚
                         â”‚ - process_input()â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  ä¸šåŠ¡é…ç½®å±‚      â”‚
                         â”‚                 â”‚
                         â”‚ - æšä¸¾é…ç½®      â”‚
                         â”‚ - è¯­ä¹‰é˜¶æ®µé…ç½®  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åä½œæµç¨‹è¯´æ˜

1. **è¯­ä¹‰ç†è§£è¯·æ±‚æµç¨‹**ï¼š

   - `FormBasedDialogSystem` è°ƒç”¨AIæœåŠ¡è¿›è¡Œè¯­ä¹‰ç†è§£
   - æ ¹æ®é…ç½®å’Œä¸Šä¸‹æ–‡é€‰æ‹©ä½¿ç”¨ `SparkLLMClient` æˆ– `SemanticMapper`
   - `OptionBuilder` åŸºäºå½“å‰ä¸Šä¸‹æ–‡åŠ¨æ€ç”Ÿæˆå€™é€‰é€‰é¡¹
2. **LLMæœåŠ¡è°ƒç”¨æµç¨‹**ï¼š

   - `SparkLLMClient.extract_slots()` æ¥æ”¶æŠ½å–è¯·æ±‚
   - `_build_extraction_prompt()` æ„é€ é¢†åŸŸç‰¹å®šçš„æç¤ºè¯
   - `_call_api()` æ‰§è¡ŒAPIè°ƒç”¨å¹¶å¤„ç†ç½‘ç»œå¼‚å¸¸
   - `_parse_llm_json()` è§£æå“åº”å¹¶å¤„ç†æ ¼å¼å¼‚å¸¸
   - `_validate_and_filter_results()` éªŒè¯ä¸šåŠ¡è§„åˆ™
3. **æœ¬åœ°è¯­ä¹‰åŒ¹é…æµç¨‹**ï¼š

   - `SemanticMapper.map()` æ‰§è¡Œå¤šçº§åŒ¹é…ç­–ç•¥
   - æŒ‰ä¼˜å…ˆçº§å°è¯•å®Œå…¨åŒ¹é…ã€åŒä¹‰è¯åŒ¹é…ã€è¾¹ç•ŒåŒ¹é…ã€å…³é”®è¯åŒ¹é…
   - è¿”å›æœ€ä½³åŒ¹é…ç»“æœå’Œç½®ä¿¡åº¦ä¿¡æ¯
4. **åŠ¨æ€é€‰é¡¹æ„å»ºæµç¨‹**ï¼š

   - `OptionBuilder.build()` æ ¹æ®è¯­ä¹‰é˜¶æ®µåŠ è½½é…ç½®
   - `_filter_by_context()` åŸºäºå·²é€‰å€¼è¿‡æ»¤é€‰é¡¹
   - `_apply_business_rules()` æ‰§è¡Œä¸šåŠ¡ç‰¹å®šçš„è¿‡æ»¤è§„åˆ™
   - è¿”å›é€‚åˆå½“å‰ä¸Šä¸‹æ–‡çš„å€™é€‰é€‰é¡¹åˆ—è¡¨
5. **å¼‚å¸¸å¤„ç†åä½œ**ï¼š

   - ç½‘ç»œå¼‚å¸¸æ—¶è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°è¯­ä¹‰åŒ¹é…
   - è§£æå¼‚å¸¸æ—¶å°è¯•å¤šç§æ¢å¤ç­–ç•¥
   - ä¸šåŠ¡éªŒè¯å¤±è´¥æ—¶è¿‡æ»¤æ— æ•ˆç»“æœ
   - æ‰€æœ‰å¼‚å¸¸æœ€ç»ˆé™é»˜å¤„ç†ï¼Œç¡®ä¿ç³»ç»Ÿå¯ç”¨æ€§

#### æ•°æ®æµå‘

```
ç”¨æˆ·è¾“å…¥
    â†“
FormBasedDialogSystem
    â†“
AIæœåŠ¡é€‰æ‹©
    â”œâ”€â”€ å¤æ‚è¡¨è¾¾ â†’ SparkLLMClient
    â”‚         â”œâ”€â”€ æç¤ºè¯æ„é€ 
    â”‚         â”œâ”€â”€ APIè°ƒç”¨
    â”‚         â”œâ”€â”€ å“åº”è§£æ
    â”‚         â””â”€â”€ ç»“æœéªŒè¯
    â”‚
    â””â”€â”€ ç®€å•è¡¨è¾¾ â†’ SemanticMapper
              â”œâ”€â”€ é€‰é¡¹å‡†å¤‡ â†’ OptionBuilder
              â”œâ”€â”€ å¤šçº§åŒ¹é…
              â””â”€â”€ ç½®ä¿¡åº¦è®¡ç®—
    â†“
è¯­ä¹‰ç†è§£ç»“æœ
    â†“
æ§½ä½å€¼æ›´æ–°
```

è¿™ç§è®¾è®¡å®ç°äº†çµæ´»å¯æ‰©å±•çš„AIæœåŠ¡é›†æˆæ¶æ„ï¼Œé€šè¿‡å¤šå±‚æ¬¡çš„è¯­ä¹‰ç†è§£ç­–ç•¥å’Œå¥å£®çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿äº†ç³»ç»Ÿåœ¨å„ç§åœºæ™¯ä¸‹çš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚

## 4.5 çŸ¥è¯†åº“å±‚è¯¦ç»†è®¾è®¡

### 4.5.1 å­ç³»ç»Ÿæ¦‚è¿°

çŸ¥è¯†åº“å±‚å­ç³»ç»Ÿè´Ÿè´£ä¸šåŠ¡é…ç½®å’Œæ¨¡æ¿çš„é›†ä¸­åŒ–ç®¡ç†ï¼Œä¸ºæ•´ä¸ªç³»ç»Ÿæä¾›ç»Ÿä¸€çš„é…ç½®æ•°æ®è®¿é—®æ¥å£ã€‚è¯¥å­ç³»ç»Ÿå®ç°äº†é…ç½®æ•°æ®çš„åŠ è½½ã€ç¼“å­˜ã€éªŒè¯å’ŒåŠ¨æ€æ³¨å…¥åŠŸèƒ½ï¼Œæ”¯æŒå¤šä¸šåŠ¡çº¿çš„å¹¶è¡Œè¿è¡Œå’Œçƒ­æ›´æ–°èƒ½åŠ›ã€‚

### 4.5.2 æ ¸å¿ƒç±»è®¾è®¡

#### BusinessConfigLoaderç±»

**å®šä¹‰æ¥æº**ï¼šbusiness_config_loader.py

```python
class BusinessConfigLoader:
    """ä¸šåŠ¡é…ç½®åŠ è½½å™¨"""
  
    def __init__(self, config_dir: str = None):
        """
        åˆå§‹åŒ–é…ç½®åŠ è½½å™¨
  
        Args:
            config_dir: é…ç½®ç›®å½•è·¯å¾„ï¼Œé»˜è®¤ä¸ºé¢„å®šä¹‰é…ç½®ç›®å½•
        """
  
    def get_business_config(self, business_name: str) -> Optional[BusinessConfig]:
        """
        è·å–æŒ‡å®šä¸šåŠ¡çš„å®Œæ•´é…ç½®
  
        Args:
            business_name: ä¸šåŠ¡åç§°ï¼Œå¯¹åº”JSONé…ç½®æ–‡ä»¶å
  
        Returns:
            ä¸šåŠ¡é…ç½®å¯¹è±¡ï¼ŒåŒ…å«æ§½ä½è§„æ ¼ã€æšä¸¾ã€æ¨¡æ¿ç­‰æ‰€æœ‰é…ç½®æ•°æ®
            å¦‚æœä¸šåŠ¡ä¸å­˜åœ¨è¿”å›None
        """
  
    def inject_slot_specs(self, business_name: str, slot_specs: List[SlotSpec]):
        """
        åŠ¨æ€æ³¨å…¥æ§½ä½è§„æ ¼åˆ°ä¸šåŠ¡é…ç½®
  
        Args:
            business_name: ç›®æ ‡ä¸šåŠ¡åç§°
            slot_specs: æ§½ä½è§„æ ¼åˆ—è¡¨ï¼Œé€šå¸¸ä»DSLç”Ÿæˆ
  
        Note:
            æ­¤æ¥å£ç”¨äºDSLé©±åŠ¨çš„åŠ¨æ€é…ç½®ï¼Œå…è®¸è¿è¡Œæ—¶ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
        """
  
    def get_intent_recommendations(self, business_name: str) -> Dict[str, List[Dict[str, Any]]]:
        """
        è·å–ä¸šåŠ¡çš„æ„å›¾æ¨èé…ç½®
  
        Args:
            business_name: ä¸šåŠ¡åç§°
  
        Returns:
            æ„å›¾æ¨èé…ç½®å­—å…¸ï¼Œç»“æ„ä¸º:
            {
                "slot_name": [
                    {
                        "intent": "åœºæ™¯æè¿°",
                        "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"],
                        "recommend": "æ¨èå€¼",
                        "confidence": 0.75,
                        "reason": "æ¨èç†ç”±"
                    }
                ]
            }
        """
  
    def get_enums(self, business_name: str) -> Dict[str, List[Dict[str, Any]]]:
        """
        è·å–ä¸šåŠ¡çš„æ‰€æœ‰æšä¸¾é…ç½®
  
        Args:
            business_name: ä¸šåŠ¡åç§°
  
        Returns:
            æšä¸¾é…ç½®å­—å…¸ï¼Œé”®ä¸ºæšä¸¾é”®åï¼Œå€¼ä¸ºæšä¸¾é¡¹åˆ—è¡¨
        """
  
    def get_slot_options(self, enum_key: str, business_name: str = None) -> List[Dict[str, Any]]:
        """
        é«˜æ•ˆçš„æšä¸¾é€‰é¡¹è®¿é—®
  
        Args:
            enum_key: æšä¸¾é”®å
            business_name: ä¸šåŠ¡åç§°ï¼Œå¯é€‰
  
        Returns:
            æšä¸¾é€‰é¡¹åˆ—è¡¨ï¼ŒåŒ…å«æ ‡ç­¾ã€åˆ«åç­‰å­—æ®µ
        """
  
    def get_template(self, business_name: str, template_key: str) -> List[str]:
        """
        è·å–ä¸šåŠ¡æ¨¡æ¿å†…å®¹
  
        Args:
            business_name: ä¸šåŠ¡åç§°
            template_key: æ¨¡æ¿é”®å
  
        Returns:
            æ¨¡æ¿å†…å®¹å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªå…ƒç´ 
        """
  
    def get_filters(self, business_name: str) -> Dict[str, Dict[str, List[str]]]:
        """
        è·å–ä¸šåŠ¡è¿‡æ»¤è§„åˆ™
  
        Args:
            business_name: ä¸šåŠ¡åç§°
  
        Returns:
            è¿‡æ»¤è§„åˆ™å­—å…¸ï¼Œæ”¯æŒå¤šçº§ä¸šåŠ¡è§„åˆ™
        """
  
    def _load_all_configs(self):
        """å®¹é”™çš„é…ç½®åŠ è½½å®ç°"""
  
    def _load_business_config(self, business_name: str, config_path: str):
        """å•ä¸ªä¸šåŠ¡é…ç½®åŠ è½½å®ç°"""
  
    def _validate_business_config(self, config_data: Dict[str, Any]) -> bool:
        """ä¸šåŠ¡é…ç½®éªŒè¯"""
```

**èŒè´£è¯´æ˜**ï¼š

- ç®¡ç†æ‰€æœ‰ä¸šåŠ¡çº¿çš„é™æ€é…ç½®æ•°æ®
- å®ç°é…ç½®çš„ç¼“å­˜æœºåˆ¶ï¼Œæå‡è®¿é—®æ€§èƒ½
- æ”¯æŒåŠ¨æ€é…ç½®æ³¨å…¥ï¼Œå®ç°DSLä¸é™æ€é…ç½®çš„èåˆ
- æä¾›ç±»å‹å®‰å…¨çš„é…ç½®è®¿é—®æ¥å£
- æ”¯æŒé…ç½®çš„çƒ­é‡è½½å’Œç‰ˆæœ¬ç®¡ç†

#### Configç±»

**å®šä¹‰æ¥æº**ï¼šconfig/settings.py

```python
class Config:
    """å…¨å±€ç³»ç»Ÿé…ç½®ç®¡ç†"""
  
    @staticmethod
    def validate_config() -> bool:
        """
        éªŒè¯å…¨å±€é…ç½®çš„å®Œæ•´æ€§
  
        Returns:
            é…ç½®éªŒè¯ç»“æœ
        """
  
    @staticmethod
    def get_llm_config() -> Dict[str, Any]:
        """
        è·å–LLMæœåŠ¡é…ç½®
  
        Returns:
            LLMé…ç½®å­—å…¸ï¼ŒåŒ…å«APIå¯†é’¥ã€ç«¯ç‚¹ç­‰
        """
  
    @staticmethod
    def get_business_config_dir() -> str:
        """
        è·å–ä¸šåŠ¡é…ç½®ç›®å½•è·¯å¾„
  
        Returns:
            é…ç½®ç›®å½•ç»å¯¹è·¯å¾„
        """
  
    @staticmethod
    def get_dsl_scripts_dir() -> str:
        """
        è·å–DSLè„šæœ¬ç›®å½•è·¯å¾„
  
        Returns:
            DSLè„šæœ¬ç›®å½•ç»å¯¹è·¯å¾„
        """
  
    @staticmethod
    def get_log_config() -> Dict[str, Any]:
        """
        è·å–æ—¥å¿—é…ç½®
  
        Returns:
            æ—¥å¿—é…ç½®å­—å…¸
        """
  
    @staticmethod
    def get_feature_flags() -> Dict[str, bool]:
        """
        è·å–åŠŸèƒ½å¼€å…³é…ç½®
  
        Returns:
            åŠŸèƒ½å¼€å…³å­—å…¸
        """
```

**èŒè´£è¯´æ˜**ï¼š

- å…¨å±€ç³»ç»Ÿé…ç½®ç®¡ç†
- ç¯å¢ƒå˜é‡æ”¯æŒå’Œè¦†ç›–
- é…ç½®éªŒè¯å’Œé»˜è®¤å€¼ç®¡ç†
- æ•æ„Ÿä¿¡æ¯çš„ç¯å¢ƒå˜é‡ä¿æŠ¤

### 4.5.3 å…³é”®æ•°æ®ç»“æ„

#### ä¸šåŠ¡é…ç½®ä¸»ç»“æ„

**å®šä¹‰æ¥æº**ï¼šbusiness_config_loader.py

```python
@dataclass
class BusinessConfig:
    """ä¸šåŠ¡é…ç½®ä¸»ç»“æ„"""
    name: str
    display_name: str
    description: str
    slot_specs: List[SlotSpec]
    enums: Dict[str, List[Dict[str, Any]]]
    templates: Dict[str, List[str]]
    filters: Dict[str, Dict[str, List[str]]]
    command_keywords: Dict[str, List[str]]
    intent_recommendations: Dict[str, List[Dict[str, Any]]]
```

**è¯´æ˜**ï¼šä¸šåŠ¡é…ç½®åŒ…å«ä¸€ä¸ªä¸šåŠ¡çº¿çš„æ‰€æœ‰é™æ€é…ç½®ä¿¡æ¯ï¼Œä»JSONæ–‡ä»¶åŠ è½½ã€‚`filters`æ”¯æŒåŠ¨æ€é€‰é¡¹è¿‡æ»¤ï¼Œ`intent_recommendations`å®ç°æ™ºèƒ½æ¨èã€‚

#### æ§½ä½è§„æ ¼å®šä¹‰

**å®šä¹‰æ¥æº**ï¼šinterfaces.py

```python
@dataclass
class SlotSpec:
    """æ§½ä½è§„æ ¼å®šä¹‰"""
    name: str
    required: bool
    description: str
    dependencies: List[str] = field(default_factory=list)
    enums_key: Optional[str] = None
    semantic_stage: Optional[str] = None
    allow_llm: bool = True
```

**è¯´æ˜**ï¼šæ§½ä½è§„æ ¼æ˜¯ä¸šåŠ¡é…ç½®çš„æ ¸å¿ƒï¼Œå®šä¹‰äº†æ¯ä¸ªä¿¡æ¯å­—æ®µçš„ä¸šåŠ¡å±æ€§ã€‚`dependencies`ç¡®ä¿æ­£ç¡®çš„å¡«å……é¡ºåºï¼Œ`allow_llm`æ§åˆ¶AIä½¿ç”¨çš„æƒé™ã€‚

#### æšä¸¾é¡¹æ•°æ®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šä¸šåŠ¡é…ç½®æ–‡ä»¶ï¼ˆå¦‚apple_store.jsonï¼‰

```json
{
  "enums": {
    "category": [
      {
        "label": "æ‰‹æœº",
        "aliases": ["iphone", "æ™ºèƒ½æ‰‹æœº", "æ‰‹æœº"],
        "description": "iPhoneç³»åˆ—äº§å“"
      },
      {
        "label": "ç”µè„‘", 
        "aliases": ["mac", "macbook", "ç¬”è®°æœ¬ç”µè„‘", "ç”µè„‘"],
        "description": "Macç³»åˆ—äº§å“"
      }
    ]
  }
}
```

**è¯´æ˜**ï¼šæšä¸¾é¡¹åŒ…å«æ˜¾ç¤ºæ ‡ç­¾ã€ç”¨æˆ·è¡¨è¾¾åˆ«åå’Œä¸šåŠ¡æè¿°ï¼Œæ”¯æŒçµæ´»çš„è¯­ä¹‰åŒ¹é…ã€‚

#### æ¨¡æ¿æ•°æ®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šä¸šåŠ¡é…ç½®æ–‡ä»¶

```json
{
  "templates": {
    "form_welcome": [
      "æ¬¢è¿æ¥åˆ°è‹¹æœä¸“å–åº—ï¼",
      "è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆäº§å“ï¼š",
      "1. æ‰‹æœº",
      "2. ç”µè„‘", 
      "3. å¹³æ¿",
      "4. æ‰‹è¡¨"
    ],
    "form_info_recorded": [
      "âœ… å¥½çš„ï¼Œæˆ‘è®°ä¸‹å•¦ï¼š"
    ]
  }
}
```

**è¯´æ˜**ï¼šæ¨¡æ¿æ•°æ®å­˜å‚¨ä¸šåŠ¡è¯æœ¯å’Œç”¨æˆ·ç•Œé¢æ–‡æœ¬ï¼Œæ”¯æŒå¤šè¯­è¨€å’Œä¸ªæ€§åŒ–å®šåˆ¶ã€‚

#### è¿‡æ»¤è§„åˆ™æ•°æ®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šä¸šåŠ¡é…ç½®æ–‡ä»¶

```json
{
  "filters": {
    "series_by_category": {
      "æ‰‹æœº": ["iPhone 15", "iPhone 14", "iPhone 13"],
      "ç”µè„‘": ["MacBook Pro", "MacBook Air", "iMac"]
    },
    "size_by_series": {
      "iPhone 15": ["6.1è‹±å¯¸", "6.7è‹±å¯¸"],
      "MacBook Pro": ["14è‹±å¯¸", "16è‹±å¯¸"]
    }
  }
}
```

**è¯´æ˜**ï¼šè¿‡æ»¤è§„åˆ™å®šä¹‰ä¸šåŠ¡å¯¹è±¡é—´çš„çº¦æŸå…³ç³»ï¼Œæ”¯æŒåŸºäºä¸Šä¸‹æ–‡çš„åŠ¨æ€é€‰é¡¹è¿‡æ»¤ã€‚

### 4.5.4 æ ¸å¿ƒç®—æ³•å®ç°

#### é…ç½®åŠ è½½ç®—æ³•

**å®ç°æ¥æº**ï¼šbusiness_config_loader.py

```python
def _load_all_configs(self):
    """å®¹é”™çš„é…ç½®åŠ è½½å®ç°"""
    if not os.path.exists(self.config_dir):
        print(f"é…ç½®ç›®å½•ä¸å­˜åœ¨: {self.config_dir}")
        return
  
    for filename in os.listdir(self.config_dir):
        if filename.endswith('.json'):
            business_name = filename[:-5]   å»æ‰.jsonåç¼€
            config_path = os.path.join(self.config_dir, filename)
            try:
                self._load_business_config(business_name, config_path)
            except Exception as e:
                print(f"åŠ è½½é…ç½®å¤±è´¥ {filename}: {e}")
                 å•ä¸ªé…ç½®å¤±è´¥ä¸å½±å“å…¶ä»–é…ç½®åŠ è½½
```

**è®¾è®¡æ€è·¯**ï¼šé…ç½®åŠ è½½é‡‡ç”¨å®¹é”™ç­–ç•¥ï¼Œå•ä¸ªé…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ä¸å½±å“å…¶ä»–é…ç½®ã€‚æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ç”¨äºé—®é¢˜æ’æŸ¥ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨éƒ¨åˆ†é…ç½®å¼‚å¸¸æ—¶ä»èƒ½æ­£å¸¸è¿è¡Œã€‚

#### å•ä¸ªä¸šåŠ¡é…ç½®åŠ è½½ç®—æ³•

**å®ç°æ¥æº**ï¼šbusiness_config_loader.py

```python
def _load_business_config(self, business_name: str, config_path: str):
    """å•ä¸ªä¸šåŠ¡é…ç½®åŠ è½½å®ç°"""
    with open(config_path, 'r', encoding='utf-8') as f:
        data = json.load(f)
  
     è§£æä¸šåŠ¡ä¿¡æ¯
    business_info = data.get('business_info', {})
  
     è§£ææ§½ä½è§„æ ¼
    slot_specs = []
    for spec_data in data.get('slot_specs', []):
        slot_spec = SlotSpec(
            name=spec_data['name'],
            required=spec_data['required'],
            description=spec_data['description'],
            dependencies=spec_data.get('dependencies', []),
            enums_key=spec_data.get('enums_key'),
            semantic_stage=spec_data.get('semantic_stage'),
            allow_llm=spec_data.get('allow_llm', False)
        )
        slot_specs.append(slot_spec)
  
     åˆ›å»ºä¸šåŠ¡é…ç½®å¯¹è±¡
    config = BusinessConfig(
        name=business_info.get('name', business_name),
        display_name=business_info.get('display_name', business_name),
        description=business_info.get('description', ''),
        slot_specs=slot_specs,
        enums=data.get('enums', {}),
        templates=data.get('templates', {}),
        filters=data.get('filters', {}),
        command_keywords=data.get('command_keywords', {}),
        intent_recommendations=data.get('intent_recommendations', {})
    )
  
    self._configs[business_name] = config
  
     æ›´æ–°å…¨å±€æšä¸¾æ³¨å†Œè¡¨
    for enum_key, enum_values in data.get('enums', {}).items():
        global_key = f"{business_name}.{enum_key}"
        self._enum_registry[global_key] = enum_values
```

**è®¾è®¡æ€è·¯**ï¼šå®ç°å®Œæ•´çš„é…ç½®è§£æå’Œç¼“å­˜ç®¡ç†ã€‚æ”¯æŒJSONæ ¼å¼çš„ä¸šåŠ¡é…ç½®ï¼Œè‡ªåŠ¨æ„å»ºå†…å­˜ä¸­çš„é…ç½®å¯¹è±¡å’Œæšä¸¾æ³¨å†Œè¡¨ï¼Œæä¾›é«˜æ•ˆçš„é…ç½®è®¿é—®ã€‚

#### åŠ¨æ€é…ç½®æ³¨å…¥ç®—æ³•

**å®ç°æ¥æº**ï¼šbusiness_config_loader.py

```python
def inject_slot_specs(self, business_name: str, slot_specs: List[SlotSpec]):
    """åŠ¨æ€é…ç½®æ³¨å…¥ç®—æ³•"""
    if business_name not in self._configs:
        print(f"ä¸šåŠ¡é…ç½®ä¸å­˜åœ¨: {business_name}")
        return
  
    existing_config = self._configs[business_name]
  
     åˆ›å»ºæ–°çš„é…ç½®å¯¹è±¡ï¼Œä¿ç•™åŸæœ‰é…ç½®ï¼Œä»…æ›´æ–°æ§½ä½è§„æ ¼
    updated_config = BusinessConfig(
        name=existing_config.name,
        display_name=existing_config.display_name,
        description=existing_config.description,
        slot_specs=slot_specs,   ä½¿ç”¨æ–°çš„æ§½ä½è§„æ ¼
        enums=existing_config.enums,
        templates=existing_config.templates,
        filters=existing_config.filters,
        command_keywords=existing_config.command_keywords,
        intent_recommendations=existing_config.intent_recommendations
    )
  
    self._configs[business_name] = updated_config
    print(f"å·²ä¸ºä¸šåŠ¡ {business_name} æ³¨å…¥ {len(slot_specs)} ä¸ªæ§½ä½è§„æ ¼")
```

**è®¾è®¡æ€è·¯**ï¼šå®ç°DSLä¸é™æ€é…ç½®çš„èåˆæœºåˆ¶ã€‚é€šè¿‡è¿è¡Œæ—¶åŠ¨æ€æ³¨å…¥æ§½ä½è§„æ ¼ï¼Œæ”¯æŒåŸºäºDSLè„šæœ¬çš„ä¸šåŠ¡é€»è¾‘è°ƒæ•´ï¼Œæ— éœ€ä¿®æ”¹é™æ€é…ç½®æ–‡ä»¶ã€‚

#### é…ç½®ç¼“å­˜ä¼˜åŒ–ç®—æ³•

**å®ç°æ¥æº**ï¼šbusiness_config_loader.py

```python
def get_slot_options(self, enum_key: str, business_name: str = None) -> List[Dict[str, Any]]:
    """é«˜æ•ˆçš„æšä¸¾é€‰é¡¹è®¿é—®"""
     ä¼˜å…ˆä½¿ç”¨ä¸šåŠ¡ç‰¹å®šçš„æšä¸¾
    if business_name:
        business_enums = self.get_enums(business_name)
        if enum_key in business_enums:
            return business_enums[enum_key]
  
     å›é€€åˆ°å…¨å±€æšä¸¾
    return self._enum_registry.get(enum_key, [])
```

**è®¾è®¡æ€è·¯**ï¼šå¯åŠ¨æ—¶é¢„åŠ è½½æ‰€æœ‰é…ç½®åˆ°å†…å­˜ç¼“å­˜ï¼Œè¿è¡Œæ—¶ç›´æ¥å†…å­˜è®¿é—®é¿å…æ–‡ä»¶IOã€‚æ”¯æŒä¸šåŠ¡ç‰¹å®šçš„æšä¸¾ä¼˜å…ˆè®¿é—®ï¼Œå‡å°‘æŸ¥æ‰¾æ—¶é—´ã€‚

#### é…ç½®éªŒè¯ç®—æ³•

**å®ç°æ¥æº**ï¼šbusiness_config_loader.py

```python
def _validate_business_config(self, config_data: Dict[str, Any]) -> bool:
    """ä¸šåŠ¡é…ç½®éªŒè¯"""
     å¿…éœ€å­—æ®µæ£€æŸ¥
    required_sections = ['business_info', 'slot_specs', 'enums']
    for section in required_sections:
        if section not in config_data:
            raise ValueError(f"ä¸šåŠ¡é…ç½®ç¼ºå°‘å¿…éœ€æ®µ: {section}")
  
     æ§½ä½è§„æ ¼éªŒè¯
    slot_specs = config_data.get('slot_specs', [])
    for spec in slot_specs:
        if 'name' not in spec or 'description' not in spec:
            raise ValueError("æ§½ä½è§„æ ¼ç¼ºå°‘nameæˆ–descriptionå­—æ®µ")
  
     æšä¸¾é…ç½®éªŒè¯
    enums = config_data.get('enums', {})
    for enum_key, enum_items in enums.items():
        for item in enum_items:
            if 'label' not in item:
                raise ValueError(f"æšä¸¾ {enum_key} ä¸­çš„é¡¹ç¼ºå°‘labelå­—æ®µ")
  
     æ¨¡æ¿é…ç½®éªŒè¯
    templates = config_data.get('templates', {})
    for template_key, template_lines in templates.items():
        if not isinstance(template_lines, list):
            raise ValueError(f"æ¨¡æ¿ {template_key} å¿…é¡»æ˜¯å­—ç¬¦ä¸²åˆ—è¡¨")
  
    return True
```

**è®¾è®¡æ€è·¯**ï¼šé€šè¿‡ä¸¥æ ¼çš„é…ç½®éªŒè¯ç¡®ä¿ä¸šåŠ¡é…ç½®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ï¼Œé˜²æ­¢é”™è¯¯çš„é…ç½®å½±å“ç³»ç»Ÿè¿è¡Œã€‚

#### å…¨å±€é…ç½®éªŒè¯ç®—æ³•

**å®ç°æ¥æº**ï¼šconfig/settings.py

```python
def validate_config() -> bool:
    """å…¨å±€é…ç½®éªŒè¯ç®—æ³•"""
     ç¯å¢ƒå˜é‡æ£€æŸ¥
    required_env_vars = ['SPARK_API_KEY']
    for env_var in required_env_vars:
        if not os.getenv(env_var):
            print(f"ç¼ºå°‘å¿…éœ€ç¯å¢ƒå˜é‡: {env_var}")
            return False
  
     ç›®å½•ç»“æ„æ£€æŸ¥
    required_dirs = [
        Config.get_business_config_dir(),
        Config.get_dsl_scripts_dir()
    ]
    for directory in required_dirs:
        if not os.path.exists(directory):
            print(f"ç›®å½•ä¸å­˜åœ¨: {directory}")
            return False
  
     ä¸šåŠ¡é…ç½®æ£€æŸ¥
    config_loader = BusinessConfigLoader()
    try:
        config_loader._load_all_configs()
        if len(config_loader._configs) == 0:
            print("æœªæ‰¾åˆ°ä»»ä½•ä¸šåŠ¡é…ç½®")
            return False
    except Exception as e:
        print(f"ä¸šåŠ¡é…ç½®åŠ è½½å¤±è´¥: {e}")
        return False
  
    return True
```

**è®¾è®¡æ€è·¯**ï¼šéªŒè¯ç³»ç»Ÿè¿è¡Œæ‰€éœ€çš„æ‰€æœ‰å‰ç½®æ¡ä»¶ï¼ŒåŒ…æ‹¬ç¯å¢ƒå˜é‡ã€ç›®å½•ç»“æ„å’Œä¸šåŠ¡é…ç½®ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿæ­£å¸¸å¯åŠ¨å’Œè¿è¡Œã€‚

### 4.5.5 ç±»åä½œå…³ç³»

#### ç±»å…³ç³»å›¾ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BusinessConfig   â”‚    â”‚      Config      â”‚
â”‚ Loader           â”‚    â”‚                  â”‚
â”‚                  â”‚    â”‚ - validate_config()â”‚
â”‚ - get_business() â”‚    â”‚ - get_llm_config()â”‚
â”‚ - inject_specs() â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ - get_enums()    â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
          â”‚                       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚                 â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                         â”‚  å…¶ä»–å­ç³»ç»Ÿ     â”‚ â”‚ ä¸šåŠ¡é…ç½®æ–‡ä»¶ â”‚
                         â”‚                 â”‚ â”‚             â”‚
                         â”‚ - DSLå¼•æ“å±‚     â”‚ â”‚ - JSONæ ¼å¼  â”‚
                         â”‚ - å¯¹è¯æ ¸å¿ƒå±‚    â”‚ â”‚ - æ¨¡æ¿æ•°æ®  â”‚
                         â”‚ - AIæœåŠ¡å±‚      â”‚ â”‚ - æšä¸¾å®šä¹‰  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åä½œæµç¨‹è¯´æ˜

1. **ç³»ç»Ÿå¯åŠ¨é…ç½®åŠ è½½**ï¼š

   - `Config.validate_config()` éªŒè¯å…¨å±€é…ç½®å®Œæ•´æ€§
   - `BusinessConfigLoader._load_all_configs()` åŠ è½½æ‰€æœ‰ä¸šåŠ¡é…ç½®
   - é…ç½®æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ä¾›å…¶ä»–å­ç³»ç»Ÿè®¿é—®
2. **ä¸šåŠ¡é€»è¾‘é…ç½®è®¿é—®**ï¼š

   - `FormBasedDialogSystem` é€šè¿‡ `BusinessConfigLoader.get_business_config()` è·å–ä¸šåŠ¡é…ç½®
   - `FlowInterpreter` é€šè¿‡ `BusinessConfigLoader.get_template()` è·å–å¯¹è¯æ¨¡æ¿
   - `SemanticMapper` é€šè¿‡ `BusinessConfigLoader.get_enums()` è·å–æšä¸¾é€‰é¡¹
3. **åŠ¨æ€é…ç½®æ›´æ–°**ï¼š

   - `YAMLFlowLoader` è§£æDSLè„šæœ¬ç”Ÿæˆæ§½ä½è§„æ ¼
   - `BusinessConfigLoader.inject_slot_specs()` åŠ¨æ€æ³¨å…¥é…ç½®
   - æ›´æ–°åçš„é…ç½®ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯ç³»ç»Ÿ
4. **é…ç½®æ•°æ®æµå‘**ï¼š

   - ä¸šåŠ¡é…ç½®æ–‡ä»¶ï¼ˆJSONï¼‰â†’ `BusinessConfigLoader` â†’ å†…å­˜ç¼“å­˜
   - å†…å­˜ç¼“å­˜ â†’ å„ä¸šåŠ¡å­ç³»ç»Ÿ â†’ è¿è¡Œæ—¶æ•°æ®å¯¹è±¡
   - DSLè„šæœ¬ â†’ åŠ¨æ€é…ç½®æ³¨å…¥ â†’ æ›´æ–°å†…å­˜ç¼“å­˜
5. **é”™è¯¯å¤„ç†åä½œ**ï¼š

   - é…ç½®åŠ è½½å¤±è´¥æ—¶è®°å½•é”™è¯¯ä½†ç»§ç»­åŠ è½½å…¶ä»–é…ç½®
   - é…ç½®éªŒè¯å¤±è´¥æ—¶é˜»æ­¢ç³»ç»Ÿå¯åŠ¨å¹¶æä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯
   - é…ç½®è®¿é—®å¼‚å¸¸æ—¶æä¾›é»˜è®¤å€¼æˆ–ç©ºç»“æœï¼Œç¡®ä¿ç³»ç»Ÿé™çº§è¿è¡Œ

#### æ•°æ®æµå‘

```
ä¸šåŠ¡é…ç½®æ–‡ä»¶ (.json)
        â†“
BusinessConfigLoader (åŠ è½½éªŒè¯)
        â†“
å†…å­˜é…ç½®ç¼“å­˜
        â”œâ”€â”€â†’ FormBasedDialogSystem (æ§½ä½è§„æ ¼)
        â”œâ”€â”€â†’ FlowInterpreter (å¯¹è¯æ¨¡æ¿)  
        â”œâ”€â”€â†’ SemanticMapper (æšä¸¾é€‰é¡¹)
        â””â”€â”€â†’ OptionBuilder (è¿‡æ»¤è§„åˆ™)
        â†“
DSLè„šæœ¬ (.yaml)
        â†“
åŠ¨æ€é…ç½®æ³¨å…¥
        â†“
æ›´æ–°å†…å­˜ç¼“å­˜
```

è¿™ç§è®¾è®¡å®ç°äº†é›†ä¸­åŒ–çš„é…ç½®ç®¡ç†ï¼Œé€šè¿‡ç»Ÿä¸€çš„é…ç½®è®¿é—®æ¥å£å’Œé«˜æ•ˆçš„ç¼“å­˜æœºåˆ¶ï¼Œä¸ºæ•´ä¸ªç³»ç»Ÿæä¾›äº†ç¨³å®šå¯é çš„é…ç½®æ•°æ®æœåŠ¡ã€‚æ”¯æŒå¤šä¸šåŠ¡çº¿å¹¶è¡Œè¿è¡Œå’ŒåŠ¨æ€é…ç½®æ›´æ–°ï¼Œç¡®ä¿ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## 4.6 æµç¨‹å®šä¹‰å±‚è¯¦ç»†è®¾è®¡

### 4.6.1 å­ç³»ç»Ÿæ¦‚è¿°

æµç¨‹å®šä¹‰å±‚å­ç³»ç»Ÿé€šè¿‡å£°æ˜å¼çš„YAML DSLè„šæœ¬å®šä¹‰å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æ ¸å¿ƒä»£ç çš„å®Œå…¨åˆ†ç¦»ã€‚è¯¥å­ç³»ç»Ÿé‡‡ç”¨"é…ç½®å³é€»è¾‘"çš„è®¾è®¡ç†å¿µï¼Œæ”¯æŒéæŠ€æœ¯äººå‘˜é€šè¿‡ç¼–å†™DSLè„šæœ¬å®šä¹‰å¤æ‚çš„å¯¹è¯æµç¨‹å’Œä¸šåŠ¡è§„åˆ™ã€‚

### 4.6.2 æ ¸å¿ƒæ–‡ä»¶ç»“æ„

#### Apple Storeä¸šåŠ¡æµç¨‹å®šä¹‰

**å®šä¹‰æ¥æº**ï¼šscripts/apple_store.flow.yaml

```yaml
flow:
  name: "apple_store"
  version: "1.0"
  description: "è‹¹æœä¸“å–åº—äº§å“é…ç½®æµç¨‹"
  business_line: "apple_store"
  
  process_order:
    - category
    - brand
    - series
    - size
    - chip
    - storage
    - color
  
  slots:
    category:
      label: "äº§å“å¤§ç±»"
      description: "é€‰æ‹©äº§å“ç±»å‹"
      required: true
      type: enum
      enums_key: category
      dependencies: []
      prompt_template: form_category_prompt
  
    brand:
      label: "å“ç‰Œ"
      description: "é€‰æ‹©äº§å“å“ç‰Œ" 
      required: true
      type: enum
      enums_key: brand
      dependencies: [category]
      allow_llm: false
  
    series:
      label: "äº§å“ç³»åˆ—"
      description: "é€‰æ‹©å…·ä½“äº§å“ç³»åˆ—"
      required: true
      type: enum
      enums_key: series
      dependencies: [category, brand]
      semantic_stage: series_selection
      prompt_template: form_series_prompt
  
    size:
      label: "å±å¹•å°ºå¯¸"
      description: "é€‰æ‹©å±å¹•å°ºå¯¸"
      required: true
      type: enum
      enums_key: size
      dependencies: [category, series]
      semantic_stage: size_selection
  
    chip:
      label: "å¤„ç†å™¨èŠ¯ç‰‡"
      description: "é€‰æ‹©å¤„ç†å™¨å‹å·"
      required: true
      type: enum
      enums_key: chip
      dependencies: [category, series, size]
      semantic_stage: chip_selection
      validation:
        must_be_valid_enum: true
        min_confidence: 0.35
  
    storage:
      label: "å­˜å‚¨å®¹é‡"
      description: "é€‰æ‹©å­˜å‚¨å®¹é‡"
      required: true
      type: enum
      enums_key: storage
      dependencies: [category, series, chip]
      semantic_stage: storage_selection
      validation:
        must_be_valid_enum: true
        min_confidence: 0.4
  
    color:
      label: "é¢œè‰²"
      description: "é€‰æ‹©äº§å“é¢œè‰²"
      required: true
      type: enum
      enums_key: color
      dependencies: [category, series]
      semantic_stage: color_selection
  
  events:
    on_start:
      - action: reset_form
      - action: show_template
        template: form_welcome
      - action: show_template
        template: form_category_prompt
  
    on_all_filled:
      - action: validate_form
      - action: show_summary
      - action: ask_confirm
  
    on_confirm:
      - action: submit_order
      - action: show_template
        template: form_order_confirmed
  
    on_validation_error:
      - action: show_template
        template: form_validation_error_title
      - action: show_errors
      - action: show_template
        template: form_validation_error_footer
  
  commands:
    restart:
      keywords: ["é‡æ–°å¼€å§‹", "é‡ç½®", "å†æ¥ä¸€æ¬¡", "restart", "reset"]
      action: restart_flow
      available_when: always
  
    confirm:
      keywords: ["ç¡®è®¤", "å¥½çš„", "ç¡®å®š", "ok", "confirm", "yes"]
      action: confirm_order
      condition: all_slots_filled
  
    help:
      keywords: ["å¸®åŠ©", "æ€ä¹ˆç”¨", "è¯´æ˜", "help"]
      action: show_help
      response: |
        ä½¿ç”¨å¸®åŠ©ï¼š
        â€¢ æŒ‰ç…§æç¤ºé€‰æ‹©äº§å“é…ç½®
        â€¢ è¯´"é‡é€‰"å¯ä»¥ä¿®æ”¹ä¹‹å‰çš„é€‰æ‹©
        â€¢ è¯´"é‡æ–°å¼€å§‹"å¯ä»¥é‡ç½®æ‰€æœ‰é€‰æ‹©
        â€¢ é€‰æ‹©å®Œæˆåè¯´"ç¡®è®¤"æäº¤è®¢å•
  
    reselect:
      keywords: ["é‡é€‰", "ä¿®æ”¹", "æ¢ä¸€ä¸ª", "change"]
      action: show_reselect_options
      condition: has_filled_slots
```

#### é¤é¥®é¢„è®¢ä¸šåŠ¡æµç¨‹å®šä¹‰

**å®šä¹‰æ¥æº**ï¼šscripts/dining.flow.yaml

```yaml
flow:
  name: "dining"
  version: "1.0"
  description: "é¤å…é¢„è®¢æµç¨‹"
  business_line: "dining"
  
  process_order:
    - restaurant
    - date
    - time
    - people
    - preference
  
  slots:
    restaurant:
      label: "é¤å…é€‰æ‹©"
      description: "é€‰æ‹©é¢„è®¢çš„é¤å…"
      required: true
      type: enum
      enums_key: restaurant
      dependencies: []
      prompt_template: form_restaurant_prompt
  
    date:
      label: "é¢„è®¢æ—¥æœŸ"
      description: "é€‰æ‹©é¢„è®¢æ—¥æœŸ"
      required: true
      type: text
      dependencies: [restaurant]
      validation:
        is_valid_date: true
        min_date_today: true
        max_days_ahead: 30
  
    time:
      label: "é¢„è®¢æ—¶é—´"
      description: "é€‰æ‹©é¢„è®¢æ—¶é—´"
      required: true
      type: enum
      enums_key: time_slot
      dependencies: [restaurant, date]
      semantic_stage: time_selection
  
    people:
      label: "ç”¨é¤äººæ•°"
      description: "è¾“å…¥ç”¨é¤äººæ•°"
      required: true
      type: text
      dependencies: [restaurant]
      validation:
        is_numeric: true
        min_value: 1
        max_value: 20
  
    preference:
      label: "ç‰¹æ®Šè¦æ±‚"
      description: "è¾“å…¥ç‰¹æ®Šè¦æ±‚æˆ–åå¥½"
      required: false
      type: text
      dependencies: [restaurant, people]
      allow_llm: true
  
  events:
    on_start:
      - action: reset_form
      - action: show_template
        template: form_welcome_dining
  
    on_all_filled:
      - action: validate_form
      - action: show_summary
      - action: ask_confirm
  
    on_confirm:
      - action: submit_booking
      - action: show_template
        template: form_booking_confirmed
  
  commands:
    restart:
      keywords: ["é‡æ–°å¼€å§‹", "é‡ç½®"]
      action: restart_flow
  
    help:
      keywords: ["å¸®åŠ©", "æ€ä¹ˆé¢„è®¢"]
      action: show_help
      response: |
        é¤å…é¢„è®¢å¸®åŠ©ï¼š
        â€¢ é€‰æ‹©æ‚¨æƒ³é¢„è®¢çš„é¤å…
        â€¢ æä¾›é¢„è®¢æ—¥æœŸå’Œæ—¶é—´
        â€¢ è¾“å…¥ç”¨é¤äººæ•°
        â€¢ å¯é€‰ï¼šæä¾›ç‰¹æ®Šè¦æ±‚
        â€¢ ç¡®è®¤é¢„è®¢ä¿¡æ¯
```

### 4.6.3 DSLè¯­æ³•è§„èŒƒ

#### æµç¨‹å®šä¹‰è¯­æ³•

```yaml
flow:
  name: <string>                   å¿…éœ€ï¼šæµç¨‹åç§°ï¼Œç”¨äºæ ‡è¯†
  version: <string>                å¯é€‰ï¼šç‰ˆæœ¬å·ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†
  description: <string>            å¯é€‰ï¼šæµç¨‹æè¿°ï¼Œç”¨äºæ–‡æ¡£
  business_line: <string>          å¿…éœ€ï¼šä¸šåŠ¡çº¿æ ‡è¯†ï¼Œå…³è”ä¸šåŠ¡é…ç½®
  
  process_order:                   å¿…éœ€ï¼šæ§½ä½å¤„ç†é¡ºåºåˆ—è¡¨
    - <slot_name_1>
    - <slot_name_2>
  
  slots:                           å¿…éœ€ï¼šæ§½ä½å®šä¹‰å­—å…¸
    <slot_name>: <SlotConfig>
  
  events:                          å¯é€‰ï¼šäº‹ä»¶å¤„ç†å®šä¹‰
    <event_name>: <ActionList>
  
  commands:                        å¯é€‰ï¼šç”¨æˆ·å‘½ä»¤æ˜ å°„
    <command_name>: <CommandConfig>
```

**è¯­æ³•è¯´æ˜**ï¼šæµç¨‹å®šä¹‰æ˜¯DSLçš„æ ¹å…ƒç´ ï¼ŒåŒ…å«å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘æè¿°ã€‚`process_order`ç¡®ä¿æ­£ç¡®çš„æ‰§è¡Œé¡ºåºï¼Œ`business_line`å…³è”å¯¹åº”çš„ä¸šåŠ¡é…ç½®ã€‚

#### æ§½ä½å®šä¹‰è¯­æ³•

```yaml
<slot_name>:
  label: <string>                  å¿…éœ€ï¼šç”¨æˆ·å¯è§çš„æ˜¾ç¤ºæ ‡ç­¾
  description: <string>            å¿…éœ€ï¼šä¸šåŠ¡æè¿°æ–‡æœ¬
  required: <boolean>              å¿…éœ€ï¼šæ˜¯å¦å¿…å¡«å­—æ®µ
  type: <enum|text>                å¯é€‰ï¼šæ•°æ®ç±»å‹ï¼Œé»˜è®¤enum
  enums_key: <string>              å¯¹äºenumç±»å‹å¿…éœ€ï¼šæšä¸¾é”®å
  dependencies:                    å¯é€‰ï¼šä¾èµ–çš„æ§½ä½åˆ—è¡¨
    - <dependency_slot_1>
  semantic_stage: <string>         å¯é€‰ï¼šè¯­ä¹‰é˜¶æ®µæ ‡è¯†
  allow_llm: <boolean>             å¯é€‰ï¼šæ˜¯å¦å…è®¸LLMå¡«å……
  prompt_template: <string>        å¯é€‰ï¼šæç¤ºæ¨¡æ¿é”®å
  validation:                      å¯é€‰ï¼šéªŒè¯è§„åˆ™
    must_be_valid_enum: <boolean>  å¿…é¡»ä¸ºæœ‰æ•ˆæšä¸¾å€¼
    min_confidence: <float>        æœ€å°ç½®ä¿¡åº¦é˜ˆå€¼
    is_valid_date: <boolean>       å¿…é¡»ä¸ºæœ‰æ•ˆæ—¥æœŸ
    is_numeric: <boolean>          å¿…é¡»ä¸ºæ•°å­—
    min_value: <number>            æœ€å°å€¼
    max_value: <number>            æœ€å¤§å€¼
```

**è¯­æ³•è¯´æ˜**ï¼šæ§½ä½å®šä¹‰æè¿°æ¯ä¸ªä¿¡æ¯å­—æ®µçš„ä¸šåŠ¡ç‰¹æ€§ã€‚`dependencies`æ”¯æŒå¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œ`semantic_stage`å¯ç”¨æ™ºèƒ½è¯­ä¹‰å¤„ç†ã€‚

#### äº‹ä»¶å¤„ç†è¯­æ³•

```yaml
events:
  on_start:                        æµç¨‹å¼€å§‹äº‹ä»¶
    - action: <action_name>        åŠ¨ä½œåç§°
      template: <template_key>     å¯é€‰ï¼šæ¨¡æ¿é”®å
  
  on_all_filled:                   æ‰€æœ‰æ§½ä½å¡«å……å®Œæˆäº‹ä»¶  
    - action: show_summary
    - action: ask_confirm
  
  on_confirm:                      ç”¨æˆ·ç¡®è®¤äº‹ä»¶
    - action: validate_form
    - action: submit_order
    - action: show_template
      template: form_order_confirmed
  
  on_validation_error:             éªŒè¯é”™è¯¯äº‹ä»¶
    - action: show_template
      template: form_validation_error_title
    - action: show_errors
    - action: show_template
      template: form_validation_error_footer
```

**è¯­æ³•è¯´æ˜**ï¼šäº‹ä»¶å¤„ç†æ”¯æŒåœ¨å…³é”®ä¸šåŠ¡æµç¨‹èŠ‚ç‚¹æ‰§è¡Œé¢„å®šä¹‰åŠ¨ä½œã€‚æ”¯æŒåŠ¨ä½œé“¾å’Œæ¨¡æ¿æ˜¾ç¤ºï¼Œå®ç°å¤æ‚çš„ä¸šåŠ¡æµç¨‹æ§åˆ¶ã€‚

#### å‘½ä»¤æ˜ å°„è¯­æ³•

```yaml
commands:
  restart:                         å‘½ä»¤åç§°
    keywords:                      è§¦å‘å…³é”®è¯åˆ—è¡¨
      - "é‡æ–°å¼€å§‹"
      - "reset"
    action: restart_flow           æ‰§è¡ŒåŠ¨ä½œ
    available_when: always         å¯ç”¨æ¡ä»¶
  
  confirm:
    keywords: ["ç¡®è®¤", "å¥½çš„", "ok"]
    action: confirm_order
    condition: all_slots_filled    æ‰§è¡Œæ¡ä»¶
  
  help:
    keywords: ["å¸®åŠ©", "help"]  
    action: show_help
    response: |                    ç›´æ¥å“åº”å†…å®¹
      ä½¿ç”¨å¸®åŠ©ï¼š
      â€¢ æŒ‰ç…§æç¤ºé€‰æ‹©é…ç½®
      â€¢ è¯´"é‡é€‰"ä¿®æ”¹ä¹‹å‰é€‰æ‹©
      â€¢ è¯´"é‡æ–°å¼€å§‹"é‡ç½®æ‰€æœ‰é€‰æ‹©
```

**è¯­æ³•è¯´æ˜**ï¼šå‘½ä»¤æ˜ å°„å°†ç”¨æˆ·è¾“å…¥æ˜ å°„åˆ°ç³»ç»ŸåŠ¨ä½œã€‚æ”¯æŒæ¡ä»¶æ‰§è¡Œå’Œç›´æ¥å“åº”ï¼Œæä¾›çµæ´»çš„ç”¨æˆ·äº¤äº’æ–¹å¼ã€‚

### 4.6.4 è¯­ä¹‰é˜¶æ®µé…ç½®

#### ç³»åˆ—é€‰æ‹©è¯­ä¹‰é˜¶æ®µ

**å®šä¹‰æ¥æº**ï¼šä¸šåŠ¡é…ç½®æ–‡ä»¶ä¸­çš„è¯­ä¹‰é˜¶æ®µå®šä¹‰

```yaml
semantic_stages:
  series_selection:
    description: "åŸºäºå“ç±»å’Œå“ç‰Œçš„ç³»åˆ—é€‰æ‹©"
    options_source: "series"
    filters:
      - type: "category_based"
        source_slot: "category"
        mapping_field: "series_by_category"
      - type: "brand_based" 
        source_slot: "brand"
        mapping_field: "series_by_brand"
    matching_strategy: "combined_keywords"
    confidence_threshold: 0.6
```

#### èŠ¯ç‰‡é€‰æ‹©è¯­ä¹‰é˜¶æ®µ

```yaml
chip_selection:
  description: "åŸºäºäº§å“ç³»åˆ—çš„èŠ¯ç‰‡é€‰æ‹©"
  options_source: "chip"
  filters:
    - type: "series_based"
      source_slot: "series"
      mapping_field: "chip_by_series"
    - type: "category_based"
      source_slot: "category" 
      mapping_field: "chip_by_category"
  matching_strategy: "technical_keywords"
  confidence_threshold: 0.35
  special_rules:
    - pattern: "æœ€å¼ºèŠ¯ç‰‡|æœ€æ–°èŠ¯ç‰‡"
      recommendation: "M3 Max"
      confidence: 0.8
    - pattern: "å¹³è¡¡æ€§èƒ½|æ€§ä»·æ¯”"
      recommendation: "M3"
      confidence: 0.7
```

### 4.6.5 ä¸šåŠ¡è§„åˆ™å®šä¹‰

#### ä¾èµ–å…³ç³»è§„åˆ™

```yaml
 æ§½ä½ä¾èµ–å…³ç³»å®šä¹‰
dependencies:
  - slot: "series"
    depends_on: ["category", "brand"]
    clear_on_change: true
  
  - slot: "size" 
    depends_on: ["series"]
    clear_on_change: true
  
  - slot: "chip"
    depends_on: ["series", "size"]
    clear_on_change: true
  
  - slot: "storage"
    depends_on: ["series", "chip"]
    clear_on_change: true
  
  - slot: "color"
    depends_on: ["series"]
    clear_on_change: false   é¢œè‰²ä¸ä¾èµ–å…·ä½“é…ç½®
```

#### éªŒè¯è§„åˆ™é›†åˆ

```yaml
validations:
  - slot: "date"
    rules:
      - type: "date_format"
        pattern: "YYYY-MM-DD"
      - type: "date_range"
        min: "today"
        max: "today+30days"
  
  - slot: "people"
    rules:
      - type: "numeric"
        min: 1
        max: 20
      - type: "integer"
  
  - slot: "chip"
    rules:
      - type: "enum_validity"
        enum_key: "chip"
      - type: "compatibility"
        depends_on: ["series"]
        check_function: "validate_chip_series_compatibility"
```

#### ä¸šåŠ¡çº¦æŸè§„åˆ™

```yaml
business_constraints:
  - name: "storage_by_category"
    description: "ä¸åŒå“ç±»çš„å­˜å‚¨é€‰é¡¹çº¦æŸ"
    conditions:
      - when: "category == 'ç”µè„‘'"
        then: "storage in ['512GB', '1TB', '2TB']"
      - when: "category == 'æ‰‹æœº'"
        then: "storage in ['128GB', '256GB', '512GB', '1TB']"
  
  - name: "chip_availability"
    description: "èŠ¯ç‰‡ä¸ç³»åˆ—çš„å¯ç”¨æ€§çº¦æŸ"
    conditions:
      - when: "series == 'MacBook Air'"
        then: "chip in ['M3', 'M3 Pro']"
      - when: "series == 'MacBook Pro'"
        then: "chip in ['M3 Pro', 'M3 Max']"
```

### 4.6.6 æ¨¡æ¿ç³»ç»Ÿè®¾è®¡

#### æ¬¢è¿æ¨¡æ¿

```yaml
form_welcome:
  - "æ¬¢è¿æ¥åˆ°è‹¹æœä¸“å–åº—ï¼ğŸ‰"
  - "æˆ‘å°†å¸®æ‚¨é…ç½®å¿ƒä»ªçš„è‹¹æœäº§å“ã€‚"
  - "è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆç±»å‹çš„äº§å“ï¼š"

form_welcome_dining:
  - "æ¬¢è¿ä½¿ç”¨é¤å…é¢„è®¢æœåŠ¡ï¼ğŸ½ï¸"
  - "æˆ‘å°†å¸®æ‚¨å®Œæˆé¤å…é¢„è®¢ã€‚"
  - "è¯·å…ˆé€‰æ‹©æ‚¨æƒ³é¢„è®¢çš„é¤å…ï¼š"
```

#### æ§½ä½æç¤ºæ¨¡æ¿

```yaml
form_category_prompt:
  - "è¯·é€‰æ‹©äº§å“ç±»å‹ï¼š"
  - "1. æ‰‹æœº - iPhoneç³»åˆ—"
  - "2. ç”µè„‘ - Macç³»åˆ—" 
  - "3. å¹³æ¿ - iPadç³»åˆ—"
  - "4. æ‰‹è¡¨ - Apple Watchç³»åˆ—"

form_series_prompt_phone:
  - "è¯·é€‰æ‹©iPhoneç³»åˆ—ï¼š"
  - "1. iPhone 15 ç³»åˆ—"
  - "2. iPhone 14 ç³»åˆ—"
  - "3. iPhone 13 ç³»åˆ—"

form_series_prompt_computer:
  - "è¯·é€‰æ‹©Macç³»åˆ—ï¼š"
  - "1. MacBook Pro - ä¸“ä¸šçº§ç¬”è®°æœ¬ç”µè„‘"
  - "2. MacBook Air - è½»è–„ä¾¿æºç¬”è®°æœ¬ç”µè„‘"
  - "3. iMac - ä¸€ä½“å¼å°å¼ç”µè„‘"
```

#### ç¡®è®¤å’Œé”™è¯¯æ¨¡æ¿

```yaml
form_info_recorded:
  - "âœ… å¥½çš„ï¼Œæˆ‘è®°ä¸‹å•¦ï¼š"

form_conflict_prompt:
  - "âš ï¸  å‘ç°é€‰æ‹©å†²çªï¼š"
  - "åŸé€‰æ‹©ï¼š{old_value}"
  - "æ–°è¾“å…¥ï¼š{new_value}"
  - "è¯·é€‰æ‹©ï¼š"
  - "1. ä¿ç•™åŸå€¼ ({old_value})"
  - "2. ä½¿ç”¨æ–°å€¼ ({new_value})"
  - "3. é‡æ–°è¯´æ˜"

form_validation_error_title:
  - "ğŸ˜® æŸäº›ç»„åˆæš‚æ—¶ä¸å¤ªåˆé€‚ï¼š"

form_validation_error_footer:
  - "å¯ä»¥è°ƒæ•´ç›¸å…³é¡¹åå†è¯•ä¸€ä¸‹ï½"

form_order_confirmed:
  - "ğŸ‰ è®¢å•æäº¤æˆåŠŸï¼"
  - "æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼"
  - "è®¢å•å·ï¼š{order_id}"
  - "é¢„è®¡å‘è´§æ—¶é—´ï¼š{delivery_time}"
```

### 4.6.7 ç±»åä½œå…³ç³»

#### æ–‡ä»¶å…³ç³»å›¾ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DSLè„šæœ¬æ–‡ä»¶     â”‚    â”‚  ä¸šåŠ¡é…ç½®æ–‡ä»¶    â”‚
â”‚                  â”‚    â”‚                  â”‚
â”‚ - .flow.yaml     â”‚    â”‚ - .json          â”‚
â”‚ - æµç¨‹å®šä¹‰       â”‚    â”‚ - æšä¸¾å®šä¹‰       â”‚
â”‚ - æ§½ä½é…ç½®       â”‚    â”‚ - æ¨¡æ¿å®šä¹‰       â”‚
â”‚ - äº‹ä»¶å¤„ç†       â”‚    â”‚ - è¿‡æ»¤è§„åˆ™       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  YAMLFlowLoader â”‚
             â”‚                 â”‚
             â”‚ - load()        â”‚
             â”‚ - validate()    â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ FlowInterpreter â”‚
              â”‚                 â”‚
              â”‚ - è§£é‡Šæ‰§è¡Œ      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åä½œæµç¨‹è¯´æ˜

1. **DSLè„šæœ¬åŠ è½½æµç¨‹**ï¼š

   - `YAMLFlowLoader.load()` è¯»å–YAMLæµç¨‹å®šä¹‰æ–‡ä»¶
   - è§£ææµç¨‹åç§°ã€ç‰ˆæœ¬ã€ä¸šåŠ¡çº¿ç­‰å…ƒä¿¡æ¯
   - æå–æ§½ä½å®šä¹‰ã€å¤„ç†é¡ºåºã€äº‹ä»¶å’Œå‘½ä»¤é…ç½®
   - éªŒè¯DSLè¯­æ³•çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§
2. **ä¸šåŠ¡é…ç½®èåˆæµç¨‹**ï¼š

   - ä»DSLæ§½ä½å®šä¹‰ç”Ÿæˆ `SlotSpec` å¯¹è±¡åˆ—è¡¨
   - é€šè¿‡ `BusinessConfigLoader.inject_slot_specs()` åŠ¨æ€æ³¨å…¥
   - èåˆé™æ€ä¸šåŠ¡é…ç½®ï¼ˆæšä¸¾ã€æ¨¡æ¿ï¼‰ä¸åŠ¨æ€DSLé…ç½®
   - åˆ›å»ºå®Œæ•´çš„ä¸šåŠ¡æµç¨‹æ‰§è¡Œç¯å¢ƒ
3. **æµç¨‹æ‰§è¡Œåä½œ**ï¼š

   - `FlowInterpreter` åŸºäºDSLå®šä¹‰è§£é‡Šæ‰§è¡Œä¸šåŠ¡æµç¨‹
   - æŒ‰ç…§ `process_order` é¡ºåºç®¡ç†æ§½ä½å¡«å……
   - è§¦å‘é¢„å®šä¹‰çš„äº‹ä»¶å¤„ç†é“¾
   - è¯†åˆ«å’Œæ‰§è¡Œç”¨æˆ·å‘½ä»¤
4. **è¯­ä¹‰é˜¶æ®µåä½œ**ï¼š

   - DSLä¸­å®šä¹‰çš„ `semantic_stage` æ ‡è¯†è¯­ä¹‰å¤„ç†é˜¶æ®µ
   - `OptionBuilder` åŸºäºè¯­ä¹‰é˜¶æ®µé…ç½®æ„å»ºå€™é€‰é€‰é¡¹
   - `SemanticMapper` ä½¿ç”¨é˜¶æ®µç‰¹å®šçš„åŒ¹é…ç­–ç•¥
   - å®ç°ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„æ™ºèƒ½æ¨è
5. **æ¨¡æ¿ç³»ç»Ÿåä½œ**ï¼š

   - DSLå¼•ç”¨ä¸šåŠ¡é…ç½®ä¸­å®šä¹‰çš„æ¨¡æ¿é”®å
   - `BusinessConfigLoader.get_template()` è·å–æ¨¡æ¿å†…å®¹
   - æ”¯æŒæ¡ä»¶åŒ–æ¨¡æ¿é€‰æ‹©ï¼ˆå¦‚åŸºäºå“ç±»çš„ä¸åŒæç¤ºï¼‰
   - æ¨¡æ¿å˜é‡æ›¿æ¢å’ŒåŠ¨æ€å†…å®¹ç”Ÿæˆ

#### æ•°æ®æµå‘

```
DSLè„šæœ¬ (.flow.yaml)
        â†“
YAMLFlowLoader (è§£æéªŒè¯)
        â†“
æµç¨‹é…ç½®å¯¹è±¡
        â”œâ”€â”€â†’ æ§½ä½è§„æ ¼ â†’ BusinessConfigLoader (åŠ¨æ€æ³¨å…¥)
        â”œâ”€â”€â†’ äº‹ä»¶å®šä¹‰ â†’ FlowInterpreter (äº‹ä»¶å¤„ç†)
        â”œâ”€â”€â†’ å‘½ä»¤æ˜ å°„ â†’ FlowInterpreter (å‘½ä»¤è¯†åˆ«)
        â””â”€â”€â†’ å¤„ç†é¡ºåº â†’ FormBasedDialogSystem (çŠ¶æ€ç®¡ç†)
        â†“
ä¸šåŠ¡é…ç½®æ–‡ä»¶ (.json)
        â†“
é™æ€é…ç½®æ•°æ®
        â”œâ”€â”€â†’ æšä¸¾é€‰é¡¹ â†’ è¯­ä¹‰ç†è§£å±‚
        â”œâ”€â”€â†’ å¯¹è¯æ¨¡æ¿ â†’ å“åº”ç”Ÿæˆå±‚
        â””â”€â”€â†’ è¿‡æ»¤è§„åˆ™ â†’ é€‰é¡¹æ„å»ºå±‚
        â†“
èåˆé…ç½®
        â†“
ä¸šåŠ¡æµç¨‹æ‰§è¡Œ
```

è¿™ç§è®¾è®¡å®ç°äº†ä¸šåŠ¡é€»è¾‘çš„å®Œå…¨å¤–éƒ¨åŒ–ï¼Œé€šè¿‡å£°æ˜å¼çš„DSLè„šæœ¬å®šä¹‰å¤æ‚çš„å¯¹è¯æµç¨‹ï¼Œæ”¯æŒå¿«é€Ÿä¸šåŠ¡è¿­ä»£å’Œä¸ªæ€§åŒ–å®šåˆ¶ã€‚DSLå±‚ä¸æ ¸å¿ƒä»£ç å±‚çš„æ¸…æ™°åˆ†ç¦»ç¡®ä¿äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚

## 4.7 é…ç½®æ–‡ä»¶è¯´æ˜

### 4.7.1 é…ç½®æ–‡ä»¶æ¦‚è¿°

ç³»ç»Ÿé‡‡ç”¨å¤šå±‚é…ç½®æ¶æ„ï¼Œé€šè¿‡ä¸åŒç±»å‹çš„é…ç½®æ–‡ä»¶å®ç°ä¸šåŠ¡é€»è¾‘ä¸ä»£ç çš„å®Œå…¨åˆ†ç¦»ã€‚é…ç½®æ–‡ä»¶æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–å’ŒåŠ¨æ€åŠ è½½ï¼Œç¡®ä¿ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### 4.7.2 ä¸šåŠ¡é…ç½®æ–‡ä»¶æ ¼å¼è¯´æ˜

#### é…ç½®æ–‡ä»¶ä½ç½®

- é»˜è®¤è·¯å¾„ï¼š`knowledge/` ç›®å½•ä¸‹
- æ–‡ä»¶æ ¼å¼ï¼šJSONæ ¼å¼
- æ–‡ä»¶å‘½åï¼š`{business_line}.json`

#### é…ç½®æ–‡ä»¶ç»“æ„

```json

{

  "business_info": {

    "name": "apple_store",

    "display_name": "è‹¹æœä¸“å–åº—",

    "description": "è‹¹æœäº§å“é…ç½®å’Œè´­ä¹°æµç¨‹",

    "version": "1.0"

  },

  

  "slot_specs": [

    {

      "name": "category",

      "required": true,

      "description": "é€‰æ‹©äº§å“ç±»å‹",

      "dependencies": [],

      "enums_key": "category",

      "semantic_stage": null,

      "allow_llm": false

    },

    {

      "name": "series",

      "required": true,

      "description": "é€‰æ‹©äº§å“ç³»åˆ—",

      "dependencies": ["category", "brand"],

      "enums_key": "series",

      "semantic_stage": "series_selection",

      "allow_llm": true

    }

  ],

  

  "enums": {

    "category": [

      {

        "label": "æ‰‹æœº",

        "aliases": ["iphone", "æ™ºèƒ½æ‰‹æœº", "æ‰‹æœº"],

        "description": "iPhoneç³»åˆ—äº§å“",

        "keywords": ["æ‰‹æœº", "iphone", "ç”µè¯"]

      },

      {

        "label": "ç”µè„‘",

        "aliases": ["mac", "macbook", "ç¬”è®°æœ¬ç”µè„‘", "ç”µè„‘"],

        "description": "Macç³»åˆ—äº§å“",

        "keywords": ["ç”µè„‘", "mac", "ç¬”è®°æœ¬"]

      }

    ],

  

    "series": [

      {

        "label": "iPhone 15",

        "aliases": ["15", "iphone15", "è‹¹æœ15"],

        "description": "iPhone 15ç³»åˆ—",

        "keywords": ["15", "åäº”", "æœ€æ–°"]

      },

      {

        "label": "MacBook Pro", 

        "aliases": ["mbp", "pro", "macbook pro"],

        "description": "MacBook Proç³»åˆ—",

        "keywords": ["pro", "ä¸“ä¸š", "é«˜æ€§èƒ½"]

      }

    ],

  

    "size": [

      {

        "label": "6.1è‹±å¯¸",

        "aliases": ["6.1", "6.1å¯¸", "6.1è‹±å¯¸"],

        "description": "6.1è‹±å¯¸å±å¹•",

        "keywords": ["6.1", "æ ‡å‡†", "é€‚ä¸­"]

      }

    ]

  },

  

  "templates": {

    "form_welcome": [

      "æ¬¢è¿æ¥åˆ°è‹¹æœä¸“å–åº—ï¼ï¿½ï¿½",

      "æˆ‘å°†å¸®æ‚¨é…ç½®å¿ƒä»ªçš„è‹¹æœäº§å“ã€‚",

      "è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆç±»å‹çš„äº§å“ï¼š"

    ],

  

    "form_category_prompt": [

      "è¯·é€‰æ‹©äº§å“ç±»å‹ï¼š",

      "1. æ‰‹æœº - iPhoneç³»åˆ—",

      "2. ç”µè„‘ - Macç³»åˆ—",

      "3. å¹³æ¿ - iPadç³»åˆ—", 

      "4. æ‰‹è¡¨ - Apple Watchç³»åˆ—"

    ],

  

    "form_info_recorded": [

      "âœ… å¥½çš„ï¼Œæˆ‘è®°ä¸‹å•¦ï¼š"

    ],

  

    "form_conflict_prompt": [

      "âš ï¸ Â å‘ç°é€‰æ‹©å†²çªï¼š",

      "åŸé€‰æ‹©ï¼š{old_value}",

      "æ–°è¾“å…¥ï¼š{new_value}",

      "è¯·é€‰æ‹©ï¼š",

      "1. ä¿ç•™åŸå€¼ ({old_value})",

      "2. ä½¿ç”¨æ–°å€¼ ({new_value})", 

      "3. é‡æ–°è¯´æ˜"

    ],

  

    "form_validation_error_title": [

      "ï¿½ï¿½ æŸäº›ç»„åˆæš‚æ—¶ä¸å¤ªåˆé€‚ï¼š"

    ],

  

    "form_validation_error_footer": [

      "å¯ä»¥è°ƒæ•´ç›¸å…³é¡¹åå†è¯•ä¸€ä¸‹ï½"

    ],

  

    "form_order_confirmed": [

      "ï¿½ï¿½ è®¢å•æäº¤æˆåŠŸï¼",

      "æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼",

      "è®¢å•å·ï¼š{order_id}",

      "é¢„è®¡å‘è´§æ—¶é—´ï¼š{delivery_time}"

    ]

  },

  

  "filters": {

    "series_by_category": {

      "æ‰‹æœº": ["iPhone 15", "iPhone 14", "iPhone 13"],

      "ç”µè„‘": ["MacBook Pro", "MacBook Air", "iMac"],

      "å¹³æ¿": ["iPad Pro", "iPad Air", "iPad"],

      "æ‰‹è¡¨": ["Apple Watch Series 9", "Apple Watch Ultra 2"]

    },

  

    "size_by_series": {

      "iPhone 15": ["6.1è‹±å¯¸", "6.7è‹±å¯¸"],

      "iPhone 14": ["6.1è‹±å¯¸", "6.7è‹±å¯¸"], 

      "MacBook Pro": ["14è‹±å¯¸", "16è‹±å¯¸"],

      "MacBook Air": ["13è‹±å¯¸", "15è‹±å¯¸"]

    },

  

    "chip_by_category": {

      "æ‰‹æœº": ["A17 Pro", "A16 Bionic"],

      "ç”µè„‘": ["M3", "M3 Pro", "M3 Max"],

      "å¹³æ¿": ["M2", "A14 Bionic"],

      "æ‰‹è¡¨": ["S9", "S8"]

    },

  

    "storage_by_category": {

      "æ‰‹æœº": ["128GB", "256GB", "512GB", "1TB"],

      "ç”µè„‘": ["512GB", "1TB", "2TB"],

      "å¹³æ¿": ["128GB", "256GB", "512GB", "1TB"],

      "æ‰‹è¡¨": ["32GB", "64GB"]

    }

  },

  

  "command_keywords": {

    "restart": ["é‡æ–°å¼€å§‹", "é‡ç½®", "å†æ¥ä¸€æ¬¡", "restart", "reset"],

    "confirm": ["ç¡®è®¤", "å¥½çš„", "ç¡®å®š", "ok", "confirm", "yes"],

    "help": ["å¸®åŠ©", "æ€ä¹ˆç”¨", "è¯´æ˜", "help"],

    "reselect": ["é‡é€‰", "ä¿®æ”¹", "æ¢ä¸€ä¸ª", "change"]

  },

  

  "intent_recommendations": {

    "category": [

      {

        "intent": "æƒ³è¦æœ€æ–°æ¬¾æ‰‹æœº",

        "keywords": ["æœ€æ–°", "æ–°æ¬¾", "åˆšå‡º", "æœ€è¿‘"],

        "recommend": "æ‰‹æœº",

        "confidence": 0.8,

        "reason": "ç”¨æˆ·è¡¨è¾¾äº†æƒ³è¦æœ€æ–°äº§å“çš„æ„æ„¿"

      },

      {

        "intent": "éœ€è¦å·¥ä½œç”¨çš„ç”µè„‘",

        "keywords": ["å·¥ä½œ", "åŠå…¬", "ç¼–ç¨‹", "è®¾è®¡"],

        "recommend": "ç”µè„‘", 

        "confidence": 0.7,

        "reason": "ç”¨æˆ·æåˆ°äº†å·¥ä½œç›¸å…³åœºæ™¯"

      }

    ],

  

    "series": [

      {

        "intent": "éœ€è¦é«˜æ€§èƒ½ç”µè„‘",

        "keywords": ["é«˜æ€§èƒ½", "å¼ºå¤§", "ä¸“ä¸š", "æ¸²æŸ“"],

        "recommend": "MacBook Pro",

        "confidence": 0.8,

        "reason": "ç”¨æˆ·è¡¨è¾¾äº†é«˜æ€§èƒ½éœ€æ±‚"

      },

      {

        "intent": "æƒ³è¦è½»è–„ä¾¿æº",

        "keywords": ["è½»è–„", "ä¾¿æº", "è½»ä¾¿", "æºå¸¦"],

        "recommend": "MacBook Air",

        "confidence": 0.7,

        "reason": "ç”¨æˆ·å…³æ³¨ä¾¿æºæ€§"

      }

    ]

  }

}

```

### 4.7.3 DSLæµç¨‹å®šä¹‰æ–‡ä»¶æ ¼å¼è¯´æ˜

#### æ–‡ä»¶ä½ç½®

- é»˜è®¤è·¯å¾„ï¼š`scripts/` ç›®å½•ä¸‹
- æ–‡ä»¶æ ¼å¼ï¼šYAMLæ ¼å¼
- æ–‡ä»¶å‘½åï¼š`{business_line}.flow.yaml`

#### æ–‡ä»¶ç»“æ„

```yaml

flow:

  name: "apple_store"

  version: "1.0"

  description: "è‹¹æœä¸“å–åº—äº§å“é…ç½®æµç¨‹"

  business_line: "apple_store"

  

  process_order:

    - category

    - brand

    - series

    - size

    - chip

    - storage

    - color

  

  slots:

    category:

      label: "äº§å“å¤§ç±»"

      description: "é€‰æ‹©äº§å“ç±»å‹"

      required: true

      type: enum

      enums_key: category

      dependencies: []

      prompt_template: form_category_prompt

      allow_llm: false

  

    brand:

      label: "å“ç‰Œ"

      description: "é€‰æ‹©äº§å“å“ç‰Œ"

      required: true 

      type: enum

      enums_key: brand

      dependencies: [category]

      allow_llm: false

  

    series:

      label: "äº§å“ç³»åˆ—"

      description: "é€‰æ‹©å…·ä½“äº§å“ç³»åˆ—"

      required: true

      type: enum

      enums_key: series

      dependencies: [category, brand]

      semantic_stage: series_selection

      prompt_template: form_series_prompt

      allow_llm: true

  

    size:

      label: "å±å¹•å°ºå¯¸"

      description: "é€‰æ‹©å±å¹•å°ºå¯¸"

      required: true

      type: enum

      enums_key: size

      dependencies: [category, series]

      semantic_stage: size_selection

      allow_llm: true

  

    chip:

      label: "å¤„ç†å™¨èŠ¯ç‰‡"

      description: "é€‰æ‹©å¤„ç†å™¨å‹å·"

      required: true

      type: enum

      enums_key: chip

      dependencies: [category, series, size]

      semantic_stage: chip_selection

      validation:

        must_be_valid_enum: true

        min_confidence: 0.35

      allow_llm: true

  

    storage:

      label: "å­˜å‚¨å®¹é‡"

      description: "é€‰æ‹©å­˜å‚¨å®¹é‡"

      required: true

      type: enum

      enums_key: storage

      dependencies: [category, series, chip]

      semantic_stage: storage_selection

      validation:

        must_be_valid_enum: true

        min_confidence: 0.4

      allow_llm: true

  

    color:

      label: "é¢œè‰²"

      description: "é€‰æ‹©äº§å“é¢œè‰²"

      required: true

      type: enum

      enums_key: color

      dependencies: [category, series]

      semantic_stage: color_selection

      allow_llm: true

  

  events:

    on_start:

      - action: reset_form

      - action: show_template

        template: form_welcome

      - action: show_template

        template: form_category_prompt

  

    on_all_filled:

      - action: validate_form

      - action: show_summary

      - action: ask_confirm

  

    on_confirm:

      - action: submit_order

      - action: show_template

        template: form_order_confirmed

  

    on_validation_error:

      - action: show_template

        template: form_validation_error_title

      - action: show_errors

      - action: show_template

        template: form_validation_error_footer

  

  commands:

    restart:

      keywords: ["é‡æ–°å¼€å§‹", "é‡ç½®", "å†æ¥ä¸€æ¬¡", "restart", "reset"]

      action: restart_flow

      available_when: always

  

    confirm:

      keywords: ["ç¡®è®¤", "å¥½çš„", "ç¡®å®š", "ok", "confirm", "yes"]

      action: confirm_order

      condition: all_slots_filled

  

    help:

      keywords: ["å¸®åŠ©", "æ€ä¹ˆç”¨", "è¯´æ˜", "help"]

      action: show_help

      response: |

        ä½¿ç”¨å¸®åŠ©ï¼š

        â€¢ æŒ‰ç…§æç¤ºé€‰æ‹©äº§å“é…ç½®

        â€¢ è¯´"é‡é€‰"å¯ä»¥ä¿®æ”¹ä¹‹å‰çš„é€‰æ‹©

        â€¢ è¯´"é‡æ–°å¼€å§‹"å¯ä»¥é‡ç½®æ‰€æœ‰é€‰æ‹©

        â€¢ é€‰æ‹©å®Œæˆåè¯´"ç¡®è®¤"æäº¤è®¢å•

  

    reselect:

      keywords: ["é‡é€‰", "ä¿®æ”¹", "æ¢ä¸€ä¸ª", "change"]

      action: show_reselect_options

      condition: has_filled_slots

```

### 4.7.4 ç¯å¢ƒå˜é‡é…ç½®è¯´æ˜

#### å¿…éœ€ç¯å¢ƒå˜é‡

```bash

 æ˜Ÿç«å¤§æ¨¡å‹APIé…ç½®

SPARK_API_KEY=your_spark_api_key_here

 

 å¯é€‰ï¼šè‡ªå®šä¹‰APIç«¯ç‚¹

SPARK_API_URL=https://spark-api.xf-yun.com/v1/chat

 

 å¯é€‰ï¼šæ¨¡å‹é€‰æ‹©

SPARK_MODEL=lite

 

 å¯é€‰ï¼šä¸šåŠ¡é…ç½®ç›®å½•ï¼ˆé»˜è®¤ï¼šé¡¹ç›®æ ¹ç›®å½•/knowledgeï¼‰

BUSINESS_CONFIG_DIR=/path/to/your/configs

 

 å¯é€‰ï¼šDSLè„šæœ¬ç›®å½•ï¼ˆé»˜è®¤ï¼šé¡¹ç›®æ ¹ç›®å½•/scriptsï¼‰ Â 

DSL_SCRIPTS_DIR=/path/to/your/scripts

```

#### å¯é€‰ç¯å¢ƒå˜é‡

```bash

 æ€§èƒ½é…ç½®

LLM_TIMEOUT=30

LLM_MAX_TOKENS=1000

MAX_CONCURRENT_REQUESTS=5

REQUEST_TIMEOUT=30

CACHE_TTL=300

 

 åŠŸèƒ½å¼€å…³

ENABLE_LLM=true

ENABLE_SEMANTIC_MAPPING=true

ENABLE_VALIDATION=true

DEBUG_MODE=false

 

 æ—¥å¿—é…ç½®

LOG_LEVEL=INFO

LOG_FILE=logs/dialog_system.log

```

### 4.7.5 é…ç½®å­—æ®µè¯¦ç»†è¯´æ˜

#### ä¸šåŠ¡ä¿¡æ¯å­—æ®µ(business_info)

- `name`: ä¸šåŠ¡çº¿æ ‡è¯†ï¼Œå¿…é¡»ä¸æ–‡ä»¶åä¸€è‡´
- `display_name`: æ˜¾ç¤ºç»™ç”¨æˆ·çš„ä¸šåŠ¡åç§°
- `description`: ä¸šåŠ¡æè¿°ï¼Œç”¨äºæ–‡æ¡£å’Œé€‰æ‹©ç•Œé¢
- `version`: é…ç½®ç‰ˆæœ¬ï¼Œæ”¯æŒé…ç½®ç‰ˆæœ¬ç®¡ç†

#### æ§½ä½è§„æ ¼å­—æ®µ(slot_specs)

- `name`: æ§½ä½åç§°ï¼Œåœ¨æµç¨‹ä¸­å”¯ä¸€æ ‡è¯†
- `required`: æ˜¯å¦å¿…å¡«å­—æ®µ
- `description`: ä¸šåŠ¡æè¿°ï¼Œç”¨äºç”Ÿæˆæç¤ºä¿¡æ¯
- `dependencies`: ä¾èµ–çš„æ§½ä½åˆ—è¡¨ï¼Œç¡®ä¿æ­£ç¡®çš„å¡«å……é¡ºåº
- `enums_key`: å¯¹åº”çš„æšä¸¾é”®åï¼Œå¿…é¡»å­˜åœ¨äºenumsé…ç½®ä¸­
- `semantic_stage`: è¯­ä¹‰é˜¶æ®µæ ‡è¯†ï¼Œå¯ç”¨æ™ºèƒ½è¯­ä¹‰å¤„ç†
- `allow_llm`: æ˜¯å¦å…è®¸LLMå¡«å……æ­¤æ§½ä½

#### æšä¸¾é…ç½®å­—æ®µ(enums)

- `label`: æ˜¾ç¤ºæ ‡ç­¾ï¼Œç³»ç»Ÿå†…éƒ¨ä½¿ç”¨çš„è§„èŒƒå€¼
- `aliases`: ç”¨æˆ·è¡¨è¾¾åˆ«åï¼Œæ”¯æŒå¤šç§è¡¨è¾¾æ–¹å¼
- `description`: æšä¸¾é¡¹æè¿°ï¼Œç”¨äºæ–‡æ¡£å’Œæç¤º
- `keywords`: å…³é”®è¯åˆ—è¡¨ï¼Œç”¨äºè¯­ä¹‰åŒ¹é…

#### æ¨¡æ¿é…ç½®å­—æ®µ(templates)

- æ”¯æŒå¤šè¡Œæ–‡æœ¬ï¼Œæ¯è¡Œä½œä¸ºåˆ—è¡¨ä¸­çš„ä¸€ä¸ªå…ƒç´ 
- æ”¯æŒå˜é‡æ›¿æ¢ï¼Œå¦‚ `{variable_name}`
- æ”¯æŒæ¡ä»¶åŒ–æ¨¡æ¿é€‰æ‹©ï¼ˆåœ¨ä»£ç ä¸­å®ç°ï¼‰

#### è¿‡æ»¤è§„åˆ™å­—æ®µ(filters)

- æ”¯æŒå¤šçº§ä¸šåŠ¡è§„åˆ™æ˜ å°„
- é”®ä¸ºæºæ§½ä½å€¼ï¼Œå€¼ä¸ºç›®æ ‡æ§½ä½çš„å…è®¸å€¼åˆ—è¡¨
- å®ç°åŸºäºä¸Šä¸‹æ–‡çš„åŠ¨æ€é€‰é¡¹è¿‡æ»¤

#### å‘½ä»¤å…³é”®è¯å­—æ®µ(command_keywords)

- é”®ä¸ºå‘½ä»¤åç§°ï¼Œå€¼ä¸ºè§¦å‘å…³é”®è¯åˆ—è¡¨
- æ”¯æŒä¸­è‹±æ–‡å…³é”®è¯
- æ”¯æŒç²¾ç¡®åŒ¹é…å’ŒåŒ…å«åŒ¹é…

#### æ„å›¾æ¨èå­—æ®µ(intent_recommendations)

- `intent`: ç”¨æˆ·æ„å›¾æè¿°
- `keywords`: è§¦å‘æ­¤æ„å›¾çš„å…³é”®è¯
- `recommend`: æ¨èçš„å€¼
- `confidence`: æ¨èç½®ä¿¡åº¦
- `reason`: æ¨èç†ç”±ï¼Œç”¨äºå¯è§£é‡Šæ€§

### 4.7.6 é…ç½®éªŒè¯è§„åˆ™

#### ä¸šåŠ¡é…ç½®éªŒè¯

1. **å¿…éœ€å­—æ®µæ£€æŸ¥**ï¼šç¡®ä¿business_infoã€slot_specsã€enumsç­‰å¿…éœ€æ®µå­˜åœ¨
2. **æ§½ä½è§„æ ¼éªŒè¯**ï¼šæ¯ä¸ªæ§½ä½å¿…é¡»æœ‰nameå’Œdescriptionå­—æ®µ
3. **æšä¸¾é…ç½®éªŒè¯**ï¼šæ¯ä¸ªæšä¸¾é¡¹å¿…é¡»æœ‰labelå­—æ®µ
4. **ä¾èµ–å…³ç³»éªŒè¯**ï¼šæ§½ä½ä¾èµ–å¿…é¡»æŒ‡å‘å·²å®šä¹‰çš„æ§½ä½
5. **æ¨¡æ¿æ ¼å¼éªŒè¯**ï¼šæ¨¡æ¿å¿…é¡»æ˜¯å­—ç¬¦ä¸²åˆ—è¡¨æ ¼å¼

#### DSLé…ç½®éªŒè¯

1. **æµç¨‹å®šä¹‰éªŒè¯**ï¼šç¡®ä¿flowã€nameã€process_orderã€slotsç­‰å¿…éœ€å­—æ®µå­˜åœ¨
2. **æ§½ä½é¡ºåºéªŒè¯**ï¼šprocess_orderä¸­çš„æ§½ä½å¿…é¡»åœ¨slotsä¸­å®šä¹‰
3. **ä¾èµ–é¡ºåºéªŒè¯**ï¼šæ§½ä½ä¸èƒ½åœ¨ä¾èµ–çš„æ§½ä½ä¹‹å‰å¤„ç†
4. **æšä¸¾å¼•ç”¨éªŒè¯**ï¼šenums_keyå¿…é¡»æŒ‡å‘ä¸šåŠ¡é…ç½®ä¸­å­˜åœ¨çš„æšä¸¾
5. **æ¨¡æ¿å¼•ç”¨éªŒè¯**ï¼šprompt_templateå¿…é¡»æŒ‡å‘ä¸šåŠ¡é…ç½®ä¸­å­˜åœ¨çš„æ¨¡æ¿

#### ç¯å¢ƒå˜é‡éªŒè¯

1. **å¿…éœ€å˜é‡æ£€æŸ¥**ï¼šSPARK_API_KEYå¿…é¡»é…ç½®
2. **ç›®å½•å­˜åœ¨æ€§æ£€æŸ¥**ï¼šé…ç½®ç›®å½•å’Œè„šæœ¬ç›®å½•å¿…é¡»å­˜åœ¨
3. **æ–‡ä»¶å¯è¯»æ€§æ£€æŸ¥**ï¼šé…ç½®æ–‡ä»¶å’Œè„šæœ¬æ–‡ä»¶å¿…é¡»å¯è¯»

### 4.7.7 é…ç½®åŠ è½½é¡ºåº

1. **ç¯å¢ƒå˜é‡åŠ è½½**ï¼šé¦–å…ˆåŠ è½½ç¯å¢ƒå˜é‡é…ç½®
2. **ä¸šåŠ¡é…ç½®åŠ è½½**ï¼šåŠ è½½æ‰€æœ‰ä¸šåŠ¡JSONé…ç½®æ–‡ä»¶åˆ°å†…å­˜ç¼“å­˜
3. **DSLè„šæœ¬åŠ è½½**ï¼šæ ¹æ®ç”¨æˆ·é€‰æ‹©åŠ è½½å¯¹åº”çš„YAMLæµç¨‹å®šä¹‰
4. **åŠ¨æ€é…ç½®æ³¨å…¥**ï¼šå°†DSLé…ç½®åŠ¨æ€æ³¨å…¥åˆ°ä¸šåŠ¡é…ç½®ä¸­
5. **é…ç½®èåˆå®Œæˆ**ï¼šåˆ›å»ºå®Œæ•´çš„è¿è¡Œæ—¶é…ç½®ç¯å¢ƒ

### 4.7.8 é…ç½®çƒ­æ›´æ–°æ”¯æŒ

ç³»ç»Ÿæ”¯æŒä»¥ä¸‹é…ç½®çš„çƒ­æ›´æ–°ï¼š

- ä¸šåŠ¡é…ç½®æ–‡ä»¶ï¼ˆJSONï¼‰ï¼šä¿®æ”¹åé‡å¯ç³»ç»Ÿç”Ÿæ•ˆ
- ç¯å¢ƒå˜é‡ï¼šä¿®æ”¹åé‡å¯ç³»ç»Ÿç”Ÿæ•ˆ
- DSLè„šæœ¬æ–‡ä»¶ï¼ˆYAMLï¼‰ï¼šå¯é€šè¿‡é‡æ–°é€‰æ‹©æµç¨‹ç«‹å³ç”Ÿæ•ˆ

ä¸æ”¯æŒçƒ­æ›´æ–°çš„é…ç½®ï¼š

- ç³»ç»Ÿæ ¸å¿ƒé…ç½®ï¼ˆéœ€è¦åœ¨ä»£ç ä¸­ä¿®æ”¹ï¼‰
- æ•°æ®ç»“æ„å®šä¹‰ï¼ˆéœ€è¦åœ¨ä»£ç ä¸­ä¿®æ”¹ï¼‰

è¿™ç§åˆ†å±‚é…ç½®æ¶æ„ç¡®ä¿äº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶å³å¯è°ƒæ•´ä¸šåŠ¡é€»è¾‘å’Œç”¨æˆ·äº¤äº’ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ã€‚

## 4.8 æ•°æ®æ–‡ä»¶è¯´æ˜

å¦‚æœç”¨åˆ°äº†æ•°æ®æ–‡ä»¶ï¼Œéœ€è¦ç»™å‡ºæ•°æ®æ–‡ä»¶çš„æ ¼å¼è¯´æ˜ã€‚

å¦‚æœç”¨åˆ°äº†å…³ç³»æ•°æ®åº“ï¼Œéœ€è¦ç»™å‡ºæ•°æ®åº“çš„è¡¨çš„è¯´æ˜ï¼ˆåŒ…æ‹¬æ¯ä¸ªå­—æ®µçš„åç§°ï¼Œç±»å‹ï¼Œè¯´æ˜ç­‰ï¼‰ã€‚

### 4.8.1 æ•°æ®æ–‡ä»¶æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨æ–‡ä»¶ç³»ç»Ÿä½œä¸ºæ•°æ®å­˜å‚¨æ–¹æ¡ˆï¼Œé€šè¿‡ç»“æ„åŒ–çš„JSONå’ŒYAMLæ–‡ä»¶å­˜å‚¨ä¸šåŠ¡é…ç½®ã€æµç¨‹å®šä¹‰å’Œè¿è¡Œæ—¶çŠ¶æ€ã€‚æ‰€æœ‰æ•°æ®æ–‡ä»¶å‡é‡‡ç”¨UTF-8ç¼–ç ï¼Œæ”¯æŒä¸­è‹±æ–‡å†…å®¹ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯ç§»æ¤æ€§å’Œæ˜“ç»´æŠ¤æ€§ã€‚

### 4.8.2 ä¸šåŠ¡é…ç½®æ–‡ä»¶æ ¼å¼

#### æ–‡ä»¶ä½ç½®ä¸å‘½å

- **å­˜å‚¨è·¯å¾„**: `knowledge/` ç›®å½•
- **æ–‡ä»¶æ ¼å¼**: JSONæ ¼å¼
- **å‘½åè§„èŒƒ**: `{business_line}.json`
- **ç¤ºä¾‹æ–‡ä»¶**: `apple_store.json`, `dining.json`

#### æ•°æ®ç»“æ„è¯´æ˜

##### ä¸šåŠ¡ä¿¡æ¯æ®µ (business_info)

```json
{
  "business_info": {
    "name": "apple_store",
    "display_name": "è‹¹æœä¸“å–åº—",
    "description": "è‹¹æœäº§å“é…ç½®å’Œè´­ä¹°æµç¨‹",
    "version": "1.0"
  }
}
```

**å­—æ®µè¯´æ˜**:

- `name`: ä¸šåŠ¡çº¿å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¿…é¡»ä¸æ–‡ä»¶åä¸€è‡´
- `display_name`: ç”¨æˆ·å¯è§çš„ä¸šåŠ¡åç§°
- `description`: ä¸šåŠ¡æè¿°ï¼Œç”¨äºæ–‡æ¡£å’Œç”¨æˆ·ç•Œé¢
- `version`: é…ç½®ç‰ˆæœ¬ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†å’Œçƒ­æ›´æ–°

##### æ§½ä½è§„æ ¼æ®µ (slot_specs)

```json
{
  "slot_specs": [
    {
      "name": "category",
      "required": true,
      "description": "é€‰æ‹©äº§å“ç±»å‹",
      "dependencies": [],
      "enums_key": "category",
      "semantic_stage": null,
      "allow_llm": false
    }
  ]
}
```

**å­—æ®µè¯´æ˜**:

- `name`: æ§½ä½åç§°ï¼Œåœ¨ä¸šåŠ¡å†…å”¯ä¸€
- `required`: å¸ƒå°”å€¼ï¼Œæ ‡è¯†æ˜¯å¦å¿…å¡«å­—æ®µ
- `description`: ä¸šåŠ¡æè¿°æ–‡æœ¬ï¼Œç”¨äºç”Ÿæˆç”¨æˆ·æç¤º
- `dependencies`: å­—ç¬¦ä¸²æ•°ç»„ï¼Œå®šä¹‰æ§½ä½ä¾èµ–å…³ç³»
- `enums_key`: å…³è”çš„æšä¸¾é”®åï¼Œå¿…é¡»å­˜åœ¨äºenumsæ®µ
- `semantic_stage`: è¯­ä¹‰é˜¶æ®µæ ‡è¯†ï¼Œå¯ç”¨æ™ºèƒ½é€‰é¡¹è¿‡æ»¤
- `allow_llm`: å¸ƒå°”å€¼ï¼Œæ§åˆ¶æ˜¯å¦å…è®¸LLMå¡«å……æ­¤æ§½ä½

##### æšä¸¾å®šä¹‰æ®µ (enums)

```json
{
  "enums": {
    "category": [
      {
        "label": "æ‰‹æœº",
        "aliases": ["iphone", "æ™ºèƒ½æ‰‹æœº", "æ‰‹æœº"],
        "description": "iPhoneç³»åˆ—äº§å“",
        "keywords": ["æ‰‹æœº", "iphone", "ç”µè¯"]
      }
    ]
  }
}
```

**å­—æ®µè¯´æ˜**:

- `label`: è§„èŒƒå€¼ï¼Œç³»ç»Ÿå†…éƒ¨ä½¿ç”¨å’Œæ˜¾ç¤º
- `aliases`: ç”¨æˆ·è¡¨è¾¾åˆ«åæ•°ç»„ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…
- `description`: æšä¸¾é¡¹çš„ä¸šåŠ¡æè¿°
- `keywords`: è¯­ä¹‰åŒ¹é…å…³é”®è¯æ•°ç»„ï¼Œç”¨äºæ™ºèƒ½æ¨è

##### æ¨¡æ¿å†…å®¹æ®µ (templates)

```json
{
  "templates": {
    "form_welcome": [
      "æ¬¢è¿æ¥åˆ°è‹¹æœä¸“å–åº—ï¼ğŸ‰",
      "æˆ‘å°†å¸®æ‚¨é…ç½®å¿ƒä»ªçš„è‹¹æœäº§å“ã€‚",
      "è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆç±»å‹çš„äº§å“ï¼š"
    ]
  }
}
```

**å­—æ®µè¯´æ˜**:

- é”®å: æ¨¡æ¿æ ‡è¯†ç¬¦ï¼Œåœ¨DSLä¸­å¼•ç”¨
- å€¼: å­—ç¬¦ä¸²æ•°ç»„ï¼Œæ¯è¡Œä½œä¸ºç‹¬ç«‹çš„æ˜¾ç¤ºè¡Œ
- æ”¯æŒå˜é‡æ›¿æ¢è¯­æ³•: `{variable_name}`

##### è¿‡æ»¤è§„åˆ™æ®µ (filters)

```json
{
  "filters": {
    "series_by_category": {
      "æ‰‹æœº": ["iPhone 15", "iPhone 14", "iPhone 13"],
      "ç”µè„‘": ["MacBook Pro", "MacBook Air", "iMac"]
    }
  }
}
```

**å­—æ®µè¯´æ˜**:

- é”®å: è¿‡æ»¤è§„åˆ™åç§°ï¼Œæ ¼å¼ä¸º `{target}_by_{source}`
- å­é”®: æºæ§½ä½çš„å¯èƒ½å€¼
- å­å€¼: ç›®æ ‡æ§½ä½çš„å…è®¸å€¼æ•°ç»„

##### å‘½ä»¤å…³é”®è¯æ®µ (command_keywords)

```json
{
  "command_keywords": {
    "restart": ["é‡æ–°å¼€å§‹", "é‡ç½®", "å†æ¥ä¸€æ¬¡"],
    "confirm": ["ç¡®è®¤", "å¥½çš„", "ç¡®å®š"]
  }
}
```

**å­—æ®µè¯´æ˜**:

- é”®å: å‘½ä»¤æ ‡è¯†ç¬¦
- å€¼: è§¦å‘å…³é”®è¯æ•°ç»„ï¼Œæ”¯æŒä¸­è‹±æ–‡æ··åˆ

##### æ„å›¾æ¨èæ®µ (intent_recommendations)

```json
{
  "intent_recommendations": {
    "category": [
      {
        "intent": "æƒ³è¦æœ€æ–°æ¬¾æ‰‹æœº",
        "keywords": ["æœ€æ–°", "æ–°æ¬¾", "åˆšå‡º"],
        "recommend": "æ‰‹æœº",
        "confidence": 0.8,
        "reason": "ç”¨æˆ·è¡¨è¾¾äº†æƒ³è¦æœ€æ–°äº§å“çš„æ„æ„¿"
      }
    ]
  }
}
```

**å­—æ®µè¯´æ˜**:

- `intent`: ç”¨æˆ·æ„å›¾çš„è‡ªç„¶è¯­è¨€æè¿°
- `keywords`: è§¦å‘æ­¤æ„å›¾çš„å…³é”®è¯æ•°ç»„
- `recommend`: æ¨èçš„æ§½ä½å€¼
- `confidence`: æ¨èç½®ä¿¡åº¦ï¼Œ0-1ä¹‹é—´çš„æµ®ç‚¹æ•°
- `reason`: æ¨èç†ç”±ï¼Œç”¨äºå¯è§£é‡Šæ€§

### 4.8.3 DSLæµç¨‹å®šä¹‰æ–‡ä»¶æ ¼å¼

#### æ–‡ä»¶ä½ç½®ä¸å‘½å

- **å­˜å‚¨è·¯å¾„**: `scripts/` ç›®å½•
- **æ–‡ä»¶æ ¼å¼**: YAMLæ ¼å¼
- **å‘½åè§„èŒƒ**: `{business_line}.flow.yaml`
- **ç¤ºä¾‹æ–‡ä»¶**: `apple_store.flow.yaml`, `dining.flow.yaml`

#### æ•°æ®ç»“æ„è¯´æ˜

##### æµç¨‹å®šä¹‰æ ¹èŠ‚ç‚¹ (flow)

```yaml
flow:
  name: "apple_store"
  version: "1.0"
  description: "è‹¹æœä¸“å–åº—äº§å“é…ç½®æµç¨‹"
  business_line: "apple_store"
```

**å­—æ®µè¯´æ˜**:

- `name`: æµç¨‹åç§°ï¼Œç”¨äºæ ‡è¯†
- `version`: ç‰ˆæœ¬å·ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†
- `description`: æµç¨‹æè¿°ï¼Œç”¨äºæ–‡æ¡£
- `business_line`: å…³è”çš„ä¸šåŠ¡çº¿æ ‡è¯†

##### å¤„ç†é¡ºåºå®šä¹‰ (process_order)

```yaml
process_order:
  - category
  - brand
  - series
```

**å­—æ®µè¯´æ˜**:

- å­—ç¬¦ä¸²æ•°ç»„ï¼Œå®šä¹‰æ§½ä½çš„å¤„ç†é¡ºåº
- å¿…é¡»ä¸slotsæ®µä¸­å®šä¹‰çš„æ§½ä½åç§°ä¸€è‡´
- ç¡®ä¿ä¾èµ–å…³ç³»çš„æ­£ç¡®æ‰§è¡Œé¡ºåº

##### æ§½ä½é…ç½®æ®µ (slots)

```yaml
slots:
  category:
    label: "äº§å“å¤§ç±»"
    description: "é€‰æ‹©äº§å“ç±»å‹"
    required: true
    type: enum
    enums_key: category
    dependencies: []
    prompt_template: form_category_prompt
```

**å­—æ®µè¯´æ˜**:

- `label`: ç”¨æˆ·å¯è§çš„æ˜¾ç¤ºæ ‡ç­¾
- `description`: è¯¦ç»†çš„ä¸šåŠ¡æè¿°
- `required`: æ˜¯å¦å¿…å¡«å­—æ®µ
- `type`: æ•°æ®ç±»å‹ï¼Œæ”¯æŒ `enum` æˆ– `text`
- `enums_key`: å¯¹äºenumç±»å‹ï¼ŒæŒ‡å®šå…³è”çš„æšä¸¾é”®
- `dependencies`: ä¾èµ–çš„æ§½ä½åˆ—è¡¨
- `prompt_template`: æç¤ºæ¨¡æ¿é”®å

##### äº‹ä»¶å¤„ç†æ®µ (events)

```yaml
events:
  on_start:
    - action: reset_form
    - action: show_template
      template: form_welcome
```

**å­—æ®µè¯´æ˜**:

- äº‹ä»¶åç§°: å¦‚ `on_start`, `on_all_filled`, `on_confirm`
- åŠ¨ä½œåˆ—è¡¨: æŒ‰é¡ºåºæ‰§è¡Œçš„åŠ¨ä½œåºåˆ—
- åŠ¨ä½œç±»å‹: `reset_form`, `show_template`, `show_summary` ç­‰
- å‚æ•°: åŠ¨ä½œæ‰€éœ€çš„å‚æ•°ï¼Œå¦‚ `template`

##### å‘½ä»¤æ˜ å°„æ®µ (commands)

```yaml
commands:
  restart:
    keywords: ["é‡æ–°å¼€å§‹", "é‡ç½®"]
    action: restart_flow
    available_when: always
```

**å­—æ®µè¯´æ˜**:

- å‘½ä»¤åç§°: ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨çš„å‘½ä»¤æ ‡è¯†
- `keywords`: è§¦å‘å‘½ä»¤çš„ç”¨æˆ·è¾“å…¥å…³é”®è¯
- `action`: æ‰§è¡Œçš„ç³»ç»ŸåŠ¨ä½œ
- `available_when`: å‘½ä»¤å¯ç”¨æ¡ä»¶

### 4.8.4 è¿è¡Œæ—¶æ•°æ®æ–‡ä»¶æ ¼å¼

#### ä¼šè¯çŠ¶æ€æ–‡ä»¶

```json
{
  "session_id": "sess_123456789",
  "business_line": "apple_store",
  "start_time": "2024-01-15T10:30:00Z",
  "last_activity": "2024-01-15T10:35:00Z",
  "current_state": {
    "order_status": "COLLECTING",
    "current_form": {
      "category": {
        "status": "FILLED",
        "value": "æ‰‹æœº",
        "confidence": 0.95,
        "source": "direct"
      },
      "series": {
        "status": "EMPTY",
        "value": null,
        "confidence": 0.0,
        "source": null
      }
    },
    "pending_conflicts": [],
    "validation_errors": []
  },
  "conversation_history": [
    {
      "timestamp": "2024-01-15T10:30:15Z",
      "user_input": "æˆ‘æƒ³ä¹°æ‰‹æœº",
      "system_response": "æ¬¢è¿æ¥åˆ°è‹¹æœä¸“å–åº—ï¼...",
      "extracted_slots": {"category": "æ‰‹æœº"}
    }
  ]
}
```

#### ç»Ÿè®¡æ—¥å¿—æ–‡ä»¶

```json
{
  "date": "2024-01-15",
  "business_line": "apple_store",
  "session_count": 45,
  "successful_completions": 38,
  "average_turns": 6.2,
  "llm_usage": {
    "total_calls": 120,
    "successful_calls": 115,
    "average_response_time": 1.2
  },
  "common_intents": {
    "é«˜æ€§èƒ½ç”µè„‘": 15,
    "æœ€æ–°æ‰‹æœº": 12,
    "è½»è–„ç¬”è®°æœ¬": 8
  }
}
```

### 4.8.5 æ•°æ®æ–‡ä»¶ç®¡ç†è§„èŒƒ

#### æ–‡ä»¶ç¼–ç ä¸æ ¼å¼

- **ç¼–ç æ ¼å¼**: æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨UTF-8ç¼–ç 
- **JSONæ ¼å¼**: ä½¿ç”¨2ä¸ªç©ºæ ¼ç¼©è¿›ï¼Œç¡®ä¿å¯è¯»æ€§
- **YAMLæ ¼å¼**: ä½¿ç”¨2ä¸ªç©ºæ ¼ç¼©è¿›ï¼Œæ”¯æŒå¤šè¡Œæ–‡æœ¬
- **è¡Œå°¾ç¬¦**: ç»Ÿä¸€ä½¿ç”¨LFï¼ˆUnixé£æ ¼ï¼‰

#### æ–‡ä»¶éªŒè¯è§„åˆ™

1. **è¯­æ³•éªŒè¯**: æ‰€æœ‰JSONå’ŒYAMLæ–‡ä»¶å¿…é¡»é€šè¿‡è¯­æ³•éªŒè¯
2. **å¼•ç”¨å®Œæ•´æ€§**: é…ç½®é—´çš„å¼•ç”¨å¿…é¡»å­˜åœ¨ä¸”æœ‰æ•ˆ
3. **æ•°æ®ç±»å‹**: å­—æ®µå€¼å¿…é¡»ç¬¦åˆé¢„æœŸçš„æ•°æ®ç±»å‹
4. **ä¸šåŠ¡é€»è¾‘**: ä¾èµ–å…³ç³»å¿…é¡»å½¢æˆæœ‰å‘æ— ç¯å›¾

#### å¤‡ä»½ä¸ç‰ˆæœ¬ç®¡ç†

1. **ç‰ˆæœ¬æ§åˆ¶**: æ‰€æœ‰é…ç½®æ–‡ä»¶çº³å…¥ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
2. **å˜æ›´æ—¥å¿—**: é‡å¤§é…ç½®å˜æ›´éœ€è¦è®°å½•å˜æ›´è¯´æ˜
3. **å¤‡ä»½ç­–ç•¥**: å®šæœŸå¤‡ä»½è¿è¡Œæ—¶æ•°æ®å’Œç»Ÿè®¡ä¿¡æ¯
4. **å›æ»šæœºåˆ¶**: æ”¯æŒé…ç½®ç‰ˆæœ¬çš„å›æ»šå’Œæ¢å¤

### 4.8.6 æ•°æ®æ–‡ä»¶åŠ è½½æµç¨‹

1. **å¯åŠ¨æ—¶åŠ è½½**:

   - éªŒè¯ç¯å¢ƒå˜é‡å’Œç›®å½•ç»“æ„
   - åŠ è½½æ‰€æœ‰ä¸šåŠ¡é…ç½®æ–‡ä»¶åˆ°å†…å­˜ç¼“å­˜
   - æ„å»ºæšä¸¾æ³¨å†Œè¡¨å’Œæ¨¡æ¿ç´¢å¼•
2. **è¿è¡Œæ—¶åŠ è½½**:

   - æ ¹æ®ç”¨æˆ·é€‰æ‹©åŠ è½½å¯¹åº”çš„DSLæµç¨‹å®šä¹‰
   - åŠ¨æ€æ³¨å…¥æ§½ä½è§„æ ¼åˆ°ä¸šåŠ¡é…ç½®
   - åˆ›å»ºå®Œæ•´çš„è¿è¡Œæ—¶é…ç½®ç¯å¢ƒ
3. **æ•°æ®æŒä¹…åŒ–**:

   - ä¼šè¯çŠ¶æ€å¯é€‰æ‹©æ€§æŒä¹…åŒ–åˆ°æ–‡ä»¶
   - ç»Ÿè®¡ä¿¡æ¯å®šæœŸå†™å…¥æ—¥å¿—æ–‡ä»¶
   - é”™è¯¯å’Œå¼‚å¸¸ä¿¡æ¯è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶

è¿™ç§åŸºäºæ–‡ä»¶çš„æ•°æ®å­˜å‚¨æ–¹æ¡ˆç¡®ä¿äº†ç³»ç»Ÿçš„è½»é‡çº§éƒ¨ç½²å’Œæ˜“äºç»´æŠ¤çš„ç‰¹æ€§ï¼ŒåŒæ—¶é€šè¿‡ç»“æ„åŒ–çš„æ•°æ®æ ¼å¼æ”¯æŒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘é…ç½®ã€‚

## 4.9 æ¥å£åè®®è¯´æ˜

å¦‚æœå­ç³»ç»Ÿä¹‹é—´å­˜åœ¨è‡ªå®šä¹‰çš„é€šä¿¡åè®®ï¼Œåˆ™éœ€è¦å¯¹åè®®æ•°æ®å•å…ƒçš„è¯­æ³•ï¼Œè¯­ä¹‰è¿›è¡Œæè¿°ï¼Œè¯´æ˜è¯¥åè®®çš„åº•å±‚æ‰¿è½½åè®®ã€‚

### 4.9.1 åè®®æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨åŸºäºå‡½æ•°è°ƒç”¨å’Œå¯¹è±¡æ–¹æ³•çš„å†…éƒ¨é€šä¿¡åè®®ï¼Œå„å­ç³»ç»Ÿä¹‹é—´é€šè¿‡å®šä¹‰è‰¯å¥½çš„æ¥å£è¿›è¡Œæ•°æ®äº¤æ¢å’ŒåŠŸèƒ½è°ƒç”¨ã€‚åè®®è®¾è®¡éµå¾ªé¢å‘å¯¹è±¡åŸåˆ™ï¼Œæä¾›ç±»å‹å®‰å…¨çš„æ¥å£å®šä¹‰å’Œæ¸…æ™°çš„é”™è¯¯å¤„ç†æœºåˆ¶ã€‚

### 4.9.2 å†…éƒ¨æ¥å£åè®®

#### 4.9.2.1 DSLè§£é‡Šå™¨æ¥å£åè®®

**åè®®æ‰¿è½½**: Pythonå‡½æ•°è°ƒç”¨
**æ•°æ®æ ¼å¼**: å­—å…¸å’Œå¯¹è±¡å®ä¾‹

##### YAMLFlowLoaderæ¥å£åè®®

```python
# åè®®æ•°æ®å•å…ƒï¼šæµç¨‹é…ç½®å­—å…¸
{
    "flow": {
        "name": "apple_store",
        "version": "1.0",
        "description": "è‹¹æœä¸“å–åº—äº§å“é…ç½®æµç¨‹",
        "business_line": "apple_store",
        "process_order": ["category", "brand", "series"],
        "slots": {
            "category": {
                "label": "äº§å“å¤§ç±»",
                "description": "é€‰æ‹©äº§å“ç±»å‹",
                "required": True,
                "type": "enum",
                "enums_key": "category",
                "dependencies": []
            }
        },
        "events": {
            "on_start": [
                {"action": "reset_form"},
                {"action": "show_template", "template": "form_welcome"}
            ]
        },
        "commands": {
            "restart": {
                "keywords": ["é‡æ–°å¼€å§‹", "reset"],
                "action": "restart_flow"
            }
        }
    }
}

# æ¥å£æ–¹æ³•åè®®
class YAMLFlowLoader:
    @staticmethod
    def load(yaml_file: str) -> Dict[str, Any]:
        """
        åè®®è¯­ä¹‰ï¼šåŠ è½½å’ŒéªŒè¯YAMLæµç¨‹å®šä¹‰æ–‡ä»¶
        è¾“å…¥åè®®ï¼šæ–‡ä»¶è·¯å¾„å­—ç¬¦ä¸²
        è¾“å‡ºåè®®ï¼šæ ‡å‡†åŒ–çš„æµç¨‹é…ç½®å­—å…¸
        é”™è¯¯åè®®ï¼šæŠ›å‡ºFileNotFoundError, yaml.YAMLError, ValueError
        """
```

##### FlowInterpreteræ¥å£åè®®

```python
# åè®®æ•°æ®å•å…ƒï¼šå¤„ç†ç»“æœå­—å…¸
{
    "response": "ç³»ç»Ÿå“åº”æ–‡æœ¬å†…å®¹",
    "action": "restart_flow",  # å¯é€‰ï¼Œæ‰§è¡Œçš„åŠ¨ä½œæ ‡è¯†
    "should_exit": False,      # å¯é€‰ï¼Œæ˜¯å¦åº”è¯¥é€€å‡ºå¯¹è¯
    "slots_updated": ["category"],  # æ‰©å±•å­—æ®µï¼Œç”¨äºè¡¨å•ç³»ç»Ÿ
    "conflicts": []            # æ‰©å±•å­—æ®µï¼Œå†²çªä¿¡æ¯
}

# æ¥å£æ–¹æ³•åè®®
class FlowInterpreter:
    def process_input(self, user_input: str, llm_client=None, semantic_mapper=None) -> Dict[str, Any]:
        """
        åè®®è¯­ä¹‰ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥å¹¶æ‰§è¡ŒDSLé€»è¾‘
        è¾“å…¥åè®®ï¼š
          - user_input: ç”¨æˆ·è¾“å…¥çš„è‡ªç„¶è¯­è¨€æ–‡æœ¬
          - llm_client: å¯é€‰çš„LLMå®¢æˆ·ç«¯å®ä¾‹
          - semantic_mapper: å¯é€‰çš„è¯­ä¹‰æ˜ å°„å™¨å®ä¾‹
        è¾“å‡ºåè®®ï¼šæ ‡å‡†åŒ–çš„å¤„ç†ç»“æœå­—å…¸
        é”™è¯¯åè®®ï¼šé™é»˜å¤„ç†ï¼Œè¿”å›åŒ…å«é”™è¯¯ä¿¡æ¯çš„å“åº”å­—å…¸
        """
```

#### 4.9.2.2 ä¸šåŠ¡é…ç½®æ¥å£åè®®

**åè®®æ‰¿è½½**: Pythonå¯¹è±¡æ–¹æ³•è°ƒç”¨
**æ•°æ®æ ¼å¼**: æ•°æ®ç±»å’Œå­—å…¸å¯¹è±¡

##### BusinessConfigLoaderæ¥å£åè®®

```python
# åè®®æ•°æ®å•å…ƒï¼šä¸šåŠ¡é…ç½®å¯¹è±¡
@dataclass
class BusinessConfig:
    name: str
    display_name: str
    description: str
    slot_specs: List[SlotSpec]
    enums: Dict[str, List[Dict[str, Any]]]
    templates: Dict[str, List[str]]
    filters: Dict[str, Dict[str, List[str]]]
    command_keywords: Dict[str, List[str]]
    intent_recommendations: Dict[str, List[Dict[str, Any]]]

# æ¥å£æ–¹æ³•åè®®
class BusinessConfigLoader:
    def get_business_config(self, business_name: str) -> Optional[BusinessConfig]:
        """
        åè®®è¯­ä¹‰ï¼šè·å–æŒ‡å®šä¸šåŠ¡çš„å®Œæ•´é…ç½®
        è¾“å…¥åè®®ï¼šä¸šåŠ¡åç§°å­—ç¬¦ä¸²
        è¾“å‡ºåè®®ï¼šBusinessConfigå¯¹è±¡å®ä¾‹æˆ–None
        é”™è¯¯åè®®ï¼šè¿”å›Noneè¡¨ç¤ºä¸šåŠ¡ä¸å­˜åœ¨
        """
  
    def inject_slot_specs(self, business_name: str, slot_specs: List[SlotSpec]):
        """
        åè®®è¯­ä¹‰ï¼šåŠ¨æ€æ³¨å…¥æ§½ä½è§„æ ¼åˆ°ä¸šåŠ¡é…ç½®
        è¾“å…¥åè®®ï¼š
          - business_name: ç›®æ ‡ä¸šåŠ¡åç§°
          - slot_specs: æ§½ä½è§„æ ¼å¯¹è±¡åˆ—è¡¨
        è¾“å‡ºåè®®ï¼šæ— è¿”å›å€¼
        é”™è¯¯åè®®ï¼šé™é»˜å¤„ç†ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯
        """
```

#### 4.9.2.3 è¡¨å•ç³»ç»Ÿæ¥å£åè®®

**åè®®æ‰¿è½½**: Pythonå¯¹è±¡æ–¹æ³•è°ƒç”¨
**æ•°æ®æ ¼å¼**: æ•°æ®ç±»ã€æšä¸¾å’Œå­—å…¸å¯¹è±¡

##### FormBasedDialogSystemæ¥å£åè®®

```python
# åè®®æ•°æ®å•å…ƒï¼šè¡¨å•å¤„ç†ç»“æœ
{
    "slots_updated": ["category", "series"],  # æœ¬æ¬¡æ›´æ–°çš„æ§½ä½
    "slots_filled": ["category"],             # æœ¬æ¬¡å¡«å……å®Œæˆçš„æ§½ä½
    "conflicts": [                            # æ£€æµ‹åˆ°çš„å†²çªåˆ—è¡¨
        {
            "slot": "series",
            "existing": SlotValue(...),
            "new": SlotValue(...)
        }
    ],
    "response": "ç³»ç»Ÿç”Ÿæˆçš„å“åº”æ–‡æœ¬",
    "form_complete": False,                   # è¡¨å•æ˜¯å¦å®Œæ•´å¡«å……
    "should_exit": False                      # æ˜¯å¦åº”è¯¥é€€å‡ºå¯¹è¯
}

# æ§½ä½å€¼åè®®æ•°æ®å•å…ƒ
@dataclass
class SlotValue:
    value: Any                    # æ§½ä½å®é™…å€¼
    confidence: float            # ç½®ä¿¡åº¦ [0.0, 1.0]
    source: str                  # å€¼æ¥æºæ ‡è¯†
    reason: str = ""             # å€¼æ¥æºç†ç”±

# æ¥å£æ–¹æ³•åè®®
class FormBasedDialogSystem:
    def process_input(self, user_input: str, llm_client, semantic_mapper) -> Dict[str, Any]:
        """
        åè®®è¯­ä¹‰ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥çš„æ ¸å¿ƒæ–¹æ³•
        è¾“å…¥åè®®ï¼š
          - user_input: ç”¨æˆ·è¾“å…¥çš„è‡ªç„¶è¯­è¨€æ–‡æœ¬
          - llm_client: LLMå®¢æˆ·ç«¯å®ä¾‹
          - semantic_mapper: è¯­ä¹‰æ˜ å°„å™¨å®ä¾‹
        è¾“å‡ºåè®®ï¼šå®Œæ•´çš„è¡¨å•å¤„ç†ç»“æœå­—å…¸
        é”™è¯¯åè®®ï¼šè¿”å›åŒ…å«é”™è¯¯ä¿¡æ¯çš„å“åº”å­—å…¸
        """
```

#### 4.9.2.4 AIæœåŠ¡æ¥å£åè®®

**åè®®æ‰¿è½½**: Pythonæ–¹æ³•è°ƒç”¨å’ŒHTTPåè®®
**æ•°æ®æ ¼å¼**: æ•°æ®ç±»ã€å­—å…¸å’ŒJSON

##### SparkLLMClientæ¥å£åè®®

```python
# åè®®æ•°æ®å•å…ƒï¼šLLMæŠ½å–ç»“æœ
{
    "category": {
        "value": "æ‰‹æœº",
        "confidence": 0.8,
        "reason": "ç”¨æˆ·æ˜ç¡®æåˆ°äº†æ‰‹æœº"
    },
    "series": {
        "value": "",
        "confidence": 0.0,
        "reason": "ç”¨æˆ·æœªæä¾›ç³»åˆ—ä¿¡æ¯"
    }
}

# HTTPè¯·æ±‚åè®®
POST /v1/chat HTTP/1.1
Authorization: Bearer {api_key}
Content-Type: application/json

{
    "model": "lite",
    "messages": [
        {
            "role": "system",
            "content": "ä½ æ˜¯ä¸€ä¸ªè‹¹æœä¸“å–åº—é¢†åŸŸçš„æ™ºèƒ½åŠ©æ‰‹..."
        },
        {
            "role": "user", 
            "content": "æˆ‘æƒ³ä¹°æœ€æ–°æ¬¾çš„iPhoneæ‰‹æœº"
        }
    ],
    "temperature": 0.1,
    "max_tokens": 1000,
    "stream": false
}

# æ¥å£æ–¹æ³•åè®®
class SparkLLMClient:
    def extract_slots(self, user_input: str, business_line: str, 
                     target_slots: List[str], current_values: Optional[Dict[str, Any]] = None) -> Dict[str, Dict[str, Any]]:
        """
        åè®®è¯­ä¹‰ï¼šä»ç”¨æˆ·è¾“å…¥ä¸­æŠ½å–å¤šä¸ªæ§½ä½ä¿¡æ¯
        è¾“å…¥åè®®ï¼š
          - user_input: ç”¨æˆ·è¾“å…¥æ–‡æœ¬
          - business_line: ä¸šåŠ¡çº¿æ ‡è¯†
          - target_slots: ç›®æ ‡æ§½ä½åˆ—è¡¨
          - current_values: å½“å‰å·²å¡«å……å€¼
        è¾“å‡ºåè®®ï¼šæ§½ä½æŠ½å–ç»“æœå­—å…¸
        é”™è¯¯åè®®ï¼šè¿”å›ç©ºå­—å…¸è¡¨ç¤ºæŠ½å–å¤±è´¥
        """
```

##### SemanticMapperæ¥å£åè®®

```python
# åè®®æ•°æ®å•å…ƒï¼šè¯­ä¹‰åŒ¹é…ç»“æœ
@dataclass
class SemanticMatchResult:
    chosen_index: Optional[int]   # é€‰æ‹©çš„é€‰é¡¹ç´¢å¼•
    confidence: float             # åŒ¹é…ç½®ä¿¡åº¦
    reason: str                   # åŒ¹é…åŸå› æè¿°
    strategy: str                 # åŒ¹é…ç­–ç•¥æ ‡è¯†

# æ¥å£æ–¹æ³•åè®®
class SemanticMapper:
    @staticmethod
    def map(user_text: str, options: List[Option]) -> SemanticMatchResult:
        """
        åè®®è¯­ä¹‰ï¼šå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè¯­ä¹‰æ˜ å°„åŒ¹é…
        è¾“å…¥åè®®ï¼š
          - user_text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬
          - options: å€™é€‰é€‰é¡¹åˆ—è¡¨
        è¾“å‡ºåè®®ï¼šè¯­ä¹‰åŒ¹é…ç»“æœå¯¹è±¡
        é”™è¯¯åè®®ï¼šè¿”å›confidence=0.0çš„åŒ¹é…ç»“æœ
        """
```

### 4.9.3 å¤–éƒ¨æœåŠ¡åè®®

#### 4.9.3.1 æ˜Ÿç«å¤§æ¨¡å‹APIåè®®

**åº•å±‚æ‰¿è½½åè®®**: HTTPS/1.1
**æ•°æ®æ ¼å¼**: JSON
**è®¤è¯æ–¹å¼**: Bearer Token

##### è¯·æ±‚åè®®

```http
POST /v1/chat HTTP/1.1
Host: spark-api.xf-yun.com
Authorization: Bearer {api_key}
Content-Type: application/json
User-Agent: DialogSystem/1.0

{
    "model": "lite",
    "messages": [
        {
            "role": "system",
            "content": "ç³»ç»Ÿæç¤ºè¯å†…å®¹..."
        },
        {
            "role": "user",
            "content": "ç”¨æˆ·è¾“å…¥å†…å®¹..."
        }
    ],
    "temperature": 0.1,
    "max_tokens": 1000,
    "stream": false
}
```

##### å“åº”åè®®

```http
HTTP/1.1 200 OK
Content-Type: application/json
Date: Mon, 15 Jan 2024 10:30:00 GMT

{
    "choices": [
        {
            "message": {
                "role": "assistant",
                "content": "{\"category\": {\"value\": \"æ‰‹æœº\", \"confidence\": 0.8, \"reason\": \"ç”¨æˆ·æ˜ç¡®æåˆ°æ‰‹æœº\"}}"
            }
        }
    ],
    "usage": {
        "prompt_tokens": 50,
        "completion_tokens": 30,
        "total_tokens": 80
    }
}
```

##### é”™è¯¯å“åº”åè®®

```http
HTTP/1.1 401 Unauthorized
Content-Type: application/json

{
    "error": {
        "message": "Invalid authentication credentials",
        "type": "invalid_request_error",
        "code": "invalid_api_key"
    }
}
```

### 4.9.4 æ•°æ®äº¤æ¢åè®®

#### 4.9.4.1 æ§½ä½çŠ¶æ€åŒæ­¥åè®®

**åè®®è¯­ä¹‰**: ç®¡ç†å¤šæ§½ä½ä¿¡æ¯é‡‡é›†çš„çŠ¶æ€åŒæ­¥
**æ•°æ®å•å…ƒ**: è¡¨å•çŠ¶æ€å¿«ç…§

```python
# çŠ¶æ€å¿«ç…§åè®®
{
    "business_line": "apple_store",
    "order_status": "COLLECTING",
    "current_form": {
        "category": {
            "status": "FILLED",
            "value": "æ‰‹æœº", 
            "confidence": 0.95,
            "source": "direct"
        },
        "series": {
            "status": "EMPTY",
            "value": None,
            "confidence": 0.0,
            "source": None
        }
    },
    "pending_conflicts": [],
    "validation_errors": []
}
```

#### 4.9.4.2 å†²çªè§£å†³åè®®

**åè®®è¯­ä¹‰**: å¤„ç†ç”¨æˆ·è¾“å…¥ä¸ç°æœ‰å€¼çš„å†²çª
**äº¤äº’æµç¨‹**:

1. **å†²çªæ£€æµ‹**: ç³»ç»Ÿæ£€æµ‹åˆ°å€¼å†²çª
2. **å†²çªæç¤º**: å‘ç”¨æˆ·å±•ç¤ºå†²çªä¿¡æ¯å’Œè§£å†³é€‰é¡¹
3. **ç”¨æˆ·é€‰æ‹©**: ç”¨æˆ·é€‰æ‹©è§£å†³ç­–ç•¥ï¼ˆ1-ä¿ç•™åŸå€¼ï¼Œ2-ä½¿ç”¨æ–°å€¼ï¼Œ3-é‡æ–°è¯´æ˜ï¼‰
4. **çŠ¶æ€æ›´æ–°**: æ ¹æ®ç”¨æˆ·é€‰æ‹©æ›´æ–°æ§½ä½çŠ¶æ€

```python
# å†²çªè§£å†³åè®®æ•°æ®å•å…ƒ
{
    "conflict_slot": "series",
    "existing_value": {
        "value": "iPhone 14",
        "confidence": 0.9,
        "source": "direct"
    },
    "new_value": {
        "value": "iPhone 15", 
        "confidence": 0.8,
        "source": "llm"
    },
    "resolution_options": [
        {"choice": "1", "action": "keep_original", "description": "ä¿ç•™åŸå€¼ (iPhone 14)"},
        {"choice": "2", "action": "use_new", "description": "ä½¿ç”¨æ–°å€¼ (iPhone 15)"},
        {"choice": "3", "action": "reinput", "description": "é‡æ–°è¯´æ˜"}
    ]
}
```

### 4.9.5 é”™è¯¯å¤„ç†åè®®

#### 4.9.5.1 é”™è¯¯åˆ†ç±»åè®®

```python
# é”™è¯¯ç±»å‹æšä¸¾
class ErrorType(Enum):
    CONFIG_ERROR = "config_error"          # é…ç½®é”™è¯¯
    NETWORK_ERROR = "network_error"        # ç½‘ç»œé”™è¯¯
    LLM_ERROR = "llm_error"               # LLMæœåŠ¡é”™è¯¯
    VALIDATION_ERROR = "validation_error"  # æ•°æ®éªŒè¯é”™è¯¯
    USER_INPUT_ERROR = "user_input_error"  # ç”¨æˆ·è¾“å…¥é”™è¯¯
    SYSTEM_ERROR = "system_error"          # ç³»ç»Ÿå†…éƒ¨é”™è¯¯

# é”™è¯¯å“åº”åè®®
{
    "error_type": "llm_error",
    "error_code": "api_timeout", 
    "error_message": "LLM APIè¯·æ±‚è¶…æ—¶",
    "recovery_suggestion": "ç³»ç»Ÿå·²é™çº§åˆ°æœ¬åœ°è¯­ä¹‰åŒ¹é…",
    "timestamp": "2024-01-15T10:30:00Z"
}
```

#### 4.9.5.2 é™çº§ç­–ç•¥åè®®

**åè®®è¯­ä¹‰**: åœ¨æœåŠ¡ä¸å¯ç”¨æ—¶æä¾›ä¼˜é›…é™çº§

```python
# é™çº§ç­–ç•¥é…ç½®
{
    "llm_service": {
        "primary": "spark_llm",
        "fallback": "local_semantic",
        "conditions": ["timeout", "network_error", "auth_error"]
    },
    "semantic_mapping": {
        "primary": "enhanced_matching", 
        "fallback": "basic_keyword",
        "conditions": ["low_confidence", "no_match"]
    }
}
```

### 4.9.6 åè®®ç‰¹ç‚¹æ€»ç»“

1. **ç±»å‹å®‰å…¨**: æ‰€æœ‰æ¥å£ä½¿ç”¨Pythonç±»å‹æ³¨è§£ï¼Œç¡®ä¿æ•°æ®ç±»å‹æ­£ç¡®æ€§
2. **é”™è¯¯æ¢å¤**: å®Œå–„çš„é”™è¯¯å¤„ç†åè®®ï¼Œæ”¯æŒä¼˜é›…é™çº§å’Œè‡ªåŠ¨æ¢å¤
3. **å¯æ‰©å±•æ€§**: åè®®è®¾è®¡æ”¯æŒæ–°åŠŸèƒ½å’Œä¸šåŠ¡åœºæ™¯çš„æ‰©å±•
4. **å¯è§‚æµ‹æ€§**: åè®®åŒ…å«å®Œæ•´çš„å…ƒæ•°æ®ï¼Œæ”¯æŒç³»ç»Ÿç›‘æ§å’Œè°ƒè¯•
5. **å…¼å®¹æ€§**: å‘åå…¼å®¹çš„åè®®è®¾è®¡ï¼Œæ”¯æŒç³»ç»Ÿå¹³æ»‘å‡çº§

è¿™ç§åˆ†å±‚çš„æ¥å£åè®®è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿå„ç»„ä»¶ä¹‹é—´çš„æ¸…æ™°é€šä¿¡å’Œæ•°æ®ä¸€è‡´æ€§ï¼ŒåŒæ—¶æä¾›äº†è‰¯å¥½çš„é”™è¯¯å¤„ç†å’Œç³»ç»Ÿå¯ç»´æŠ¤æ€§ã€‚

# 5 æµ‹è¯•æŠ¥å‘Š

## 5.1 æµ‹è¯•é©±åŠ¨è®¾è®¡è¯´æ˜

## 5.2 æµ‹è¯•æ¡©è®¾è®¡è¯´æ˜

## 5.3 è‡ªåŠ¨æµ‹è¯•è„šæœ¬è®¾è®¡è¯´æ˜

## 5.4 æµ‹è¯•è¿‡ç¨‹

## 5.5 æµ‹è¯•ç»“æœ

# 6 DSLè„šæœ¬ç¼–å†™æŒ‡å—

## 6.1 DSLæ–‡æ³•å®šä¹‰

### 6.1.1 æ€»ä½“ç»“æ„æ–‡æ³•

```
<DSLè„šæœ¬> ::= "flow:" <æµç¨‹é…ç½®>

<æµç¨‹é…ç½®> ::= 
    "name:" <å­—ç¬¦ä¸²>
    "version:" <å­—ç¬¦ä¸²>?
    "description:" <å­—ç¬¦ä¸²>?
    "business_line:" <å­—ç¬¦ä¸²>
    "process_order:" <æ§½ä½é¡ºåºåˆ—è¡¨>
    "slots:" <æ§½ä½å®šä¹‰å­—å…¸>
    "events:" <äº‹ä»¶å¤„ç†å­—å…¸>?
    "commands:" <å‘½ä»¤æ˜ å°„å­—å…¸>?
    "validations:" <éªŒè¯è§„åˆ™åˆ—è¡¨>?
    "templates:" <è‡ªå®šä¹‰æ¨¡æ¿å­—å…¸>?
```

### 6.1.2 æ§½ä½å®šä¹‰æ–‡æ³•

```
<æ§½ä½å®šä¹‰å­—å…¸> ::= 
    <æ§½ä½åç§°> ":" <æ§½ä½é…ç½®>

<æ§½ä½é…ç½®> ::=
    "label:" <å­—ç¬¦ä¸²>
    "description:" <å­—ç¬¦ä¸²>
    "required:" <å¸ƒå°”å€¼>
    ("type:" ("enum" | "text"))?
    ("enums_key:" <å­—ç¬¦ä¸²>)?
    ("dependencies:" <ä¾èµ–åˆ—è¡¨>)?
    ("semantic_stage:" <å­—ç¬¦ä¸²>)?
    ("allow_llm:" <å¸ƒå°”å€¼>)?
    ("prompt_template:" <å­—ç¬¦ä¸²>)?
    ("help:" <å­—ç¬¦ä¸²>)?
    ("validation:" <éªŒè¯é…ç½®>)?

<ä¾èµ–åˆ—è¡¨> ::= "[" <æ§½ä½åç§°åˆ—è¡¨> "]"
<æ§½ä½åç§°åˆ—è¡¨> ::= <æ§½ä½åç§°> ("," <æ§½ä½åç§°>)*
```

### 6.1.3 äº‹ä»¶å¤„ç†æ–‡æ³•

```
<äº‹ä»¶å¤„ç†å­—å…¸> ::=
    <äº‹ä»¶åç§°> ":" <åŠ¨ä½œåˆ—è¡¨>

<äº‹ä»¶åç§°> ::= 
    "on_start" | "on_all_filled" | "on_confirm" | "on_restart"

<åŠ¨ä½œåˆ—è¡¨> ::= "[" <åŠ¨ä½œå®šä¹‰> ("," <åŠ¨ä½œå®šä¹‰>)* "]"

<åŠ¨ä½œå®šä¹‰> ::=
    "-" "action:" <åŠ¨ä½œåç§°>
    ("template:" <å­—ç¬¦ä¸²>)?
    ("description:" <å­—ç¬¦ä¸²>)?

<åŠ¨ä½œåç§°> ::=
    "reset_form" | "auto_fill_single_options" | "show_template" |
    "show_summary" | "submit_order" | "validate_form" | "ask_continue"
```

### 6.1.4 å‘½ä»¤æ˜ å°„æ–‡æ³•

```
<å‘½ä»¤æ˜ å°„å­—å…¸> ::=
    <å‘½ä»¤åç§°> ":" <å‘½ä»¤é…ç½®>

<å‘½ä»¤é…ç½®> ::=
    "keywords:" <å…³é”®è¯åˆ—è¡¨>
    "action:" <åŠ¨ä½œåç§°>
    ("description:" <å­—ç¬¦ä¸²>)?
    ("condition:" <æ¡ä»¶è¡¨è¾¾å¼>)?
    ("available_when:" <å¯ç”¨æ¡ä»¶>)?
    ("response:" <å¤šè¡Œå­—ç¬¦ä¸²>)?

<å…³é”®è¯åˆ—è¡¨> ::= "[" <å­—ç¬¦ä¸²åˆ—è¡¨> "]"
<å¯ç”¨æ¡ä»¶> ::= "always" | "any_slot_filled" | "all_slots_filled"
```

## 6.2 æ ¸å¿ƒè¯­æ³•å…ƒç´ è¯´æ˜

### 6.2.1 æ•°æ®ç±»å‹å®šä¹‰

#### 6.2.1.1 åŸºæœ¬æ•°æ®ç±»å‹

- **å­—ç¬¦ä¸²**ï¼šåŒå¼•å·åŒ…è£¹çš„æ–‡æœ¬ï¼Œæ”¯æŒUnicodeå­—ç¬¦
- **å¸ƒå°”å€¼**ï¼š`true` æˆ– `false`
- **æ•°å­—**ï¼šæ•´æ•°æˆ–æµ®ç‚¹æ•°
- **åˆ—è¡¨**ï¼šæ–¹æ‹¬å·åŒ…è£¹çš„å…ƒç´ åºåˆ—ï¼Œå…ƒç´ é—´ç”¨é€—å·åˆ†éš”
- **å­—å…¸**ï¼šé”®å€¼å¯¹é›†åˆï¼Œé”®ä¸ºå­—ç¬¦ä¸²ï¼Œå€¼å¯ä¸ºä»»æ„ç±»å‹

#### 6.2.1.2 ç‰¹æ®Šå€¼ç±»å‹

- **æ§½ä½åç§°**ï¼šç”±å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ç»„æˆï¼Œéœ€åœ¨process_orderä¸­å®šä¹‰
- **ä¸šåŠ¡çº¿æ ‡è¯†**ï¼šå¯¹åº”ä¸šåŠ¡é…ç½®ç›®å½•ä¸­çš„JSONæ–‡ä»¶å
- **æšä¸¾é”®å**ï¼šå¯¹åº”ä¸šåŠ¡é…ç½®ä¸­enumså­—å…¸çš„é”®
- **æ¨¡æ¿é”®å**ï¼šå¯¹åº”ä¸šåŠ¡é…ç½®ä¸­templateså­—å…¸çš„é”®

### 6.2.2 æµç¨‹æ§åˆ¶å…ƒç´ 

#### 6.2.2.1 ä¾èµ–å…³ç³»å®šä¹‰

```yaml
dependencies: [brand, category]  # ä¾èµ–å¤šä¸ªå‰ç½®æ§½ä½
dependencies: []                 # æ— ä¾èµ–ï¼Œå¯é¦–å…ˆå¡«å……
```

**è¯­ä¹‰**ï¼šå®šä¹‰æ§½ä½å¡«å……çš„é¡ºåºçº¦æŸï¼Œç¡®ä¿å‰ç½®æ¡ä»¶æ»¡è¶³åæ‰æç¤ºå½“å‰æ§½ä½ã€‚

#### 6.2.2.2 æ¡ä»¶æ‰§è¡Œ

```yaml
condition: all_slots_filled      # æ‰€æœ‰æ§½ä½å¡«å……æ—¶å¯ç”¨
available_when: any_slot_filled  # ä»»æ„æ§½ä½å¡«å……æ—¶å¯ç”¨
```

**è¯­ä¹‰**ï¼šæ§åˆ¶å‘½ä»¤å’ŒåŠ¨ä½œçš„å¯ç”¨æ€§æ¡ä»¶ï¼Œå®ç°ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„äº¤äº’é€»è¾‘ã€‚

### 6.2.3 è¯­ä¹‰å¤„ç†å…ƒç´ 

#### 6.2.3.1 è¯­ä¹‰é˜¶æ®µæ ‡è¯†

```yaml
semantic_stage: chip_selection    # èŠ¯ç‰‡é€‰æ‹©è¯­ä¹‰é˜¶æ®µ
semantic_stage: storage_select    # å­˜å‚¨é€‰æ‹©è¯­ä¹‰é˜¶æ®µ
```

**è¯­ä¹‰**ï¼šæ ‡è¯†æ§½ä½çš„è¯­ä¹‰å¤„ç†é˜¶æ®µï¼Œç”¨äºåŠ¨æ€é€‰é¡¹æ„å»ºå’Œæ™ºèƒ½æ¨èã€‚

#### 6.2.3.2 AIä½¿ç”¨æ§åˆ¶

```yaml
allow_llm: true    # å…è®¸LLMå¡«å……è¯¥æ§½ä½
allow_llm: false   # ç¦æ­¢LLMå¡«å……ï¼Œä»…ä½¿ç”¨æœ¬åœ°åŒ¹é…
```

**è¯­ä¹‰**ï¼šæ§åˆ¶æ˜¯å¦ä½¿ç”¨AIè¿›è¡Œæ§½ä½å¡«å……ï¼Œå¹³è¡¡æ™ºèƒ½æ€§ä¸å¯æ§æ€§ã€‚

## 6.3 å®Œæ•´ç”¨æ³•è¯´æ˜

### 6.3.1 è„šæœ¬æ–‡ä»¶ç»“æ„

#### 6.3.1.1 å¿…éœ€éƒ¨åˆ†

æ¯ä¸ªDSLè„šæœ¬å¿…é¡»åŒ…å«ä»¥ä¸‹æ ¸å¿ƒéƒ¨åˆ†ï¼š

```yaml
flow:
  name: "ä¸šåŠ¡æµç¨‹åç§°"           # å¿…éœ€ï¼šæµç¨‹æ ‡è¯†
  business_line: "ä¸šåŠ¡çº¿åç§°"     # å¿…éœ€ï¼šå…³è”çš„ä¸šåŠ¡é…ç½®
  process_order:                 # å¿…éœ€ï¼šæ§½ä½æ‰§è¡Œé¡ºåº
    - æ§½ä½1
    - æ§½ä½2
  slots:                         # å¿…éœ€ï¼šæ§½ä½å®šä¹‰
    æ§½ä½1:
      label: "æ˜¾ç¤ºæ ‡ç­¾"
      description: "ä¸šåŠ¡æè¿°"
      required: true
```

#### 6.3.1.2 å¯é€‰æ‰©å±•éƒ¨åˆ†

æ ¹æ®ä¸šåŠ¡å¤æ‚åº¦å¯é€‰åŒ…å«ï¼š

```yaml
events:                         # å¯é€‰ï¼šäº‹ä»¶å¤„ç†
  on_start:
    - action: show_template
      template: form_welcome
  
commands:                       # å¯é€‰ï¼šç”¨æˆ·å‘½ä»¤
  help:
    keywords: ["å¸®åŠ©", "help"]
    action: show_help
  
validations:                    # å¯é€‰ï¼šéªŒè¯è§„åˆ™
  - name: "ä¸šåŠ¡è§„åˆ™éªŒè¯"
    rules: [...]
  
templates:                      # å¯é€‰ï¼šè‡ªå®šä¹‰æ¨¡æ¿
  custom_welcome:
    - "è‡ªå®šä¹‰æ¬¢è¿ä¿¡æ¯"
```

### 6.3.2 æ§½ä½å®šä¹‰è¯¦è§£

#### 6.3.2.1 åŸºç¡€æ§½ä½å®šä¹‰

```yaml
category:
  label: "äº§å“å¤§ç±»"
  description: "é€‰æ‹©äº§å“ç±»å‹"
  required: true
  type: enum
  enums_key: category
  dependencies: []
  prompt_template: form_category_prompt
```

**å­—æ®µè¯´æ˜**ï¼š

- `label`ï¼šç”¨æˆ·å¯è§çš„æ˜¾ç¤ºåç§°
- `description`ï¼šä¸šåŠ¡æè¿°ï¼Œç”¨äºæ–‡æ¡£å’Œæç¤º
- `required`ï¼šæ˜¯å¦å¿…é¡»å¡«å……
- `type`ï¼šæ•°æ®ç±»å‹ï¼Œenumæˆ–text
- `enums_key`ï¼šæšä¸¾é…ç½®é”®ï¼Œå¯¹åº”ä¸šåŠ¡JSONä¸­çš„enums
- `dependencies`ï¼šä¾èµ–çš„å‰ç½®æ§½ä½
- `prompt_template`ï¼šä½¿ç”¨çš„æç¤ºæ¨¡æ¿

#### 6.3.2.2 é«˜çº§æ§½ä½ç‰¹æ€§

```yaml
chip:
  label: "å¤„ç†å™¨èŠ¯ç‰‡"
  description: "é€‰æ‹©å¤„ç†å™¨å‹å·"
  required: true
  allow_llm: true
  type: enum
  enums_key: chip
  dependencies: [category, series, size]
  semantic_stage: chip_selection
  validation:
    must_be_valid_enum: true
    min_confidence: 0.35
  help: "æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„èŠ¯ç‰‡å‹å·"
```

**é«˜çº§ç‰¹æ€§**ï¼š

- `allow_llm`ï¼šå¯ç”¨AIæ™ºèƒ½å¡«å……
- `semantic_stage`ï¼šå¯ç”¨è¯­ä¹‰æ˜ å°„
- `validation`ï¼šå€¼éªŒè¯è§„åˆ™
- `help`ï¼šç”¨æˆ·å¸®åŠ©ä¿¡æ¯

### 6.3.3 äº‹ä»¶å¤„ç†æœºåˆ¶

#### 6.3.3.1 ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

```yaml
events:
  on_start:                    # æµç¨‹å¼€å§‹æ—¶è§¦å‘
    - action: reset_form
    - action: show_template
      template: form_welcome
  
  on_all_filled:               # æ‰€æœ‰å¿…å¡«æ§½ä½å¡«å……æ—¶è§¦å‘
    - action: show_summary
    - action: ask_confirm
  
  on_confirm:                  # ç”¨æˆ·ç¡®è®¤æ—¶è§¦å‘
    - action: validate_form
    - action: submit_order
    - action: show_template
      template: form_order_confirmed
  
  on_restart:                  # é‡æ–°å¼€å§‹æ—¶è§¦å‘
    - action: reset_form
    - action: show_welcome
```

**äº‹ä»¶è¯´æ˜**ï¼š

- `on_start`ï¼šåˆå§‹åŒ–æµç¨‹ï¼Œæ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
- `on_all_filled`ï¼šè¡¨å•å®Œæˆæ—¶æ˜¾ç¤ºæ‘˜è¦å’Œç¡®è®¤é€‰é¡¹
- `on_confirm`ï¼šè®¢å•ç¡®è®¤æ—¶æ‰§è¡ŒéªŒè¯å’Œæäº¤
- `on_restart`ï¼šé‡ç½®æµç¨‹çŠ¶æ€ï¼Œé‡æ–°å¼€å§‹

#### 6.3.3.2 åŠ¨ä½œç±»å‹

```yaml
- action: reset_form                    # é‡ç½®è¡¨å•çŠ¶æ€
- action: auto_fill_single_options      # è‡ªåŠ¨å¡«å……å•é€‰é¡¹
- action: show_template                 # æ˜¾ç¤ºæ¨¡æ¿å†…å®¹
- action: show_summary                  # æ˜¾ç¤ºè®¢å•æ‘˜è¦
- action: submit_order                  # æäº¤è®¢å•
- action: validate_form                 # éªŒè¯è¡¨å•æ•°æ®
- action: ask_continue                  # è¯¢é—®æ˜¯å¦ç»§ç»­
```

### 6.3.4 å‘½ä»¤æ˜ å°„é…ç½®

#### 6.3.4.1 åŸºç¡€å‘½ä»¤å®šä¹‰

```yaml
commands:
  restart:                        # å‘½ä»¤æ ‡è¯†
    keywords:                     # è§¦å‘å…³é”®è¯
      - "é‡æ–°å¼€å§‹"
      - "é‡ç½®"
      - "reset"
    action: restart_flow          # æ‰§è¡ŒåŠ¨ä½œ
    description: "æ¸…ç©ºæ‰€æœ‰é€‰æ‹©é‡æ–°å¼€å§‹"
  
  confirm:
    keywords: ["ç¡®è®¤", "å¥½çš„", "ok", "yes"]
    action: confirm_order
    condition: all_slots_filled   # æ‰§è¡Œæ¡ä»¶
    description: "ç¡®è®¤å½“å‰è®¢å•"
```

#### 6.3.4.2 é«˜çº§å‘½ä»¤ç‰¹æ€§

```yaml
help:
  keywords: ["å¸®åŠ©", "help", "?"]
  action: show_help
  available_when: always          # å¯ç”¨æ¡ä»¶
  response: |                     # ç›´æ¥å“åº”å†…å®¹
    ä½¿ç”¨å¸®åŠ©ï¼š
  
    â€¢ æŒ‰ç…§æç¤ºé€‰æ‹©äº§å“é…ç½®
    â€¢ å¯ä»¥ç›´æ¥è¯´åç§°æˆ–è¾“å…¥æ•°å­—
    â€¢ è¯´"é‡é€‰"ä¿®æ”¹ä¹‹å‰çš„é€‰æ‹©
    â€¢ è¯´"å¸®åŠ©"æŸ¥çœ‹æœ¬è¯´æ˜
  
  description: "æ˜¾ç¤ºä½¿ç”¨å¸®åŠ©ä¿¡æ¯"
```

## 6.4 è„šæœ¬èŒƒä¾‹

### 6.4.1 è‹¹æœä¸“å–åº—è´­ç‰©æµç¨‹

```yaml
# apple_store.flow.yaml
flow:
  name: apple_shopping
  version: "1.0"
  description: "è‹¹æœäº§å“æ™ºèƒ½è´­ç‰©æµç¨‹"
  business_line: apple_store
  
  process_order:
    - category
    - brand
    - series
    - size
    - chip
    - storage
    - color

  slots:
    category:
      label: "äº§å“å¤§ç±»"
      description: "é€‰æ‹©äº§å“ç±»å‹"
      required: true
      allow_llm: false
      type: enum
      enums_key: category
      dependencies: []
      prompt_template: form_category_prompt
      help: "æˆ‘ä»¬æœ‰Macç”µè„‘ã€iPhoneæ‰‹æœºå’ŒiPadå¹³æ¿ä¸‰å¤§ç±»äº§å“"
  
    brand:
      label: "å“ç‰Œé€‰æ‹©"
      description: "å“ç‰Œé€‰æ‹©"
      required: true
      allow_llm: false
      type: enum
      enums_key: brand
      dependencies: [category]
      prompt_template: form_brand_prompt
      auto_fill: true
  
    series:
      label: "äº§å“ç³»åˆ—"
      description: "é€‰æ‹©å…·ä½“äº§å“ç³»åˆ—"
      required: true
      allow_llm: false
      type: enum
      enums_key: series
      semantic_stage: series_selection
      dependencies: [brand]
      prompt_template: form_series_prompt
      conditional_prompts:
        - condition: "category == 'ç”µè„‘'"
          template: form_series_prompt_computer
        - condition: "category == 'æ‰‹æœº'"
          template: form_series_prompt_phone
      help: "æ ¹æ®æ‚¨é€‰æ‹©çš„ç±»åˆ«ï¼Œä¸ºæ‚¨æ¨èåˆé€‚çš„ç³»åˆ—"
  
    chip:
      label: "å¤„ç†å™¨èŠ¯ç‰‡"
      description: "é€‰æ‹©å¤„ç†å™¨å‹å·"
      required: true
      allow_llm: true
      type: enum
      enums_key: chip
      semantic_stage: chip_selection
      dependencies: [category, series, size]
      prompt_template: form_chip_prompt
      validation:
        must_be_valid_enum: true
        min_confidence: 0.35

  events:
    on_start:
      - action: reset_form
        description: "é‡ç½®è¡¨å•çŠ¶æ€"
      - action: auto_fill_single_options
        description: "è‡ªåŠ¨å¡«å……å•é€‰é¡¹"
      - action: show_template
        template: form_welcome
        description: "æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯"
  
    on_all_filled:
      - action: show_summary
        description: "æ˜¾ç¤ºè®¢å•æ‘˜è¦"
      - action: show_template
        template: form_confirmation_options
        description: "æ˜¾ç¤ºç¡®è®¤é€‰é¡¹"

  commands:
    restart:
      keywords: ["é‡æ–°å¼€å§‹", "é‡ç½®", "reset"]
      action: restart_flow
      available_when: always
  
    confirm:
      keywords: ["ç¡®è®¤", "ä¸‹å•", "ok", "yes"]
      action: confirm_order
      condition: all_slots_filled
  
    help:
      keywords: ["å¸®åŠ©", "help", "?"]
      action: show_help
      response: |
        ğŸ“– ä½¿ç”¨å¸®åŠ©ï¼š
  
        â€¢ æŒ‰ç…§æç¤ºé€‰æ‹©äº§å“é…ç½®
        â€¢ å¯ä»¥ç›´æ¥è¯´åç§°ï¼Œä¹Ÿå¯ä»¥è¾“å…¥æ•°å­—
        â€¢ éšæ—¶è¯´"é‡é€‰"å¯ä»¥ä¿®æ”¹ä¹‹å‰çš„é€‰æ‹©
        â€¢ è¯´"é‡æ–°å¼€å§‹"å¯ä»¥æ¸…ç©ºé‡æ¥
        â€¢ è¯´"æŸ¥çœ‹"å¯ä»¥çœ‹å½“å‰è®¢å•
        â€¢ è¯´"å¸®åŠ©"æŸ¥çœ‹æœ¬è¯´æ˜
```

### 6.4.2 é¤é¥®é¢„è®¢æµç¨‹

```yaml
# dining.flow.yaml
flow:
  name: dining_reservation
  version: "1.0"
  description: "é¤å…é¢„è®¢æ™ºèƒ½è¡¨å•æµç¨‹"
  business_line: dining
  
  process_order:
    - category
    - brand
    - series
    - party_size
    - date
    - contact

  slots:
    category:
      label: "é¢„è®¢ç±»å‹"
      description: "é¢„è®¢ç±»å‹"
      required: true
      allow_llm: false
      type: enum
      enums_key: dining_category
      dependencies: []
      prompt_template: form_category_prompt
      auto_fill: true
  
    brand:
      label: "é¤å…é€‰æ‹©"
      description: "é€‰æ‹©é¤å…"
      required: true
      allow_llm: false
      type: enum
      enums_key: dining_brand
      dependencies: [category]
      prompt_template: form_brand_prompt
      semantic_stage: brand
  
    series:
      label: "ç”¨é¤æ—¶æ®µ"
      description: "é€‰æ‹©ç”¨é¤æ—¶æ®µ"
      required: true
      allow_llm: false
      type: enum
      enums_key: dining_series
      dependencies: [brand]
      prompt_template: form_series_prompt
      semantic_stage: series

    party_size:
      label: "ç”¨é¤äººæ•°"
      description: "ç”¨é¤äººæ•°"
      required: true
      allow_llm: false
      type: enum
      enums_key: party_size
      dependencies: [series]
      prompt_template: form_party_size_prompt
      semantic_stage: party_size

    date:
      label: "é¢„è®¢æ—¥æœŸ"
      description: "é¢„è®¢æ—¥æœŸ"
      required: true
      allow_llm: true
      type: enum
      enums_key: date
      dependencies: [party_size]
      prompt_template: form_date_prompt
      validation:
        must_be_valid_enum: true
        min_confidence: 0.35
  
    contact:
      label: "è”ç³»æ–¹å¼"
      description: "è”ç³»æ–¹å¼"
      required: true
      allow_llm: true
      type: text
      dependencies: [date]
      prompt_template: form_contact_prompt

  events:
    on_start:
      - action: reset_form
      - action: show_template
        template: form_welcome
  
    on_all_filled:
      - action: show_summary
      - action: ask_confirm
  
    on_confirm:
      - action: validate_form
      - action: submit_order
      - action: show_template
        template: form_order_confirmed
      - action: show_template
        template: form_order_thanks
      - action: ask_continue

  commands:
    restart:
      keywords: ["é‡æ–°é¢„è®¢", "é‡æ¥", "reset"]
      action: restart_flow
  
    confirm:
      keywords: ["ç¡®è®¤", "å¥½çš„", "æ˜¯çš„", "æ²¡é—®é¢˜"]
      condition: all_slots_filled
      action: confirm_order
  
    modify:
      keywords: ["ä¿®æ”¹", "æ”¹ä¸€ä¸‹", "é‡é€‰"]
      action: enter_reselect_mode
  
    help:
      keywords: ["å¸®åŠ©", "help"]
      action: show_help
      response: |
        ğŸ“– é¢„è®¢å¸®åŠ©ï¼š
  
        â€¢ æŒ‰ç…§æç¤ºæä¾›é¢„è®¢ä¿¡æ¯
        â€¢ å¯ä»¥è¯´"ä¿®æ”¹"é‡æ–°é€‰æ‹©æŸé¡¹
        â€¢ è¯´"é‡æ–°é¢„è®¢"å¯ä»¥æ¸…ç©ºé‡æ¥
        â€¢ è¯´"å¸®åŠ©"æŸ¥çœ‹æœ¬è¯´æ˜
```

### 6.4.3 ç®€å•é—®ç­”æµç¨‹èŒƒä¾‹

```yaml
# simple_qa.flow.yaml
flow:
  name: simple_qa
  version: "1.0"
  description: "ç®€å•é—®ç­”æ”¶é›†æµç¨‹"
  business_line: apple_store  # å¤ç”¨ç°æœ‰ä¸šåŠ¡é…ç½®
  
  process_order:
    - user_name
    - question_type
    - question_detail
    - contact_info

  slots:
    user_name:
      label: "æ‚¨çš„å§“å"
      description: "ç”¨æˆ·å§“å"
      required: true
      allow_llm: true
      type: text
      dependencies: []
      prompt_template: form_name_prompt
  
    question_type:
      label: "é—®é¢˜ç±»å‹"
      description: "é€‰æ‹©é—®é¢˜ç±»å‹"
      required: true
      allow_llm: true
      type: enum
      enums_key: question_type
      dependencies: [user_name]
      prompt_template: form_question_type_prompt
  
    question_detail:
      label: "é—®é¢˜æè¿°"
      description: "è¯¦ç»†é—®é¢˜æè¿°"
      required: true
      allow_llm: true
      type: text
      dependencies: [question_type]
      prompt_template: form_question_detail_prompt
  
    contact_info:
      label: "è”ç³»æ–¹å¼"
      description: "å›å¤è”ç³»æ–¹å¼"
      required: false
      allow_llm: true
      type: text
      dependencies: [question_detail]
      prompt_template: form_contact_prompt

  events:
    on_start:
      - action: show_template
        template: qa_welcome
  
    on_all_filled:
      - action: show_summary
      - action: show_template
        template: qa_thanks

  commands:
    skip:
      keywords: ["è·³è¿‡", "ä¸æƒ³å¡«", "skip"]
      action: skip_current_slot
  
    back:
      keywords: ["ä¸Šä¸€æ­¥", "è¿”å›", "back"]
      action: go_previous_slot
```

## 6.5 å®è·µæŒ‡å—

### 6.5.1 æ§½ä½è®¾è®¡åŸåˆ™

#### 6.5.1.1 åˆç†çš„ä¾èµ–å…³ç³»

```yaml
# æ¨èï¼šæ¸…æ™°çš„ä¾èµ–é“¾
slots:
  category:
    dependencies: []           # æ— ä¾èµ–ï¼Œé¦–å…ˆå¡«å……
  
  brand:
    dependencies: [category]   # ä¾èµ–ç±»åˆ«
  
  series:
    dependencies: [brand]      # ä¾èµ–å“ç‰Œ
  
  size:
    dependencies: [series]     # ä¾èµ–ç³»åˆ—
```

**åŸåˆ™**ï¼šå»ºç«‹æ¸…æ™°çš„ä¾èµ–é“¾æ¡ï¼Œé¿å…å¾ªç¯ä¾èµ–ã€‚ç¡®ä¿ç”¨æˆ·æŒ‰é€»è¾‘é¡ºåºæä¾›ä¿¡æ¯ã€‚

#### 6.5.1.2 æ™ºèƒ½å¡«å……ç­–ç•¥

```yaml
# æ··åˆä½¿ç”¨ä¸åŒå¡«å……ç­–ç•¥
slots:
  category:
    allow_llm: false           # å…³é”®é€‰æ‹©ï¼Œç¦ç”¨AI
  
  color:
    allow_llm: true            # ä¸»è§‚é€‰æ‹©ï¼Œå¯ç”¨AI
  
  contact:
    allow_llm: true            # è‡ªç”±æ–‡æœ¬ï¼Œå¯ç”¨AI
```

**åŸåˆ™**ï¼šå…³é”®ä¸šåŠ¡é€‰æ‹©ä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼Œä¸»è§‚å’Œè‡ªç”±æ–‡æœ¬ä½¿ç”¨AIå¢å¼ºã€‚

### 6.5.2 äº‹ä»¶å¤„ç†è®¾è®¡

#### 6.5.2.1 æ¸è¿›å¼åé¦ˆ

```yaml
events:
  on_start:
    - action: show_template    # æ¬¢è¿ä¿¡æ¯
      template: form_welcome
  
  on_all_filled:
    - action: show_summary     # å®Œæˆåé¦ˆ
    - action: ask_confirm      # ç¡®è®¤æç¤º
  
  on_confirm:
    - action: show_template    # æˆåŠŸåé¦ˆ
      template: form_success
```

**åŸåˆ™**ï¼šåœ¨æ¯ä¸ªå…³é”®èŠ‚ç‚¹æä¾›é€‚å½“çš„ç”¨æˆ·åé¦ˆï¼Œå¢å¼ºäº¤äº’ä½“éªŒã€‚

### 6.5.3 å‘½ä»¤è®¾è®¡å»ºè®®

#### 6.5.3.1 è¦†ç›–ä¸»è¦ç”¨æˆ·æ„å›¾

```yaml
commands:
  # æµç¨‹æ§åˆ¶
  restart: [...]               # é‡æ–°å¼€å§‹
  confirm: [...]               # ç¡®è®¤æ“ä½œ
  
  # å¯¼èˆªæ§åˆ¶  
  back: [...]                  # è¿”å›ä¸Šä¸€æ­¥
  skip: [...]                  # è·³è¿‡å½“å‰
  
  # ä¿¡æ¯æŸ¥è¯¢
  help: [...]                  # å¸®åŠ©ä¿¡æ¯
  status: [...]                # å½“å‰çŠ¶æ€
```

**åŸåˆ™**ï¼šè¦†ç›–ç”¨æˆ·å¯èƒ½çš„ä¸»è¦æ“ä½œæ„å›¾ï¼Œæä¾›æµç•…çš„æµç¨‹æ§åˆ¶ã€‚

### 6.5.4 è°ƒè¯•ä¸éªŒè¯æŠ€å·§

#### 6.5.4.1 DSLè¯­æ³•éªŒè¯

```bash
# éªŒè¯DSLè¯­æ³•æ­£ç¡®æ€§
python -c "
from src.dsl.yaml_flow_loader import YAMLFlowLoader
try:
    config = YAMLFlowLoader.load('scripts/your_flow.flow.yaml')
    print('âœ… DSLè¯­æ³•éªŒè¯é€šè¿‡')
except Exception as e:
    print(f'âŒ DSLè¯­æ³•é”™è¯¯: {e}')
"
```

#### 6.5.4.2 ä¾èµ–å…³ç³»æ£€æŸ¥

```yaml
# æ£€æŸ¥å¾ªç¯ä¾èµ–
process_order:
  - category    # âœ… æ­£ç¡®ï¼šæ— ä¾èµ–
  - brand       # âœ… æ­£ç¡®ï¼šä¾èµ–category
  - series      # âœ… æ­£ç¡®ï¼šä¾èµ–brand
  - category    # âŒ é”™è¯¯ï¼šå¾ªç¯ä¾èµ–
```

#### 6.5.4.3 ä¸šåŠ¡é…ç½®ä¸€è‡´æ€§éªŒè¯

```yaml
# ç¡®ä¿æšä¸¾é”®å­˜åœ¨
slots:
  category:
    enums_key: category  # âœ… å¿…é¡»åœ¨ä¸šåŠ¡JSONçš„enumsä¸­å®šä¹‰
  
  invalid_slot:
    enums_key: nonexistent  # âŒ é”™è¯¯ï¼šæšä¸¾é”®ä¸å­˜åœ¨
```

## 6.6 é«˜çº§ç‰¹æ€§

### 6.6.1 æ¡ä»¶åŒ–æ¨¡æ¿

```yaml
slots:
  series:
    conditional_prompts:
      - condition: "category == 'ç”µè„‘'"
        template: form_series_prompt_computer
      - condition: "category == 'æ‰‹æœº'"
        template: form_series_prompt_phone
      - condition: "true"  # é»˜è®¤æƒ…å†µ
        template: form_series_prompt_default
```

### 6.6.2 åŠ¨æ€éªŒè¯è§„åˆ™

```yaml
slots:
  storage:
    validation:
      must_be_valid_enum: true
      min_confidence: 0.4
      business_rules:
        - condition: "category == 'ç”µè„‘'"
          allowed_values: ["512GB", "1TB", "2TB"]
        - condition: "category == 'æ‰‹æœº'"
          allowed_values: ["128GB", "256GB", "512GB", "1TB"]
```

### 6.6.3 è¯­ä¹‰é˜¶æ®µé…ç½®

```yaml
semantic_stages:
  chip_selection:
    description: "åŸºäºäº§å“ç³»åˆ—çš„èŠ¯ç‰‡é€‰æ‹©"
    options_source: "chip"
    filters:
      - type: "series_based"
        source_slot: "series"
        mapping_field: "chip_by_series"
    matching_strategy: "technical_keywords"
    confidence_threshold: 0.35
```

### 6.6.4 è‡ªå®šä¹‰åŠ¨ä½œ

```yaml
events:
  on_custom_event:
    - action: custom_validation
      parameters:
        rule: "business_specific_rule"
        severity: "warning"
    - action: external_api_call
      endpoint: "https://api.example.com/validate"
      timeout: 30
```

é€šè¿‡éµå¾ªæœ¬æŒ‡å—ï¼Œæ‚¨å¯ä»¥å¿«é€ŸæŒæ¡DSLè„šæœ¬çš„ç¼–å†™æ–¹æ³•ï¼Œæ„å»ºå‡ºåŠŸèƒ½ä¸°å¯Œã€ç”¨æˆ·ä½“éªŒè‰¯å¥½çš„æ™ºèƒ½å¯¹è¯æµç¨‹ã€‚DSLçš„è®¾è®¡å……åˆ†è€ƒè™‘äº†ä¸šåŠ¡äººå‘˜çš„æ˜“ç”¨æ€§å’Œå¼€å‘äººå‘˜çš„çµæ´»æ€§ï¼Œæ˜¯è¿æ¥ä¸šåŠ¡éœ€æ±‚ä¸æŠ€æœ¯å®ç°çš„é‡è¦æ¡¥æ¢ã€‚

# 7 AIè¾…åŠ©ç¼–ç¨‹è¿‡ç¨‹è¯´æ˜

## 7.1 æœ¬ä½œä¸šä½¿ç”¨çš„AIè¾…åŠ©ç¼–ç¨‹å·¥å…·è¯´æ˜

åœ¨æœ¬é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¸»è¦ä½¿ç”¨äº†ä¸¤ç§AIè¾…åŠ©ç¼–ç¨‹å·¥å…·ï¼š

### 7.1.1 DeepSeek AIåŠ©æ‰‹

- **ä½¿ç”¨å¹³å°**ï¼šDeepSeek Webç•Œé¢åŠAPI
- **ä¸»è¦ç”¨é€”**ï¼šä»£ç ç”Ÿæˆã€æ¶æ„è®¾è®¡å’¨è¯¢ã€ç®—æ³•ä¼˜åŒ–å»ºè®®
- **ä½¿ç”¨é¢‘ç‡**ï¼šåœ¨å¤æ‚æ¨¡å—å¼€å‘å’Œæ¶æ„è®¾è®¡é˜¶æ®µå¯†é›†ä½¿ç”¨

### 7.1.2 GitHub Copilot

- **é›†æˆç¯å¢ƒ**ï¼šVS Codeç¼–è¾‘å™¨
- **ä¸»è¦ç”¨é€”**ï¼šä»£ç è‡ªåŠ¨è¡¥å…¨ã€å‡½æ•°ç­¾åç”Ÿæˆã€ä»£ç ç‰‡æ®µå»ºè®®
- **ä½¿ç”¨æ¨¡å¼**ï¼šä½œä¸ºå®æ—¶ç¼–ç åŠ©æ‰‹ï¼Œæä¾›å³æ—¶å»ºè®®

### 7.1.3 AIå·¥å…·ä½¿ç”¨åŸåˆ™

åœ¨æ•´ä¸ªå¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘å§‹ç»ˆåšæŒä»¥ä¸‹åŸåˆ™ï¼š

1. **ä¸»å¯¼æƒæ˜ç¡®**ï¼šAIä½œä¸ºè¾…åŠ©å·¥å…·ï¼Œæ‰€æœ‰æŠ€æœ¯å†³ç­–å’Œæ¶æ„è®¾è®¡ç”±æˆ‘ä¸»å¯¼
2. **ä»£ç å®¡æŸ¥**ï¼šå¯¹AIç”Ÿæˆçš„ä»£ç è¿›è¡Œä¸¥æ ¼å®¡æŸ¥å’Œæµ‹è¯•
3. **ç†è§£ä¼˜å…ˆ**ï¼šç¡®ä¿å®Œå…¨ç†è§£AIå»ºè®®çš„ä»£ç é€»è¾‘å’ŒåŸç†
4. **è¿­ä»£ä¼˜åŒ–**ï¼šåŸºäºAIå»ºè®®è¿›è¡ŒäºŒæ¬¡å¼€å‘å’Œä¼˜åŒ–

## 7.2 ä½¿ç”¨AIè¾…åŠ©ç¼–ç¨‹çš„è¿‡ç¨‹

### 7.2.1 ç³»ç»Ÿæ¶æ„è®¾è®¡é˜¶æ®µ

#### åœºæ™¯ä¸€ï¼šåˆ†å±‚æ¶æ„è®¾è®¡å’¨è¯¢

**æˆ‘çš„éœ€æ±‚**ï¼š

```
æˆ‘éœ€è¦è®¾è®¡ä¸€ä¸ªæ™ºèƒ½å®¢æœæœºå™¨äººçš„ç³»ç»Ÿæ¶æ„ï¼Œè¦æ±‚ï¼š
1. æ”¯æŒDSLé©±åŠ¨çš„ä¸šåŠ¡æµç¨‹å®šä¹‰
2. é›†æˆå¤§è¯­è¨€æ¨¡å‹è¿›è¡Œè¯­ä¹‰ç†è§£
3. å®ç°å¤šè½®å¯¹è¯çŠ¶æ€ç®¡ç†
4. æ”¯æŒå¤šç§ä¸šåŠ¡åœºæ™¯çš„å¿«é€Ÿé€‚é…

è¯·å¸®æˆ‘è®¾è®¡ä¸€ä¸ªæ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œå¹¶è¯´æ˜å„å±‚çš„èŒè´£åˆ’åˆ†ã€‚
```

**AIå›å¤è¦ç‚¹**ï¼š

```
å»ºè®®é‡‡ç”¨ä»¥ä¸‹åˆ†å±‚æ¶æ„ï¼š

1. å…¥å£å±‚ï¼šè´Ÿè´£ç³»ç»Ÿå¯åŠ¨å’Œç”¨æˆ·äº¤äº’
2. DSLå¼•æ“å±‚ï¼šè§£æå’Œæ‰§è¡Œä¸šåŠ¡æµç¨‹å®šä¹‰
3. å¯¹è¯æ ¸å¿ƒå±‚ï¼šç®¡ç†å¯¹è¯çŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘
4. AIæœåŠ¡å±‚ï¼šé›†æˆLLMå’Œè¯­ä¹‰ç†è§£æœåŠ¡
5. çŸ¥è¯†åº“å±‚ï¼šç®¡ç†ä¸šåŠ¡é…ç½®å’Œæ¨¡æ¿
6. æµç¨‹å®šä¹‰å±‚ï¼šå£°æ˜å¼ä¸šåŠ¡æµç¨‹æè¿°

å„å±‚èŒè´£æ¸…æ™°ï¼Œæ”¯æŒæ¨¡å—åŒ–å¼€å‘å’Œæµ‹è¯•ã€‚
```

**æˆ‘çš„æ”¹è¿›å’Œå®ç°**ï¼š

- åœ¨AIå»ºè®®çš„åŸºç¡€ä¸Šï¼Œæˆ‘å¢åŠ äº†**è¯­ä¹‰ç†è§£å±‚**ä½œä¸ºAIæœåŠ¡å±‚çš„è¡¥å……
- è®¾è®¡äº†**é…ç½®æ³¨å…¥æœºåˆ¶**å®ç°DSLä¸é™æ€é…ç½®çš„èåˆ
- å¼•å…¥äº†**ä¸‰å±‚ä¿¡æ¯æŠ½å–ç­–ç•¥**å¹³è¡¡æ€§èƒ½ä¸å‡†ç¡®æ€§
- å»ºç«‹äº†**å†²çªè§£å†³æœºåˆ¶**å¤„ç†ç”¨æˆ·è¾“å…¥å†²çª

æœ€ç»ˆå½¢æˆçš„æ¶æ„æ¯”AIåˆå§‹å»ºè®®æ›´åŠ å®Œå–„å’Œå¥å£®ã€‚

#### åœºæ™¯äºŒï¼šDSLè¯­è¨€è®¾è®¡

**æˆ‘çš„éœ€æ±‚**ï¼š

```
æˆ‘éœ€è¦è®¾è®¡ä¸€ä¸ªç”¨äºå®¢æœæœºå™¨äººçš„DSLï¼Œè¦æ±‚ï¼š
- æ”¯æŒæ§½ä½å®šä¹‰å’Œä¾èµ–å…³ç³»
- æ”¯æŒäº‹ä»¶é©±åŠ¨çš„å·¥ä½œæµ
- æ”¯æŒç”¨æˆ·å‘½ä»¤æ˜ å°„
- è¯­æ³•ç®€æ´ï¼Œæ˜“äºä¸šåŠ¡äººå‘˜ç†è§£

è¯·æä¾›DSLçš„è¯­æ³•è®¾è®¡å’Œå®ç°æ€è·¯ã€‚
```

**AIå›å¤è¦ç‚¹**ï¼š

```
å»ºè®®ä½¿ç”¨YAMLæ ¼å¼çš„DSLï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒå…ƒç´ ï¼š

flow:
  name: string
  process_order: list
  slots: dict
  events: dict
  commands: dict

æ§½ä½å®šä¹‰åŒ…å«labelã€descriptionã€dependenciesç­‰å­—æ®µã€‚
äº‹ä»¶æ”¯æŒon_startã€on_all_filledç­‰ç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹ã€‚
```

**æˆ‘çš„æ”¹è¿›å’Œå®ç°**ï¼š

- æ‰©å±•äº†æ§½ä½å®šä¹‰çš„**è¯­ä¹‰é˜¶æ®µ**å’Œ**éªŒè¯è§„åˆ™**
- è®¾è®¡äº†**åŠ¨æ€é…ç½®æ³¨å…¥**æœºåˆ¶è¿æ¥DSLä¸ä¸šåŠ¡é…ç½®
- å®ç°äº†**æ¡ä»¶åŒ–æ¨¡æ¿**æ”¯æŒåŸºäºä¸Šä¸‹æ–‡çš„åŠ¨æ€æç¤º
- å¢åŠ äº†**ä¸šåŠ¡è§„åˆ™å¼•æ“**æ”¯æŒå¤æ‚çš„éªŒè¯é€»è¾‘

### 7.2.2 æ ¸å¿ƒç®—æ³•å®ç°é˜¶æ®µ

#### åœºæ™¯ä¸‰ï¼šå¤šæ§½ä½ä¿¡æ¯æŠ½å–ç®—æ³•

**æˆ‘çš„éœ€æ±‚**ï¼š

```
æˆ‘éœ€è¦å®ç°ä¸€ä¸ªå¤šæ§½ä½ä¿¡æ¯æŠ½å–ç®—æ³•ï¼Œè¦æ±‚ï¼š
1. æ”¯æŒä»ç”¨æˆ·å•æ¬¡è¾“å…¥ä¸­æå–å¤šä¸ªæ§½ä½ä¿¡æ¯
2. ç»“åˆè§„åˆ™åŒ¹é…å’ŒAIç†è§£
3. å¤„ç†æ§½ä½é—´çš„ä¾èµ–å…³ç³»
4. æä¾›ç½®ä¿¡åº¦è¯„ä¼°

è¯·ç»™å‡ºç®—æ³•è®¾è®¡å’Œå®ç°æ€è·¯ã€‚
```

**AIå›å¤è¦ç‚¹**ï¼š

```
å»ºè®®é‡‡ç”¨åˆ†å±‚æŠ½å–ç­–ç•¥ï¼š

1. ç›´æ¥å…³é”®è¯åŒ¹é…ï¼šåŸºäºé…ç½®åˆ«åçš„ç²¾ç¡®åŒ¹é…
2. è¯­ä¹‰æ˜ å°„ï¼šåŸºäºä¸Šä¸‹æ–‡çš„æ™ºèƒ½æ¨è
3. LLMæŠ½å–ï¼šä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œå¤æ‚ç†è§£

æ¯å±‚äº§ç”Ÿçš„ç»“æœå¸¦æœ‰ç½®ä¿¡åº¦ï¼ŒæŒ‰ä¼˜å…ˆçº§åˆå¹¶ã€‚
```

**æˆ‘çš„æ”¹è¿›å’Œå®ç°**ï¼š

- è®¾è®¡äº†**ä¸‰å±‚æ¸è¿›å¼æŠ½å–ç­–ç•¥**ï¼š
  - Layer 1: ç›´æ¥å…³é”®è¯åŒ¹é…ï¼ˆé«˜ç½®ä¿¡åº¦ï¼‰
  - Layer 2: è¯­ä¹‰æ˜ å°„æ¨èï¼ˆä¸­ç­‰ç½®ä¿¡åº¦ï¼‰
  - Layer 3: LLMå…¨å±€æŠ½å–ï¼ˆå…œåº•ç­–ç•¥ï¼‰
- å®ç°äº†**ç½®ä¿¡åº¦èåˆç®—æ³•**å¤„ç†å¤šæ¥æºç»“æœ
- å¢åŠ äº†**å†²çªæ£€æµ‹å’Œè§£å†³æœºåˆ¶**
- ä¼˜åŒ–äº†**æ€§èƒ½å¹³è¡¡**ï¼Œå‡å°‘ä¸å¿…è¦çš„LLMè°ƒç”¨

#### åœºæ™¯å››ï¼šå¯¹è¯çŠ¶æ€ç®¡ç†

**æˆ‘çš„éœ€æ±‚**ï¼š

```
æˆ‘éœ€è¦è®¾è®¡ä¸€ä¸ªå¯¹è¯çŠ¶æ€ç®¡ç†ç³»ç»Ÿï¼Œè¦æ±‚ï¼š
1. ç®¡ç†å¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡
2. å¤„ç†æ§½ä½å¡«å……çŠ¶æ€
3. æ”¯æŒå†²çªæ£€æµ‹å’Œè§£å†³
4. ç»´æŠ¤ä¸šåŠ¡è§„åˆ™ä¸€è‡´æ€§

è¯·æä¾›çŠ¶æ€æœºè®¾è®¡å’Œæ•°æ®æ¨¡å‹ã€‚
```

**AIå›å¤è¦ç‚¹**ï¼š

```
å»ºè®®ä½¿ç”¨æœ‰é™çŠ¶æ€æœºç®¡ç†å¯¹è¯çŠ¶æ€ï¼š

çŠ¶æ€åŒ…æ‹¬ï¼šCOLLECTING, READY_CONFIRM, CONFIRMEDç­‰
æ§½ä½çŠ¶æ€åŒ…æ‹¬ï¼šEMPTY, FILLED, CONFLICTEDç­‰

ä½¿ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡ç»´æŠ¤å½“å‰å¯¹è¯çŠ¶æ€ã€‚
```

**æˆ‘çš„æ”¹è¿›å’Œå®ç°**ï¼š

- è®¾è®¡äº†**åŒå±‚çŠ¶æ€æœº**ï¼š
  - è®¢å•çº§çŠ¶æ€ï¼ˆOrderStatusï¼‰
  - æ§½ä½çº§çŠ¶æ€ï¼ˆSlotStatusï¼‰
- å®ç°äº†**ä¾èµ–é“¾ç®¡ç†**ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- è®¾è®¡äº†**å†²çªè§£å†³åè®®**ï¼Œæ”¯æŒä¸‰ç§è§£å†³ç­–ç•¥
- å¢åŠ äº†**çŠ¶æ€æŒä¹…åŒ–**æ”¯æŒï¼Œä¾¿äºè°ƒè¯•å’Œæ¢å¤

### 7.2.3 ä»£ç å®ç°å’Œä¼˜åŒ–é˜¶æ®µ

#### åœºæ™¯äº”ï¼šDSLè§£é‡Šå™¨å®ç°

**æˆ‘çš„æç¤ºè¯**ï¼š

```
è¯·å¸®æˆ‘å®ç°ä¸€ä¸ªYAML DSLè§£é‡Šå™¨çš„æ ¸å¿ƒç±»ï¼Œéœ€è¦åŒ…å«ï¼š
- YAMLé…ç½®åŠ è½½å’ŒéªŒè¯
- æµç¨‹çŠ¶æ€ç®¡ç†
- äº‹ä»¶è§¦å‘æœºåˆ¶
- å‘½ä»¤æ˜ å°„æ‰§è¡Œ

è¯·ä½¿ç”¨Pythonå®ç°ï¼Œè¦æ±‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œæœ‰é€‚å½“çš„é”™è¯¯å¤„ç†ã€‚
```

**AIç”Ÿæˆçš„ä»£ç æ¡†æ¶**ï¼š

```python
class FlowInterpreter:
    def __init__(self, flow_config, form_system):
        self.flow_config = flow_config
        self.form_system = form_system
  
    def process_input(self, user_input, llm_client=None, semantic_mapper=None):
        # å¤„ç†ç”¨æˆ·è¾“å…¥çš„æ ¸å¿ƒæ–¹æ³•
        pass
  
    def _handle_events(self, event_name):
        # äº‹ä»¶å¤„ç†é€»è¾‘
        pass
  
    def _execute_command(self, command_name):
        # å‘½ä»¤æ‰§è¡Œé€»è¾‘
        pass
```

**æˆ‘çš„æ”¹è¿›å’Œå®ç°**ï¼š

- å¢åŠ äº†**é…ç½®éªŒè¯ç®—æ³•**ç¡®ä¿DSLå®Œæ•´æ€§
- å®ç°äº†**æ™ºèƒ½å‘½ä»¤è¯†åˆ«**æ”¯æŒæ¨¡ç³ŠåŒ¹é…
- è®¾è®¡äº†**åŠ¨ä½œé“¾æ‰§è¡Œæœºåˆ¶**æ”¯æŒå¤æ‚ä¸šåŠ¡æµç¨‹
- å¢åŠ äº†**å¼‚å¸¸å¤„ç†å’Œé™çº§ç­–ç•¥**
- ä¼˜åŒ–äº†**æ€§èƒ½ç›‘æ§**å’Œ**æ—¥å¿—è®°å½•**

#### åœºæ™¯å…­ï¼šè¯­ä¹‰åŒ¹é…ç®—æ³•

**æˆ‘çš„æç¤ºè¯**ï¼š

```
è¯·å®ç°ä¸€ä¸ªè¯­ä¹‰åŒ¹é…å™¨ï¼Œæ”¯æŒï¼š
1. ç²¾ç¡®åŒ¹é…ï¼ˆæ ‡ç­¾å’ŒåŒä¹‰è¯ï¼‰
2. è¾¹ç•ŒåŒ¹é…ï¼ˆé¿å…è¯¯åŒ¹é…ï¼‰
3. å…³é”®è¯åŒ¹é…
4. ç½®ä¿¡åº¦è®¡ç®—

è¾“å…¥ä¸ºç”¨æˆ·æ–‡æœ¬å’Œå€™é€‰é€‰é¡¹åˆ—è¡¨ï¼Œè¾“å‡ºæœ€ä½³åŒ¹é…ç»“æœã€‚
```

**AIç”Ÿæˆçš„ç®—æ³•æ¡†æ¶**ï¼š

```python
class SemanticMapper:
    @staticmethod
    def map(user_text, options):
        best_match = None
        for option in options:
            # å¤šç§åŒ¹é…ç­–ç•¥
            pass
        return best_match
```

**æˆ‘çš„æ”¹è¿›å’Œå®ç°**ï¼š

- è®¾è®¡äº†**å¤šçº§åŒ¹é…ç­–ç•¥**æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œ
- å®ç°äº†**ç½®ä¿¡åº¦åŠ¨æ€è®¡ç®—**åŸºäºåŒ¹é…è´¨é‡
- å¢åŠ äº†**åŒ¹é…åŸå› è®°å½•**æ”¯æŒå¯è§£é‡Šæ€§
- ä¼˜åŒ–äº†**æ€§èƒ½**é€šè¿‡é€‰æ‹©æ€§åŒ¹é…å’Œæå‰ç»ˆæ­¢
- å¢åŠ äº†**æµ‹è¯•ç”¨ä¾‹**éªŒè¯å„ç§è¾¹ç•Œæƒ…å†µ

### 7.2.4 æµ‹è¯•å’Œè°ƒè¯•é˜¶æ®µ

#### åœºæ™¯ä¸ƒï¼šæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆ

**æˆ‘çš„éœ€æ±‚**ï¼š

```
è¯·ä¸ºè¡¨å•å¯¹è¯ç³»ç»Ÿç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–ï¼š
1. æ­£å¸¸æµç¨‹ï¼šå®Œæ•´çš„ä¿¡æ¯æ”¶é›†æµç¨‹
2. å¼‚å¸¸æµç¨‹ï¼šç”¨æˆ·ä¸­é€”ä¿®æ”¹ã€å†²çªå¤„ç†
3. è¾¹ç•Œæƒ…å†µï¼šç©ºè¾“å…¥ã€æ— æ•ˆé€‰æ‹©ã€ç½‘ç»œå¼‚å¸¸
4. æ€§èƒ½æµ‹è¯•ï¼šå¤šç”¨æˆ·å¹¶å‘åœºæ™¯

è¦æ±‚æµ‹è¯•ç”¨ä¾‹å…¨é¢ï¼Œè¦†ç›–ä¸»è¦ä¸šåŠ¡åœºæ™¯ã€‚
```

**AIç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹æ¡†æ¶**ï¼š

```python
def test_normal_flow():
    # æµ‹è¯•æ­£å¸¸æµç¨‹
    pass

def test_conflict_resolution():
    # æµ‹è¯•å†²çªè§£å†³
    pass

def test_error_handling():
    # æµ‹è¯•é”™è¯¯å¤„ç†
    pass
```

**æˆ‘çš„æ”¹è¿›å’Œå®ç°**ï¼š

- è®¾è®¡äº†**åˆ†å±‚æµ‹è¯•ç­–ç•¥**ï¼š
  - å•å…ƒæµ‹è¯•ï¼šæ ¸å¿ƒç®—æ³•å’Œç»„ä»¶
  - é›†æˆæµ‹è¯•ï¼šå­ç³»ç»Ÿåä½œ
  - ç³»ç»Ÿæµ‹è¯•ï¼šç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹
- å®ç°äº†**æµ‹è¯•æ•°æ®å·¥å‚**æ”¯æŒå¤æ‚æµ‹è¯•åœºæ™¯
- å¢åŠ äº†**æ€§èƒ½åŸºå‡†æµ‹è¯•**ç¡®ä¿ç³»ç»Ÿå“åº”æ—¶é—´
- å»ºç«‹äº†**æŒç»­é›†æˆæµæ°´çº¿**è‡ªåŠ¨åŒ–æµ‹è¯•æ‰§è¡Œ

## 7.3 ä½¿ç”¨AIè¾…åŠ©ç¼–ç¨‹çš„ç»éªŒæ•™è®­æ€»ç»“

### 7.3.1 æˆåŠŸç»éªŒ

#### 7.3.1.1 æ¶æ„è®¾è®¡è¾…åŠ©

- **ä¼˜åŠ¿**ï¼šAIèƒ½å¤Ÿå¿«é€Ÿæä¾›å¤šç§æ¶æ„æ–¹æ¡ˆï¼Œå¸®åŠ©æ‹“å®½è®¾è®¡æ€è·¯
- **å®è·µ**ï¼šåœ¨ç³»ç»Ÿåˆ†å±‚ã€æ¨¡å—åˆ’åˆ†ç­‰å®è§‚è®¾è®¡ä¸Šï¼ŒAIæä¾›äº†æœ‰ä»·å€¼çš„å‚è€ƒ
- **æ•ˆæœ**ï¼šç¼©çŸ­äº†æ¶æ„è®¾è®¡å‘¨æœŸï¼Œé¿å…äº†æ˜æ˜¾çš„è®¾è®¡ç¼ºé™·

#### 7.3.1.2 ä»£ç ç”Ÿæˆæ•ˆç‡

- **ä¼˜åŠ¿**ï¼šAIèƒ½å¤Ÿå¿«é€Ÿç”Ÿæˆæ ‡å‡†åŒ–çš„ä»£ç æ¡†æ¶å’Œæ¨¡æ¿
- **å®è·µ**ï¼šåœ¨æ•°æ®ç»“æ„å®šä¹‰ã€APIæ¥å£ç­‰é‡å¤æ€§å·¥ä½œä¸Šå¤§å¹…æå‡æ•ˆç‡
- **æ•ˆæœ**ï¼šå‡å°‘äº†æ ·æ¿ä»£ç çš„ç¼–å†™æ—¶é—´ï¼Œä¸“æ³¨äºæ ¸å¿ƒé€»è¾‘

#### 7.3.1.3 ç®—æ³•æ€è·¯å¯å‘

- **ä¼˜åŠ¿**ï¼šAIèƒ½å¤Ÿæä¾›å¤šç§ç®—æ³•å®ç°æ€è·¯å’Œä¼˜åŒ–å»ºè®®
- **å®è·µ**ï¼šåœ¨å¤æ‚ç®—æ³•è®¾è®¡ä¸Šï¼ŒAIçš„å»ºè®®å¯å‘äº†æ›´å¥½çš„è§£å†³æ–¹æ¡ˆ
- **æ•ˆæœ**ï¼šæå‡äº†ç®—æ³•è´¨é‡å’Œæ€§èƒ½è¡¨ç°

### 7.3.2 æŒ‘æˆ˜å’Œå±€é™

#### 7.3.2.1 ä¸šåŠ¡ç†è§£æ·±åº¦ä¸è¶³

- **é—®é¢˜**ï¼šAIå¯¹ç‰¹å®šä¸šåŠ¡åœºæ™¯çš„ç†è§£ä¸å¤Ÿæ·±å…¥
- **æ¡ˆä¾‹**ï¼šåœ¨è®¾è®¡ä¸šåŠ¡è§„åˆ™å¼•æ“æ—¶ï¼ŒAIå»ºè®®çš„æ–¹æ¡ˆè¿‡äºé€šç”¨ï¼Œç¼ºä¹è¡Œä¸šç‰¹æ€§
- **è§£å†³**ï¼šéœ€è¦äººå·¥æ·±å…¥åˆ†æä¸šåŠ¡éœ€æ±‚ï¼Œå®šåˆ¶åŒ–å¼€å‘

#### 7.3.2.2 ä»£ç è´¨é‡å‚å·®ä¸é½

- **é—®é¢˜**ï¼šAIç”Ÿæˆçš„ä»£ç è´¨é‡ä¸ç¨³å®šï¼Œéœ€è¦ä¸¥æ ¼å®¡æŸ¥
- **æ¡ˆä¾‹**ï¼šéƒ¨åˆ†ç”Ÿæˆçš„ä»£ç å­˜åœ¨è¾¹ç•Œæ¡ä»¶å¤„ç†ä¸å®Œå–„ã€é”™è¯¯å¤„ç†ç¼ºå¤±ç­‰é—®é¢˜
- **è§£å†³**ï¼šå»ºç«‹ä»£ç å®¡æŸ¥æµç¨‹ï¼Œå¯¹AIç”Ÿæˆä»£ç è¿›è¡Œä¸¥æ ¼æµ‹è¯•

#### 7.3.2.3 ç³»ç»Ÿé›†æˆå¤æ‚åº¦

- **é—®é¢˜**ï¼šAIéš¾ä»¥ç†è§£å¤æ‚çš„ç³»ç»Ÿäº¤äº’å’ŒçŠ¶æ€ç®¡ç†
- **æ¡ˆä¾‹**ï¼šåœ¨å¤šè½®å¯¹è¯çŠ¶æ€ç®¡ç†ä¸Šï¼ŒAIå»ºè®®çš„æ–¹æ¡ˆè¿‡äºç®€å•
- **è§£å†³**ï¼šéœ€è¦äººå·¥è®¾è®¡å¤æ‚çš„çŠ¶æ€æœºå’Œæ•°æ®æµç®¡ç†

### 7.3.3 æœ‰æ•ˆä½¿ç”¨ç­–ç•¥

#### 7.3.3.1 æ˜ç¡®åˆ†å·¥åŸåˆ™

- **AIè´Ÿè´£**ï¼šä»£ç æ¡†æ¶ã€æ ‡å‡†ç®—æ³•ã€æ–‡æ¡£æ¨¡æ¿
- **äººå·¥è´Ÿè´£**ï¼šä¸šåŠ¡é€»è¾‘ã€ç³»ç»Ÿæ¶æ„ã€æ ¸å¿ƒç®—æ³•ã€ä»£ç å®¡æŸ¥
- **åä½œæ¨¡å¼**ï¼šAIæä¾›é€‰æ‹©ï¼Œäººå·¥å†³ç­–ä¼˜åŒ–

#### 7.3.3.2 æ¸è¿›å¼å¼€å‘æµç¨‹

1. **éœ€æ±‚åˆ†æ**ï¼šäººå·¥ä¸»å¯¼ï¼Œæ˜ç¡®ä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯è¦æ±‚
2. **æ¶æ„è®¾è®¡**ï¼šAIè¾…åŠ©æä¾›æ–¹æ¡ˆï¼Œäººå·¥å†³ç­–ä¼˜åŒ–
3. **ä»£ç å®ç°**ï¼šAIç”Ÿæˆæ¡†æ¶ï¼Œäººå·¥å®Œå–„é€»è¾‘
4. **æµ‹è¯•ä¼˜åŒ–**ï¼šäººå·¥ä¸»å¯¼ï¼ŒAIè¾…åŠ©ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹

#### 7.3.3.3 è´¨é‡ä¿éšœæœºåˆ¶

- **ä»£ç å®¡æŸ¥**ï¼šå¯¹æ‰€æœ‰AIç”Ÿæˆä»£ç è¿›è¡Œä¸¥æ ¼å®¡æŸ¥
- **æµ‹è¯•é©±åŠ¨**ï¼šå…ˆå†™æµ‹è¯•ç”¨ä¾‹ï¼Œå†ä½¿ç”¨AIè¾…åŠ©å®ç°
- **è¿­ä»£ä¼˜åŒ–**ï¼šåŸºäºæµ‹è¯•åé¦ˆä¸æ–­ä¼˜åŒ–AIç”Ÿæˆä»£ç 

### 7.3.4 å¯¹æœªæ¥AIè¾…åŠ©ç¼–ç¨‹çš„å±•æœ›

åŸºäºæœ¬æ¬¡é¡¹ç›®ç»éªŒï¼Œæˆ‘è®¤ä¸ºAIè¾…åŠ©ç¼–ç¨‹å°†åœ¨ä»¥ä¸‹æ–¹é¢æŒç»­å‘å±•ï¼š

#### 7.3.4.1 æŠ€æœ¯æ”¹è¿›æ–¹å‘

- **ä¸Šä¸‹æ–‡ç†è§£**ï¼šæå‡å¯¹å¤æ‚ä¸šåŠ¡åœºæ™¯å’Œç³»ç»Ÿæ¶æ„çš„ç†è§£èƒ½åŠ›
- **ä»£ç è´¨é‡**ï¼šç”Ÿæˆæ›´å¥å£®ã€æ›´ç¬¦åˆå·¥ç¨‹å®è·µçš„ä»£ç 
- **è°ƒè¯•èƒ½åŠ›**ï¼šæä¾›æ›´æ™ºèƒ½çš„é”™è¯¯è¯Šæ–­å’Œä¿®å¤å»ºè®®

#### 7.3.4.2 å·¥ä½œæµç¨‹ä¼˜åŒ–

- **æ›´æ·±åº¦é›†æˆ**ï¼šAIå·¥å…·ä¸å¼€å‘ç¯å¢ƒçš„æ— ç¼é›†æˆ
- **ä¸ªæ€§åŒ–é€‚é…**ï¼šæ ¹æ®å¼€å‘è€…ä¹ æƒ¯å’Œé¡¹ç›®ç‰¹ç‚¹è‡ªé€‚åº”è°ƒæ•´
- **çŸ¥è¯†ç®¡ç†**ï¼šæ›´å¥½åœ°ç†è§£å’Œåˆ©ç”¨é¡¹ç›®ç‰¹å®šçš„é¢†åŸŸçŸ¥è¯†

#### 7.3.4.3 å¼€å‘è€…è§’è‰²æ¼”è¿›

- **æ¶æ„å¸ˆæ€ç»´**ï¼šå¼€å‘è€…æ›´å¤šä¸“æ³¨äºç³»ç»Ÿè®¾è®¡å’Œä¸šåŠ¡å»ºæ¨¡
- **ä»£ç å®¡æŸ¥è€…**ï¼šä»ä»£ç ç¼–å†™è€…å‘ä»£ç è´¨é‡ä¿è¯è€…è½¬å˜
- **åˆ›æ–°æ¨åŠ¨è€…**ï¼šåˆ©ç”¨AIèƒ½åŠ›æ¢ç´¢æ›´å¤æ‚çš„æŠ€æœ¯è§£å†³æ–¹æ¡ˆ

### 7.3.5 æ€»ç»“

é€šè¿‡æœ¬é¡¹ç›®çš„å®è·µï¼Œæˆ‘æ·±åˆ»ä½“ä¼šåˆ°AIè¾…åŠ©ç¼–ç¨‹çš„å·¨å¤§æ½œåŠ›å’Œå½“å‰å±€é™ã€‚æ°å½“ä½¿ç”¨AIå·¥å…·èƒ½å¤Ÿæ˜¾è‘—æå‡å¼€å‘æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯åœ¨ä»£ç æ¡†æ¶ç”Ÿæˆã€ç®—æ³•æ€è·¯å¯å‘ç­‰æ–¹é¢ã€‚ç„¶è€Œï¼ŒAIå¹¶ä¸èƒ½æ›¿ä»£å¼€å‘è€…çš„æ ¸å¿ƒä½œç”¨â€”â€”ä¸šåŠ¡ç†è§£ã€æ¶æ„è®¾è®¡ã€ç³»ç»Ÿé›†æˆå’Œè´¨é‡ä¿éšœã€‚

æˆåŠŸçš„AIè¾…åŠ©ç¼–ç¨‹éœ€è¦ï¼š

1. **æ˜ç¡®çš„ä¸»å¯¼æ„è¯†**ï¼šå¼€å‘è€…å§‹ç»ˆæŒæ¡æŠ€æœ¯å†³ç­–æƒ
2. **ä¸¥æ ¼çš„è´¨ä¿æµç¨‹**ï¼šå¯¹AIè¾“å‡ºè¿›è¡Œå……åˆ†éªŒè¯å’Œæµ‹è¯•
3. **æŒç»­çš„å­¦ä¹ æ€åº¦**ï¼šç†è§£AIå»ºè®®èƒŒåçš„åŸç†å’Œé€»è¾‘
4. **å¹³è¡¡çš„ä½¿ç”¨ç­–ç•¥**ï¼šåœ¨æ•ˆç‡å’Œè´¨é‡çš„å¹³è¡¡ä¸­å¯»æ‰¾æœ€ä½³å®è·µ

æœªæ¥ï¼Œéšç€AIæŠ€æœ¯çš„ä¸æ–­è¿›æ­¥ï¼Œæˆ‘ç›¸ä¿¡AIè¾…åŠ©ç¼–ç¨‹å°†æˆä¸ºè½¯ä»¶å¼€å‘çš„æ ‡å‡†å®è·µï¼Œä½†å¼€å‘è€…çš„æ ¸å¿ƒä»·å€¼â€”â€”åˆ›é€ æ€§æ€ç»´ã€ä¸šåŠ¡ç†è§£å’Œç³»ç»Ÿè®¾è®¡èƒ½åŠ›â€”â€”å°†å˜å¾—æ›´åŠ é‡è¦ã€‚

# 7 AIè¾…åŠ©ç¼–ç¨‹è¿‡ç¨‹è¯´æ˜

å¦‚æœå¤§ä½œä¸šä½¿ç”¨äº†AIè¾…åŠ©ç¼–ç¨‹ï¼Œéœ€è¦å†™è¿™ä¸€ç« 

## 7.1 æœ¬ä½œä¸šä½¿ç”¨çš„AIè¾…åŠ©ç¼–ç¨‹å·¥å…·è¯´æ˜

## 7.2 ä½¿ç”¨AIè¾…åŠ©ç¼–ç¨‹çš„è¿‡ç¨‹

éœ€è¦è®°å½•å¼€å‘è¿‡ç¨‹ä¿¡æ¯åœ¨æ–‡æ¡£ä¸­ä½“ç°ï¼Œä¾‹å¦‚ï¼Œç¼–ç¨‹è¿‡ç¨‹ä¸­ï¼Œç»™LLMæçš„è¦æ±‚ï¼Œä½¿ç”¨çš„æç¤ºè¯ï¼›å‡ è½®å¯¹è¯ï¼Œå¦‚æœè½®æ•°å¾ˆå¤šï¼Œå¯ä»¥ç®€åŒ–è¿‡ç¨‹ï¼Œåªè¯´æ˜å‰å‡ è½®å’Œæœ€åå‡ è½®çš„LLMè¾“å‡ºç»“æœï¼›å¦‚æ¨¡å—åˆ’åˆ†ï¼Œæ¥å£å½¢å¼ï¼Œæ¯ä¸ªç±»çš„å®šä¹‰ï¼Œéœ€è¦æœ‰æ˜ç¡®çš„è¦æ±‚ã€‚LLMçš„å›å¤æ˜¯ä»€ä¹ˆï¼Œä½ åšäº†å“ªäº›ä¿®æ”¹ã€‚åŸåˆ™æ˜¯ï¼šä½¿ç”¨LLMçš„åœ°æ–¹è¦è¯¦ç»†è¯´æ˜ä½¿ç”¨è¿‡ç¨‹å’Œå¯¹LLMè¾“å‡ºç»“æœçš„åˆ©ç”¨æƒ…å†µã€‚

## 7.3 ä½¿ç”¨AIè¾…åŠ©ç¼–ç¨‹çš„ç»éªŒæ•™è®­æ€»ç»“

# 8 GITæ—¥å¿—

å¤§ä½œä¸šå¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä½¿ç”¨GITåšç‰ˆæœ¬ç®¡ç†ï¼Œæ¯ä¸€ä¸ªå°çš„é˜¶æ®µæ€§ä¿®æ”¹ï¼Œéƒ½éœ€è¦commitå¹¶å¸¦æœ‰å‡†ç¡®çš„æ³¨é‡Šã€‚

æœ¬ç« å†…å®¹æ˜¯å¼€å‘è¿‡ç¨‹çš„å®Œæ•´GITæ—¥å¿—å¯¼å‡ºã€‚

# 9 æ€»ç»“ä¸å±•æœ›

åšå¤§ä½œä¸šè¿‡ç¨‹çš„æ”¶è·ã€‚

å°šæœªå®ç°çš„ä¸€äº›è®¾æƒ³ã€‚

å¯¹å¤§ä½œä¸šçš„æ„è§å’Œå»ºè®®ã€‚
