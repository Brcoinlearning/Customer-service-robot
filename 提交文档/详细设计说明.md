# è¯¦ç»†è®¾è®¡è¯´æ˜

# ç¬¬ä¸€éƒ¨åˆ†ï¼šæ ¸å¿ƒæ¶æ„ä¸æ•°æ®ç»“æ„

## 1. ç³»ç»Ÿæ€»ä½“æ¶æ„

### 1.1 æ¶æ„è®¾è®¡ç†å¿µ

æœ¬ç³»ç»Ÿé‡‡ç”¨**å£°æ˜å¼DSLé©±åŠ¨**çš„æ¶æ„ï¼Œå°†ä¸šåŠ¡é€»è¾‘ä»ä»£ç ä¸­æŠ½ç¦»ï¼Œé€šè¿‡å¯é…ç½®çš„YAMLè„šæœ¬å®šä¹‰ä¸šåŠ¡æµç¨‹ã€‚ç³»ç»Ÿéµå¾ª"é…ç½®å³é€»è¾‘"çš„è®¾è®¡ç†å¿µï¼Œé€šè¿‡DSLè„šæœ¬æè¿°å®Œæ•´çš„å¯¹è¯æµç¨‹ï¼Œè§£é‡Šå™¨è´Ÿè´£æ‰§è¡Œè¿™äº›é€»è¾‘ã€‚

### 1.2 å››å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DSLé…ç½®å±‚                                 â”‚
â”‚  ä¸šåŠ¡é€»è¾‘é€šè¿‡YAMLå£°æ˜ï¼Œå®ç°ä»£ç ä¸ä¸šåŠ¡åˆ†ç¦»                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ apple_store     â”‚  â”‚ dining          â”‚                   â”‚
â”‚  â”‚ .flow.yaml      â”‚  â”‚ .flow.yaml      â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DSLè§£é‡Šå±‚                                 â”‚
â”‚  è§£æå’Œæ‰§è¡ŒDSLè„šæœ¬ï¼Œç®¡ç†æµç¨‹çŠ¶æ€                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ YAMLFlowLoader  â”‚  â”‚ FlowInterpreter â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒä¸šåŠ¡å±‚                                â”‚
â”‚  å®ç°å¤šæ§½ä½ä¿¡æ¯é‡‡é›†å’Œå¯¹è¯ç®¡ç†                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ FormBased       â”‚  â”‚ BusinessConfig  â”‚                   â”‚
â”‚  â”‚ DialogSystem    â”‚  â”‚ Loader          â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡é›†æˆå±‚                                â”‚
â”‚  é›†æˆå¤–éƒ¨AIæœåŠ¡å’Œè¯­ä¹‰ç†è§£èƒ½åŠ›                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SparkLLMClient  â”‚  â”‚ SemanticMapper  â”‚  â”‚ OptionBuilder â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æ•°æ®æµå‘æ¶æ„

```
ç”¨æˆ·è¾“å…¥
    â†“
å‘½ä»¤è¡Œç•Œé¢ â†’ æµç¨‹è§£é‡Šå™¨ â†’ è¡¨å•ç³»ç»Ÿ
    â†‘                              â†“
ç”¨æˆ·è¾“å‡º â† å“åº”ç”Ÿæˆå™¨ â† çŠ¶æ€æ£€æŸ¥å™¨
                    â†“
             ä¸‰å±‚ä¿¡æ¯æŠ½å–å¼•æ“
           â†—         â†‘          â†–
    ç›´æ¥å…³é”®è¯åŒ¹é…  è¯­ä¹‰æ˜ å°„æ¨è  LLMå…œåº•æŠ½å–
```

## 2. å…³é”®æ•°æ®ç»“æ„

### 2.1 DSLé…ç½®æ•°æ®ç»“æ„

#### 2.1.1 æµç¨‹é…ç½®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šYAML DSLæ–‡ä»¶ï¼ˆå¦‚apple_store.flow.yamlï¼‰

```yaml
flow:
  name: string                    # æµç¨‹åç§°
  version: string                 # ç‰ˆæœ¬å·
  description: string             # æµç¨‹æè¿°
  business_line: string           # ä¸šåŠ¡çº¿æ ‡è¯†
  
  process_order:                  # æ§½ä½å¤„ç†é¡ºåº
    - category
    - brand
    - series
  
  slots:                          # æ§½ä½å®šä¹‰å­—å…¸
    category:
      label: "äº§å“å¤§ç±»"
      description: "é€‰æ‹©äº§å“ç±»å‹" 
      required: true
      type: enum
      enums_key: category
      dependencies: []
  
  events:                         # äº‹ä»¶å¤„ç†å™¨
    on_start:
      - action: reset_form
      - action: show_template
        template: form_welcome
    
  commands:                       # ç”¨æˆ·å‘½ä»¤æ˜ å°„
    restart:
      keywords: ["é‡æ–°å¼€å§‹", "reset"]
      action: restart_flow
```

**è¯´æ˜**ï¼š

    è¿™æ˜¯DSLçš„æ ¹ç»“æ„ï¼Œå®šä¹‰äº†å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ï¼ŒåŒ…æ‹¬æ§½ä½é¡ºåºã€äº‹ä»¶å¤„ç†å’Œç”¨æˆ·å‘½ä»¤æ˜ å°„ã€‚æ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½é€šè¿‡è¿™ä¸ªç»“æ„å£°æ˜å¼å®šä¹‰ã€‚

#### 2.1.2 æ§½ä½é…ç½®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šYAML DSLæ–‡ä»¶ä¸­çš„slotséƒ¨åˆ†

```yaml
slots:
  category:
    label: "äº§å“å¤§ç±»"
    description: "é€‰æ‹©äº§å“ç±»å‹"
    required: true
    allow_llm: false
    type: enum
    enums_key: category
    dependencies: []
    prompt_template: form_category_prompt
  
  chip:
    label: "å¤„ç†å™¨èŠ¯ç‰‡" 
    description: "é€‰æ‹©å¤„ç†å™¨å‹å·"
    required: true
    allow_llm: true
    type: enum
    enums_key: chip
    dependencies: [category, series, size]
    semantic_stage: chip_selection
    validation:
      must_be_valid_enum: true
      min_confidence: 0.35
```

**è¯´æ˜**ï¼š

    æ¯ä¸ªæ§½ä½é…ç½®å®šä¹‰äº†ä¿¡æ¯é‡‡é›†å­—æ®µçš„æ‰€æœ‰å±æ€§ï¼ŒåŒ…æ‹¬æ•°æ®ç±»å‹ã€ä¾èµ–å…³ç³»ã€éªŒè¯è§„åˆ™å’Œæç¤ºæ–¹å¼ã€‚`semantic_stage`æ”¯æŒåŠ¨æ€è¯­ä¹‰è¿‡æ»¤ï¼Œ`dependencies`ç¡®ä¿æ§½ä½å¡«å……é¡ºåºã€‚

### 2.2 ä¸šåŠ¡é…ç½®æ•°æ®ç»“æ„

#### 2.2.1 ä¸šåŠ¡é…ç½®ä¸»ç»“æ„

**å®šä¹‰æ¥æº**ï¼šbusiness_config_loader.py

```python
@dataclass
class BusinessConfig:
    name: str
    display_name: str
    description: str
    slot_specs: List[SlotSpec]
    enums: Dict[str, List[Dict[str, Any]]]
    templates: Dict[str, List[str]]
    filters: Dict[str, Dict[str, List[str]]]
    command_keywords: Dict[str, List[str]]
    intent_recommendations: Dict[str, List[Dict[str, Any]]]
```

**è¯´æ˜**ï¼š

    ä¸šåŠ¡é…ç½®åŒ…å«ä¸€ä¸ªä¸šåŠ¡çº¿çš„æ‰€æœ‰é™æ€é…ç½®ä¿¡æ¯ï¼Œä»JSONæ–‡ä»¶åŠ è½½ã€‚`filters`æ”¯æŒåŠ¨æ€é€‰é¡¹è¿‡æ»¤ï¼Œ`intent_recommendations`å®ç°æ™ºèƒ½æ¨èã€‚

#### 2.2.2 æ§½ä½è§„æ ¼å®šä¹‰

**å®šä¹‰æ¥æº**ï¼šinterfaces.py

```python
@dataclass
class SlotSpec:
    name: str
    required: bool
    description: str
    dependencies: List[str] = field(default_factory=list)
    enums_key: Optional[str] = None
    semantic_stage: Optional[str] = None
    allow_llm: bool = True
```

**è¯´æ˜**ï¼š

    æ§½ä½è§„æ ¼æ˜¯ä¸šåŠ¡é…ç½®çš„æ ¸å¿ƒï¼Œå®šä¹‰äº†æ¯ä¸ªä¿¡æ¯å­—æ®µçš„ä¸šåŠ¡å±æ€§ã€‚`dependencies`ç¡®ä¿æ­£ç¡®çš„å¡«å……é¡ºåºï¼Œ`allow_llm`æ§åˆ¶AIä½¿ç”¨çš„æƒé™ã€‚

### 2.3 è¿è¡Œæ—¶æ•°æ®ç»“æ„

#### 2.3.1 è¡¨å•æ§½ä½è¿è¡Œæ—¶çŠ¶æ€

**å®šä¹‰æ¥æº**ï¼šform_based_system.py

```python
@dataclass
class FormSlot:
    definition: SlotDefinition
    status: SlotStatus = SlotStatus.EMPTY
    value: Optional[SlotValue] = None
    candidates: List[SlotValue] = field(default_factory=list)
```

**è¯´æ˜**ï¼š

    ç®¡ç†å•ä¸ªæ§½ä½çš„å®Œæ•´è¿è¡Œæ—¶çŠ¶æ€ã€‚`status`è·Ÿè¸ªå¡«å……è¿›åº¦ï¼Œ`candidates`å­˜å‚¨å†²çªæ£€æµ‹çš„å€™é€‰å€¼ï¼Œæ”¯æŒå¤šè½®äº¤äº’å’Œå†²çªè§£å†³ã€‚

#### 2.3.2 æ§½ä½å€¼æ•°æ®ç»“æ„

**å®šä¹‰æ¥æº**ï¼šform_based_system.py

```python
@dataclass  
class SlotValue:
    value: Any
    confidence: float
    source: str  # "numeric", "semantic", "llm", "direct", "single_match"
    reason: str = ""
```

**è¯´æ˜**ï¼š

    å°è£…ç”¨æˆ·æä¾›çš„å€¼åŠå…¶å…ƒæ•°æ®ã€‚`confidence`æ”¯æŒç½®ä¿¡åº¦å†³ç­–ï¼Œ`source`è®°å½•è¯†åˆ«æ¥æºç”¨äºå†²çªä¼˜å…ˆçº§åˆ¤æ–­ï¼Œ`reason`æä¾›å†³ç­–é€æ˜åº¦ã€‚

#### 2.3.3 è¯­ä¹‰é€‰é¡¹ç»“æ„

**å®šä¹‰æ¥æº**ï¼šoption_mapping.py

```python
@dataclass
class Option:
    idx: int               # 1-basedç´¢å¼•
    code: str              # è§„èŒƒçŸ­ä»£ç 
    label: str             # æ˜¾ç¤ºæ ‡ç­¾
    synonyms: List[str] = field(default_factory=list)    # åŒä¹‰è¯
    keywords: List[str] = field(default_factory=list)    # å…³é”®è¯
```

**è¯´æ˜**ï¼š

    ç”¨äºè¯­ä¹‰æ˜ å°„çš„é€‰é¡¹ç»“æ„ã€‚`synonyms`æ”¯æŒçµæ´»çš„ç”¨æˆ·è¡¨è¾¾ï¼Œ`keywords`ç”¨äºç²¾ç¡®çš„è¯­ä¹‰åŒ¹é…ï¼Œå®ç°æœ¬åœ°åŒ–çš„æ™ºèƒ½ç†è§£ã€‚

### 2.4 çŠ¶æ€æšä¸¾å®šä¹‰

#### 2.4.1 æ§½ä½çŠ¶æ€æšä¸¾

**å®šä¹‰æ¥æº**ï¼šform_based_system.py

```python
class SlotStatus(Enum):
    EMPTY = "empty"           # æœªå¡«å……ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥
    PARTIAL = "partial"       # éƒ¨åˆ†ä¿¡æ¯ï¼Œéœ€è¦è¿›ä¸€æ­¥ç¡®è®¤
    FILLED = "filled"         # å·²å®Œæ•´å¡«å……ï¼Œä¿¡æ¯å°±ç»ª
    CONFLICTED = "conflicted" # ä¿¡æ¯å†²çªï¼Œéœ€è¦ç”¨æˆ·å†³ç­–
```

**è¯´æ˜**ï¼š

    å®šä¹‰æ§½ä½å¡«å……çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ã€‚æ”¯æŒæ¸è¿›å¼ä¿¡æ¯æ”¶é›†å’Œå†²çªå¤„ç†ï¼Œç¡®ä¿æ•°æ®è´¨é‡ã€‚

#### 2.4.2 è®¢å•çŠ¶æ€æšä¸¾

**å®šä¹‰æ¥æº**ï¼šform_based_system.py

```python
class OrderStatus(Enum):
    COLLECTING = "collecting"           # ä¿¡æ¯æ”¶é›†ä¸­
    READY_CONFIRM = "ready_confirm"     # å‡†å¤‡ç¡®è®¤è®¢å•
    CONFIRMED = "confirmed"             # å·²ç¡®è®¤è®¢å•
    RESELECTING = "reselecting"         # é‡æ–°é€‰æ‹©æŸé¡¹
    AWAITING_CONTINUE = "awaiting_continue"  # ç­‰å¾…ç»§ç»­è´­ç‰©å†³ç­–
```

**è¯´æ˜**ï¼š

    ç®¡ç†æ•´ä¸ªè®¢å•æµç¨‹çš„çŠ¶æ€æœºã€‚ä»ä¿¡æ¯æ”¶é›†åˆ°è®¢å•ç¡®è®¤çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œæ”¯æŒä¸­é€”ä¿®æ”¹å’Œæµç¨‹æ§åˆ¶ã€‚

### 2.5 è¯­ä¹‰åŒ¹é…æ•°æ®ç»“æ„

#### 2.5.1 è¯­ä¹‰åŒ¹é…ç»“æœ

**å®šä¹‰æ¥æº**ï¼šoption_mapping.py

```python
@dataclass
class SemanticMatchResult:
    chosen_index: Optional[int]   # é€‰æ‹©çš„é€‰é¡¹ç´¢å¼•
    confidence: float             # åŒ¹é…ç½®ä¿¡åº¦ [0.0, 1.0]
    reason: str                   # åŒ¹é…åŸå› æè¿°
    strategy: str                 # åŒ¹é…ç­–ç•¥æ ‡è¯†
```

**è¯´æ˜**ï¼š

    å°è£…è¯­ä¹‰åŒ¹é…çš„ç»“æœå’Œå…ƒæ•°æ®ã€‚`confidence`æ”¯æŒé˜ˆå€¼è¿‡æ»¤ï¼Œ`reason`æä¾›å¯è§£é‡Šçš„åŒ¹é…è¿‡ç¨‹ï¼Œå¢å¼ºç³»ç»Ÿé€æ˜åº¦ã€‚

## 3. æ¨¡å—åˆ’åˆ†ä¸èŒè´£

### 3.1 DSLè§£é‡Šæ¨¡å—

#### 3.1.1 YAMLFlowLoader

**èŒè´£èŒƒå›´**ï¼š

- DSLè„šæœ¬çš„åŠ è½½å’Œè¯­æ³•éªŒè¯
- é…ç½®å®Œæ•´æ€§å’Œä¸€è‡´æ€§æ£€æŸ¥
- æµç¨‹ä¿¡æ¯çš„æå–å’Œæä¾›

**å…³é”®ç‰¹æ€§**ï¼š

- æ”¯æŒYAMLæ ¼å¼çš„æµç¨‹å®šä¹‰
- ä¸¥æ ¼çš„é…ç½®éªŒè¯ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§
- æä¾›æµç¨‹å…ƒä¿¡æ¯æŸ¥è¯¢æ¥å£

#### 3.1.2 FlowInterpreter

**èŒè´£èŒƒå›´**ï¼š

- DSLè„šæœ¬çš„è§£é‡Šå’Œæ‰§è¡Œ
- ç”¨æˆ·å‘½ä»¤çš„è¯†åˆ«å’Œå¤„ç†
- ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„è§¦å‘å’Œç®¡ç†

**å…³é”®ç‰¹æ€§**ï¼š

- ç»‘å®šDSLé…ç½®ä¸è¡¨å•ç³»ç»Ÿ
- æ”¯æŒå¤æ‚çš„äº‹ä»¶å¤„ç†é“¾
- ç®¡ç†æµç¨‹çŠ¶æ€å’Œæ‰§è¡Œé¡ºåº

### 3.2 é…ç½®ç®¡ç†æ¨¡å—

#### 3.2.1 BusinessConfigLoader

**èŒè´£èŒƒå›´**ï¼š

- ä¸šåŠ¡é…ç½®çš„åŠ è½½å’Œç¼“å­˜ç®¡ç†
- åŠ¨æ€é…ç½®æ³¨å…¥æ”¯æŒ
- ç»Ÿä¸€çš„é…ç½®è®¿é—®æ¥å£

**å…³é”®ç‰¹æ€§**ï¼š

- æ”¯æŒå¤šä¸šåŠ¡çº¿é…ç½®å¹¶è¡Œ
- é…ç½®æ•°æ®çš„å•ä¾‹ç¼“å­˜
- DSLä¸ä¸šåŠ¡é…ç½®çš„æ¡¥æ¥

#### 3.2.2 Config

**èŒè´£èŒƒå›´**ï¼š

- å…¨å±€ç³»ç»Ÿé…ç½®ç®¡ç†
- ç¯å¢ƒå˜é‡æ”¯æŒå’Œè¦†ç›–
- é…ç½®éªŒè¯å’Œé»˜è®¤å€¼ç®¡ç†

**å…³é”®ç‰¹æ€§**ï¼š

- ç±»å‹å®‰å…¨çš„é…ç½®è®¿é—®
- æ•æ„Ÿä¿¡æ¯çš„ç¯å¢ƒå˜é‡ä¿æŠ¤
- ç³»ç»Ÿå‚æ•°çš„é›†ä¸­ç®¡ç†

### 3.3 æ ¸å¿ƒä¸šåŠ¡æ¨¡å—

#### 3.3.1 FormBasedDialogSystem

**èŒè´£èŒƒå›´**ï¼š

- å¤šæ§½ä½ä¿¡æ¯é‡‡é›†çš„çŠ¶æ€ç®¡ç†
- ä¸‰å±‚ä¿¡æ¯æŠ½å–ç­–ç•¥çš„æ‰§è¡Œ
- å†²çªæ£€æµ‹å’Œè§£å†³æœºåˆ¶
- è®¢å•çŠ¶æ€æœºç®¡ç†

**å…³é”®ç‰¹æ€§**ï¼š

- æ”¯æŒæ¸è¿›å¼ä¿¡æ¯æ”¶é›†
- æ™ºèƒ½çš„å†²çªæ£€æµ‹å’Œè§£å†³
- å®Œæ•´çš„ä¸šåŠ¡æµç¨‹çŠ¶æ€è·Ÿè¸ª

### 3.4 è¯­ä¹‰ç†è§£æ¨¡å—

#### 3.4.1 SemanticMapper

**èŒè´£èŒƒå›´**ï¼š

- æœ¬åœ°è¯­ä¹‰æ˜ å°„å’ŒåŒ¹é…
- å…³é”®è¯å’ŒåŒä¹‰è¯çš„åŒ¹é…è®¡ç®—
- ç½®ä¿¡åº¦è¯„ä¼°å’Œç»“æœæ’åº

**å…³é”®ç‰¹æ€§**ï¼š

- åŸºäºè§„åˆ™çš„å¿«é€Ÿè¯­ä¹‰ç†è§£
- æ”¯æŒè¾¹ç•ŒåŒ¹é…é¿å…è¯¯åŒ¹é…
- æä¾›å¯è§£é‡Šçš„åŒ¹é…ç»“æœ

#### 3.4.2 OptionBuilder

**èŒè´£èŒƒå›´**ï¼š

- åŠ¨æ€é€‰é¡¹åˆ—è¡¨çš„æ„å»º
- åŸºäºä¸Šä¸‹æ–‡çš„é€‰é¡¹è¿‡æ»¤
- è¯­ä¹‰é˜¶æ®µçš„é€‰é¡¹é…ç½®

**å…³é”®ç‰¹æ€§**ï¼š

- æ”¯æŒæ¡ä»¶åŒ–é€‰é¡¹ç”Ÿæˆ
- åŸºäºä¸šåŠ¡è§„åˆ™çš„åŠ¨æ€è¿‡æ»¤
- è¯­ä¹‰æè¿°çš„è‡ªåŠ¨ç”Ÿæˆ

### 3.5 å¤–éƒ¨æœåŠ¡æ¨¡å—

#### 3.5.1 SparkLLMClient

**èŒè´£èŒƒå›´**ï¼š

- LLM APIçš„å°è£…å’Œè°ƒç”¨
- è¯·æ±‚æ„é€ å’Œå“åº”è§£æ
- é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥

**å…³é”®ç‰¹æ€§**ï¼š

- æ”¯æŒå¤šæ§½ä½å¹¶è¡ŒæŠ½å–
- æ™ºèƒ½çš„æç¤ºè¯æ„é€ 
- å®Œå–„çš„é”™è¯¯æ¢å¤æœºåˆ¶

## 4. DSLè¯­æ³•è§„èŒƒ

### 4.1 æµç¨‹å®šä¹‰è¯­æ³•

```yaml
flow:
  name: <string>                  # å¿…éœ€ï¼šæµç¨‹åç§°ï¼Œç”¨äºæ ‡è¯†
  version: <string>               # å¯é€‰ï¼šç‰ˆæœ¬å·ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†
  description: <string>           # å¯é€‰ï¼šæµç¨‹æè¿°ï¼Œç”¨äºæ–‡æ¡£
  business_line: <string>         # å¿…éœ€ï¼šä¸šåŠ¡çº¿æ ‡è¯†ï¼Œå…³è”ä¸šåŠ¡é…ç½®
  
  process_order:                  # å¿…éœ€ï¼šæ§½ä½å¤„ç†é¡ºåºåˆ—è¡¨
    - <slot_name_1>
    - <slot_name_2>
  
  slots:                          # å¿…éœ€ï¼šæ§½ä½å®šä¹‰å­—å…¸
    <slot_name>: <SlotConfig>
  
  events:                         # å¯é€‰ï¼šäº‹ä»¶å¤„ç†å®šä¹‰
    <event_name>: <ActionList>
  
  commands:                       # å¯é€‰ï¼šç”¨æˆ·å‘½ä»¤æ˜ å°„
    <command_name>: <CommandConfig>
```

**è¯­æ³•è¯´æ˜**ï¼š

    æµç¨‹å®šä¹‰æ˜¯DSLçš„æ ¹å…ƒç´ ï¼ŒåŒ…å«å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘æè¿°ã€‚`process_order`ç¡®ä¿æ­£ç¡®çš„æ‰§è¡Œé¡ºåºï¼Œ`business_line`å…³è”å¯¹åº”çš„ä¸šåŠ¡é…ç½®ã€‚

### 4.2 æ§½ä½å®šä¹‰è¯­æ³•

```yaml
<slot_name>:
  label: <string>                 # å¿…éœ€ï¼šç”¨æˆ·å¯è§çš„æ˜¾ç¤ºæ ‡ç­¾
  description: <string>           # å¿…éœ€ï¼šä¸šåŠ¡æè¿°æ–‡æœ¬
  required: <boolean>             # å¿…éœ€ï¼šæ˜¯å¦å¿…å¡«å­—æ®µ
  type: <enum|text>               # å¯é€‰ï¼šæ•°æ®ç±»å‹ï¼Œé»˜è®¤enum
  enums_key: <string>             # å¯¹äºenumç±»å‹å¿…éœ€ï¼šæšä¸¾é”®å
  dependencies:                   # å¯é€‰ï¼šä¾èµ–çš„æ§½ä½åˆ—è¡¨
    - <dependency_slot_1>
  semantic_stage: <string>        # å¯é€‰ï¼šè¯­ä¹‰é˜¶æ®µæ ‡è¯†
  allow_llm: <boolean>            # å¯é€‰ï¼šæ˜¯å¦å…è®¸LLMå¡«å……
  prompt_template: <string>       # å¯é€‰ï¼šæç¤ºæ¨¡æ¿é”®å
```

**è¯­æ³•è¯´æ˜**ï¼š

    æ§½ä½å®šä¹‰æè¿°æ¯ä¸ªä¿¡æ¯å­—æ®µçš„ä¸šåŠ¡ç‰¹æ€§ã€‚`dependencies`æ”¯æŒå¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œ`semantic_stage`å¯ç”¨æ™ºèƒ½è¯­ä¹‰å¤„ç†ã€‚

### 4.3 äº‹ä»¶å¤„ç†è¯­æ³•

```yaml
events:
  on_start:                       # æµç¨‹å¼€å§‹äº‹ä»¶
    - action: <action_name>       # åŠ¨ä½œåç§°
      template: <template_key>    # å¯é€‰ï¼šæ¨¡æ¿é”®å
  
  on_all_filled:                  # æ‰€æœ‰æ§½ä½å¡«å……å®Œæˆäº‹ä»¶  
    - action: show_summary
    - action: ask_confirm
  
  on_confirm:                     # ç”¨æˆ·ç¡®è®¤äº‹ä»¶
    - action: validate_form
    - action: submit_order
    - action: show_template
      template: form_order_confirmed
```

**è¯­æ³•è¯´æ˜**ï¼š

    äº‹ä»¶å¤„ç†æ”¯æŒåœ¨å…³é”®ä¸šåŠ¡æµç¨‹èŠ‚ç‚¹æ‰§è¡Œé¢„å®šä¹‰åŠ¨ä½œã€‚æ”¯æŒåŠ¨ä½œé“¾å’Œæ¨¡æ¿æ˜¾ç¤ºï¼Œå®ç°å¤æ‚çš„ä¸šåŠ¡æµç¨‹æ§åˆ¶ã€‚

### 4.4 å‘½ä»¤æ˜ å°„è¯­æ³•

```yaml
commands:
  restart:                        # å‘½ä»¤åç§°
    keywords:                     # è§¦å‘å…³é”®è¯åˆ—è¡¨
      - "é‡æ–°å¼€å§‹"
      - "reset"
    action: restart_flow          # æ‰§è¡ŒåŠ¨ä½œ
    available_when: always        # å¯ç”¨æ¡ä»¶
  
  confirm:
    keywords: ["ç¡®è®¤", "å¥½çš„", "ok"]
    action: confirm_order
    condition: all_slots_filled   # æ‰§è¡Œæ¡ä»¶
  
  help:
    keywords: ["å¸®åŠ©", "help"]  
    action: show_help
    response: |                   # ç›´æ¥å“åº”å†…å®¹
      ä½¿ç”¨å¸®åŠ©ï¼š
      â€¢ æŒ‰ç…§æç¤ºé€‰æ‹©é…ç½®
      â€¢ è¯´"é‡é€‰"ä¿®æ”¹ä¹‹å‰é€‰æ‹©
```

**è¯­æ³•è¯´æ˜**ï¼š

    å‘½ä»¤æ˜ å°„å°†ç”¨æˆ·è¾“å…¥æ˜ å°„åˆ°ç³»ç»ŸåŠ¨ä½œã€‚æ”¯æŒæ¡ä»¶æ‰§è¡Œå’Œç›´æ¥å“åº”ï¼Œæä¾›çµæ´»çš„ç”¨æˆ·äº¤äº’æ–¹å¼ã€‚

# ç¬¬äºŒéƒ¨åˆ†ï¼šæ¥å£è®¾è®¡ä¸æ ¸å¿ƒç®—æ³•

## 5. ç¨‹åºé—´æ¥å£è®¾è®¡

### 5.1 DSLè§£é‡Šå™¨æ¥å£

#### 5.1.1 YAMLFlowLoader æ¥å£

**å®šä¹‰æ¥æº**ï¼šyaml_flow_loader.py

```python
class YAMLFlowLoader:
    @staticmethod
    def load(yaml_file: str) -> Dict[str, Any]:
        """
        åŠ è½½å’ŒéªŒè¯YAMLæµç¨‹å®šä¹‰æ–‡ä»¶
    
        Args:
            yaml_file: YAMLæ–‡ä»¶è·¯å¾„ï¼Œæ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„
        
        Returns:
            æµç¨‹é…ç½®å­—å…¸ï¼ŒåŒ…å«nameã€process_orderã€slotsç­‰å­—æ®µ
        
        Raises:
            FileNotFoundError: æ–‡ä»¶ä¸å­˜åœ¨æ—¶æŠ›å‡º
            yaml.YAMLError: YAMLæ ¼å¼é”™è¯¯æ—¶æŠ›å‡º  
            ValueError: é…ç½®éªŒè¯å¤±è´¥æ—¶æŠ›å‡º
        """
```

**æ¥å£è¯´æ˜**ï¼š

    è¿™æ˜¯DSLåŠ è½½çš„æ ¸å¿ƒæ¥å£ï¼Œè´Ÿè´£ä»YAMLæ–‡ä»¶åŠ è½½æµç¨‹é…ç½®å¹¶è¿›è¡Œå®Œæ•´æ€§éªŒè¯ã€‚è¿”å›ç»“æ„åŒ–å­—å…¸ä¾›è§£é‡Šå™¨ä½¿ç”¨ã€‚

```python
    @staticmethod
    def validate(flow_config: Dict[str, Any]) -> bool:
        """
        éªŒè¯æµç¨‹é…ç½®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
    
        Args:
            flow_config: æµç¨‹é…ç½®å­—å…¸
        
        Returns:
            Trueè¡¨ç¤ºéªŒè¯é€šè¿‡ï¼ŒFalseè¡¨ç¤ºéªŒè¯å¤±è´¥
        
        Raises:
            ValueError: é…ç½®ç¼ºå°‘å¿…éœ€å­—æ®µæˆ–å­˜åœ¨é€»è¾‘é”™è¯¯æ—¶æŠ›å‡º
        """
```

**æ¥å£è¯´æ˜**ï¼š

    é…ç½®éªŒè¯æ¥å£ï¼Œç¡®ä¿DSLè„šæœ¬ç¬¦åˆé¢„å®šä¹‰çš„è¯­æ³•å’Œè¯­ä¹‰è§„åˆ™ã€‚åœ¨åŠ è½½é˜¶æ®µè‡ªåŠ¨è°ƒç”¨ï¼Œé˜²æ­¢é”™è¯¯é…ç½®å½±å“ç³»ç»Ÿè¿è¡Œã€‚

#### 5.1.2 FlowInterpreter æ¥å£

**å®šä¹‰æ¥æº**ï¼šflow_interpreter.py

```python
class FlowInterpreter:
    def __init__(self, flow_config: Dict[str, Any], form_system: FormBasedDialogSystem):
        """
        åˆå§‹åŒ–æµç¨‹è§£é‡Šå™¨
    
        Args:
            flow_config: é€šè¿‡YAMLFlowLoaderåŠ è½½çš„æµç¨‹é…ç½®
            form_system: è¡¨å•ç³»ç»Ÿå®ä¾‹ï¼Œç”¨äºå®é™…ä¸šåŠ¡å¤„ç†
        """
```

**æ¥å£è¯´æ˜**ï¼š

    è§£é‡Šå™¨æ„é€ å‡½æ•°ï¼Œå»ºç«‹DSLé…ç½®ä¸ä¸šåŠ¡ç³»ç»Ÿçš„ç»‘å®šå…³ç³»ã€‚æ”¯æŒå¤šä¸ªè§£é‡Šå™¨å®ä¾‹å¹¶è¡Œè¿è¡Œä¸åŒçš„ä¸šåŠ¡æµç¨‹ã€‚

```python
    def process_input(self, user_input: str, llm_client=None, semantic_mapper=None) -> Dict[str, Any]:
        """
        å¤„ç†ç”¨æˆ·è¾“å…¥å¹¶æ‰§è¡ŒDSLé€»è¾‘
    
        Args:
            user_input: ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹
            llm_client: å¯é€‰çš„LLMå®¢æˆ·ç«¯ï¼Œç”¨äºAIå¢å¼ºç†è§£
            semantic_mapper: å¯é€‰çš„è¯­ä¹‰æ˜ å°„å™¨ï¼Œç”¨äºæœ¬åœ°è¯­ä¹‰åŒ¹é…
        
        Returns:
            å¤„ç†ç»“æœå­—å…¸ï¼ŒåŒ…å«:
            - response: ç³»ç»Ÿå“åº”æ–‡æœ¬
            - action: æ‰§è¡Œçš„åŠ¨ä½œæ ‡è¯†ï¼ˆå¯é€‰ï¼‰
            - should_exit: æ˜¯å¦åº”è¯¥é€€å‡ºå¯¹è¯ï¼ˆå¯é€‰ï¼‰
        """
```

**æ¥å£è¯´æ˜**ï¼š

    æ ¸å¿ƒå¤„ç†æ¥å£ï¼Œå°†ç”¨æˆ·è¾“å…¥è½¬æ¢ä¸ºç³»ç»Ÿå“åº”ã€‚æ”¯æŒLLMå’Œè¯­ä¹‰æ˜ å°„å™¨çš„å¯é€‰æ³¨å…¥ï¼Œå®ç°çµæ´»çš„èƒ½åŠ›æ‰©å±•ã€‚

### 5.2 ä¸šåŠ¡é…ç½®æ¥å£

#### 5.2.1 BusinessConfigLoader æ¥å£

**å®šä¹‰æ¥æº**ï¼šbusiness_config_loader.py

```python
class BusinessConfigLoader:
    def get_business_config(self, business_name: str) -> Optional[BusinessConfig]:
        """
        è·å–æŒ‡å®šä¸šåŠ¡çš„å®Œæ•´é…ç½®
    
        Args:
            business_name: ä¸šåŠ¡åç§°ï¼Œå¯¹åº”JSONé…ç½®æ–‡ä»¶å
        
        Returns:
            ä¸šåŠ¡é…ç½®å¯¹è±¡ï¼ŒåŒ…å«æ§½ä½è§„æ ¼ã€æšä¸¾ã€æ¨¡æ¿ç­‰æ‰€æœ‰é…ç½®æ•°æ®
            å¦‚æœä¸šåŠ¡ä¸å­˜åœ¨è¿”å›None
        """
```

**æ¥å£è¯´æ˜**ï¼š

    ä¸šåŠ¡é…ç½®çš„ä¸»è®¿é—®æ¥å£ï¼Œæä¾›ç±»å‹å®‰å…¨çš„é…ç½®æ•°æ®è®¿é—®ã€‚æ”¯æŒé…ç½®çš„æ‡’åŠ è½½å’Œç¼“å­˜ç®¡ç†ã€‚

```python
    def inject_slot_specs(self, business_name: str, slot_specs: List[SlotSpec]):
        """
        åŠ¨æ€æ³¨å…¥æ§½ä½è§„æ ¼åˆ°ä¸šåŠ¡é…ç½®
    
        Args:
            business_name: ç›®æ ‡ä¸šåŠ¡åç§°
            slot_specs: æ§½ä½è§„æ ¼åˆ—è¡¨ï¼Œé€šå¸¸ä»DSLç”Ÿæˆ
        
        Note:
            æ­¤æ¥å£ç”¨äºDSLé©±åŠ¨çš„åŠ¨æ€é…ç½®ï¼Œå…è®¸è¿è¡Œæ—¶ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
        """
```

**æ¥å£è¯´æ˜**ï¼š

    åŠ¨æ€é…ç½®æ³¨å…¥æ¥å£ï¼Œå®ç°DSLä¸é™æ€é…ç½®çš„èåˆã€‚æ”¯æŒåœ¨è¿è¡Œæ—¶åŸºäºDSLè„šæœ¬è°ƒæ•´ä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚

```python
    def get_intent_recommendations(self, business_name: str) -> Dict[str, List[Dict[str, Any]]]:
        """
        è·å–ä¸šåŠ¡çš„æ„å›¾æ¨èé…ç½®
    
        Args:
            business_name: ä¸šåŠ¡åç§°
        
        Returns:
            æ„å›¾æ¨èé…ç½®å­—å…¸ï¼Œç»“æ„ä¸º:
            {
                "slot_name": [
                    {
                        "intent": "åœºæ™¯æè¿°",
                        "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"],
                        "recommend": "æ¨èå€¼",
                        "confidence": 0.75,
                        "reason": "æ¨èç†ç”±"
                    }
                ]
            }
        """
```

**æ¥å£è¯´æ˜**ï¼š

    æ™ºèƒ½æ¨èé…ç½®æ¥å£ï¼Œæä¾›åŸºäºå…³é”®è¯çš„è‡ªåŠ¨å¡«å……èƒ½åŠ›ã€‚æ”¯æŒå¤šæ§½ä½çš„ä¸ªæ€§åŒ–æ¨èç­–ç•¥ã€‚

### 5.3 è¡¨å•ç³»ç»Ÿæ¥å£

#### 5.3.1 FormBasedDialogSystem æ¥å£

**å®šä¹‰æ¥æº**ï¼šform_based_system.py

```python
class FormBasedDialogSystem:
    def __init__(self, business_line: str):
        """
        åˆå§‹åŒ–è¡¨å•å¯¹è¯ç³»ç»Ÿ
    
        Args:
            business_line: ä¸šåŠ¡çº¿æ ‡è¯†ï¼Œç”¨äºåŠ è½½å¯¹åº”çš„ä¸šåŠ¡é…ç½®
        """
```

**æ¥å£è¯´æ˜**ï¼š

    è¡¨å•ç³»ç»Ÿæ„é€ å‡½æ•°ï¼ŒåŸºäºä¸šåŠ¡çº¿æ ‡è¯†åˆå§‹åŒ–å®Œæ•´çš„è¡¨å•çŠ¶æ€ã€‚æ”¯æŒå¤šä¸šåŠ¡çº¿çš„å¹¶è¡Œè¿è¡Œã€‚

```python
    def process_input(self, user_input: str, llm_client, semantic_mapper) -> Dict[str, Any]:
        """
        å¤„ç†ç”¨æˆ·è¾“å…¥çš„æ ¸å¿ƒæ–¹æ³•
    
        Args:
            user_input: ç”¨æˆ·è¾“å…¥çš„è‡ªç„¶è¯­è¨€æ–‡æœ¬
            llm_client: LLMå®¢æˆ·ç«¯å®ä¾‹ï¼Œç”¨äºAIç†è§£
            semantic_mapper: è¯­ä¹‰æ˜ å°„å™¨å®ä¾‹ï¼Œç”¨äºæœ¬åœ°åŒ¹é…
        
        Returns:
            å®Œæ•´çš„å¤„ç†ç»“æœï¼ŒåŒ…å«:
            - slots_updated: æœ¬æ¬¡æ›´æ–°äº†çš„æ§½ä½åˆ—è¡¨
            - slots_filled: æœ¬æ¬¡å¡«å……å®Œæˆçš„æ§½ä½åˆ—è¡¨  
            - conflicts: æ£€æµ‹åˆ°çš„å†²çªåˆ—è¡¨
            - response: ç”Ÿæˆçš„ç³»ç»Ÿå“åº”æ–‡æœ¬
            - form_complete: è¡¨å•æ˜¯å¦å·²å®Œæ•´å¡«å……
            - should_exit: æ˜¯å¦åº”è¯¥é€€å‡ºå¯¹è¯
        """
```

**æ¥å£è¯´æ˜**ï¼š

    è¡¨å•å¤„ç†çš„æ ¸å¿ƒæ¥å£ï¼Œå®ç°å®Œæ•´çš„å¤šæ§½ä½ä¿¡æ¯é‡‡é›†æµç¨‹ã€‚é›†æˆä¸‰å±‚æŠ½å–ç­–ç•¥å’Œå†²çªæ£€æµ‹æœºåˆ¶ã€‚

```python
    def get_initial_prompt(self) -> str:
        """
        è·å–åˆå§‹æç¤ºä¿¡æ¯
    
        Returns:
            å¼•å¯¼ç”¨æˆ·å¼€å§‹è¡¨å•å¡«å†™çš„åˆå§‹æç¤ºæ–‡æœ¬
            å¦‚æœå·²ç»æ˜¾ç¤ºè¿‡æˆ–æ— éœ€æç¤ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        """
```

**æ¥å£è¯´æ˜**ï¼š

    åˆå§‹åŒ–å¼•å¯¼æ¥å£ï¼Œæä¾›ç”¨æˆ·å‹å¥½çš„æµç¨‹å¼€å§‹æç¤ºã€‚æ”¯æŒè‡ªåŠ¨å¡«å……å•é€‰é¡¹å’Œæ™ºèƒ½çŠ¶æ€åˆ¤æ–­ã€‚

```python
    def get_context(self) -> Dict[str, Any]:
        """
        è·å–å½“å‰è¡¨å•çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
    
        Returns:
            ä¸Šä¸‹æ–‡å­—å…¸ï¼ŒåŒ…å«å½“å‰å·²å¡«å……çš„æ‰€æœ‰æ§½ä½å€¼
            ç”¨äºè¯­ä¹‰æ˜ å°„å’ŒLLMç†è§£çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥
        """
```

**æ¥å£è¯´æ˜**ï¼š

    ä¸Šä¸‹æ–‡æä¾›æ¥å£ï¼Œæ”¯æŒè¯­ä¹‰ç†è§£å’ŒAIæ¨èçš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥ã€‚ç¡®ä¿æ¨èå’Œç†è§£çš„å‡†ç¡®æ€§ã€‚

### 5.4 è¯­ä¹‰ç†è§£æ¥å£

#### 5.4.1 SemanticMapper æ¥å£

**å®šä¹‰æ¥æº**ï¼šoption_mapping.py

```python
class SemanticMapper:
    @staticmethod
    def map(user_text: str, options: List[Option]) -> SemanticMatchResult:
        """
        å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè¯­ä¹‰æ˜ å°„åŒ¹é…
    
        Args:
            user_text: ç”¨æˆ·è¾“å…¥æ–‡æœ¬ï¼Œè¿›è¡Œå°å†™åŒ–å’Œæ¸…ç†å¤„ç†
            options: å€™é€‰é€‰é¡¹åˆ—è¡¨ï¼ŒåŒ…å«æ ‡ç­¾ã€åŒä¹‰è¯å’Œå…³é”®è¯
        
        Returns:
            è¯­ä¹‰åŒ¹é…ç»“æœï¼ŒåŒ…å«é€‰æ‹©çš„ç´¢å¼•ã€ç½®ä¿¡åº¦ã€åŸå› å’Œç­–ç•¥
            å¦‚æœæ²¡æœ‰è¶³å¤Ÿç½®ä¿¡åº¦çš„åŒ¹é…ï¼Œchosen_indexä¸ºNone
        """
```

**æ¥å£è¯´æ˜**ï¼š

    æœ¬åœ°è¯­ä¹‰åŒ¹é…çš„æ ¸å¿ƒæ¥å£ï¼ŒåŸºäºè§„åˆ™çš„å…³é”®è¯åŒ¹é…ã€‚æä¾›å¿«é€Ÿã€å¯è§£é‡Šçš„è¯­ä¹‰ç†è§£èƒ½åŠ›ï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡ã€‚

#### 5.4.2 OptionBuilder æ¥å£

**å®šä¹‰æ¥æº**ï¼šoption_mapping.py

```python
class OptionBuilder:
    @staticmethod
    def build(stage: str, context: Dict) -> List[Option]:
        """
        æ ¹æ®è¯­ä¹‰é˜¶æ®µå’Œä¸Šä¸‹æ–‡æ„å»ºå€™é€‰é€‰é¡¹
    
        Args:
            stage: è¯­ä¹‰é˜¶æ®µæ ‡è¯†ï¼Œå¦‚'chip_select'ã€'storage_select'
            context: ä¸Šä¸‹æ–‡å­—å…¸ï¼ŒåŒ…å«å½“å‰å·²é€‰çš„æ§½ä½å€¼
        
        Returns:
            å€™é€‰é€‰é¡¹åˆ—è¡¨ï¼ŒåŒ…å«ç´¢å¼•ã€ä»£ç ã€æ ‡ç­¾å’Œè¯­ä¹‰ä¿¡æ¯
            å¦‚æœæ²¡æœ‰åŒ¹é…çš„é˜¶æ®µï¼Œè¿”å›ç©ºåˆ—è¡¨
        """
```

**æ¥å£è¯´æ˜**ï¼š

    åŠ¨æ€é€‰é¡¹æ„å»ºæ¥å£ï¼Œæ”¯æŒåŸºäºä¸Šä¸‹æ–‡çš„æ™ºèƒ½é€‰é¡¹ç”Ÿæˆã€‚å®ç°ä¸šåŠ¡è§„åˆ™çš„åŠ¨æ€åº”ç”¨å’Œä¸ªæ€§åŒ–æ¨èã€‚

### 5.5 LLMæœåŠ¡æ¥å£

#### 5.5.1 SparkLLMClient æ¥å£

**å®šä¹‰æ¥æº**ï¼šspark_client.py

```python
class SparkLLMClient(ILLMClient):
    def __init__(self, api_key: str, api_url: str = None, model: str = None):
        """
        åˆå§‹åŒ–LLMå®¢æˆ·ç«¯
    
        Args:
            api_key: APIè®¤è¯å¯†é’¥ï¼Œæ”¯æŒBearer Tokenæ ¼å¼
            api_url: APIç«¯ç‚¹URLï¼Œå¯é€‰ï¼Œæœ‰é»˜è®¤å€¼
            model: ä½¿ç”¨çš„æ¨¡å‹åç§°ï¼Œå¯é€‰ï¼Œæœ‰é»˜è®¤å€¼
        """
```

**æ¥å£è¯´æ˜**ï¼š

    LLMå®¢æˆ·ç«¯æ„é€ å‡½æ•°ï¼Œæ”¯æŒçµæ´»çš„é…ç½®å’Œé»˜è®¤å€¼ã€‚ç¡®ä¿ä¸è®¯é£æ˜Ÿç«APIçš„å…¼å®¹æ€§ã€‚

```python
    def extract_slots(self, user_input: str, business_line: str, 
                     target_slots: List[str], current_values: Optional[Dict[str, Any]] = None) -> Dict[str, Dict[str, Any]]:
        """
        ä»ç”¨æˆ·è¾“å…¥ä¸­æŠ½å–å¤šä¸ªæ§½ä½ä¿¡æ¯
    
        Args:
            user_input: ç”¨æˆ·è¾“å…¥çš„è‡ªç„¶è¯­è¨€æ–‡æœ¬
            business_line: ä¸šåŠ¡çº¿æ ‡è¯†ï¼Œç”¨äºæ„é€ é¢†åŸŸç‰¹å®šçš„æç¤º
            target_slots: ç›®æ ‡æŠ½å–çš„æ§½ä½åç§°åˆ—è¡¨
            current_values: å½“å‰å·²å¡«å……çš„æ§½ä½å€¼ï¼Œç”¨äºä¸Šä¸‹æ–‡ç†è§£
        
        Returns:
            æ§½ä½æŠ½å–ç»“æœå­—å…¸ï¼Œç»“æ„ä¸º:
            {
                "slot_name": {
                    "value": "æŠ½å–çš„å€¼",
                    "confidence": 0.8,
                    "reason": "æŠ½å–ç†ç”±"
                }
            }
        """
```

**æ¥å£è¯´æ˜**ï¼š

    å¤šæ§½ä½æŠ½å–çš„æ ¸å¿ƒæ¥å£ï¼Œåˆ©ç”¨LLMå®ç°å¤æ‚è¡¨è¾¾çš„æ™ºèƒ½ç†è§£ã€‚æ”¯æŒä¸Šä¸‹æ–‡æ„ŸçŸ¥å’Œä¸šåŠ¡é¢†åŸŸé€‚é…ã€‚

## 6. æ ¸å¿ƒç®—æ³•å®ç°

### 6.1 ä¸‰å±‚ä¿¡æ¯æŠ½å–ç®—æ³•

#### 6.1.1 æ€»ä½“æŠ½å–ç­–ç•¥

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _extract_multiple_slots(self, user_input: str, llm_client, semantic_mapper) -> Dict[str, SlotValue]:
    """ä»ç”¨æˆ·è¾“å…¥ä¸­æŠ½å–å¤šä¸ªæ§½ä½ä¿¡æ¯çš„ä¸‰å±‚ç­–ç•¥"""
    extracted = {}
  
    # Layer 1: ç›´æ¥å…³é”®è¯åŒ¹é…ï¼ˆé«˜ç½®ä¿¡åº¦ï¼‰
    direct_matches = self._direct_keyword_extraction(user_input)
    extracted.update(direct_matches)
  
    # Layer 2: æ™ºèƒ½æ¨èå±‚ï¼ˆåŸºäºæ„å›¾å’Œè¯­ä¹‰ï¼‰
    missing_slots = [name for name, slot in self.current_form.items() 
                    if slot.status == SlotStatus.EMPTY and name not in extracted]
  
    for slot_name in missing_slots:
        # ä¼˜å…ˆä½¿ç”¨è¯­ä¹‰é˜¶æ®µåŠ¨æ€è¿‡æ»¤
        semantic_result = self._semantic_slot_extraction(user_input, slot_name, semantic_mapper)
        if semantic_result:
            extracted[slot_name] = semantic_result
            continue
    
        # æ„å›¾æ¨èä½œä¸ºè¯­ä¹‰æ˜ å°„çš„è¡¥å……
        intent_result = self._intent_based_recommendation(user_input, slot_name)
        if intent_result:
            extracted[slot_name] = intent_result
  
    # Layer 3: LLMå…¨å±€æŠ½å–ï¼ˆå…œåº•ç­–ç•¥ï¼‰
    all_missing_slots = [name for name, slot in self.current_form.items() 
                        if slot.status == SlotStatus.EMPTY]
    llm_result = self._llm_slot_extraction(user_input, all_missing_slots, llm_client)
    for slot_name, slot_value in llm_result.items():
        if slot_name not in extracted:  # ä¼˜å…ˆçº§æ§åˆ¶
            extracted[slot_name] = slot_value
        
    return extracted
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†ä¸‰å±‚æ¸è¿›å¼ä¿¡æ¯æŠ½å–ç­–ç•¥ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯åœ¨ä¿è¯ç†è§£å‡†ç¡®æ€§çš„åŒæ—¶æœ€å¤§åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚è¿™ç§åˆ†å±‚æ¶æ„æºäºæˆ‘åœ¨ç¬¬äºŒä»£ç³»ç»Ÿä¸­å®Œå…¨ä¾èµ–LLMæ—¶é‡åˆ°çš„æ€§èƒ½ç“¶é¢ˆé—®é¢˜ã€‚é€šè¿‡å°†ç†è§£ä»»åŠ¡æŒ‰å¤æ‚åº¦åˆ†é…åˆ°ä¸åŒå±‚çº§ï¼Œå®ç°äº†ä»ç²¾ç¡®åˆ°æ¨¡ç³Šçš„æ¸è¿›å¼ç†è§£ï¼Œæ—¢å‡å°‘äº†LLMè°ƒç”¨æˆæœ¬ï¼Œåˆæå‡äº†ç”¨æˆ·ä½“éªŒã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	è¯¥ç­–ç•¥æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œï¼šLayer 1å¤„ç†é«˜é¢‘ç¡®å®šçš„åŒ¹é…åœºæ™¯ï¼Œä½¿ç”¨æœ¬åœ°ç®—æ³•å¿«é€Ÿå“åº”ï¼›Layer 2å®ç°ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„æ™ºèƒ½æ¨èï¼ŒåŸºäºä¸šåŠ¡è§„åˆ™å’Œç”¨æˆ·æ„å›¾æä¾›ä¸ªæ€§åŒ–é€‰é¡¹ï¼›Layer 3ä½œä¸ºå…œåº•æ–¹æ¡ˆï¼Œç”¨AIå¤„ç†å¤æ‚è¡¨è¾¾ã€‚ä¼˜å…ˆçº§æ§åˆ¶ç¡®ä¿é«˜ç½®ä¿¡åº¦ç»“æœä¼˜å…ˆä½¿ç”¨ï¼Œé¿å…LLMç»“æœè¦†ç›–æ›´å‡†ç¡®çš„æœ¬åœ°åŒ¹é…ã€‚

#### 6.1.2 ç›´æ¥å…³é”®è¯åŒ¹é…ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _direct_keyword_extraction(self, user_input: str) -> Dict[str, SlotValue]:
    """ç›´æ¥å…³é”®è¯åŒ¹é…ç®—æ³•"""
    extracted = {}
    text_lower = user_input.lower().strip()
    candidates = {}  # æ”¶é›†æ¯ä¸ªæ§½ä½çš„åŒ¹é…å€™é€‰
  
    # ä»…æ‰«æç¼ºå¤±æ§½ä½ï¼Œä¼˜åŒ–æ€§èƒ½
    for slot_name, slot_def in self.form_template.items():
        if self.current_form[slot_name].status != SlotStatus.EMPTY:
            continue  # è·³è¿‡å·²å¡«å……æ§½ä½
    
        enum_key = slot_def.enums_key
        enum_list = business_config_loader.get_enums(self.business_line).get(enum_key, [])
    
        for enum_item in enum_list:
            label = enum_item.get("label", "")
            aliases = enum_item.get("aliases", [])
        
            # å¤šç­–ç•¥åŒ¹é…
            matched = False
            matched_keyword = None
            best_match_length = 0
        
            for alias in aliases:
                alias_lower = alias.lower()
                # ç­–ç•¥1: å®Œå…¨ç›¸ç­‰åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                if text_lower == alias_lower:
                    matched = True
                    matched_keyword = alias
                    break
                # ç­–ç•¥2: è¾¹ç•Œå­ä¸²åŒ¹é…ï¼ˆé¿å…è¯¯åŒ¹é…ï¼‰
                elif len(alias_lower) > best_match_length:
                    pattern = r'(^|[^a-z0-9])' + re.escape(alias_lower) + r'($|[^a-z0-9])'
                    if re.search(pattern, text_lower):
                        matched = True
                        matched_keyword = alias
                        best_match_length = len(alias_lower)
        
            if matched:
                # ç½®ä¿¡åº¦è®¡ç®—å’Œå€™é€‰æ”¶é›†
                confidence = 0.95  # ç›´æ¥åŒ¹é…é«˜ç½®ä¿¡åº¦
                if slot_name not in candidates:
                    candidates[slot_name] = []
                candidates[slot_name].append((label, confidence, f"å…³é”®è¯'{matched_keyword}'åŒ¹é…", best_match_length))
  
    # æ¶ˆæ­§å¤„ç†ï¼šæ¯ä¸ªæ§½ä½é€‰æ‹©æœ€ä½³åŒ¹é…
    for slot_name, matches in candidates.items():
        if matches:
            best_match = max(matches, key=lambda x: (x[3], x[1]))  # é•¿åº¦ä¼˜å…ˆï¼Œå…¶æ¬¡ç½®ä¿¡åº¦
            label, confidence, reason, _ = best_match
            extracted[slot_name] = SlotValue(label, confidence, "direct", reason)
  
    return extracted
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†åŸºäºé…ç½®åˆ«åçš„ç²¾ç¡®åŒ¹é…æœºåˆ¶ï¼Œä¸“é—¨å¤„ç†ç”¨æˆ·è¾“å…¥ä¸­çš„æ˜ç¡®æšä¸¾å€¼ã€‚è¿™ä¸ªè®¾è®¡çš„æ ¸å¿ƒæ´å¯Ÿæ˜¯ï¼šå¤§å¤šæ•°ç”¨æˆ·å¯¹è¯éƒ½åŒ…å«æ˜ç¡®çš„äº§å“åç§°æˆ–é€‰é¡¹ï¼Œå®Œå…¨å¯ä»¥é€šè¿‡æœ¬åœ°åŒ¹é…å¿«é€Ÿå¤„ç†ï¼Œæ— éœ€è°ƒç”¨æ˜‚è´µçš„LLMæœåŠ¡ã€‚é€šè¿‡è¾¹ç•ŒåŒ¹é…ç­–ç•¥å’Œé€‰æ‹©æ€§æ‰«æä¼˜åŒ–ï¼Œåœ¨ä¿è¯å‡†ç¡®æ€§çš„åŒæ—¶æ˜¾è‘—æå‡æ€§èƒ½ã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	ç®—æ³•ä»…æ‰«ææœªå¡«å……æ§½ä½ï¼Œé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ç¡®ä¿å…³é”®è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…è¯¯åŒ¹é…é—®é¢˜ã€‚æ”¯æŒå¤šçº§åŒ¹é…ç­–ç•¥ï¼Œå®Œå…¨ç›¸ç­‰åŒ¹é…ä¼˜å…ˆï¼Œè¾¹ç•Œå­ä¸²åŒ¹é…å…œåº•ã€‚å¯¹äºç³»åˆ—åç§°ç­‰æ˜“æ­§ä¹‰åœºæ™¯ï¼Œå®æ–½ç‰¹æ®Šå¤„ç†è§„åˆ™ï¼Œå¦‚è¦æ±‚"pro"å¿…é¡»å‡ºç°åœ¨å®Œæ•´ç³»åˆ—åä¸­ã€‚ç®—æ³•è¿˜æ”¯æŒæ™ºèƒ½æ¨æ–­ï¼Œä»ç³»åˆ—åè‡ªåŠ¨æ¨å¯¼å“ç±»å’Œå“ç‰Œï¼Œå‡å°‘ç”¨æˆ·é‡å¤è¾“å…¥ã€‚

#### 6.1.3 è¯­ä¹‰æ˜ å°„æŠ½å–ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _semantic_slot_extraction(self, user_input: str, slot_name: str, semantic_mapper) -> Optional[SlotValue]:
    """åŸºäºè¯­ä¹‰é˜¶æ®µçš„æ™ºèƒ½æ˜ å°„"""
    slot_def = self.form_template.get(slot_name)
    if not slot_def or not slot_def.semantic_stage:
        return None
  
    # æ„å»ºä¸Šä¸‹æ–‡å¹¶è·å–è¯­ä¹‰é€‰é¡¹
    context = self.get_context()
    options = OptionBuilder.build(slot_def.semantic_stage, context)
    if not options:
        return None
  
    # æ‰§è¡Œè¯­ä¹‰åŒ¹é…
    match_result = semantic_mapper.map(user_input, options)
    if match_result.chosen_index is None:
        return None
  
    # è½¬æ¢ä¸ºæ§½ä½å€¼
    chosen_opt = options[match_result.chosen_index - 1]
    return SlotValue(
        value=chosen_opt.label,
        confidence=match_result.confidence,
        source="semantic",
        reason=match_result.reason
    )
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†åŸºäºè¯­ä¹‰é˜¶æ®µçš„åŠ¨æ€é€‰é¡¹æ„å»ºæœºåˆ¶ï¼Œè§£å†³å›ºå®šæšä¸¾åˆ—è¡¨æ— æ³•é€‚åº”å¤æ‚ä¸šåŠ¡åœºæ™¯çš„é—®é¢˜ã€‚è¿™ä¸ªè®¾è®¡çš„çµæ„Ÿæ¥è‡ªäºå®é™…ä¸šåŠ¡éœ€æ±‚ï¼šä¸åŒäº§å“ç»„åˆä¸‹ï¼Œå¯ç”¨é€‰é¡¹åº”è¯¥åŠ¨æ€å˜åŒ–ã€‚é€šè¿‡è¯­ä¹‰é˜¶æ®µæ ‡è¯†å’Œä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼Œå®ç°äº†çœŸæ­£æ™ºèƒ½çš„é€‰é¡¹æ¨èï¼Œè€Œä¸ä»…ä»…æ˜¯é™æ€åˆ—è¡¨å±•ç¤ºã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	ç®—æ³•æ ¹æ®æ§½ä½çš„semantic_stageæ ‡è¯†å’Œå½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ï¼ŒåŠ¨æ€æ„å»ºå€™é€‰é€‰é¡¹åˆ—è¡¨ã€‚åˆ©ç”¨OptionBuilderåŸºäºä¸šåŠ¡è§„åˆ™è¿‡æ»¤å’Œæ’åºé€‰é¡¹ï¼Œç¡®ä¿æ¨èçš„åˆç†æ€§ã€‚é€šè¿‡SemanticMapperæ‰§è¡Œæœ¬åœ°è¯­ä¹‰åŒ¹é…ï¼Œè®¡ç®—ç”¨æˆ·è¾“å…¥ä¸å€™é€‰é€‰é¡¹çš„ç›¸ä¼¼åº¦ã€‚è¿™ç§è®¾è®¡å°†ä¸šåŠ¡è§„åˆ™ä»ä»£ç ä¸­æŠ½ç¦»ï¼Œæ”¯æŒé€šè¿‡é…ç½®å®šä¹‰å¤æ‚çš„é€‰é¡¹è¿‡æ»¤é€»è¾‘ã€‚

### 6.2 å†²çªæ£€æµ‹ä¸è§£å†³ç®—æ³•

#### 6.2.1 å†²çªæ£€æµ‹ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _should_trigger_conflict(self, existing_value: SlotValue, new_value: SlotValue) -> bool:
    """å†²çªè§¦å‘æ¡ä»¶åˆ¤æ–­ç®—æ³•"""
    # ç›¸åŒå€¼ä¸å†²çª
    if existing_value.value == new_value.value:
        return False
    
    # å†²çªè§¦å‘ç­–ç•¥ï¼š
    # 1. é«˜ç½®ä¿¡åº¦çš„æ–°å€¼ä¸ç°æœ‰å€¼ä¸åŒ
    if new_value.confidence >= 0.6:
        return True
    
    # 2. ä¸åŒæ¥æºçš„å€¼ä¼˜å…ˆçº§æ¯”è¾ƒ
    source_priorities = {
        "direct": 3,      # ç›´æ¥å…³é”®è¯åŒ¹é…
        "numeric": 2,     # æ•°å­—é€‰æ‹©
        "semantic": 2,    # è¯­ä¹‰æ˜ å°„  
        "single_match": 2,# å”¯ä¸€åŒ¹é…
        "llm": 1,         # å•ä¸ªLLMè¯†åˆ«
        "multi_llm": 1,   # å¤šæ§½ä½LLMè¯†åˆ«
        "intent_recommend": 1  # æ„å›¾æ¨è
    }
  
    existing_priority = source_priorities.get(existing_value.source, 0)
    new_priority = source_priorities.get(new_value.source, 0)
  
    # å¦‚æœæ–°å€¼ä¼˜å…ˆçº§è¶³å¤Ÿé«˜ï¼Œä¸”ç½®ä¿¡åº¦ä¸æ˜¯å¤ªä½ï¼Œè§¦å‘å†²çª
    if new_priority >= existing_priority and new_value.confidence >= 0.4:
        return True
    
    # 3. ç‰¹æ®Šæƒ…å†µï¼šAIè¯†åˆ«ä¸ç›´æ¥è¯†åˆ«å†²çªæ—¶ï¼Œæ€»æ˜¯æç¤ºç”¨æˆ·ç¡®è®¤
    if ((existing_value.source == "direct" and new_value.source in ["llm", "multi_llm"]) or
        (existing_value.source in ["llm", "multi_llm"] and new_value.source == "direct")):
        return True
    
    return False
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†å¤šç»´åº¦å†²çªæ£€æµ‹ç­–ç•¥ï¼Œè§£å†³ç”¨æˆ·ä¸­é€”ä¿®æ”¹é€‰æ‹©å¯¼è‡´çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚è¿™ä¸ªè®¾è®¡åŸºäºå¯¹çœŸå®å¯¹è¯åœºæ™¯çš„è§‚å¯Ÿï¼šç”¨æˆ·ç»å¸¸åœ¨å¯¹è¯è¿‡ç¨‹ä¸­è°ƒæ•´éœ€æ±‚ï¼Œç³»ç»Ÿéœ€è¦æ™ºèƒ½è¯†åˆ«è¿™äº›è°ƒæ•´å¹¶å¦¥å–„å¤„ç†ã€‚é€šè¿‡ç»¼åˆè€ƒè™‘ç½®ä¿¡åº¦ã€æ¥æºä¼˜å…ˆçº§å’Œç‰¹æ®Šåœºæ™¯ï¼Œå®ç°äº†ç²¾ç¡®çš„å†²çªè¯†åˆ«ã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	ç®—æ³•é¦–å…ˆæ£€æŸ¥å€¼æ˜¯å¦ç›¸åŒï¼Œç›¸åŒå€¼ä¸è§¦å‘å†²çªã€‚ç„¶ååŸºäºç½®ä¿¡åº¦é˜ˆå€¼åˆ¤æ–­ï¼Œé«˜ç½®ä¿¡åº¦æ–°å€¼ä¼˜å…ˆè§¦å‘å†²çªã€‚æ¥ç€æ¯”è¾ƒæ¥æºä¼˜å…ˆçº§ï¼Œç›´æ¥åŒ¹é…ä¼˜äºè¯­ä¹‰æ˜ å°„ï¼Œè¯­ä¹‰æ˜ å°„ä¼˜äºLLMè¯†åˆ«ã€‚ç‰¹åˆ«å¤„ç†AIè¯†åˆ«ä¸ç›´æ¥è¯†åˆ«çš„äº¤å‰å†²çªï¼Œç¡®ä¿é‡è¦å†²çªè¢«åŠæ—¶æ£€æµ‹ã€‚è¿™ç§åˆ†å±‚åˆ¤æ–­ç­–ç•¥åœ¨ä¿è¯æ•°æ®è´¨é‡çš„åŒæ—¶é¿å…ä¸å¿…è¦çš„ç”¨æˆ·æ‰“æ‰°ã€‚

#### 6.2.2 å†²çªè§£å†³ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _resolve_conflict(self, slot_name: str, decision: str):
    """å†²çªè§£å†³å¤„ç†ç®—æ³•"""
    slot = self.current_form.get(slot_name)
    if not slot:
        return
    
    old_value = slot.value.value if slot.value else "(æ— )"
  
    if decision == "1":
        # ä¿ç•™åŸå€¼ï¼Œä¸¢å¼ƒå€™é€‰
        slot.status = SlotStatus.FILLED
        slot.candidates = []
    
    elif decision == "2":
        # ä½¿ç”¨æ–°å€¼ï¼šæ¸…ç©ºè¯¥æ§½ä½åŠå…¶ä¾èµ–é“¾ï¼Œç„¶åå¡«å……æ–°å€¼
        if slot.candidates:
            new_val = slot.candidates[-1]
        
            # å…ˆæ¸…ç©ºä¾èµ–é“¾ï¼ˆé¿å…æ—§å€¼æ®‹ç•™ï¼‰
            self._clear_slot_and_dependencies(slot_name)
        
            # å¡«å……æ–°å€¼
            slot.value = new_val
            slot.status = SlotStatus.FILLED if new_val.confidence >= 0.7 else SlotStatus.PARTIAL
            slot.candidates = []
        
    elif decision == "3":
        # æ¸…ç©ºè¯¥æ§½ä½åŠå…¶ä¾èµ–é“¾ï¼Œç­‰å¾…é‡æ–°è¾“å…¥
        self._clear_slot_and_dependencies(slot_name)
  
    # æ¸…ç†å†²çªçŠ¶æ€
    self.awaiting_conflict_slot = None
    self.pending_conflicts = [c for c in self.pending_conflicts if c.get("slot") != slot_name]
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†åŸºäºä¾èµ–é“¾çš„å†²çªè§£å†³æ–¹æ¡ˆï¼Œå½»åº•è§£å†³ç¬¬äºŒä»£ç³»ç»Ÿä¸­å¤æ‚çš„å¤šå€¼åŒæ­¥é—®é¢˜ã€‚è¿™ä¸ªè®¾è®¡çš„æ ¸å¿ƒåˆ›æ–°æ˜¯"æœ€å°é—­åŒ…æ¸…ç©º"ç­–ç•¥ï¼šå½“ç”¨æˆ·é€‰æ‹©ä¿®æ”¹æŸä¸ªå€¼æ—¶ï¼Œè‡ªåŠ¨æ¸…ç©ºå…¶æ‰€æœ‰ä¸‹æ¸¸ä¾èµ–æ§½ä½ï¼Œé¿å…æ®‹ç•™æ—§å€¼å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚è¿™ç§è®¾è®¡ç®€åŒ–äº†çŠ¶æ€ç®¡ç†ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯é æ€§ã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	ç®—æ³•æä¾›ä¸‰ç§è§£å†³ç­–ç•¥ï¼šä¿ç•™åŸå€¼ã€ä½¿ç”¨æ–°å€¼å’Œæ¸…ç©ºé‡å¡«ã€‚å…³é”®æ”¹è¿›æ˜¯åœ¨ä½¿ç”¨æ–°å€¼æˆ–æ¸…ç©ºé‡å¡«æ—¶ï¼Œé€’å½’æ¸…ç©ºç›®æ ‡æ§½ä½çš„æ‰€æœ‰ä¾èµ–æ§½ä½ã€‚è¿™ç§ä¾èµ–é“¾ç®¡ç†ç¡®ä¿ä¸šåŠ¡è§„åˆ™çš„ä¸€è‡´æ€§ï¼Œæ¯”å¦‚æ›´æ¢å“ç‰Œåè‡ªåŠ¨æ¸…ç©ºç³»åˆ—ã€é…ç½®ç­‰ä¾èµ–é€‰æ‹©ã€‚ç®—æ³•è¿˜ç»´æŠ¤å†²çªçŠ¶æ€æ¸…ç†ï¼Œé˜²æ­¢æ®‹ç•™çŠ¶æ€å½±å“åç»­å¯¹è¯æµç¨‹ã€‚

### 6.3 åŠ¨æ€æšä¸¾è¿‡æ»¤ç®—æ³•

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _get_filtered_options(self, enum_key: str) -> List[Dict[str, Any]]:
    """åŠ¨æ€æšä¸¾è¿‡æ»¤ç®—æ³•"""
    raw_options = get_slot_options(enum_key, self.business_line)
    if not raw_options:
        return []
  
    # ä»…è‹¹æœä¸“å–åº—æ‰§è¡ŒåŠ¨æ€è¿‡æ»¤
    if self.business_line != "apple_store":
        return raw_options
  
    # è·å–å½“å‰ä¸Šä¸‹æ–‡ç”¨äºè¿‡æ»¤
    category = self.current_form.get("category")
    category_val = category.value.value if category and category.value else None
  
    series = self.current_form.get("series") 
    series_val = series.value.value if series and series.value else None
  
    # åº”ç”¨å±‚çº§è¿‡æ»¤è§„åˆ™
    if enum_key == "series" and category_val:
        allowed_series = self.business_filters.get("series_by_category", {}).get(category_val)
        if allowed_series:
            return [opt for opt in raw_options if opt.get("label") in allowed_series]
  
    elif enum_key == "size":
        # ä¼˜å…ˆæŒ‰seriesè¿‡æ»¤ï¼Œå…¶æ¬¡æŒ‰category
        if series_val:
            allowed_sizes = self.business_filters.get("size_by_series", {}).get(series_val)
            if allowed_sizes:
                return [opt for opt in raw_options if opt.get("label") in allowed_sizes]
    
        if category_val:
            allowed_sizes = self.business_filters.get("size_by_category", {}).get(category_val)
            if allowed_sizes:
                return [opt for opt in raw_options if opt.get("label") in allowed_sizes]
  
    elif enum_key == "chip" and category_val:
        allowed_chips = self.business_filters.get("chip_by_category", {}).get(category_val)
        if allowed_chips:
            return [opt for opt in raw_options if opt.get("label") in allowed_chips]
  
    elif enum_key == "storage" and category_val:
        allowed_storage = self.business_filters.get("storage_by_category", {}).get(category_val)
        if allowed_storage:
            filtered = [opt for opt in raw_options if opt.get("label") in allowed_storage]
            # å­˜å‚¨ç‰¹æ®Šå¤„ç†ï¼šç”µè„‘ä¸æ˜¾ç¤º128/256GB
            if category_val == "ç”µè„‘":
                filtered = [opt for opt in filtered if opt.get("label") in {"512GB", "1TB", "2TB"}]
            return filtered
  
    # é»˜è®¤è¿”å›åŸå§‹é€‰é¡¹
    return raw_options
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†å±‚çº§è¿‡æ»¤ç­–ç•¥ç”¨äºç›¸å¯¹å¤æ‚çš„ä¿¡æ¯æ”¶å–åœºæ™¯ï¼ˆå¦‚è‹¹æœä¸“å–åº—åœºæ™¯ï¼‰ï¼Œå®ç°åŸºäºä¸Šä¸‹æ–‡çš„æ™ºèƒ½é€‰é¡¹æ¨èã€‚è¿™ä¸ªè®¾è®¡è§£å†³äº†é™æ€æšä¸¾åˆ—è¡¨æ— æ³•é€‚åº”å¤æ‚äº§å“å…³ç³»çš„ç—›ç‚¹ã€‚é€šè¿‡åˆ†æè‹¹æœäº§å“çº¿çš„å®é™…ä¸šåŠ¡è§„åˆ™ï¼Œæˆ‘å»ºç«‹äº†å¤šçº§è¿‡æ»¤æ˜ å°„ï¼Œç¡®ä¿ç”¨æˆ·åœ¨æ¯ä¸ªæ­¥éª¤éƒ½åªèƒ½çœ‹åˆ°å½“å‰ä¸Šä¸‹æ–‡ä¸­æœ‰æ•ˆçš„é€‰é¡¹ã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	ç®—æ³•æ ¹æ®å½“å‰å·²é€‰æ‹©çš„æ§½ä½å€¼åŠ¨æ€è¿‡æ»¤åç»­é€‰é¡¹ã€‚é‡‡ç”¨ä¼˜å…ˆçº§ç­–ç•¥ï¼šä¼˜å…ˆä½¿ç”¨å…·ä½“çš„è¿‡æ»¤æ¡ä»¶ï¼ˆå¦‚ç³»åˆ—çº§åˆ«çš„å°ºå¯¸è¿‡æ»¤ï¼‰ï¼Œå…¶æ¬¡ä½¿ç”¨é€šç”¨æ¡ä»¶ï¼ˆå¦‚å“ç±»çº§åˆ«çš„èŠ¯ç‰‡è¿‡æ»¤ï¼‰ã€‚å¯¹äºç‰¹æ®Šä¸šåŠ¡è§„åˆ™ï¼ˆå¦‚ç”µè„‘ä¸æ˜¾ç¤º128GBå­˜å‚¨ï¼‰ï¼Œåœ¨é€šç”¨è¿‡æ»¤åŸºç¡€ä¸Šè¿›ä¸€æ­¥ç»†åŒ–ã€‚è¿™ç§è®¾è®¡å°†å¤æ‚çš„ä¸šåŠ¡è§„åˆ™å°è£…åœ¨é…ç½®ä¸­ï¼Œæ”¯æŒçµæ´»è°ƒæ•´è€Œä¸å½±å“æ ¸å¿ƒä»£ç ã€‚

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šåŠŸèƒ½å®ç°ä¸å·¥ç¨‹å®è·µ

## 7. å…³é”®åŠŸèƒ½æµç¨‹å®ç°

### 7.1 ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹

#### 7.1.1 å®Œæ•´åˆå§‹åŒ–åºåˆ—

**å®ç°æ¥æº**ï¼šmain.py, business_config_loader.py

```python
def main():
    """ç³»ç»Ÿä¸»åˆå§‹åŒ–æµç¨‹"""
    # 1. åŸºç¡€é…ç½®éªŒè¯
    if not Config.validate_config():
        print("é…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒå˜é‡å’Œç›®å½•ç»“æ„")
        return
  
    # 2. ä¸šåŠ¡æµç¨‹é€‰æ‹©
    business_line, yaml_file = choose_flow()
  
    try:
        # 3. DSLè„šæœ¬åŠ è½½å’ŒéªŒè¯
        print(f"ğŸ“„ æ­£åœ¨åŠ è½½æµç¨‹å®šä¹‰: {yaml_file}")
        flow_config = YAMLFlowLoader.load(yaml_file)
        flow_info = YAMLFlowLoader.get_flow_info(flow_config)
    
        # 4. ä»DSLæ„å»ºæ§½ä½è§„æ ¼
        slot_specs = []
        for slot_name in flow_config['process_order']:
            slot_cfg = flow_config['slots'].get(slot_name, {})
            if slot_cfg:
                slot_spec = SlotSpec(
                    name=slot_name,
                    required=slot_cfg.get('required', True),
                    description=slot_cfg.get('description', slot_cfg.get('label', '')),
                    dependencies=slot_cfg.get('dependencies', []),
                    enums_key=slot_cfg.get('enums_key'),
                    semantic_stage=slot_cfg.get('semantic_stage'),
                    allow_llm=slot_cfg.get('allow_llm', False)
                )
                slot_specs.append(slot_spec)
    
        # 5. åŠ¨æ€æ³¨å…¥æ§½ä½è§„æ ¼åˆ°ä¸šåŠ¡é…ç½®
        business_config_loader.inject_slot_specs(business_line, slot_specs)
    
        # 6. åˆ›å»ºæ ¸å¿ƒç³»ç»Ÿç»„ä»¶
        form = FormBasedDialogSystem(business_line)
        interpreter = FlowInterpreter(flow_config, form)
    
        # 7. åˆ›å»ºæœåŠ¡ç»„ä»¶
        semantic_mapper = SemanticMapper()
        llm_client = build_llm_client()  # å¯èƒ½è¿”å›Noneï¼ˆé™çº§æ¨¡å¼ï¼‰
    
        # 8. è§¦å‘åˆå§‹äº‹ä»¶
        if interpreter.last_response:
            display_response(interpreter.last_response)
        
    except Exception as e:
        print(f"ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: {e}")
        return
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†åˆ†å±‚æ„å»ºçš„ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹ï¼Œç¡®ä¿å„ç»„ä»¶æŒ‰æ­£ç¡®ä¾èµ–é¡ºåºåˆ›å»ºå’Œé…ç½®ã€‚è¿™ä¸ªè®¾è®¡çš„å…³é”®åœ¨äºDSLé©±åŠ¨çš„åŠ¨æ€é…ç½®æ³¨å…¥ï¼Œå…è®¸åœ¨è¿è¡Œæ—¶åŸºäºYAMLè„šæœ¬è°ƒæ•´ä¸šåŠ¡é€»è¾‘ã€‚é€šè¿‡ä¸¥æ ¼çš„é…ç½®éªŒè¯å’Œé”™è¯¯å¤„ç†ï¼Œä¿è¯ç³»ç»Ÿåœ¨é…ç½®å¼‚å¸¸æ—¶ä»èƒ½ä¼˜é›…é™çº§ã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	åˆå§‹åŒ–æµç¨‹ä»åŸºç¡€é…ç½®éªŒè¯å¼€å§‹ï¼Œç¡®ä¿ç¯å¢ƒå°±ç»ªã€‚ç„¶ååŠ è½½å’ŒéªŒè¯YAML DSLé…ç½®ï¼Œä»æµç¨‹å®šä¹‰ä¸­æå–æ§½ä½è§„æ ¼ã€‚é€šè¿‡åŠ¨æ€æ³¨å…¥æœºåˆ¶å°†DSLé…ç½®ä¸é™æ€ä¸šåŠ¡é…ç½®èåˆã€‚æœ€åæŒ‰ä¾èµ–é¡ºåºåˆ›å»ºæ ¸å¿ƒç»„ä»¶å’ŒæœåŠ¡ç»„ä»¶ï¼Œè§¦å‘åˆå§‹äº‹ä»¶å®Œæˆå¯åŠ¨ã€‚æ•´ä¸ªè¿‡ç¨‹æ”¯æŒå¤šä¸šåŠ¡çº¿å¹¶è¡Œåˆå§‹åŒ–ï¼Œä¸ºç³»ç»Ÿæ‰©å±•æ€§å¥ å®šåŸºç¡€ã€‚

#### 7.1.2 ä¸šåŠ¡é…ç½®åŠ è½½æµç¨‹

**å®ç°æ¥æº**ï¼šbusiness_config_loader.py

```python
def _load_business_config(self, business_name: str, config_path: str):
    """å•ä¸ªä¸šåŠ¡é…ç½®åŠ è½½å®ç°"""
    with open(config_path, 'r', encoding='utf-8') as f:
        data = json.load(f)
  
    # è§£æä¸šåŠ¡ä¿¡æ¯
    business_info = data.get('business_info', {})
  
    # è§£ææ§½ä½è§„æ ¼
    slot_specs = []
    for spec_data in data.get('slot_specs', []):
        slot_spec = SlotSpec(
            name=spec_data['name'],
            required=spec_data['required'],
            description=spec_data['description'],
            dependencies=spec_data.get('dependencies', []),
            enums_key=spec_data.get('enums_key'),
            semantic_stage=spec_data.get('semantic_stage'),
            allow_llm=spec_data.get('allow_llm', False)
        )
        slot_specs.append(slot_spec)
  
    # åˆ›å»ºä¸šåŠ¡é…ç½®å¯¹è±¡
    config = BusinessConfig(
        name=business_info.get('name', business_name),
        display_name=business_info.get('display_name', business_name),
        description=business_info.get('description', ''),
        slot_specs=slot_specs,
        enums=data.get('enums', {}),
        templates=data.get('templates', {}),
        filters=data.get('filters', {}),
        command_keywords=data.get('command_keywords', {}),
        intent_recommendations=data.get('intent_recommendations', {})
    )
  
    self._configs[business_name] = config
  
    # æ›´æ–°å…¨å±€æšä¸¾æ³¨å†Œè¡¨
    for enum_key, enum_values in data.get('enums', {}).items():
        global_key = f"{business_name}.{enum_key}"
        self._enum_registry[global_key] = enum_values
```

**åŠŸèƒ½è¯´æ˜**ï¼šä¸šåŠ¡é…ç½®åŠ è½½å®ç°å®Œæ•´çš„é…ç½®è§£æå’Œç¼“å­˜ç®¡ç†ã€‚æ”¯æŒJSONæ ¼å¼çš„ä¸šåŠ¡é…ç½®ï¼Œè‡ªåŠ¨æ„å»ºå†…å­˜ä¸­çš„é…ç½®å¯¹è±¡å’Œæšä¸¾æ³¨å†Œè¡¨ï¼Œæä¾›é«˜æ•ˆçš„é…ç½®è®¿é—®ã€‚

### 7.2 ç”¨æˆ·è¾“å…¥å¤„ç†æµç¨‹

#### 7.2.1 ä¸»å¤„ç†æµç¨‹å®ç°

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def process_input(self, user_input: str, llm_client, semantic_mapper) -> Dict[str, Any]:
    """ç”¨æˆ·è¾“å…¥å¤„ç†ä¸»æµç¨‹"""
    result = {
        "slots_updated": [],
        "slots_filled": [], 
        "conflicts": [],
        "response": "",
        "form_complete": False,
        "should_exit": False
    }

    # 1. ç‰¹æ®ŠçŠ¶æ€å¤„ç†ï¼ˆç»§ç»­è´­ç‰©/ç»“æŸï¼‰
    if self.order_status == OrderStatus.AWAITING_CONTINUE:
        return self._handle_continue_state(user_input)

    stripped = user_input.strip()
  
    # 2. çº¯æ•°å­—è¾“å…¥å¤„ç†
    if stripped.isdigit():
        digital_result = self._handle_digital_input(stripped)
        if digital_result:
            return digital_result

    # 3. å”¯ä¸€åŒ¹é…å°è¯•ï¼ˆé’ˆå¯¹æœ€è¿‘æç¤ºæ§½ä½ï¼‰
    if self.last_prompted_slot and not stripped.isdigit() and not self.awaiting_conflict_slot:
        unique_result = self._handle_unique_match(stripped)
        if unique_result:
            return unique_result

    # 4. é€šç”¨å‘½ä»¤å¤„ç†
    command_result = self._handle_commands(stripped)
    if command_result:
        return command_result

    # 5. ä¸‰å±‚ä¿¡æ¯æŠ½å–
    extracted_info = self._extract_multiple_slots(user_input, llm_client, semantic_mapper)
  
    # 6. æ§½ä½æ›´æ–°å’Œå†²çªæ£€æµ‹
    for slot_name, slot_value in extracted_info.items():
        update_result = self._update_slot(slot_name, slot_value)
        if update_result["updated"]:
            result["slots_updated"].append(slot_name)
        if update_result["filled"]:
            result["slots_filled"].append(slot_name)
        if update_result["conflict"]:
            result["conflicts"].append({
                "slot": slot_name,
                "existing": self.current_form[slot_name].value,
                "new": slot_value
            })
            # å†²çªæ—¶ç«‹å³ä¸­æ–­ï¼Œä¼˜å…ˆè§£å†³å†²çª
            break
  
    # 7. å“åº”ç”Ÿæˆ
    result["form_complete"] = self._check_form_completeness()
    result["response"] = self._generate_response(result)
  
    return result
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†åŸºäºä¼˜å…ˆçº§çš„çŠ¶æ€å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿ç”¨æˆ·è¾“å…¥å¾—åˆ°æœ€åˆé€‚çš„å¤„ç†ã€‚è¿™ä¸ªè®¾è®¡æºäºå¯¹ç”¨æˆ·è¡Œä¸ºæ¨¡å¼çš„æ·±å…¥åˆ†æï¼šæ•°å­—è¾“å…¥å’Œå”¯ä¸€åŒ¹é…åº”è¯¥ä¼˜å…ˆå¤„ç†ä»¥æé«˜æ•ˆç‡ï¼Œå†²çªæ£€æµ‹å…·æœ‰æœ€é«˜ä¸­æ–­ä¼˜å…ˆçº§ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚é€šè¿‡æ¸…æ™°çš„çŠ¶æ€è½¬æ¢é€»è¾‘ï¼Œå®ç°äº†æµç•…çš„å¤šè½®å¯¹è¯ä½“éªŒã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	æµç¨‹é¦–å…ˆå¤„ç†ç‰¹æ®ŠçŠ¶æ€ï¼ˆå¦‚ç»§ç»­è´­ç‰©å†³ç­–ï¼‰ï¼Œç„¶åæŒ‰ä¼˜å…ˆçº§å¤„ç†çº¯æ•°å­—è¾“å…¥ã€å”¯ä¸€åŒ¹é…å°è¯•å’Œé€šç”¨å‘½ä»¤ã€‚æ ¸å¿ƒçš„ä¸‰å±‚ä¿¡æ¯æŠ½å–å¹¶è¡Œå¤„ç†å¤šä¸ªæ§½ä½ï¼Œå†²çªæ£€æµ‹æœºåˆ¶ç¡®ä¿åœ¨å‘ç°å†²çªæ—¶ç«‹å³ä¸­æ–­åç»­å¤„ç†ã€‚å“åº”ç”ŸæˆåŸºäºå®Œæ•´çš„ç³»ç»ŸçŠ¶æ€è¯„ä¼°ï¼Œç¡®ä¿æç¤ºä¿¡æ¯çš„å‡†ç¡®æ€§å’Œå¼•å¯¼æ€§ã€‚æ•´ä¸ªæµç¨‹ç»´æŠ¤è¯¦ç»†çš„å¤„ç†ç»“æœè®°å½•ï¼Œæ”¯æŒå¤æ‚çš„å¯¹è¯çŠ¶æ€è·Ÿè¸ªã€‚

#### 7.2.2 æ•°å­—è¾“å…¥å¤„ç†å®ç°

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _handle_digital_input(self, input_text: str) -> Optional[Dict[str, Any]]:
    """æ•°å­—è¾“å…¥å¤„ç†å®ç°"""
    number = int(input_text)
  
    # åœºæ™¯1ï¼šå†²çªè§£å†³å†³ç­–
    if self.awaiting_conflict_slot:
        if number in {1, 2, 3}:
            self._resolve_conflict(self.awaiting_conflict_slot, str(number))
            return {
                "response": self._generate_response({"slots_updated": [], "slots_filled": [], "conflicts": []}),
                "form_complete": self._check_form_completeness()
            }
        else:
            # æ— æ•ˆå†²çªé€‰æ‹©
            invalid_template = business_config_loader.get_template(self.business_line, "form_conflict_invalid_choice")
            return {"response": "\n".join(invalid_template) if invalid_template else "è¯·è¾“å…¥ 1 ä¿ç•™åŸå€¼ | 2 ä½¿ç”¨æ–°å€¼ | 3 é‡æ–°è¯´æ˜"}
  
    # åœºæ™¯2ï¼šé‡é€‰æ§½ä½é€‰æ‹©
    if self.reselect_slot == "waiting":
        required_slots = [name for name, slot in self.current_form.items() 
                         if slot.definition.required and slot.status == SlotStatus.FILLED]
        if 1 <= number <= len(required_slots):
            selected_slot = required_slots[number - 1]
            self.order_status = OrderStatus.RESELECTING
            self._clear_slot_and_dependencies(selected_slot)
            self.last_prompted_slot = selected_slot
            self.reselect_slot = None
        
            reselect_prefix = business_config_loader.get_template(self.business_line, "form_reselect_prompt_prefix")
            prefix_text = "\n".join(reselect_prefix).replace("{slot_desc}", 
                            self.current_form[selected_slot].definition.description) if reselect_prefix else f"å¥½çš„ï¼Œè¯·é‡æ–°é€‰æ‹©{self.current_form[selected_slot].definition.description}ï¼š"
        
            return {
                "response": prefix_text + "\n\n" + self._generate_slot_prompt(selected_slot)
            }
  
    # åœºæ™¯3ï¼šç¡®è®¤èœå•é€‰æ‹©
    if self.order_status == OrderStatus.READY_CONFIRM:
        if number == 1:
            # ç¡®è®¤è®¢å•ï¼Œç»§ç»­æ‰§è¡Œåç»­é€»è¾‘
            pass
        elif number == 2:
            return {"response": self._generate_reselect_options()}
        elif number == 3:
            self._reset_form()
            next_slot = self._get_next_missing_slot()
            if next_slot:
                self.last_prompted_slot = next_slot
                return {"response": "å¥½çš„ï¼è®©æˆ‘ä»¬é‡æ–°å¼€å§‹é€‰æ‹©ï½\n\n" + self._generate_slot_prompt(next_slot)}
  
    # åœºæ™¯4ï¼šæšä¸¾é€‰é¡¹åºå·æ˜ å°„
    target_slot = self.last_prompted_slot or self._get_next_missing_slot()
    if target_slot:
        return self._handle_enum_selection(target_slot, number)
  
    return None
```

**åŠŸèƒ½è¯´æ˜**ï¼š

    æ•°å­—è¾“å…¥å¤„ç†æ”¯æŒå››ç§åœºæ™¯ï¼Œè¦†ç›–å†²çªè§£å†³ã€é‡é€‰æ“ä½œã€ç¡®è®¤èœå•å’Œé€‰é¡¹é€‰æ‹©ã€‚ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç¡®ä¿æ•°å­—çš„æ­£ç¡®è§£é‡Šï¼Œæä¾›æµç•…çš„ç”¨æˆ·ä½“éªŒã€‚

### 7.3 å“åº”ç”Ÿæˆæœºåˆ¶

#### 7.3.1 æ™ºèƒ½å“åº”ç”Ÿæˆ

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _generate_response(self, extraction_result: Dict[str, Any]) -> str:
    """æ™ºèƒ½å“åº”ç”Ÿæˆå®ç°"""
    response_parts = []
  
    # 1. ç¡®è®¤æ”¶åˆ°çš„ä¿¡æ¯ï¼ˆå¸¦æ¥æºæ ‡è¯†ï¼‰
    if extraction_result["slots_updated"]:
        filled_info = []
        for slot_name in extraction_result["slots_updated"]:
            slot = self.current_form[slot_name]
            source_prefix = self._get_source_prefix(slot.value.source)
            filled_info.append(f"{source_prefix}{slot.definition.description}: {slot.value.value}")
    
        if filled_info:
            recorded_template = business_config_loader.get_template(self.business_line, "form_info_recorded")
            recorded_msg = "\n".join(recorded_template) if recorded_template else "âœ… å¥½çš„ï¼Œæˆ‘è®°ä¸‹å•¦ï¼š"
            response_parts.append(recorded_msg + "\n" + "\n".join(f"   {info}" for info in filled_info))
  
    # 2. å†²çªå¤„ç†æç¤º
    if extraction_result["conflicts"]:
        for conflict in extraction_result["conflicts"]:
            conflict_msg = self._generate_conflict_message(conflict)
            response_parts.append(conflict_msg)
            return "\n\n".join(response_parts)  # å†²çªæ—¶ç«‹å³è¿”å›
  
    # 3. è¯¢é—®ç¼ºå¤±ä¿¡æ¯
    missing_required = [name for name, slot in self.current_form.items()
                       if slot.definition.required and slot.status == SlotStatus.EMPTY]
  
    if missing_required and not extraction_result["form_complete"]:
        next_slot_name = self._get_next_available_slot(missing_required)
        if next_slot_name:
            prompt = self._generate_slot_prompt(next_slot_name)
            response_parts.append(prompt)
            self.last_prompted_slot = next_slot_name
  
    # 4. è¡¨å•å®Œæˆå¤„ç†
    elif extraction_result["form_complete"]:
        # è¿è¡ŒéªŒè¯å™¨
        from core.slot_validators import run_validators
        context_view = {n: s.value.value for n, s in self.current_form.items() if s.value}
        errors = run_validators(context_view)
    
        if errors:
            self.validation_errors = errors
            error_title_template = business_config_loader.get_template(self.business_line, "form_validation_error_title")
            error_footer_template = business_config_loader.get_template(self.business_line, "form_validation_error_footer")
            error_title = "\n".join(error_title_template) if error_title_template else "ğŸ˜® æŸäº›ç»„åˆæš‚æ—¶ä¸å¤ªåˆé€‚ï¼š"
            error_footer = "\n".join(error_footer_template) if error_footer_template else "å¯ä»¥è°ƒæ•´ç›¸å…³é¡¹åå†è¯•ä¸€ä¸‹ï½"
            response_parts.append(error_title)
            response_parts.extend(f"- {msg}" for msg in errors)
            response_parts.append(error_footer)
        else:
            # è®¾ç½®è®¢å•çŠ¶æ€ä¸ºå‡†å¤‡ç¡®è®¤
            self.order_status = OrderStatus.READY_CONFIRM
            order_summary = self._generate_order_summary()
            response_parts.append(order_summary)
            response_parts.append(self._generate_confirmation_options())
  
    return "\n\n".join(response_parts)
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†çŠ¶æ€é©±åŠ¨çš„å“åº”ç”Ÿæˆæœºåˆ¶ï¼Œæ ¹æ®ç³»ç»Ÿå½“å‰çŠ¶æ€å’Œç”¨æˆ·æ“ä½œç”Ÿæˆæœ€åˆé€‚çš„æç¤ºä¿¡æ¯ã€‚è¿™ä¸ªè®¾è®¡çš„æ ¸å¿ƒæ€æƒ³æ˜¯"å¯¹è¯ä¸Šä¸‹æ–‡æ„ŸçŸ¥"ï¼šç³»ç»Ÿå“åº”åº”è¯¥åæ˜ å®Œæ•´çš„å¯¹è¯çŠ¶æ€ï¼Œè€Œä¸ä»…ä»…æ˜¯æœ€åä¸€æ¬¡ç”¨æˆ·è¾“å…¥ã€‚é€šè¿‡æ¨¡æ¿åŒ–å“åº”å’ŒåŠ¨æ€å†…å®¹æ„å»ºï¼Œå®ç°äº†è‡ªç„¶æµç•…çš„å¯¹è¯ä½“éªŒã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	ç”Ÿæˆå™¨é¦–å…ˆç¡®è®¤æ”¶åˆ°çš„ä¿¡æ¯ï¼Œæ ‡æ³¨è¯†åˆ«æ¥æºå¢å¼ºé€æ˜åº¦ã€‚ç„¶åå¤„ç†å†²çªæƒ…å†µï¼Œæä¾›æ¸…æ™°çš„è§£å†³é€‰é¡¹ã€‚å¯¹äºç¼ºå¤±ä¿¡æ¯ï¼ŒåŸºäºä¾èµ–å…³ç³»é€‰æ‹©ä¸‹ä¸€ä¸ªè¯¢é—®æ§½ä½ï¼Œç”Ÿæˆé’ˆå¯¹æ€§æç¤ºã€‚è¡¨å•å®Œæˆæ—¶æ‰§è¡Œæ•°æ®éªŒè¯ï¼Œç¡®ä¿ä¸šåŠ¡è§„åˆ™æ»¡è¶³ã€‚æœ€åæ ¹æ®éªŒè¯ç»“æœç”Ÿæˆè®¢å•æ‘˜è¦æˆ–é”™è¯¯æç¤ºï¼Œå¼•å¯¼ç”¨æˆ·å®Œæˆåç»­æ“ä½œã€‚æ•´ä¸ªè¿‡ç¨‹æ”¯æŒä¸šåŠ¡æ¨¡æ¿å®šåˆ¶ï¼Œä¿è¯è¯æœ¯çš„ä¸€è‡´æ€§ã€‚

#### 7.3.2 æ§½ä½æç¤ºç”Ÿæˆ

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _generate_slot_prompt(self, slot_name: str) -> str:
    """åŠ¨æ€æ§½ä½æç¤ºç”Ÿæˆ"""
    # åŸºäºç±»åˆ«é€‰æ‹©æ¨¡æ¿
    category_val = None
    if self.current_form.get("category") and self.current_form["category"].value:
        category_val = self.current_form["category"].value.value

    template_key = f"form_{slot_name}_prompt"
    if slot_name == "series" and self.business_line == "apple_store":
        if category_val == "ç”µè„‘":
            template_key = "form_series_prompt_computer"
        elif category_val == "æ‰‹æœº":
            template_key = "form_series_prompt_phone"
        else:
            template_key = "form_series_prompt"
  
    # è·å–æ¨¡æ¿å†…å®¹
    template_lines = business_config_loader.get_template(self.business_line, template_key)
    slot_def = self.form_template.get(slot_name)
    enum_key = slot_def.enums_key if slot_def and slot_def.enums_key else slot_name
    options = self._get_filtered_options(enum_key)

    # æ„å»ºè¾“å‡º
    out_lines = []
    if template_lines:
        out_lines.extend(template_lines)
  
    # æ·»åŠ æšä¸¾é€‰é¡¹ï¼ˆå¦‚æœæ¨¡æ¿æ²¡æœ‰ç¼–å·ï¼‰
    def _has_numbering(lines: List[str]) -> bool:
        return any(l.strip().startswith("1.") for l in lines)

    if options and not _has_numbering(template_lines if template_lines else []):
        filtered = options
        if enum_key == 'storage' and category_val == "ç”µè„‘":
            filtered = [o for o in options if o['label'] in {'512GB','1TB','2TB'}]
    
        option_lines = [f"{i+1}. {opt['label']}" for i, opt in enumerate(filtered)]
        out_lines.extend(option_lines[:10])  # é™åˆ¶é€‰é¡¹æ•°é‡
  
    return "\n".join(out_lines) if out_lines else self._get_default_prompt(slot_name)
```

**åŠŸèƒ½è¯´æ˜**ï¼š

    æ§½ä½æç¤ºç”Ÿæˆæ”¯æŒæ¡ä»¶åŒ–æ¨¡æ¿é€‰æ‹©å’ŒåŠ¨æ€é€‰é¡¹è¿‡æ»¤ã€‚åŸºäºä¸šåŠ¡ä¸Šä¸‹æ–‡é€‰æ‹©æœ€åˆé€‚çš„æç¤ºæ¨¡æ¿ï¼Œè‡ªåŠ¨ç”Ÿæˆå¸¦ç¼–å·çš„é€‰é¡¹åˆ—è¡¨ï¼Œæä¾›ç”¨æˆ·å‹å¥½çš„äº¤äº’ç•Œé¢ã€‚

## 8. é”™è¯¯å¤„ç†ä¸çŠ¶æ€ç®¡ç†

### 8.1 å¼‚å¸¸å¤„ç†æœºåˆ¶

#### 8.1.1 LLMæœåŠ¡å¼‚å¸¸å¤„ç†

**å®ç°æ¥æº**ï¼šspark_client.py

```python
def extract_slots(self, user_input: str, business_line: str, target_slots: List[str], 
                 current_values: Optional[Dict[str, Any]] = None) -> Dict[str, Dict[str, Any]]:
    """LLMæŠ½å–çš„å¼‚å¸¸å®‰å…¨å®ç°"""
    if not user_input or not target_slots:
        return {}
  
    try:
        # æ„å»ºæç¤ºè¯å’Œè°ƒç”¨LLM
        raw_result = self._call_extraction_api(messages)
        text = raw_result.strip()
    
        # å“åº”æ ¼å¼æ¸…ç†
        cleaned_text = self._clean_llm_response(text)
        if not cleaned_text:
            return {}
        
        # JSONè§£æ
        result_obj = self._parse_llm_json(cleaned_text)
        if not result_obj:
            return {}
        
        # ç»“æœéªŒè¯å’Œè¿‡æ»¤
        return self._validate_and_filter_results(result_obj, business_line)
    
    except Exception as e:
        print(f"ğŸ¤– LLMæŠ½å–å¼‚å¸¸: {e}")
        return {}  # é™é»˜é™çº§ï¼Œè¿”å›ç©ºç»“æœ
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†é˜²å¾¡æ€§çš„LLMæœåŠ¡é›†æˆç­–ç•¥ï¼Œç¡®ä¿åœ¨å¤–éƒ¨æœåŠ¡å¼‚å¸¸æ—¶ç³»ç»Ÿä»èƒ½é™çº§è¿è¡Œã€‚è¿™ä¸ªè®¾è®¡åŸºäºåˆ†å¸ƒå¼ç³»ç»Ÿ	çš„å®¹é”™ç†å¿µï¼šå•ä¸ªç»„ä»¶æ•…éšœä¸åº”è¯¥å¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒã€‚é€šè¿‡å¤šå±‚å¼‚å¸¸æ•è·å’Œé™é»˜é™çº§ï¼Œå®ç°äº†é«˜å¯ç”¨çš„å¯¹è¯æœåŠ¡ã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	å¼‚å¸¸å¤„ç†æ¶µç›–ç½‘ç»œè¯·æ±‚ã€å“åº”è§£æã€ç»“æœéªŒè¯ç­‰æ¯ä¸ªå¯èƒ½å¤±è´¥çš„ç¯èŠ‚ã€‚åœ¨APIè°ƒç”¨å¤±è´¥æ—¶è¿”å›ç©ºç»“æœï¼Œè®©ç³»ç»Ÿé™çº§åˆ°æœ¬åœ°ç®—æ³•ç»§ç»­è¿è¡Œã€‚å“åº”æ ¼å¼æ¸…ç†å¤„ç†LLMè¿”å›çš„ä¸è§„èŒƒJSONï¼Œè§£æå¤±è´¥æ—¶å°è¯•å¤šç§æ¢å¤ç­–ç•¥ã€‚ç»“æœéªŒè¯ç¡®ä¿LLMè¿”å›å€¼åœ¨ä¸šåŠ¡æšä¸¾èŒƒå›´å†…ï¼Œè¿‡æ»¤æ— æ•ˆå»ºè®®ã€‚è¿™ç§å…¨é¢çš„å¼‚å¸¸å¤„ç†ä¿è¯ç³»ç»Ÿåœ¨LLMæœåŠ¡ä¸ç¨³å®šæ—¶ä»èƒ½æä¾›åŸºæœ¬æœåŠ¡ã€‚

#### 8.1.2 é…ç½®åŠ è½½å¼‚å¸¸å¤„ç†

**å®ç°æ¥æº**ï¼šbusiness_config_loader.py

```python
def _load_all_configs(self):
    """å®¹é”™çš„é…ç½®åŠ è½½å®ç°"""
    if not os.path.exists(self.config_dir):
        print(f"é…ç½®ç›®å½•ä¸å­˜åœ¨: {self.config_dir}")
        return
    
    for filename in os.listdir(self.config_dir):
        if filename.endswith('.json'):
            business_name = filename[:-5]  # å»æ‰.jsonåç¼€
            config_path = os.path.join(self.config_dir, filename)
            try:
                self._load_business_config(business_name, config_path)
            except Exception as e:
                print(f"åŠ è½½é…ç½®å¤±è´¥ {filename}: {e}")
                # å•ä¸ªé…ç½®å¤±è´¥ä¸å½±å“å…¶ä»–é…ç½®åŠ è½½
```

**åŠŸèƒ½è¯´æ˜**ï¼š

    é…ç½®åŠ è½½é‡‡ç”¨å®¹é”™ç­–ç•¥ï¼Œå•ä¸ªé…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ä¸å½±å“å…¶ä»–é…ç½®ã€‚æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ç”¨äºé—®é¢˜æ’æŸ¥ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨éƒ¨åˆ†é…ç½®å¼‚å¸¸æ—¶ä»èƒ½æ­£å¸¸è¿è¡Œã€‚

### 8.2 çŠ¶æ€æœºç®¡ç†

#### 8.2.1 è®¢å•çŠ¶æ€æœºå®ç°

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
# è®¢å•çŠ¶æ€å®šä¹‰
class OrderStatus(Enum):
    COLLECTING = "collecting"           # ä¿¡æ¯æ”¶é›†ä¸­
    READY_CONFIRM = "ready_confirm"     # å‡†å¤‡ç¡®è®¤è®¢å•
    CONFIRMED = "confirmed"             # å·²ç¡®è®¤è®¢å•
    RESELECTING = "reselecting"         # é‡æ–°é€‰æ‹©æŸé¡¹
    AWAITING_CONTINUE = "awaiting_continue"  # ç­‰å¾…ç»§ç»­è´­ç‰©å†³ç­–

# çŠ¶æ€è½¬æ¢æ¡ä»¶
def _check_state_transitions(self):
    """çŠ¶æ€è½¬æ¢æ¡ä»¶æ£€æŸ¥"""
    # COLLECTING -> READY_CONFIRM
    if self.order_status == OrderStatus.COLLECTING and self._check_form_completeness():
        self.order_status = OrderStatus.READY_CONFIRM
  
    # READY_CONFIRM -> AWAITING_CONTINUE (ç”¨æˆ·ç¡®è®¤æ—¶)
    # RESELECTING -> COLLECTING (é‡é€‰å®Œæˆå)
    # å…¶ä»–çŠ¶æ€è½¬æ¢...
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†åŸºäºä¸šåŠ¡ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€æœºæ¨¡å‹ï¼Œç²¾ç¡®ç®¡ç†å¯¹è¯æµç¨‹çš„æ¯ä¸ªé˜¶æ®µã€‚è¿™ä¸ªè®¾è®¡è§£å†³äº†ç¬¬äºŒä»£ç³»ç»Ÿä¸­çŠ¶æ€ç®¡ç†æ··ä¹±çš„é—®é¢˜ï¼Œé€šè¿‡æ˜ç¡®çš„çŠ¶æ€å®šä¹‰å’Œè½¬æ¢æ¡ä»¶ï¼Œå®ç°äº†å¯é¢„æµ‹ã€å¯ç»´æŠ¤çš„å¯¹è¯æ§åˆ¶ã€‚çŠ¶æ€æœºçš„å¼•å…¥å¤§å¹…å‡å°‘äº†ä»£ç ä¸­çš„æ¡ä»¶åˆ†æ”¯ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯è¯»æ€§ã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	çŠ¶æ€æœºç®¡ç†ä»ä¿¡æ¯æ”¶é›†åˆ°è®¢å•ç¡®è®¤çš„å®Œæ•´æµç¨‹ï¼Œæ¯ä¸ªçŠ¶æ€éƒ½æœ‰æ˜ç¡®çš„è¿›å…¥å’Œé€€å‡ºæ¡ä»¶ã€‚COLLECTINGçŠ¶æ€è´Ÿè´£æ¸è¿›å¼ä¿¡æ¯æ”¶é›†ï¼ŒREADY_CONFIRMçŠ¶æ€å¤„ç†è®¢å•ç¡®è®¤å‰çš„éªŒè¯å’Œå±•ç¤ºï¼ŒCONFIRMEDçŠ¶æ€æ‰§è¡Œè®¢å•æäº¤é€»è¾‘ï¼ŒAWAITING_CONTINUEçŠ¶æ€ç®¡ç†ä¼šè¯å»¶ç»­å†³ç­–ã€‚çŠ¶æ€è½¬æ¢åŸºäºè¡¨å•å®Œæ•´æ€§å’Œç”¨æˆ·æ“ä½œè§¦å‘ï¼Œç¡®ä¿ä¸šåŠ¡æµç¨‹çš„é€»è¾‘æ­£ç¡®æ€§ã€‚è¿™ç§è®¾è®¡æ”¯æŒå¤æ‚çš„çŠ¶æ€æ¢å¤å’Œä¼šè¯æŒä¹…åŒ–éœ€æ±‚ã€‚

#### 8.2.2 æ§½ä½çŠ¶æ€ç®¡ç†

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _update_slot(self, slot_name: str, new_value: SlotValue) -> Dict[str, bool]:
    """æ§½ä½çŠ¶æ€æ›´æ–°å®ç°"""
    slot = self.current_form[slot_name]
    result = {"updated": False, "filled": False, "conflict": False}
  
    if slot.status == SlotStatus.EMPTY:
        # ç©ºæ§½ä½ç›´æ¥å¡«å……
        slot.value = new_value
        slot.status = SlotStatus.FILLED if new_value.confidence >= 0.7 else SlotStatus.PARTIAL
        result["updated"] = True
        result["filled"] = (slot.status == SlotStatus.FILLED)
  
    elif slot.status == SlotStatus.FILLED:
        # å·²å¡«å……æ§½ä½éœ€è¦æ£€æŸ¥å†²çª
        if self._should_trigger_conflict(slot.value, new_value):
            slot.candidates.append(new_value)
            slot.status = SlotStatus.CONFLICTED
            result["conflict"] = True
        else:
            # ç›¸åŒå€¼æˆ–å…¼å®¹å€¼ï¼Œæ›´æ–°ç½®ä¿¡åº¦
            if slot.value.value == new_value.value:
                slot.value.confidence = min(1.0, slot.value.confidence + 0.1)
                result["updated"] = True
  
    elif slot.status == SlotStatus.CONFLICTED:
        # å·²å¤„äºå†²çªçŠ¶æ€ï¼Œæ·»åŠ åˆ°å€™é€‰åˆ—è¡¨
        if not any(c.value == new_value.value for c in slot.candidates):
            slot.candidates.append(new_value)
  
    return result
```

**åŠŸèƒ½è¯´æ˜**ï¼š

    æ§½ä½çŠ¶æ€ç®¡ç†å®ç°æ¸è¿›å¼ä¿¡æ¯æ”¶é›†å’Œå†²çªå¤„ç†ã€‚æ”¯æŒä»ç©ºçŠ¶æ€åˆ°å¡«å……çŠ¶æ€çš„å¤šçº§è½¬æ¢ï¼Œç¡®ä¿æ•°æ®è´¨é‡å’Œç”¨æˆ·ä½“éªŒã€‚

## 9. æ€§èƒ½ä¸èµ„æºç®¡ç†

### 9.1 ç°æœ‰æ€§èƒ½ä¼˜åŒ–

#### 9.1.1 é€‰æ‹©æ€§æ‰«æä¼˜åŒ–

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _direct_keyword_extraction(self, user_input: str) -> Dict[str, SlotValue]:
    """é€‰æ‹©æ€§æ‰«æçš„æ€§èƒ½ä¼˜åŒ–"""
    extracted = {}
    text_lower = user_input.lower().strip()
  
    # å…³é”®ä¼˜åŒ–ï¼šä»…æ‰«æç¼ºå¤±æ§½ä½
    for slot_name, slot_def in self.form_template.items():
        if self.current_form[slot_name].status != SlotStatus.EMPTY:
            continue  # è·³è¿‡å·²å¡«å……æ§½ä½ï¼Œå‡å°‘ä¸å¿…è¦çš„åŒ¹é…è®¡ç®—
    
        # ä»…å¯¹ç¼ºå¤±æ§½ä½è¿›è¡Œæšä¸¾æ‰«æ
        enum_key = slot_def.enums_key
        enum_list = business_config_loader.get_enums(self.business_line).get(enum_key, [])
    
        for enum_item in enum_list:
            # åŒ¹é…é€»è¾‘...
```

 **è®¾è®¡æ€è·¯è¯´æ˜** ï¼š
	æˆ‘è®¾è®¡äº†åŸºäºæ§½ä½çŠ¶æ€çš„é€‰æ‹©æ€§æ‰«ææœºåˆ¶ï¼Œæ˜¾è‘—å‡å°‘ä¸å¿…è¦çš„ä¿¡æ¯æŠ½å–è®¡ç®—ã€‚è¿™ä¸ªä¼˜åŒ–æºäºå¯¹æ€§èƒ½ç“¶é¢ˆçš„åˆ†æï¼šåœ¨è¡¨å•å¡«å……åæœŸï¼Œå¤§éƒ¨åˆ†æ§½ä½å·²ç»å¡«å®Œï¼Œç»§ç»­æ‰«æè¿™äº›æ§½ä½çº¯å±æµªè´¹ã€‚é€šè¿‡åŠ¨æ€è°ƒæ•´æ‰«æèŒƒå›´ï¼Œå®ç°äº†éšå¯¹è¯è¿›å±•è€Œè‡ªé€‚åº”çš„æ€§èƒ½ä¼˜åŒ–ã€‚

 **å®ç°åŠŸèƒ½æè¿°** ï¼š
	ä¼˜åŒ–ç®—æ³•åœ¨ç›´æ¥å…³é”®è¯åŒ¹é…å’Œè¯­ä¹‰æ˜ å°„é˜¶æ®µéƒ½åªå¤„ç†çŠ¶æ€ä¸ºEMPTYçš„æ§½ä½ï¼Œè·³è¿‡å·²å¡«å……æ§½ä½ã€‚åœ¨è¡¨å•å¡«å……åˆæœŸï¼Œè¿™ç§ä¼˜åŒ–æ•ˆæœä¸æ˜æ˜¾ï¼Œä½†éšç€ç”¨æˆ·é€æ­¥æä¾›ä¿¡æ¯ï¼Œæ‰«æèŒƒå›´çº¿æ€§å‡å°ã€‚åœ¨å…¸å‹çš„7æ§½ä½è¡¨å•ä¸­ï¼Œå¡«å……åˆ°ç¬¬5ä¸ªæ§½ä½æ—¶è®¡ç®—é‡å‡å°‘çº¦70%ã€‚è¿™ç§è®¾è®¡ç‰¹åˆ«é€‚åˆé•¿æµç¨‹å¯¹è¯åœºæ™¯ï¼Œåœ¨ä¿è¯åŠŸèƒ½å®Œæ•´æ€§çš„åŒæ—¶æœ€å¤§åŒ–æ€§èƒ½ã€‚

#### 9.1.2 é…ç½®ç¼“å­˜ä¼˜åŒ–

**å®ç°æ¥æº**ï¼šbusiness_config_loader.py

```python
class BusinessConfigLoader:
    def __init__(self, config_dir: str = None):
        self.config_dir = config_dir
        self._configs: Dict[str, BusinessConfig] = {}  # ä¸šåŠ¡é…ç½®ç¼“å­˜
        self._enum_registry: Dict[str, List[Dict[str, Any]]] = {}  # æšä¸¾æ³¨å†Œè¡¨ç¼“å­˜
        self._load_all_configs()  # å¯åŠ¨æ—¶é¢„åŠ è½½æ‰€æœ‰é…ç½®
  
    def get_slot_options(self, enum_key: str, business_name: str = None) -> List[Dict[str, Any]]:
        """é«˜æ•ˆçš„æšä¸¾é€‰é¡¹è®¿é—®"""
        # ä¼˜å…ˆä½¿ç”¨ä¸šåŠ¡ç‰¹å®šçš„æšä¸¾
        if business_name:
            business_enums = self.get_enums(business_name)
            if enum_key in business_enums:
                return business_enums[enum_key]
    
        # å›é€€åˆ°å…¨å±€æšä¸¾
        return self._enum_registry.get(enum_key, [])
```

**æ€§èƒ½ç‰¹æ€§**ï¼š

    å¯åŠ¨æ—¶é¢„åŠ è½½æ‰€æœ‰é…ç½®åˆ°å†…å­˜ç¼“å­˜ï¼Œè¿è¡Œæ—¶ç›´æ¥å†…å­˜è®¿é—®é¿å…æ–‡ä»¶IOã€‚æ”¯æŒä¸šåŠ¡ç‰¹å®šçš„æšä¸¾ä¼˜å…ˆè®¿é—®ï¼Œå‡å°‘æŸ¥æ‰¾æ—¶é—´ã€‚

### 9.2 èµ„æºç®¡ç†

#### 9.2.1 ä¼šè¯èµ„æºç®¡ç†

**å®ç°æ¥æº**ï¼šform_based_system.py

```python
def _reset_form(self):
    """è¡¨å•èµ„æºé‡ç½®å®ç°"""
    # é‡ç½®æ‰€æœ‰æ§½ä½çŠ¶æ€
    for slot in self.current_form.values():
        slot.status = SlotStatus.EMPTY
        slot.value = None
        slot.candidates = []  # æ¸…ç©ºå€™é€‰åˆ—è¡¨ï¼Œé‡Šæ”¾å†…å­˜
  
    # é‡ç½®ç³»ç»ŸçŠ¶æ€
    self.pending_conflicts = []
    self.awaiting_conflict_slot = None
    self.validation_errors = []
    self.order_confirmed = False
    self.order_summary = {}
    self.order_status = OrderStatus.COLLECTING
    self.reselect_slot = None
    self.last_prompted_slot = None
```

**èµ„æºç®¡ç†**ï¼š

    æä¾›å®Œæ•´çš„è¡¨å•é‡ç½®åŠŸèƒ½ï¼Œæ¸…ç†æ‰€æœ‰è¿è¡Œæ—¶çŠ¶æ€å’Œä¸´æ—¶æ•°æ®ã€‚æ”¯æŒä¼šè¯å¤ç”¨ï¼Œé¿å…é‡å¤çš„å¯¹è±¡åˆ›å»ºå’Œå†…å­˜åˆ†é…ã€‚

#### 9.2.2 ç½‘ç»œèµ„æºç®¡ç†

**å®ç°æ¥æº**ï¼šspark_client.py

```python
def _call_api(self, messages: List[Dict]) -> str:
    """ç½‘ç»œè¯·æ±‚çš„èµ„æºç®¡ç†"""
    headers = {
        'Authorization': self.api_key,
        'content-type': "application/json"
    }
    body = {
        "model": "lite", 
        "user": "user_id",
        "messages": messages,
        "stream": False,
        "temperature": 0.1,
        "max_tokens": 10  # é™åˆ¶è¾“å‡ºé•¿åº¦ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
    }

    # è¶…æ—¶æ§åˆ¶å’Œé”™è¯¯å¤„ç†
    response = requests.post(url=self.url, json=body, headers=headers, timeout=30)
    if response.status_code == 200:
        return response.json()['choices'][0]['message']['content']
    else:
        raise Exception(f"APIè°ƒç”¨é”™è¯¯: {response.status_code}, {response.text}")
```

**èµ„æºç®¡ç†**ï¼š

    ç½‘ç»œè¯·æ±‚è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡ã€‚é€šè¿‡`max_tokens`é™åˆ¶å“åº”å¤§å°ï¼Œä¼˜åŒ–ç½‘ç»œå¸¦å®½ä½¿ç”¨ã€‚å®Œæ•´çš„é”™è¯¯å¤„ç†ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾ã€‚
