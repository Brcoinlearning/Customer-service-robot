# 开发日志

## 2025年10月7日

- **初始化开发环境**：
  - 安装依赖库：`pytest`-用于测试框架。
  - 创建项目结构：
    - `src/`：源代码目录。
    - `tests/`：测试代码目录。
  - 添加配置文件：
    - `requirements.txt`：记录项目依赖。
    - `.gitignore`：忽略不必要的文件。
- **开发环境测试**：
  - 创建测试脚本 `src/test_spark_api.py`，验证星火API是否正常工作。
- **版本管理初始化**：
  - 初始化Git仓库，并提交了项目结构和配置文件。

---

## 2025年10月11日

* **完成阶段一：需求分析与规划** ：
  * 撰写详细的需求分析文档，明确项目功能需求和非功能需求
  * 制定详细的项目计划表，明确各阶段时间节点和输出物
  * 确定技术栈：Python + 星火LLM API + 自定义DSL解释器
* **项目文档完善** ：
  * 创建《需求分析.md》文档，包含功能需求、非功能需求、约束条件等
  * 更新《任务计划.md》，细化各阶段具体任务和时间安排
  * 制定开发规范和代码标准

---

## 2025年10月14日

* **DSL语法设计** ：

  * 设计完整的DSL语法规范，采用BNF格式定义
  * 定义INTENT、RULE、WHEN、THEN等核心语法结构
  * 支持意图匹配、条件判断、响应动作等语义
* **DSL文法定义文档** ：

  * 创建《DSL文法定义.txt》文档，详细描述语法规则
  * 编写《DSL设计.md》设计说明文档

---

## 2025年10月17日

* **脚本范例开发** ：
  * 创建电商客服场景脚本  `src/scripts/ecommerce.dsl`
  * 设计技术支持场景脚本模板
  * 设计银行客服场景脚本模板
* **核心模块框架搭建** ：
  * 创建DSL解析器基础框架  `src/parser/dsl_parser.py`
  * 搭建解释执行引擎结构  `src/interpreter/interpreter.py`
  * 设计模块接口规范

---

## 2025年10月19日

完成阶段二：DSL设计

完成解释器部分设计

* **DSL解析器实现** ：
  * 完成INTENT定义解析功能
  * 实现RULE规则解析，支持WHEN条件识别
  * 添加THEN动作序列解析
  * 完善错误处理和语法验证
* **解释器核心逻辑** ：
  * 实现规则匹配算法
  * 开发动作执行引擎
  * 添加默认规则处理机制

---

## 2025年10月21日

完成阶段三：解释器的设计和实现

程序完善工作

* **LLM集成优化** ：
  * 完善LLM API客户端  `src/llm/spark_client.py`
  * 优化意图识别提示词，提高识别准确率
  * 添加响应格式清理和验证机制
  * 实现降级处理（关键词匹配）
* **主程序开发** ：
  * 创建程序入口  `src/main.py`，实现完整的对话流程
  * 支持用户输入 → 意图识别 → DSL执行 → 响应输出的完整链路
  * 添加详细的调试信息和错误处理
* **测试验证** ：
  * 编写解析器测试用例  `tests/test_parser.py`
  * 验证DSL脚本解析正确性
  * 测试LLM意图识别准确性
  * 确认多轮对话功能正常工作
* **问题修复与优化** ：
  * 修复LLM API响应格式处理问题
  * 优化文件路径处理，解决脚本加载问题
  * 完善日志输出和用户界面

---

## 2025年10月31日

- **完成阶段四：模块化设计与实现**：
  - **接口规范实现**：
    - 完成所有核心模块对接口的实现
    - `DSLParser` 类实现 `IDSLParser` 接口
    - `DSLInterpreter` 类实现 `IInterpreter` 接口
    - `SparkLLMClient` 类实现 `ILLMClient` 接口
    - `ConversationContext` 类实现 `IContextManager` 接口
  - **配置管理优化**：
    - 统一使用 `Config` 类管理所有配置项
    - 修复 `SparkLLMClient` 使用配置的 model 参数
    - 移除主程序中的硬编码配置
  - **代码结构清理**：
    - 清理主程序中的重复代码和冲突定义
    - 统一错误处理和日志输出
    - 完善上下文管理器的集成使用
  - **模块依赖规范**：
    - 所有模块通过接口进行交互
    - 实现依赖注入的设计模式
    - 提高代码的可测试性和可维护性

---

## 2025年10月25日

- **开始阶段四：模块化设计与实现**：

  - **项目结构重构**：
    - 创建核心架构目录 `src/core/`
    - 创建配置管理目录 `src/config/`
    - 建立清晰的模块分层结构
  - **接口设计**：
    - 定义 `IDSLParser` 接口 - DSL解析器规范
    - 定义 `IInterpreter` 接口 - 解释执行器规范
    - 定义 `ILLMClient` 接口 - LLM客户端规范
    - 定义 `IContextManager` 接口 - 上下文管理器规范
  - **配置集中管理**：
    - 创建 `Config` 配置类，统一管理所有配置项
    - 支持环境变量覆盖默认配置
    - 提供类型安全的配置访问接口
  - **上下文管理设计**：
    - 创建 `ConversationContext` 类管理对话状态
    - 支持对话历史记录和变量存储
    - 实现上下文持久化和状态跟踪
  - **目录结构标准化**：
    - 规范各模块的职责边界
    - 建立模块间的依赖关系
    - 为后续扩展奠定架构基础

---

## 2025年10月31日

- **完成阶段四：模块化设计与实现**：
  - **接口规范实现**：
    - `DSLParser` 类完整实现 `IDSLParser` 接口
    - `DSLInterpreter` 类完整实现 `IInterpreter` 接口
    - `SparkLLMClient` 类完整实现 `ILLMClient` 接口
    - `ConversationContext` 类完整实现 `IContextManager` 接口
  - **配置管理优化**：
    - 统一使用 `Config` 类管理所有配置项
    - 修复 `SparkLLMClient` 构造函数参数匹配问题
    - 移除主程序中的硬编码配置，全面使用配置类
  - **代码结构清理与优化**：
    - 清理主程序中的重复代码和冲突定义
    - 统一错误处理机制和日志输出格式
    - 完善上下文管理器在主程序中的集成使用
  - **模块依赖规范化**：
    - 所有核心模块通过接口契约进行交互
    - 实现依赖注入的设计模式，降低模块耦合度
    - 显著提高代码的可测试性、可维护性和可扩展性
  - **导入路径修复**：
    - 解决相对导入 beyond top-level package 错误
    - 统一模块导入方式，确保各环境下的兼容性

---

## 2025年11月5日

- 进入阶段5:优化部分，先尝试拓展上下文记忆功能
- **阶段5.1：创建核心记忆框架**：
  - **增强上下文管理器**：
    - 实现 `EnhancedConversationContext` 类，支持产品选择链记忆
    - 添加对话阶段管理和状态历史跟踪
    - 实现用户偏好记录和查询计数功能
  - **产品知识库**：
    - 创建 `ProductKnowledge` 类，定义完整的产品分类结构
    - 实现品类-品牌-系列的三级产品树
    - 支持基于场景的智能推荐算法
  - **架构基础**：
    - 建立记忆功能的底层数据结构
    - 设计选择链回退和状态重建机制
    - 为后续自然语言识别奠定基础

---

## 2025年11月7日

- **继续阶段5开发**：
  - **DSL购物流程扩展**：
    - 在 `ecommerce.txt` 中添加完整的购物车操作规则
    - 实现加入购物车、查看购物车、结算、清空购物车功能
    - 支持继续购物和重新开始流程
  - **多级产品配置**：
    - 完善苹果笔记本的完整配置流程（尺寸→芯片→存储→颜色）
    - 添加联想、戴尔等品牌的闭合处理
    - 实现产品选择链的可视化显示

---

## 2025年11月9日

- **意图识别优化**：
  - **智能意图修正**：
    - 在 `interpreter.py` 中添加基于上下文的数字选项意图修正
    - 实现购物车阶段数字选项自动识别为 `cart_operation`
    - 产品选择阶段数字选项保持为 `product_query`
  - **确认词直接匹配**：
    - 在 `spark_client.py` 中添加简单确认词和否定词的直接匹配
    - 提高"是"、"好的"等简单回答的识别准确率
    - 减少不必要的LLM API调用

---

## 2025年11月10日

- **上下文记忆与智能交互优化**：
  - **状态重置功能**：
    - 实现购物上下文重置功能，支持流程重新开始
    - 修复继续购物后无法选择新产品的状态问题
    - 确保 `current_stage` 正确重置为 "welcome"
  - **交互体验完善**：
    - 优化购物车操作的用户引导
    - 完善错误处理和异常状态恢复
    - 统一调试信息和日志输出格式
  - **功能验证测试**：
    - 测试完整的产品选择 → 配置 → 加入购物车 → 继续购物流程
    - 验证意图识别在不同上下文中的准确性
    - 确认多轮对话记忆功能的稳定性

**
    总结阶段五：**

1. **多轮对话记忆功能**

   - 实现增强版上下文管理器，支持产品选择链记忆
   - 添加对话阶段管理和状态历史跟踪
2. **意图识别上下文优化**

   - 基于对话阶段智能修正数字选项意图识别
   - 实现确认词和否定词的直接匹配处理
   - 提高复杂场景下的意图识别准确性
3. **DSL购物流程扩展**

   - 完整实现购物车操作流程（加入、查看、结算、清空）
   - 支持多级产品配置选择（品类→品牌→系列→配置）
   - 添加闭合处理和异常状态恢复
4. **交互体验增强**

   - 产品选择链可视化显示
   - 智能状态重置和流程重新开始
   - 完善的错误处理和用户引导

---

## 2025年11月12日

- **阶段五补充：多场景对话完善与兼容性增强**：
  - **上下文状态管理升级**：
    - `EnhancedConversationContext` 新增 `current_subtype` 记录，并在链路回滚、重置时自动同步
    - `add_to_chain` 支持按层级去重，防止切换子类或品牌时残留错误节点
    - 对话摘要、变量替换等接口同步暴露 `current_subtype`，提升调试可读性
  - **解释器智能修正**：
    - 购物车阶段的数字与“继续”指令自动归类为 `cart_operation`
    - 品牌选择兜底提示优先展示子类名称，新增手机流程各阶段的回退提示
    - 完善重置兜底逻辑，确保手动重置包含子类字段
  - **DSL 脚本扩展**：
    - 电脑流程支持在台式机→笔记本间自由切换，并允许直接点名品牌
    - 新增苹果 iPhone 深度配置流程（型号→容量→颜色），用于演示与验证
    - 加强购物车“继续”语料覆盖，台式机品牌闭合逻辑同步到子类语义
  - **解析器兼容性**：
    - `DSLParser` 兼容简写 `ADD_TO_CHAIN "type" "value"` 与 `INCREMENT` 语法
    - 避免旧版脚本解析报错，为后续迁移提供缓冲
  - **验证与回归测试**：
    - 运行 `PYTHONPATH=src pytest tests/test_parser.py tests/test_memory_features.py`
    - 覆盖上下文回滚、产品链更新、手机流程等关键路径，确认全部通过

---

## 2025年11月12日 11:02:52

- **DSL 文法对齐与记忆规则完善**：
  - **DSL 设计文档与实现对齐**：
    - 在《DSL设计.md》中新增“当前实现版 DSL 文法”与“设计演进”小节，将文档以实际实现为准进行统一
    - 明确补充 `CONTEXT_HAS` 条件的文法定义与语义说明，保留初版 BNF 作为历史版本做对比
    - 清理未落地的初版场景示例，避免文档与代码行为不一致
  - **解析器与解释器支持 CONTEXT_HAS**：
    - `DSLParser` 新增对 `CONTEXT_HAS "var"` 与 `CONTEXT_HAS "var" = number` 两种形式的解析
    - `DSLInterpreter` 在规则匹配中实现 `context_has` 条件判断，支持从上下文与 `session_variables` 中读取变量
  - **业务 DSL 记忆规则与流程修复**：
    - 在 `ecommerce.dsl` 中基于 `query_count` 区分首次/重复产品咨询，优化欢迎阶段话术
    - 放宽电脑/手机大类规则对阶段的约束，确保在 `welcome`、`category_select` 等阶段都能正确识别“电脑/手机”
    - 新增 `cart_global_reset_rule`，在 `cart_operation` 意图下支持“重置/重新开始”时完整重置购物上下文
  - **测试用例补充与回归验证**：
    - 新增 `test_first_vs_repeat_product_query_prompts`，覆盖 `query_count` 条件下的首问/复问分支
    - 新增 `test_cart_operation_reset_with_reset_keyword`，验证 LLM 将“重置”识别为 `cart_operation` 时仍能正确重置上下文
    - 运行 `pytest tests/test_parser.py tests/test_memory_features.py -q`，确认解析器、解释器与记忆相关逻辑全部通过

---

## 2025年11月13日

- **解释器与对话控制优化（动作执行重构）**：
  - **动作执行逻辑重构为可扩展 handler 映射**：
    - 在 `DSLInterpreter.__init__` 中新增 `_action_handlers` 映射，将 `respond`、`set_variable`、`set_stage`、`add_to_chain`、`increment`、`record_preference`、`reset_shopping_context` 等动作类型统一映射到独立处理函数
    - 将 `_execute_actions` 重构为通过 `atype` 查找对应 handler 并执行，替代原有长链式 `if-elif` 判断，保持行为不变但提升可维护性和可扩展性
  - **动作处理函数拆分与职责清晰化**：
    - 为每种动作拆分 `_handle_respond`、`_handle_set_variable`、`_handle_set_stage`、`_handle_add_to_chain`、`_handle_increment`、`_handle_record_preference`、`_handle_reset_shopping_context` 等小函数
    - 保持对上下文管理器 `EnhancedConversationContext` 的调用方式不变，方便后续扩展新的 DSL 动作（如基于知识库的推荐动作）
  - **测试验证**：
    - 运行 `pytest tests/test_parser.py tests/test_memory_features.py -q`，确认解析器与记忆相关行为在重构后全部通过，证明本次改动为纯结构优化，无逻辑回归


---

## 2025年11月13日

- **解释器兜底逻辑迁移到 DSL fallback 规则**：
  - **新增 fallback 意图与兜底规则集**：
    - 在 `ecommerce.dsl` 中增加 `INTENT fallback: "上下文兜底提示"`，作为统一的兜底意图
    - 约定所有以 `fallback_` 开头的规则名为兜底规则（如 `fallback_category_select`、`fallback_brand_select_with_subtype` 等），根据 `current_stage`、`current_category`、`current_subtype` 等上下文变量生成不同阶段的提示文案
  - **解释器回退流程调整**：
    - 将原先硬编码在 `_get_context_aware_fallback` 中的“阶段 → 提示语”字典改为：优先遍历 DSL 中的 `fallback_*` 规则，并以 `detected_intent = "fallback"` 进行匹配
    - 若命中任一 `fallback_*` 规则，则执行其中的 `RESPOND` 动作，完全由 DSL 控制兜底话术；若未命中，则返回一条简单的通用提示，确保极端情况下依然有反馈
  - **测试用例补充与验证**：
    - 新增 `test_fallback_brand_select_from_dsl`，在 `brand_select` 阶段构造无法命中任何品牌规则的输入，断言返回文案来自 DSL 中的品牌兜底规则（含“手机”“品牌”等提示）
    - 运行 `pytest tests/test_parser.py tests/test_memory_features.py -q`，确认解析器与记忆相关测试在引入 fallback 兜底规则后全部通过，确保行为稳定
